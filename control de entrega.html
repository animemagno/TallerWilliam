<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos - Mototaxis</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.4;
            padding: 15px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            padding: 12px;
            text-align: center;
        }

        h1 {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .tabs {
            display: flex;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 13px;
            min-width: 120px;
        }

        .tab.active {
            background-color: white;
            border-bottom: 3px solid #27ae60;
            color: #27ae60;
        }

        .tab-content {
            display: none;
            padding: 12px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
        }

        input,
        select,
        textarea {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 6px;
            font-size: 13px;
        }

        .btn-primary {
            background-color: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background-color: #219653;
        }

        .btn-success {
            background-color: #3498db;
            color: white;
        }

        .btn-success:hover {
            background-color: #2980b9;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .fila-compacta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .monto-input {
            width: 120px;
            flex-shrink: 0;
        }

        .fecha-input {
            width: 120px;
            flex-shrink: 0;
        }

        .equipo-select,
        .cliente-select {
            flex: 1;
            min-width: 150px;
        }

        .resumen-equipos,
        .resumen-clientes {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }

        .resumen-equipos h2,
        .resumen-clientes h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .lista-equipos,
        .lista-clientes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .equipo-card,
        .cliente-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
        }

        .equipo-header,
        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        .equipo-numero,
        .cliente-nombre {
            font-weight: bold;
            color: #27ae60;
            font-size: 14px;
        }

        .equipo-total,
        .cliente-total {
            font-weight: bold;
            color: #e74c3c;
        }

        .equipo-info,
        .cliente-info {
            color: #6c757d;
            margin-bottom: 3px;
        }

        .ingresos-list {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }

        .ingresos-list h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .lista-ingresos {
            max-height: 400px;
            overflow-y: auto;
        }

        .ingreso-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .ingreso-item:hover {
            background-color: #f8f9fa;
        }

        .ingreso-fecha {
            width: 80px;
            color: #666;
            font-size: 11px;
            flex-shrink: 0;
        }

        .ingreso-equipo {
            width: 80px;
            font-weight: bold;
            color: #27ae60;
            flex-shrink: 0;
        }

        .ingreso-cliente {
            width: 100px;
            font-weight: bold;
            color: #3498db;
            flex-shrink: 0;
        }

        .ingreso-monto {
            width: 80px;
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            flex-shrink: 0;
        }

        .ingreso-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #6c757d;
            font-size: 12px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
            flex-shrink: 0;
        }

        .edit-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
            flex-shrink: 0;
            margin-right: 5px;
        }

        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 12px;
            font-size: 13px;
        }

        .total-general {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #27ae60;
        }

        .fecha-hoy-btn {
            margin-left: 8px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Estilos para la vista de depósitos por equipo */
        .depositos-equipo,
        .depositos-cliente {
            margin-top: 15px;
        }

        .depositos-equipo h2,
        .depositos-cliente h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .depositos-lista {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        @media (min-width: 768px) {
            .depositos-lista {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .deposito-equipo-card,
        .deposito-cliente-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
        }

        .deposito-equipo-header,
        .deposito-cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .deposito-equipo-numero,
        .deposito-cliente-nombre {
            font-weight: bold;
            color: #27ae60;
            font-size: 16px;
        }

        .deposito-equipo-total,
        .deposito-cliente-total {
            font-weight: bold;
            color: #e74c3c;
            font-size: 14px;
        }

        .deposito-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        .deposito-fecha {
            color: #666;
        }

        .deposito-monto {
            font-weight: bold;
            color: #2d3748;
        }

        .deposito-total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #27ae60;
            font-weight: bold;
            text-align: right;
            color: #27ae60;
        }

        .imprimir-btn {
            margin-top: 10px;
            background-color: #6c757d;
            color: white;
        }

        .imprimir-btn:hover {
            background-color: #5a6268;
        }

        /* Estilos para impresión */
        @media print {
            body * {
                visibility: hidden;
            }

            .calendario-print,
            .calendario-print * {
                visibility: visible;
            }

            .calendario-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                font-size: 12px;
            }

            .no-print {
                display: none !important;
            }

            /* Estilos para el calendario en tamaño carta */
            .calendario-mensual {
                width: 8.5in;
                height: 11in;
                padding: 0.5in;
                margin: 0 auto;
                page-break-after: always;
                font-family: Arial, sans-serif;
            }

            .encabezado-recibo {
                text-align: center;
                margin-bottom: 10px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }

            .encabezado-recibo h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }

            .encabezado-recibo .info-mes {
                font-size: 14px;
                margin-bottom: 5px;
            }

            .info-equipo {
                text-align: center;
                margin-bottom: 15px;
                font-size: 13px;
            }

            .info-equipo .numero-equipo {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 5px;
            }

            .tabla-calendario {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            .tabla-calendario th {
                background-color: #f0f0f0;
                border: 1px solid #000;
                padding: 5px;
                text-align: center;
                font-size: 12px;
            }

            .tabla-calendario td {
                border: 1px solid #000;
                padding: 5px;
                vertical-align: top;
                height: 90px;
                width: 14.28%;
            }

            .cuadro-dia {
                height: 100%;
                display: flex;
                flex-direction: column;
                text-align: center;
                padding: 3px;
                position: relative;
            }

            .dia-numero {
                font-weight: bold;
                font-size: 16px;
                text-align: left;
                position: absolute;
                top: 3px;
                left: 5px;
            }

            .dia-monto {
                font-size: 14px;
                font-weight: bold;
                margin-top: 20px;
            }

            .dia-comentario {
                font-size: 10px;
                color: #666;
                margin-top: auto;
                padding-bottom: 5px;
            }

            .dia-descanso {
                background-color: #f0f0f0;
            }

            .texto-descanso {
                font-size: 14px;
                font-weight: bold;
                color: #666;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 20px;
            }

            .pie-pagina {
                margin-top: 30px;
                padding-top: 10px;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
            }

            .total-general-print {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 40px;
            }

            .firma {
                font-size: 14px;
                border-top: 1px solid #000;
                padding-top: 3px;
                width: 200px;
                text-align: center;
            }
        }

        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filtro-group {
            flex: 1;
            min-width: 150px;
        }

        /* NUEVOS ESTILOS PARA EL FORMULARIO SIMPLIFICADO */
        .formulario-rapido {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .campo-rapido {
            flex: 1;
            min-width: 120px;
        }

        .campo-rapido.pequeno {
            max-width: 100px;
        }

        .campo-rapido.medio {
            max-width: 200px;
        }

        .campo-rapido.grande {
            flex: 2;
        }

        .campo-rapido.observacion {
            min-width: 100%;
        }

        .resumen-equipos-saldos {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }

        .resumen-equipos-saldos h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .lista-equipos-saldos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .equipo-saldo-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
        }

        .equipo-saldo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        .equipo-saldo-numero {
            font-weight: bold;
            color: #27ae60;
            font-size: 14px;
        }

        .equipo-saldo-total {
            font-weight: bold;
            color: #e74c3c;
        }

        .equipo-saldo-info {
            color: #6c757d;
            margin-bottom: 3px;
        }

        .equipo-saldo-fecha {
            font-size: 11px;
            color: #3498db;
            font-weight: bold;
        }

        /* Estilos para el botón de imprimir calendario */
        .btn-imprimir-calendario {
            margin-top: 10px;
            background-color: #9b59b6;
            color: white;
        }

        .btn-imprimir-calendario:hover {
            background-color: #8e44ad;
        }

        /* Estilos para selección de días de descanso */
        .dias-descanso {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .dias-descanso h3 {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .lista-dias-descanso {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dia-descanso-check {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dia-descanso-check label {
            margin-bottom: 0;
            font-weight: normal;
        }

        /* Estilos para vista previa del calendario */
        .vista-previa-calendario {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }

        .vista-previa-calendario h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .tabla-calendario-preview {
            width: 100%;
            border-collapse: collapse;
        }

        .tabla-calendario-preview th {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        .tabla-calendario-preview td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
            height: 90px;
            width: 14.28%;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tabla-calendario-preview td:hover {
            background-color: #f9f9f9;
        }

        .dia-descanso-preview {
            background-color: #f0f0f0;
        }

        .cuadro-dia-preview {
            height: 100%;
            display: flex;
            flex-direction: column;
            text-align: center;
            padding: 3px;
            position: relative;
        }

        .dia-numero-preview {
            font-weight: bold;
            font-size: 16px;
            text-align: left;
            position: absolute;
            top: 3px;
            left: 5px;
        }

        .dia-monto-preview {
            font-size: 14px;
            font-weight: bold;
            margin-top: 20px;
        }

        .dia-comentario-preview {
            font-size: 10px;
            color: #666;
            margin-top: auto;
            padding-bottom: 5px;
        }

        .texto-descanso-preview {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .dia-seleccionado {
            background-color: #e3f2fd;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Control de Ingresos - Mototaxis</h1>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="ingresos">Registrar Ingreso</div>
            <div class="tab" data-tab="equipos">Gestionar Equipos</div>
            <div class="tab" data-tab="historial">Historial de Ingresos</div>
            <div class="tab" data-tab="depositos-equipos">Depósitos por Equipo</div>
            <div class="tab" data-tab="calendario">Calendario Mensual</div>
        </div>

        <!-- Pestaña de Ingresos -->
        <div class="tab-content active" id="ingresos">
            <div class="form-group">
                <label for="fecha">Fecha:</label>
                <div class="fila-compacta">
                    <input type="date" id="fecha" class="fecha-input">
                    <button class="btn btn-warning fecha-hoy-btn" id="fecha-hoy">Hoy</button>
                </div>
            </div>

            <div class="formulario-rapido">
                <div class="campo-rapido pequeno">
                    <label for="equipo-rapido">Equipo:</label>
                    <input type="number" id="equipo-rapido" placeholder="Número" min="1">
                </div>

                <div class="campo-rapido medio">
                    <label for="nombre-rapido">Nombre:</label>
                    <input type="text" id="nombre-rapido" placeholder="Nombre del conductor" readonly>
                </div>

                <div class="campo-rapido pequeno">
                    <label for="monto-rapido">Monto ($):</label>
                    <input type="number" id="monto-rapido" placeholder="0.00" min="0" step="0.01">
                </div>

                <div class="campo-rapido">
                    <button class="btn btn-primary" id="guardar-rapido" style="margin-top: 20px;">Registrar</button>
                </div>
            </div>

            <div class="campo-rapido observacion">
                <label for="observacion-rapida">Observación (opcional):</label>
                <textarea id="observacion-rapida" placeholder="Observación o comentario..."></textarea>
            </div>

            <div class="resumen-equipos-saldos">
                <h2>Resumen de Equipos con Saldo</h2>
                <div class="lista-equipos-saldos" id="resumen-equipos-saldos">
                    <!-- Aquí se mostrará el resumen de equipos con saldo -->
                </div>
            </div>
        </div>

        <!-- Pestaña de Equipos -->
        <div class="tab-content" id="equipos">
            <h2>Registrar Nuevo Equipo</h2>

            <div class="form-group">
                <label for="numero-equipo">Número de Equipo:</label>
                <input type="number" id="numero-equipo" placeholder="Ej: 1, 2, 3..." min="1">
            </div>

            <div class="form-group">
                <label for="placa">Placa:</label>
                <input type="text" id="placa" placeholder="Ej: M52795">
            </div>

            <div class="form-group">
                <label for="nombre">Nombre del Conductor:</label>
                <input type="text" id="nombre" placeholder="Nombre completo">
            </div>

            <div class="form-group">
                <label for="dui">DUI:</label>
                <input type="text" id="dui" placeholder="Ej: 12345678-9">
            </div>

            <div>
                <button class="btn btn-success" id="guardar-equipo">Guardar Equipo</button>
            </div>

            <div class="ingresos-list">
                <h2>Equipos Registrados</h2>
                <div class="lista-ingresos" id="lista-equipos">
                    <!-- Aquí se mostrarán los equipos -->
                </div>
            </div>
        </div>

        <!-- Pestaña de Historial -->
        <div class="tab-content" id="historial">
            <h2>Historial de Ingresos</h2>

            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-equipo">Filtrar por Equipo:</label>
                    <select id="filtro-equipo">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>

                <div class="filtro-group">
                    <label for="filtro-fecha">Filtrar por Fecha:</label>
                    <input type="month" id="filtro-fecha">
                </div>
            </div>

            <div class="lista-ingresos" id="historial-ingresos">
                <!-- Aquí se mostrará el historial -->
            </div>
        </div>

        <!-- Pestaña de Depósitos por Equipo -->
        <div class="tab-content" id="depositos-equipos">
            <h2>Depósitos por Equipo</h2>
            <button class="btn btn-info no-print" id="imprimir-todos-equipos">Imprimir Todos</button>

            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-equipo-depositos">Filtrar por Equipo:</label>
                    <select id="filtro-equipo-depositos">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
            </div>

            <div class="depositos-equipo">
                <div class="depositos-lista" id="depositos-lista-equipos">
                    <!-- Aquí se mostrarán los depósitos por equipo -->
                </div>
            </div>
        </div>

        <!-- Pestaña de Calendario Mensual -->
        <div class="tab-content" id="calendario">
            <h2>Calendario Mensual para Imprimir</h2>

            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-mes-calendario">Seleccionar Mes:</label>
                    <input type="month" id="filtro-mes-calendario">
                </div>

                <div class="filtro-group">
                    <label for="filtro-equipo-calendario">Filtrar por Equipo:</label>
                    <select id="filtro-equipo-calendario">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
            </div>

            <div class="dias-descanso">
                <h3>Haz clic en los días del calendario para marcarlos como DÍA SIN INGRESOS ($0)</h3>
                <p>Los días marcados se mostrarán en gris con el monto "$0"</p>
            </div>

            <div class="vista-previa-calendario">
                <h3>Vista Previa del Calendario</h3>
                <div id="calendario-preview">
                    <!-- Aquí se generará la vista previa del calendario -->
                </div>
            </div>

            <button class="btn btn-imprimir-calendario" id="imprimir-calendario">Imprimir Calendario</button>

            <div class="calendario-print" id="calendario-print">
                <!-- Aquí se generará el calendario para imprimir -->
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
            authDomain: "tallerwilliam-732b3.firebaseapp.com",
            projectId: "tallerwilliam-732b3",
            storageBucket: "tallerwilliam-732b3.firebasestorage.app",
            messagingSenderId: "822262666247",
            appId: "1:822262666247:web:6680487bbf1108006b86a2"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variable global para almacenar los días de descanso seleccionados
        let diasDescansoSeleccionados = [];

        document.addEventListener('DOMContentLoaded', function () {
            // Configurar pestañas
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Remover clase active de todas las pestañas y contenidos
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));

                    // Agregar clase active a la pestaña y contenido seleccionados
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Actualizar selectores si es necesario
                    if (tabId === 'ingresos') {
                        actualizarResumenEquiposSaldos();
                    } else if (tabId === 'depositos-equipos') {
                        cargarDepositosPorEquipo();
                        actualizarFiltroEquipos('filtro-equipo-depositos');
                    } else if (tabId === 'historial') {
                        actualizarFiltroEquipos('filtro-equipo');
                        cargarHistorialIngresos();
                    } else if (tabId === 'calendario') {
                        actualizarFiltroEquipos('filtro-equipo-calendario');
                        const hoy = new Date();
                        const mesActual = hoy.getFullYear() + '-' + String(hoy.getMonth() + 1).padStart(2, '0');
                        document.getElementById('filtro-mes-calendario').value = mesActual;
                        generarCalendario();
                    }
                });
            });

            // Función para obtener fecha actual en formato YYYY-MM-DD
            function obtenerFechaHoy() {
                const fechaActual = new Date();
                const año = fechaActual.getFullYear();
                const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaActual.getDate()).padStart(2, '0');
                return `${año}-${mes}-${dia}`;
            }

            // Función para formatear fecha de YYYY-MM-DD a dd/mm/aaaa
            function formatearFecha(fechaISO) {
                const [año, mes, dia] = fechaISO.split('-');
                return `${dia}/${mes}/${año}`;
            }

            // Función para formatear placa agregando "M" al inicio si no la tiene
            function formatearPlaca(placa) {
                if (!placa || placa === 'No registrada') return 'No registrada';
                
                // Si la placa ya empieza con M, dejarla como está
                if (placa.toUpperCase().startsWith('M')) {
                    return placa.toUpperCase();
                }
                
                // Si no empieza con M, agregarla
                return 'M' + placa.toUpperCase();
            }

            // Establecer fecha actual en el formulario
            const fechaInput = document.getElementById('fecha');
            fechaInput.value = obtenerFechaHoy();

            // Botón para establecer fecha de hoy
            document.getElementById('fecha-hoy').addEventListener('click', function () {
                fechaInput.value = obtenerFechaHoy();
            });

            // Elementos del DOM
            const guardarRapidoBtn = document.getElementById('guardar-rapido');
            const guardarEquipoBtn = document.getElementById('guardar-equipo');
            const imprimirTodosEquiposBtn = document.getElementById('imprimir-todos-equipos');
            const imprimirCalendarioBtn = document.getElementById('imprimir-calendario');

            // Elementos del formulario rápido
            const equipoRapidoInput = document.getElementById('equipo-rapido');
            const nombreRapidoInput = document.getElementById('nombre-rapido');
            const montoRapidoInput = document.getElementById('monto-rapido');
            const observacionRapidaInput = document.getElementById('observacion-rapida');

            // Inicializar la aplicación
            inicializarApp();

            // Event listeners
            guardarRapidoBtn.addEventListener('click', guardarIngresoRapido);
            guardarEquipoBtn.addEventListener('click', guardarEquipo);
            imprimirTodosEquiposBtn.addEventListener('click', () => window.print());
            imprimirCalendarioBtn.addEventListener('click', () => window.print());

            // Filtros
            document.getElementById('filtro-equipo').addEventListener('change', cargarHistorialIngresos);
            document.getElementById('filtro-fecha').addEventListener('change', cargarHistorialIngresos);
            document.getElementById('filtro-equipo-depositos').addEventListener('change', cargarDepositosPorEquipo);
            document.getElementById('filtro-mes-calendario').addEventListener('change', generarCalendario);
            document.getElementById('filtro-equipo-calendario').addEventListener('change', generarCalendario);

            // Event listeners para navegación con ENTER
            equipoRapidoInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    nombreRapidoInput.focus();
                }
            });

            nombreRapidoInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    montoRapidoInput.focus();
                }
            });

            montoRapidoInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    guardarIngresoRapido();
                }
            });

            // Event listener para autocompletar nombre cuando se ingresa número de equipo
            equipoRapidoInput.addEventListener('change', function () {
                const numeroEquipo = parseInt(this.value);
                if (numeroEquipo > 0) {
                    const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    const equipo = equipos.find(e => e.numero === numeroEquipo);
                    if (equipo) {
                        nombreRapidoInput.value = equipo.nombre;
                    } else {
                        nombreRapidoInput.value = '';
                    }
                }
            });

            // Enfocar en el campo de equipo al cargar la página
            equipoRapidoInput.focus();

            // Función para inicializar la aplicación
            async function inicializarApp() {
                // Cargar datos desde Firebase
                await cargarDatosFirebase();

                // Cargar datos iniciales
                actualizarResumenEquiposSaldos();
                cargarListaEquipos();
                cargarHistorialIngresos();
            }

            // Función para cargar datos desde Firebase
            async function cargarDatosFirebase() {
                try {
                    // Cargar equipos
                    const equiposSnapshot = await db.collection('equipos').get();
                    const equipos = [];
                    equiposSnapshot.forEach(doc => {
                        const equipoData = doc.data();
                        // Formatear la placa al cargar
                        equipoData.placa = formatearPlaca(equipoData.placa);
                        equipos.push({ id: doc.id, ...equipoData });
                    });
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Cargar ingresos
                    const ingresosSnapshot = await db.collection('ingresos').get();
                    const ingresos = [];
                    ingresosSnapshot.forEach(doc => {
                        ingresos.push({ id: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                } catch (error) {
                    console.error("Error cargando datos desde Firebase:", error);
                    // Si no hay datos en Firebase, usar datos locales
                    if (!localStorage.getItem('equiposMototaxis')) {
                        localStorage.setItem('equiposMototaxis', JSON.stringify([]));
                    }
                    if (!localStorage.getItem('ingresosMototaxis')) {
                        localStorage.setItem('ingresosMototaxis', JSON.stringify([]));
                    }
                }
            }

            // Función para guardar datos en Firebase
            async function guardarEnFirebase(coleccion, datos, id = null) {
                try {
                    if (id) {
                        await db.collection(coleccion).doc(id.toString()).set(datos);
                    } else {
                        await db.collection(coleccion).add(datos);
                    }
                    return true;
                } catch (error) {
                    console.error("Error guardando en Firebase:", error);
                    return false;
                }
            }

            // Función para eliminar datos de Firebase
            async function eliminarDeFirebase(coleccion, id) {
                try {
                    await db.collection(coleccion).doc(id.toString()).delete();
                    return true;
                } catch (error) {
                    console.error("Error eliminando de Firebase:", error);
                    return false;
                }
            }

            // Función para guardar un nuevo equipo
            async function guardarEquipo() {
                const numero = parseInt(document.getElementById('numero-equipo').value) || 0;
                let placa = document.getElementById('placa').value.trim();
                const nombre = document.getElementById('nombre').value.trim();
                const dui = document.getElementById('dui').value.trim();

                // Validaciones mínimas - solo el número es obligatorio
                if (numero <= 0) {
                    alert('Por favor, ingrese un número de equipo válido.');
                    return;
                }

                // Formatear la placa (agregar M al inicio si no la tiene)
                placa = formatearPlaca(placa);

                // Obtener equipos actuales
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                // Verificar si ya existe el número de equipo
                if (equipos.some(equipo => equipo.numero === numero)) {
                    alert('Ya existe un equipo con ese número.');
                    return;
                }

                // Crear nuevo equipo
                const nuevoEquipo = {
                    numero: numero,
                    placa: placa || 'No registrada',
                    nombre: nombre || 'No registrado',
                    dui: dui || 'No registrado'
                };

                // Guardar equipo en Firebase
                const id = Date.now().toString();
                const exito = await guardarEnFirebase('equipos', nuevoEquipo, id);

                if (exito) {
                    // Guardar equipo localmente
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Actualizar interfaces
                    cargarListaEquipos();

                    // Limpiar formulario
                    document.getElementById('numero-equipo').value = '';
                    document.getElementById('placa').value = '';
                    document.getElementById('nombre').value = '';
                    document.getElementById('dui').value = '';

                    alert('Equipo registrado correctamente.');
                } else {
                    alert('Error al guardar el equipo. Los datos se guardarán localmente.');

                    // Guardar solo localmente si falla Firebase
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Actualizar interfaces
                    cargarListaEquipos();

                    // Limpiar formulario
                    document.getElementById('numero-equipo').value = '';
                    document.getElementById('placa').value = '';
                    document.getElementById('nombre').value = '';
                    document.getElementById('dui').value = '';
                }
            }

            // Función para cargar la lista de equipos
            function cargarListaEquipos() {
                const listaEquipos = document.getElementById('lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                if (equipos.length === 0) {
                    listaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados.</div>';
                    return;
                }

                let html = '';
                equipos.forEach(equipo => {
                    html += `
                        <div class="ingreso-item">
                            <div class="ingreso-equipo">Equipo ${equipo.numero}</div>
                            <div class="ingreso-cliente">${equipo.nombre}</div>
                            <div class="ingreso-info">Placa: ${equipo.placa} | DUI: ${equipo.dui}</div>
                            <button class="delete-btn" data-id="${equipo.id}">Eliminar</button>
                        </div>
                    `;
                });

                listaEquipos.innerHTML = html;

                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('#lista-equipos .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        eliminarEquipo(id);
                    });
                });
            }

            // Función para eliminar un equipo
            async function eliminarEquipo(id) {
                if (!confirm('¿Está seguro de eliminar este equipo?')) {
                    return;
                }

                // Eliminar de Firebase
                const exito = await eliminarDeFirebase('equipos', id);

                if (exito) {
                    // Eliminar localmente
                    let equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    equipos = equipos.filter(equipo => equipo.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Actualizar interfaz
                    cargarListaEquipos();

                    alert('Equipo eliminado correctamente.');
                } else {
                    alert('Error al eliminar el equipo. Se eliminará solo localmente.');

                    // Eliminar solo localmente si falla Firebase
                    let equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    equipos = equipos.filter(equipo => equipo.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Actualizar interfaz
                    cargarListaEquipos();
                }
            }

            // Función para guardar un ingreso rápido
            async function guardarIngresoRapido() {
                const fecha = document.getElementById('fecha').value;
                const numeroEquipo = parseInt(equipoRapidoInput.value) || 0;
                const nombre = nombreRapidoInput.value.trim();
                const monto = parseFloat(montoRapidoInput.value) || 0;
                const observacion = observacionRapidaInput.value.trim();

                // Validaciones
                if (numeroEquipo <= 0) {
                    alert('Por favor, ingrese un número de equipo válido.');
                    equipoRapidoInput.focus();
                    return;
                }

                if (nombre === '') {
                    alert('Por favor, ingrese el nombre del conductor.');
                    nombreRapidoInput.focus();
                    return;
                }

                if (monto <= 0) {
                    alert('Por favor, ingrese un monto válido.');
                    montoRapidoInput.focus();
                    return;
                }

                // Verificar si el equipo existe
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                let equipo = equipos.find(e => e.numero === numeroEquipo);

                // Si no existe, crear uno nuevo
                if (!equipo) {
                    const nuevoEquipo = {
                        numero: numeroEquipo,
                        placa: 'No registrada',
                        nombre: nombre,
                        dui: 'No registrado'
                    };

                    // Formatear la placa
                    nuevoEquipo.placa = formatearPlaca(nuevoEquipo.placa);

                    // Guardar equipo en Firebase
                    const id = Date.now().toString();
                    const exito = await guardarEnFirebase('equipos', nuevoEquipo, id);

                    if (exito) {
                        nuevoEquipo.id = id;
                        equipos.push(nuevoEquipo);
                        localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                        equipo = nuevoEquipo;
                    } else {
                        alert('Error al guardar el equipo. Los datos se guardarán localmente.');
                        nuevoEquipo.id = id;
                        equipos.push(nuevoEquipo);
                        localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                        equipo = nuevoEquipo;
                    }
                }

                // Crear nuevo ingreso
                const nuevoIngreso = {
                    fecha: fecha,
                    equipo: numeroEquipo,
                    nombre: equipo.nombre,
                    monto: monto,
                    observacion: observacion || 'Sin observación'
                };

                // Guardar ingreso en Firebase
                const idIngreso = Date.now().toString();
                const exitoIngreso = await guardarEnFirebase('ingresos', nuevoIngreso, idIngreso);

                if (exitoIngreso) {
                    // Guardar ingreso localmente
                    nuevoIngreso.id = idIngreso;
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos.push(nuevoIngreso);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Limpiar formulario
                    equipoRapidoInput.value = '';
                    nombreRapidoInput.value = '';
                    montoRapidoInput.value = '';
                    observacionRapidaInput.value = '';

                    // Actualizar resumen
                    actualizarResumenEquiposSaldos();

                    // Enfocar en el campo de equipo
                    equipoRapidoInput.focus();

                    alert('Ingreso registrado correctamente.');
                } else {
                    alert('Error al guardar el ingreso. Los datos se guardarán localmente.');

                    // Guardar solo localmente si falla Firebase
                    nuevoIngreso.id = idIngreso;
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos.push(nuevoIngreso);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Limpiar formulario
                    equipoRapidoInput.value = '';
                    nombreRapidoInput.value = '';
                    montoRapidoInput.value = '';
                    observacionRapidaInput.value = '';

                    // Actualizar resumen
                    actualizarResumenEquiposSaldos();

                    // Enfocar en el campo de equipo
                    equipoRapidoInput.focus();
                }
            }

            // Función para actualizar el resumen de equipos con saldo
            function actualizarResumenEquiposSaldos() {
                const resumenEquiposSaldos = document.getElementById('resumen-equipos-saldos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                if (equipos.length === 0) {
                    resumenEquiposSaldos.innerHTML = '<div class="empty-message">No hay equipos registrados.</div>';
                    return;
                }

                // Calcular total por equipo
                const totalesPorEquipo = {};
                const ultimaFechaPorEquipo = {};

                ingresos.forEach(ingreso => {
                    const equipo = ingreso.equipo;
                    if (!totalesPorEquipo[equipo]) {
                        totalesPorEquipo[equipo] = 0;
                    }
                    totalesPorEquipo[equipo] += ingreso.monto;

                    // Guardar la última fecha de ingreso
                    if (!ultimaFechaPorEquipo[equipo] || ingreso.fecha > ultimaFechaPorEquipo[equipo]) {
                        ultimaFechaPorEquipo[equipo] = ingreso.fecha;
                    }
                });

                // Ordenar equipos por número
                equipos.sort((a, b) => a.numero - b.numero);

                let html = '';
                equipos.forEach(equipo => {
                    const total = totalesPorEquipo[equipo.numero] || 0;
                    const ultimaFecha = ultimaFechaPorEquipo[equipo.numero] || 'Sin registros';

                    html += `
                        <div class="equipo-saldo-card">
                            <div class="equipo-saldo-header">
                                <div class="equipo-saldo-numero">Equipo ${equipo.numero}</div>
                                <div class="equipo-saldo-total">$${total.toFixed(2)}</div>
                            </div>
                            <div class="equipo-saldo-info">${equipo.nombre}</div>
                            <div class="equipo-saldo-fecha">Último: ${formatearFecha(ultimaFecha)}</div>
                        </div>
                    `;
                });

                resumenEquiposSaldos.innerHTML = html;
            }

            // Función para cargar el historial de ingresos
            function cargarHistorialIngresos() {
                const historialIngresos = document.getElementById('historial-ingresos');
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                if (ingresos.length === 0) {
                    historialIngresos.innerHTML = '<div class="empty-message">No hay ingresos registrados.</div>';
                    return;
                }

                // Aplicar filtros
                let ingresosFiltrados = [...ingresos];
                const filtroEquipo = document.getElementById('filtro-equipo').value;
                const filtroFecha = document.getElementById('filtro-fecha').value;

                if (filtroEquipo) {
                    ingresosFiltrados = ingresosFiltrados.filter(ingreso => ingreso.equipo == filtroEquipo);
                }

                if (filtroFecha) {
                    ingresosFiltrados = ingresosFiltrados.filter(ingreso => ingreso.fecha.startsWith(filtroFecha));
                }

                // Ordenar por fecha (más reciente primero)
                ingresosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                if (ingresosFiltrados.length === 0) {
                    historialIngresos.innerHTML = '<div class="empty-message">No hay ingresos que coincidan con los filtros.</div>';
                    return;
                }

                let html = '';
                let totalGeneral = 0;

                ingresosFiltrados.forEach(ingreso => {
                    totalGeneral += ingreso.monto;

                    html += `
                        <div class="ingreso-item">
                            <div class="ingreso-fecha">${formatearFecha(ingreso.fecha)}</div>
                            <div class="ingreso-equipo">Equipo ${ingreso.equipo}</div>
                            <div class="ingreso-cliente">${ingreso.nombre}</div>
                            <div class="ingreso-monto">$${ingreso.monto.toFixed(2)}</div>
                            <div class="ingreso-info">${ingreso.observacion}</div>
                            <button class="edit-btn" data-id="${ingreso.id}">Editar</button>
                            <button class="delete-btn" data-id="${ingreso.id}">Eliminar</button>
                        </div>
                    `;
                });

                // Agregar total general
                html += `
                    <div class="total-general">
                        Total General: $${totalGeneral.toFixed(2)}
                    </div>
                `;

                historialIngresos.innerHTML = html;

                // Agregar event listeners a los botones de eliminar y editar
                document.querySelectorAll('#historial-ingresos .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        eliminarIngreso(id);
                    });
                });

                document.querySelectorAll('#historial-ingresos .edit-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        editarIngreso(id);
                    });
                });
            }

            // Función para eliminar un ingreso
            async function eliminarIngreso(id) {
                if (!confirm('¿Está seguro de eliminar este ingreso?')) {
                    return;
                }

                // Eliminar de Firebase
                const exito = await eliminarDeFirebase('ingresos', id);

                if (exito) {
                    // Eliminar localmente
                    let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Actualizar interfaces
                    cargarHistorialIngresos();
                    actualizarResumenEquiposSaldos();

                    alert('Ingreso eliminado correctamente.');
                } else {
                    alert('Error al eliminar el ingreso. Se eliminará solo localmente.');

                    // Eliminar solo localmente si falla Firebase
                    let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Actualizar interfaces
                    cargarHistorialIngresos();
                    actualizarResumenEquiposSaldos();
                }
            }

            // Función para editar un ingreso (placeholder)
            function editarIngreso(id) {
                alert('Funcionalidad de edición en desarrollo.');
                // Aquí se implementaría la lógica para editar un ingreso
            }

            // Función para cargar depósitos por equipo
            function cargarDepositosPorEquipo() {
                const depositosListaEquipos = document.getElementById('depositos-lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                if (equipos.length === 0) {
                    depositosListaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados.</div>';
                    return;
                }

                // Aplicar filtro de equipo
                const filtroEquipo = document.getElementById('filtro-equipo-depositos').value;
                let equiposFiltrados = [...equipos];

                if (filtroEquipo) {
                    equiposFiltrados = equiposFiltrados.filter(equipo => equipo.numero == filtroEquipo);
                }

                // Ordenar equipos por número
                equiposFiltrados.sort((a, b) => a.numero - b.numero);

                let html = '';

                equiposFiltrados.forEach(equipo => {
                    // Filtrar ingresos por equipo
                    const ingresosEquipo = ingresos.filter(ingreso => ingreso.equipo === equipo.numero);

                    if (ingresosEquipo.length === 0) {
                        return; // No mostrar equipos sin ingresos
                    }

                    // Calcular total del equipo
                    const totalEquipo = ingresosEquipo.reduce((sum, ingreso) => sum + ingreso.monto, 0);

                    // Ordenar ingresos por fecha (más reciente primero)
                    ingresosEquipo.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                    let ingresosHtml = '';
                    ingresosEquipo.forEach(ingreso => {
                        ingresosHtml += `
                            <div class="deposito-item">
                                <div class="deposito-fecha">${formatearFecha(ingreso.fecha)}</div>
                                <div class="deposito-monto">$${ingreso.monto.toFixed(2)}</div>
                            </div>
                        `;
                    });

                    html += `
                        <div class="deposito-equipo-card">
                            <div class="deposito-equipo-header">
                                <div class="deposito-equipo-numero">Equipo ${equipo.numero}</div>
                                <div class="deposito-equipo-total">$${totalEquipo.toFixed(2)}</div>
                            </div>
                            <div class="deposito-equipo-info">${equipo.nombre} - ${equipo.placa}</div>
                            ${ingresosHtml}
                            <div class="deposito-total">Total: $${totalEquipo.toFixed(2)}</div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = '<div class="empty-message">No hay ingresos registrados para los equipos seleccionados.</div>';
                }

                depositosListaEquipos.innerHTML = html;
            }

            // Función para actualizar los filtros de equipos
            function actualizarFiltroEquipos(idFiltro) {
                const filtro = document.getElementById(idFiltro);
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                // Limpiar opciones actuales (excepto la primera)
                while (filtro.options.length > 1) {
                    filtro.remove(1);
                }

                // Ordenar equipos por número
                equipos.sort((a, b) => a.numero - b.numero);

                // Agregar opciones de equipos
                equipos.forEach(equipo => {
                    const option = document.createElement('option');
                    option.value = equipo.numero;
                    option.textContent = `Equipo ${equipo.numero} - ${equipo.nombre}`;
                    filtro.appendChild(option);
                });
            }

            // Función para generar el calendario mensual
            function generarCalendario() {
                const calendarioPreview = document.getElementById('calendario-preview');
                const calendarioPrint = document.getElementById('calendario-print');
                const filtroMes = document.getElementById('filtro-mes-calendario').value;
                const filtroEquipo = document.getElementById('filtro-equipo-calendario').value;

                if (!filtroMes) {
                    calendarioPreview.innerHTML = '<div class="empty-message">Seleccione un mes para generar el calendario.</div>';
                    calendarioPrint.innerHTML = '';
                    return;
                }

                const [año, mes] = filtroMes.split('-').map(Number);
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                // Obtener información del equipo seleccionado
                let equipoSeleccionado = null;
                if (filtroEquipo) {
                    equipoSeleccionado = equipos.find(e => e.numero == filtroEquipo);
                }

                // Filtrar ingresos por mes y equipo si es necesario
                let ingresosFiltrados = ingresos.filter(ingreso => {
                    const [ingresoAño, ingresoMes] = ingreso.fecha.split('-').map(Number);
                    return ingresoAño === año && ingresoMes === mes;
                });

                if (filtroEquipo) {
                    ingresosFiltrados = ingresosFiltrados.filter(ingreso => ingreso.equipo == filtroEquipo);
                }

                // Crear objeto para agrupar ingresos por día
                const ingresosPorDia = {};
                ingresosFiltrados.forEach(ingreso => {
                    const dia = parseInt(ingreso.fecha.split('-')[2]);
                    if (!ingresosPorDia[dia]) {
                        ingresosPorDia[dia] = [];
                    }
                    ingresosPorDia[dia].push(ingreso);
                });

                // Obtener el primer día del mes y el número de días
                const primerDia = new Date(año, mes - 1, 1);
                const ultimoDia = new Date(año, mes, 0);
                const diasEnMes = ultimoDia.getDate();
                const diaInicio = primerDia.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = Sábado

                // Nombres de los meses
                const nombresMeses = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];

                // Calcular total general (solo de días que no son descanso)
                let totalGeneral = 0;
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    if (!diasDescansoSeleccionados.includes(dia)) {
                        const ingresosDia = ingresosPorDia[dia] || [];
                        const totalDia = ingresosDia.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                        totalGeneral += totalDia;
                    }
                }

                // Generar HTML del calendario para vista previa
                let htmlPreview = `
                    <table class="tabla-calendario-preview">
                        <thead>
                            <tr>
                                <th>Domingo</th>
                                <th>Lunes</th>
                                <th>Martes</th>
                                <th>Miércoles</th>
                                <th>Jueves</th>
                                <th>Viernes</th>
                                <th>Sábado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Generar celdas del calendario para vista previa
                let diaActual = 1;
                for (let i = 0; i < 6; i++) { // Máximo 6 filas
                    htmlPreview += '<tr>';

                    for (let j = 0; j < 7; j++) { // 7 días por semana
                        if ((i === 0 && j < diaInicio) || diaActual > diasEnMes) {
                            // Celda vacía
                            htmlPreview += '<td></td>';
                        } else {
                            const ingresosDia = ingresosPorDia[diaActual] || [];
                            const totalDia = ingresosDia.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                            const comentarios = ingresosDia.map(ingreso =>
                                ingreso.observacion && ingreso.observacion !== 'Sin observación' ? ingreso.observacion : ''
                            ).filter(c => c !== '').join(', ');

                            const esDescanso = diasDescansoSeleccionados.includes(diaActual);

                            htmlPreview += `
                                <td class="${esDescanso ? 'dia-descanso-preview' : ''}" data-dia="${diaActual}">
                                    <div class="cuadro-dia-preview">
                                        <div class="dia-numero-preview">${diaActual}</div>
                                        ${esDescanso ? `<div class="dia-monto-preview">$0</div>` : 
                                          totalDia > 0 ? `<div class="dia-monto-preview">$${totalDia.toFixed(2)}</div>` : ''}
                                        ${!esDescanso && comentarios ? `<div class="dia-comentario-preview">${comentarios}</div>` : ''}
                                    </div>
                                </td>
                            `;
                            diaActual++;
                        }
                    }

                    htmlPreview += '</tr>';

                    // Si ya hemos completado todos los días, salir del bucle
                    if (diaActual > diasEnMes) break;
                }

                htmlPreview += `
                        </tbody>
                    </table>
                `;

                calendarioPreview.innerHTML = htmlPreview;

                // Agregar event listeners a las celdas del calendario
                document.querySelectorAll('.tabla-calendario-preview td[data-dia]').forEach(celda => {
                    celda.addEventListener('click', function () {
                        const dia = parseInt(this.getAttribute('data-dia'));
                        if (diasDescansoSeleccionados.includes(dia)) {
                            diasDescansoSeleccionados = diasDescansoSeleccionados.filter(d => d !== dia);
                        } else {
                            diasDescansoSeleccionados.push(dia);
                        }
                        generarCalendario();
                    });
                });

                // Generar HTML del calendario para impresión
                let htmlPrint = `
                    <div class="calendario-mensual">
                        <div class="encabezado-recibo">
                            <h1>RECIBO DE INGRESO EN CONCEPTO DE TRANSPORTE PÚBLICO ALTERNATIVO</h1>
                            <div class="info-mes">MES: ${nombresMeses[mes - 1]} AÑO: ${año}</div>
                        </div>
                `;

                // Agregar información del equipo si está seleccionado
                if (equipoSeleccionado) {
                    htmlPrint += `
                        <div class="info-equipo">
                            <div>Nombre: ${equipoSeleccionado.nombre}</div>
                            <div>DUI: ${equipoSeleccionado.dui}</div>
                            <div>Placas: ${equipoSeleccionado.placa}</div>
                        </div>
                    `;
                }

                htmlPrint += `
                        <table class="tabla-calendario">
                            <thead>
                                <tr>
                                    <th>Domingo</th>
                                    <th>Lunes</th>
                                    <th>Martes</th>
                                    <th>Miércoles</th>
                                    <th>Jueves</th>
                                    <th>Viernes</th>
                                    <th>Sábado</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Generar celdas del calendario para impresión
                diaActual = 1;
                for (let i = 0; i < 6; i++) { // Máximo 6 filas
                    htmlPrint += '<tr>';

                    for (let j = 0; j < 7; j++) { // 7 días por semana
                        if ((i === 0 && j < diaInicio) || diaActual > diasEnMes) {
                            // Celda vacía
                            htmlPrint += '<td></td>';
                        } else {
                            const ingresosDia = ingresosPorDia[diaActual] || [];
                            const totalDia = ingresosDia.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                            const comentarios = ingresosDia.map(ingreso =>
                                ingreso.observacion && ingreso.observacion !== 'Sin observación' ? ingreso.observacion : ''
                            ).filter(c => c !== '').join(', ');

                            const esDescanso = diasDescansoSeleccionados.includes(diaActual);

                            htmlPrint += `
                                <td class="${esDescanso ? 'dia-descanso' : ''}">
                                    <div class="cuadro-dia">
                                        <div class="dia-numero">${diaActual}</div>
                                        ${esDescanso ? `<div class="dia-monto">$0</div>` : 
                                          totalDia > 0 ? `<div class="dia-monto">$${totalDia.toFixed(2)}</div>` : ''}
                                        ${!esDescanso && comentarios ? `<div class="dia-comentario">${comentarios}</div>` : ''}
                                    </div>
                                </td>
                            `;
                            diaActual++;
                        }
                    }

                    htmlPrint += '</tr>';

                    // Si ya hemos completado todos los días, salir del bucle
                    if (diaActual > diasEnMes) break;
                }

                htmlPrint += `
                            </tbody>
                        </table>
                        
                        <div class="pie-pagina">
                            <div class="total-general-print">TOTAL: $${totalGeneral.toFixed(2)}</div>
                            <div class="firma">FIRMA</div>
                        </div>
                    </div>
                `;

                calendarioPrint.innerHTML = htmlPrint;
            }
        });
    </script>
</body>
</html>
