// Estado global de la aplicación
const AppState = {
    cart: [],
    searchResults: []
};

// Servicio de UI
const UIService = {
    updateCartDisplay() {
        const cartItems = document.getElementById('cart-items');
        const totalAmount = document.getElementById('total-amount');
        
        if (AppState.cart.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-basket" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <div>Carrito vacío</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; color: var(--text-muted);">Los productos agregados aparecerán aquí</div>
                </div>
            `;
            totalAmount.textContent = 'TOTAL: $0.00';
            return;
        }
        
        let total = 0;
        let itemsHTML = '';
        
        AppState.cart.forEach((item, index) => {
            const itemTotal = item.precio * item.cantidad;
            total += itemTotal;
            
            const tienePrecioCero = item.precio === 0;
            
            itemsHTML += `
                <div class="cart-item">
                    <div>
                        <input type="number" class="quantity-input" value="${item.cantidad}" 
                               min="1" data-index="${index}" onchange="SalesService.updateQuantity(${index}, this.value)">
                    </div>
                    <div class="product-desc">${item.descripcion}</div>
                    <div>
                        <input type="number" class="price-input ${tienePrecioCero ? 'price-warning' : ''}" value="${item.precio.toFixed(2)}" 
                               step="0.01" min="0" data-index="${index}" onchange="SalesService.updatePrice(${index}, this.value)">
                    </div>
                    <div class="subtotal">$${itemTotal.toFixed(2)}</div>
                    <div class="cart-actions">
                        <button class="delete-item-btn" onclick="SalesService.removeFromCart(${index})" title="Eliminar producto">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        cartItems.innerHTML = itemsHTML;
        totalAmount.textContent = `TOTAL: $${total.toFixed(2)}`;
    },

    showStatus(message, type = 'info') {
        alert(message); // Simple alert por ahora
    }
};

// Servicio de Ventas
const SalesService = {
    addToCart(product) {
        const cartItem = {
            id: product.id,
            codigo: product.codigo || 'MANUAL',
            descripcion: product.descripcion || 'Sin descripción',
            precio: product.precio || 0,
            cantidad: 1
        };
        
        AppState.cart.push(cartItem);
        UIService.updateCartDisplay();
        UIService.showStatus("Producto agregado al carrito", "success");
    },

    addManualProduct(descripcion) {
        if (!descripcion.trim()) {
            UIService.showStatus("Ingrese una descripción para el producto", "error");
            return;
        }
        
        this.addToCart({
            id: 'manual-' + Date.now(),
            codigo: 'MANUAL',
            descripcion: descripcion,
            precio: 0,
            cantidad: 1
        });
    },

    removeFromCart(index) {
        AppState.cart.splice(index, 1);
        UIService.updateCartDisplay();
        UIService.showStatus("Producto eliminado del carrito", "info");
    },

    updateQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity) || 1;
        if (quantity < 1) {
            UIService.showStatus("La cantidad debe ser al menos 1", "error");
            AppState.cart[index].cantidad = 1;
        } else {
            AppState.cart[index].cantidad = quantity;
        }
        UIService.updateCartDisplay();
    },

    updatePrice(index, newPrice) {
        const price = parseFloat(newPrice) || 0;
        if (price < 0) {
            UIService.showStatus("El precio no puede ser negativo", "error");
            AppState.cart[index].precio = 0;
        } else {
            AppState.cart[index].precio = price;
        }
        UIService.updateCartDisplay();
    },

    async processSale(paymentType) {
        if (AppState.cart.length === 0) {
            UIService.showStatus("El carrito está vacío", "error");
            return;
        }
        
        const equipo = document.getElementById('equipo').value.trim();
        const ciudad = document.getElementById('ciudad').value;
        const cliente = document.getElementById('cliente').value.trim();
        
        try {
            // Validaciones básicas
            if (!equipo) {
                throw new Error("El número de equipo es obligatorio");
            }
            
            if (!/^\d+$/.test(equipo)) {
                throw new Error("El número de equipo debe contener solo números");
            }
            
            const productosConPrecioCero = AppState.cart.filter(item => item.precio === 0);
            if (productosConPrecioCero.length > 0) {
                throw new Error("Hay productos con precio $0.00. Modifique los precios antes de guardar.");
            }
            
            const totalVenta = AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            // Simular procesamiento de venta
            UIService.showStatus(`Procesando venta ${paymentType} por $${totalVenta.toFixed(2)}...`, "success");
            
            // Aquí iría la lógica real de guardado en Firebase
            console.log('Datos de venta:', {
                equipo,
                ciudad,
                cliente,
                productos: AppState.cart,
                total: totalVenta,
                tipo: paymentType
            });
            
            // Limpiar carrito después de la venta
            AppState.cart = [];
            UIService.updateCartDisplay();
            document.getElementById('equipo').value = '';
            document.getElementById('cliente').value = '';
            document.getElementById('buscar-producto').value = '';
            
        } catch (error) {
            UIService.showStatus("Error al procesar la venta: " + error.message, "error");
        }
    }
};

// Inicialización de la aplicación
const App = {
    init() {
        this.setupUI();
        this.setupEventListeners();
        UIService.showStatus("Sistema de ventas listo", "success");
    },

    setupUI() {
        // Configurar tema
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const icon = themeToggle.querySelector('i');
        
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.className = savedTheme;
            this.updateThemeIcon(savedTheme, icon);
        }
        
        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('theme-light')) {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                localStorage.setItem('theme', 'theme-dark');
            } else {
                body.classList.remove('theme-dark');
                body.classList.add('theme-light');
                localStorage.setItem('theme', 'theme-light');
            }
            this.updateThemeIcon(body.className, icon);
        });
    },

    updateThemeIcon(theme, icon) {
        if (theme === 'theme-dark') {
            icon.className = 'fas fa-sun';
        } else {
            icon.className = 'fas fa-moon';
        }
    },

    setupEventListeners() {
        // Búsqueda de productos
        const searchInput = document.getElementById('buscar-producto');
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query) {
                    SalesService.addManualProduct(query);
                    searchInput.value = '';
                }
            }
        });

        // Validación de equipo
        document.getElementById('equipo').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            if (e.target.value.length > 4) {
                e.target.value = e.target.value.substring(0, 4);
            }
        });

        // Botones de venta
        document.getElementById('contado-btn').addEventListener('click', () => {
            SalesService.processSale('contado');
        });

        document.getElementById('pendiente-btn').addEventListener('click', () => {
            SalesService.processSale('pendiente');
        });

        // Botones de acceso rápido
        document.getElementById('historial-btn').addEventListener('click', () => {
            UIService.showStatus("Acceso a Historial de Ventas - Función en desarrollo", "info");
        });

        document.getElementById('pendientes-grupos-btn').addEventListener('click', () => {
            UIService.showStatus("Acceso a Facturas Pendientes y Grupos - Función en desarrollo", "info");
        });
    }
};

// Inicializar la aplicación cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    App.init();
});
