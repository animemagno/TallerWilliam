<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avanzado de Ventas - Taller Wilian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #eef2f5;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 12px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .header-info {
            font-size: 0.75rem;
            opacity: 0.9;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            height: fit-content;
        }

        .dashboard-section.full-width {
            grid-column: 1 / -1;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .fecha-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .fecha-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .venta-header {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 5px;
        }

        .form-group.equipo-group {
            flex: 0 0 100px;
        }

        .form-group.grupo-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #333;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-container {
            position: relative;
        }

        .search-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            display: none;
        }

        .search-dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.2s;
        }

        .search-dropdown-item:hover {
            background-color: #3498db;
            color: white;
        }

        /* CARRITO CON SCROLL */
        .cart-container {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .cart-items-container {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            margin-bottom: 10px;
        }

        .cart-header {
            display: grid;
            grid-template-columns: 80px 1fr 100px 100px 80px;
            gap: 10px;
            padding: 8px 12px;
            background: #2c3e50;
            color: white;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 80px 1fr 100px 100px 80px;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            border: 1px solid #e9ecef;
            align-items: center;
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .cart-item:last-child {
            margin-bottom: 0;
        }

        .quantity-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8rem;
            -moz-appearance: textfield;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .price-input {
            width: 90px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8rem;
        }

        .product-desc {
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .subtotal {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85rem;
        }

        .cart-actions {
            display: flex;
            gap: 4px;
        }

        .cart-total {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 2px solid #3498db;
            margin-top: auto;
        }

        .empty-cart {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 30px;
            background: white;
            border-radius: 4px;
            border: 2px dashed #ddd;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d35400;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.85rem;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            margin: 2px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 28px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin: 0 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 28px;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .btn-view {
            background-color: #3498db;
            color: white;
        }

        .btn-view:hover {
            background-color: #2980b9;
        }

        .btn-reprint {
            background-color: #f39c12;
            color: white;
        }

        .btn-reprint:hover {
            background-color: #d35400;
        }

        .btn-edit {
            background-color: #27ae60;
            color: white;
        }

        .btn-edit:hover {
            background-color: #219a52;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-abono {
            background-color: #17a2b8;
            color: white;
        }

        .btn-abono:hover {
            background-color: #138496;
        }

        .btn-cancel {
            background-color: #9b59b6;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #8e44ad;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.8rem;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .history-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .history-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .invoice-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .edit-mode {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .abono-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }

        .abono-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .saldo-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .historial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .filter-btn:hover {
            background: #2980b9;
            color: white;
            border-color: #2980b9;
        }

        .cache-info {
            background: #e8f4fd;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-align: center;
            border-left: 3px solid #3498db;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .contado-badge {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .pendiente-badge {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .total-display {
            font-weight: bold;
        }
        
        .saldo-pendiente-rojo {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .saldo-pendiente-negro {
            color: #333;
            font-weight: bold;
        }
        
        .cliente-equipo {
            font-weight: bold;
        }
        
        .cliente-nombre {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .historial-actions-container {
            min-width: 240px;
        }

        .delete-item-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .delete-item-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .refresh-cache-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
            color: #2c3e50;
        }

        .refresh-cache-btn:hover {
            background: #3498db;
            color: white;
            transform: scale(1.1);
        }

        /* PESTAÑAS FACTURAS PENDIENTES */
        .tabs-container {
            margin-top: 10px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #3498db;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: white;
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .facturas-pendientes-container {
            margin-top: 15px;
        }

        .facturas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .facturas-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .equipos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .equipo-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 80px;
        }

        .equipo-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            border-color: #2980b9;
        }

        .equipo-number {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            line-height: 1;
        }

        .equipo-nombre {
            font-size: 0.7rem;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 3px;
            line-height: 1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .equipo-total {
            font-size: 0.8rem;
            font-weight: bold;
            color: #27ae60;
            line-height: 1;
        }

        .grupos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .grupo-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .grupo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #3498db;
        }

        .grupo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .grupo-name {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .grupo-actions {
            display: flex;
            gap: 5px;
        }

        .grupo-equipos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            justify-content: flex-start;
        }

        .grupo-total {
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #2c3e50;
            padding: 8px;
            background: #e8f4fd;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        /* SECCIÓN GRUPOS - GESTIÓN */
        .grupos-management {
            padding: 15px;
        }

        .grupos-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .grupos-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background: #f8f9fa;
        }

        .grupo-management-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grupo-management-info {
            flex: 1;
        }

        .grupo-management-name {
            font-weight: bold;
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .grupo-management-details {
            font-size: 0.8rem;
            color: #666;
        }

        .grupo-management-actions {
            display: flex;
            gap: 5px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .create-grupo-modal {
            max-width: 400px;
        }

        .equipos-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .equipo-selection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .equipo-selection-item:hover {
            background: #f8f9fa;
        }

        .equipo-selection-item.selected {
            background: #3498db;
            color: white;
        }

        .selected-equipos {
            margin: 10px 0;
            padding: 8px;
            background: #e8f4fd;
            border-radius: 4px;
            min-height: 40px;
            font-size: 0.85rem;
        }

        .selected-equipo-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            margin: 2px;
            font-size: 0.75rem;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 30px 20px;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .detalle-equipo {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .factura-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin: 6px 0;
            border-left: 3px solid #3498db;
            font-size: 0.85rem;
        }

        .producto-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.8rem;
        }

        .grupo-facturas {
            margin-top: 8px;
        }

        .all-equipos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
        }

        .all-equipo-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            width: 80px;
        }

        .all-equipo-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .all-equipo-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .edit-grupo-modal {
            max-width: 500px;
        }

        .grupo-detalle-equipo {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #3498db;
        }

        .grupo-detalle-factura {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin: 6px 0;
            border: 1px solid #e0e0e0;
        }

        .grupo-resumen {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2c3e50;
            font-weight: bold;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 10001;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }

        .connection-status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .price-warning {
            border: 2px solid #e74c3c !important;
            background-color: #fdf2f2 !important;
        }

        .date-warning {
            border: 2px solid #f39c12 !important;
            background-color: #fef9e7 !important;
        }
    </style>
</head>
<body>
    <div class="status" id="status-message"></div>
    <div class="connection-status" id="connection-status"></div>
    
    <div class="container">
        <header>
            <h1>Sistema Avanzado de Ventas - OPTIMIZADO</h1>
            <div class="header-info">
                <span>Taller Wilian - <span id="current-date"></span></span>
                <div class="cache-info" id="cache-info" style="display: none;">
                    <span><i class="fas fa-database"></i> Cache activo: <span id="cache-count">0</span> productos</span>
                    <button class="refresh-cache-btn" id="refresh-cache-btn" title="Actualizar cache">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-section">
                <h2 class="section-title">
                    NUEVA VENTA
                    <div class="fecha-control">
                        <label for="fecha-venta">Fecha:</label>
                        <input type="date" id="fecha-venta" class="fecha-input">
                    </div>
                </h2>
                
                <div class="venta-header">
                    <div class="form-group equipo-group">
                        <label for="equipo">Equipo *</label>
                        <input type="text" id="equipo" placeholder="Número" maxlength="4" required>
                    </div>

                    <div class="form-group grupo-group">
                        <label for="cliente">Grupo</label>
                        <input type="text" id="cliente" placeholder="Nombre del grupo">
                    </div>
                </div>

                <div class="form-group">
                    <label for="buscar-producto">Buscar Producto</label>
                    <div class="search-container">
                        <input type="text" id="buscar-producto" placeholder="Código, descripción o formato: 3 pernos de culata $3">
                        <div id="search-dropdown" class="search-dropdown"></div>
                    </div>
                </div>

                <div class="cart-container" id="cart-container">
                    <div class="cart-header">
                        <div>CANT</div>
                        <div>DESCRIPCIÓN</div>
                        <div>PRECIO UNIT.</div>
                        <div>SUBTOTAL</div>
                        <div>ACCIÓN</div>
                    </div>
                    <div class="cart-items-container" id="cart-items">
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <div>No hay productos agregados</div>
                        </div>
                    </div>
                    <div class="cart-total" id="total-amount">
                        TOTAL: $0.00
                    </div>
                </div>

                <div class="payment-buttons">
                    <button class="btn btn-success" id="contado-btn">
                        GUARDAR CONTADO
                    </button>
                    <button class="btn btn-warning" id="pendiente-btn">
                        GUARDAR PENDIENTE
                    </button>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title">
                    Facturas Pendientes
                </h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="facturas">FACTURAS PENDIENTES</button>
                        <button class="tab-btn" data-tab="grupos">GRUPO</button>
                    </div>
                    
                    <div class="tab-content active" id="tab-facturas">
                        <div class="facturas-pendientes-container" id="facturas-pendientes-container">
                            <div class="equipos-container">
                                <div id="equipos-individuales" class="equipos-grid">
                                </div>
                                
                                <div id="empty-equipos" class="empty-state" style="display: none;">
                                    <i class="fas fa-cube"></i>
                                    <div>No hay facturas pendientes</div>
                                    <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Las ventas pendientes aparecerán aquí</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-grupos">
                        <div class="grupos-management">
                            <div class="grupos-actions">
                                <button class="btn btn-success" id="crear-grupo-btn">
                                    <i class="fas fa-plus"></i> CREAR GRUPO
                                </button>
                            </div>
                            
                            <div class="grupos-list" id="grupos-list">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <div>No hay grupos creados</div>
                                    <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Crea tu primer grupo para organizar los equipos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section full-width">
                <h2 class="section-title">HISTORIAL DE VENTAS (Últimas 500)</h2>
                
                <div class="historial-actions">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="todo">TODO</button>
                        <button class="filter-btn" data-filter="hoy">HOY</button>
                        <button class="filter-btn" data-filter="ventas">VENTAS</button>
                        <button class="filter-btn" data-filter="abonos">ABONOS</button>
                        <button class="filter-btn" data-filter="pendientes">PENDIENTES</button>
                    </div>
                    <button class="btn btn-info" id="print-historial-btn">
                        IMPRIMIR HISTORIAL
                    </button>
                </div>
                
                <div class="form-group">
                    <input type="text" id="filter-historial" placeholder="Filtrar por número de equipo...">
                </div>
                
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Factura</th>
                            <th>Equipo</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th width="250">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historial-body">
                        <tr>
                            <td colspan="6" class="empty-cart">Cargando historial...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal para detalles de equipo -->
        <div class="modal-overlay" id="detalle-modal">
            <div class="modal-content">
                <div id="detalle-modal-content"></div>
                <button class="btn btn-primary" id="close-detalle-modal" style="margin-top: 15px; width: 100%;">CERRAR</button>
                <button class="btn btn-success" id="imprimir-detalle-modal" style="margin-top: 10px; width: 100%;">IMPRIMIR</button>
            </div>
        </div>

        <!-- Modal para detalles de grupo -->
        <div class="modal-overlay" id="grupo-detalle-modal">
            <div class="modal-content">
                <div id="grupo-detalle-modal-content"></div>
                <button class="btn btn-primary" id="close-grupo-detalle-modal" style="margin-top: 15px; width: 100%;">CERRAR</button>
                <button class="btn btn-success" id="imprimir-grupo-detalle-modal" style="margin-top: 10px; width: 100%;">IMPRIMIR GRUPO</button>
            </div>
        </div>

        <!-- Modal para crear grupo -->
        <div class="modal-overlay" id="crear-grupo-modal">
            <div class="modal-content create-grupo-modal">
                <h3 style="margin-bottom: 15px; text-align: center;">Crear Nuevo Grupo</h3>
                <div class="form-group">
                    <label for="nombre-grupo">Nombre del Grupo:</label>
                    <input type="text" id="nombre-grupo" placeholder="Ej: Grupo A" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Equipos (Máx. 130):</label>
                    <div class="all-equipos-grid" id="all-equipos-grid">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Equipos Seleccionados: (<span id="contador-equipos">0</span>/130)</label>
                    <div class="selected-equipos" id="selected-equipos-list">
                        <div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos seleccionados</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" id="guardar-grupo-btn" style="flex: 1;">CREAR GRUPO</button>
                    <button class="btn btn-danger" id="cancelar-grupo-btn" style="flex: 1;">CANCELAR</button>
                </div>
            </div>
        </div>

        <!-- Modal para editar grupo -->
        <div class="modal-overlay" id="editar-grupo-modal">
            <div class="modal-content edit-grupo-modal">
                <h3 style="margin-bottom: 15px; text-align: center;">Editar Grupo</h3>
                <div class="form-group">
                    <label for="editar-nombre-grupo">Nombre del Grupo:</label>
                    <input type="text" id="editar-nombre-grupo" placeholder="Ej: Grupo A" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Equipos (Máx. 130):</label>
                    <div class="all-equipos-grid" id="editar-all-equipos-grid">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Equipos Seleccionados: (<span id="editar-contador-equipos">0</span>/130)</label>
                    <div class="selected-equipos" id="editar-selected-equipos-list">
                        <div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos seleccionados</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" id="actualizar-grupo-btn" style="flex: 1;">ACTUALIZAR GRUPO</button>
                    <button class="btn btn-danger" id="cancelar-editar-grupo-btn" style="flex: 1;">CANCELAR</button>
                </div>
            </div>
        </div>

        <!-- Modal para ver factura -->
        <div id="invoice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div id="invoice-modal-content"></div>
                <button class="btn btn-primary" id="close-invoice-modal" style="margin-top: 15px; width: 100%;">CERRAR</button>
            </div>
        </div>

        <!-- Modal para abonos -->
        <div id="abono-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
                <h3 style="margin-bottom: 15px; text-align: center;">Registrar Abono</h3>
                <div id="abono-modal-content"></div>
                <div class="form-group">
                    <label for="monto-abono">Monto del Abono:</label>
                    <input type="number" id="monto-abono" step="0.01" min="0.01" placeholder="0.00">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" id="process-abono-btn" style="flex: 1;">PROCESAR ABONO</button>
                    <button class="btn btn-danger" id="close-abono-modal" style="flex: 1;">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
                authDomain: "tallerwilliam-732b3.firebaseapp.com",
                projectId: "tallerwilliam-732b3",
                storageBucket: "tallerwilliam-732b3.firebasestorage.app",
                messagingSenderId: "822262666247",
                appId: "1:822262666247:web:6680487bbf1108006b86a2"
            }
        };

        // ========== CONEXIÓN Y MONITOREO ==========
        const ConnectionManager = {
            isOnline: true,
            
            initialize() {
                this.checkConnection();
                setInterval(() => this.checkConnection(), 30000); // Verificar cada 30 segundos
                
                // Monitorear eventos de conexión del navegador
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
            },
            
            async checkConnection() {
                try {
                    // Intentar una operación simple de Firestore
                    if (AppState.firebaseInitialized) {
                        await AppState.db.collection("VENTAS").limit(1).get();
                        this.handleOnline();
                    } else {
                        this.handleOffline();
                    }
                } catch (error) {
                    this.handleOffline();
                }
            },
            
            handleOnline() {
                if (!this.isOnline) {
                    this.isOnline = true;
                    this.updateUI();
                    UIService.showStatus("Conexión restaurada", "success");
                }
            },
            
            handleOffline() {
                if (this.isOnline) {
                    this.isOnline = false;
                    this.updateUI();
                    UIService.showStatus("Sin conexión - Modo offline", "error");
                }
            },
            
            updateUI() {
                const statusElement = document.getElementById('connection-status');
                if (this.isOnline) {
                    statusElement.textContent = "🟢 CONECTADO";
                    statusElement.className = "connection-status online";
                } else {
                    statusElement.textContent = "🔴 SIN CONEXIÓN";
                    statusElement.className = "connection-status offline";
                }
                statusElement.style.display = 'block';
            }
        };

        const GrupoManager = {
            grupos: new Map(),
            equiposPendientes: new Map(),
            currentEditingGroup: null,
            currentGrupoDetalle: null,
            unsubscribe: null,
            
            async initialize() {
                await this.loadGrupos();
                await this.loadEquiposPendientes();
                this.setupRealTimeListener();
                this.updateUI();
            },

            setupRealTimeListener() {
                if (!AppState.firebaseInitialized) return;
                
                this.unsubscribe = AppState.db.collection("VENTAS")
                    .where("paymentType", "==", "pendiente")
                    .where("status", "==", "pendiente")
                    .onSnapshot(async (snapshot) => {
                        console.log("🔄 Actualización en tiempo real detectada");
                        await this.loadEquiposPendientes();
                        await this.actualizarTotalesGrupos(); // ACTUALIZAR TOTALES DE GRUPOS
                        this.updateUI();
                    }, (error) => {
                        console.error("Error en listener tiempo real:", error);
                    });
            },
            
            async loadGrupos() {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    const snapshot = await AppState.db.collection("GRUPOS").get();
                    this.grupos.clear();
                    snapshot.forEach(doc => {
                        this.grupos.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    console.log(`✅ ${this.grupos.size} grupos cargados`);
                    
                    // Actualizar totales después de cargar grupos
                    await this.actualizarTotalesGrupos();
                    
                } catch (error) {
                    console.error("Error cargando grupos:", error);
                }
            },
            
            async actualizarTotalesGrupos() {
                try {
                    console.log("🔄 Actualizando totales de grupos...");
                    
                    // Recorrer todos los grupos y recalcular sus totales
                    for (const [grupoId, grupo] of this.grupos.entries()) {
                        let nuevoTotal = 0;
                        let equiposConFacturas = 0;
                        
                        // Calcular el total actualizado del grupo
                        for (const equipoNum of grupo.equipos) {
                            let equipoEncontrado = null;
                            this.equiposPendientes.forEach((equipo, key) => {
                                if (equipo.numero === equipoNum && equipo.total > 0) {
                                    equipoEncontrado = equipo;
                                }
                            });
                            
                            if (equipoEncontrado) {
                                nuevoTotal += equipoEncontrado.total;
                                equiposConFacturas++;
                            }
                        }
                        
                        // Actualizar el total del grupo en memoria
                        grupo.total = nuevoTotal;
                        
                        // Actualizar el total del grupo en Firestore solo si hay cambios
                        if (AppState.firebaseInitialized && nuevoTotal !== grupo.total) {
                            try {
                                await AppState.db.collection("GRUPOS").doc(grupoId).update({
                                    total: nuevoTotal,
                                    fechaActualizacion: new Date()
                                });
                                console.log(`✅ Grupo ${grupo.nombre} actualizado: $${nuevoTotal.toFixed(2)}`);
                            } catch (error) {
                                console.error(`❌ Error actualizando grupo ${grupo.nombre}:`, error);
                            }
                        }
                    }
                    
                    console.log("✅ Totales de grupos actualizados correctamente");
                    
                } catch (error) {
                    console.error("❌ Error actualizando totales de grupos:", error);
                }
            },
            
            async loadEquiposPendientes() {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    const snapshot = await AppState.db.collection("VENTAS")
                        .where("paymentType", "==", "pendiente")
                        .where("status", "==", "pendiente")
                        .get();
                    
                    this.equiposPendientes.clear();
                    
                    snapshot.forEach(doc => {
                        const venta = doc.data();
                        const equipo = venta.equipoNumber;
                        const cliente = venta.clientName || '';
                        
                        // Calcular saldo pendiente considerando abonos
                        let saldoPendiente = venta.total || 0;
                        if (venta.abonos && venta.abonos.length > 0) {
                            const totalAbonado = venta.abonos.reduce((sum, abono) => sum + abono.monto, 0);
                            saldoPendiente = venta.total - totalAbonado;
                        }
                        
                        // Solo incluir equipos con saldo pendiente mayor a 0
                        if (equipo && saldoPendiente > 0) {
                            const key = `${equipo}-${cliente}`;
                            
                            if (!this.equiposPendientes.has(key)) {
                                this.equiposPendientes.set(key, {
                                    numero: equipo,
                                    cliente: cliente,
                                    total: 0,
                                    facturas: []
                                });
                            }
                            
                            const equipoData = this.equiposPendientes.get(key);
                            equipoData.facturas.push({
                                id: doc.id,
                                ...venta,
                                saldoPendiente: saldoPendiente
                            });
                            equipoData.total += saldoPendiente;
                        }
                    });
                    
                    console.log(`✅ ${this.equiposPendientes.size} equipos pendientes cargados`);
                    
                    // Actualizar totales de grupos después de cargar equipos
                    await this.actualizarTotalesGrupos();
                    
                } catch (error) {
                    console.error("Error cargando equipos pendientes:", error);
                }
            },
            
            async crearGrupo(nombre, equiposSeleccionados) {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    // Filtrar equipos que realmente tienen facturas pendientes
                    const equiposConFacturas = equiposSeleccionados.filter(equipoNum => {
                        let tieneFacturas = false;
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === equipoNum && equipo.total > 0) {
                                tieneFacturas = true;
                            }
                        });
                        return tieneFacturas;
                    });
                    
                    if (equiposConFacturas.length === 0) {
                        throw new Error("Los equipos seleccionados no tienen facturas pendientes");
                    }
                    
                    // Calcular total real del grupo
                    let totalGrupo = 0;
                    equiposConFacturas.forEach(equipoNum => {
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === equipoNum) {
                                totalGrupo += equipo.total;
                            }
                        });
                    });
                    
                    const grupoData = {
                        nombre: nombre,
                        equipos: equiposConFacturas,
                        total: totalGrupo,
                        fechaCreacion: new Date(),
                        activo: true
                    };
                    
                    const docRef = await AppState.db.collection("GRUPOS").add(grupoData);
                    grupoData.id = docRef.id;
                    this.grupos.set(docRef.id, grupoData);
                    
                    // Actualizar las facturas con la información del grupo
                    for (const equipoNum of equiposConFacturas) {
                        this.equiposPendientes.forEach(async (equipo, key) => {
                            if (equipo.numero === equipoNum) {
                                for (const factura of equipo.facturas) {
                                    await AppState.db.collection("VENTAS").doc(factura.id).update({
                                        grupo: docRef.id,
                                        grupoNombre: nombre
                                    });
                                }
                            }
                        });
                    }
                    
                    await this.loadEquiposPendientes();
                    await this.actualizarTotalesGrupos();
                    this.updateUI();
                    
                    return docRef.id;
                } catch (error) {
                    console.error("Error creando grupo:", error);
                    throw error;
                }
            },

            async actualizarGrupo(grupoId, nombre, equiposSeleccionados) {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    // Filtrar equipos que realmente tienen facturas pendientes
                    const equiposConFacturas = equiposSeleccionados.filter(equipoNum => {
                        let tieneFacturas = false;
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === equipoNum && equipo.total > 0) {
                                tieneFacturas = true;
                            }
                        });
                        return tieneFacturas;
                    });
                    
                    // Calcular total real del grupo
                    let totalGrupo = 0;
                    equiposConFacturas.forEach(equipoNum => {
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === equipoNum) {
                                totalGrupo += equipo.total;
                            }
                        });
                    });
                    
                    const grupoData = {
                        nombre: nombre,
                        equipos: equiposConFacturas,
                        total: totalGrupo,
                        fechaActualizacion: new Date()
                    };
                    
                    await AppState.db.collection("GRUPOS").doc(grupoId).update(grupoData);
                    
                    const grupoExistente = this.grupos.get(grupoId);
                    if (grupoExistente) {
                        Object.assign(grupoExistente, grupoData);
                    }
                    
                    // Actualizar las facturas con la nueva información del grupo
                    for (const equipoNum of equiposConFacturas) {
                        this.equiposPendientes.forEach(async (equipo, key) => {
                            if (equipo.numero === equipoNum) {
                                for (const factura of equipo.facturas) {
                                    await AppState.db.collection("VENTAS").doc(factura.id).update({
                                        grupo: grupoId,
                                        grupoNombre: nombre
                                    });
                                }
                            }
                        });
                    }
                    
                    // Remover grupo de facturas que ya no están en el grupo
                    const grupoOriginal = this.grupos.get(grupoId);
                    if (grupoOriginal) {
                        for (const equipoNum of grupoOriginal.equipos) {
                            if (!equiposConFacturas.includes(equipoNum)) {
                                this.equiposPendientes.forEach(async (equipo, key) => {
                                    if (equipo.numero === equipoNum) {
                                        for (const factura of equipo.facturas) {
                                            await AppState.db.collection("VENTAS").doc(factura.id).update({
                                                grupo: firebase.firestore.FieldValue.delete(),
                                                grupoNombre: firebase.firestore.FieldValue.delete()
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    }
                    
                    await this.loadEquiposPendientes();
                    await this.actualizarTotalesGrupos();
                    this.updateUI();
                    
                    return grupoId;
                } catch (error) {
                    console.error("Error actualizando grupo:", error);
                    throw error;
                }
            },
            
            async eliminarGrupo(grupoId) {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    const grupo = this.grupos.get(grupoId);
                    if (grupo) {
                        // Remover información de grupo de todas las facturas
                        for (const equipoNum of grupo.equipos) {
                            this.equiposPendientes.forEach(async (equipo, key) => {
                                if (equipo.numero === equipoNum) {
                                    for (const factura of equipo.facturas) {
                                        await AppState.db.collection("VENTAS").doc(factura.id).update({
                                            grupo: firebase.firestore.FieldValue.delete(),
                                            grupoNombre: firebase.firestore.FieldValue.delete()
                                        });
                                    }
                                }
                            });
                        }
                    }
                    
                    await AppState.db.collection("GRUPOS").doc(grupoId).delete();
                    this.grupos.delete(grupoId);
                    
                    await this.loadEquiposPendientes();
                    await this.actualizarTotalesGrupos();
                    this.updateUI();
                    
                } catch (error) {
                    console.error("Error eliminando grupo:", error);
                    throw error;
                }
            },
            
            getEquiposSinGrupo() {
                const equiposSinGrupo = new Map();
                
                this.equiposPendientes.forEach((equipo, key) => {
                    let tieneGrupo = false;
                    
                    this.grupos.forEach(grupo => {
                        if (grupo.equipos.includes(equipo.numero)) {
                            tieneGrupo = true;
                        }
                    });
                    
                    if (!tieneGrupo && equipo.total > 0) {
                        equiposSinGrupo.set(key, equipo);
                    }
                });
                
                return equiposSinGrupo;
            },
            
            updateUI() {
                this.renderEquiposIndividuales();
                this.renderGruposManagement();
            },
            
            renderEquiposIndividuales() {
                const container = document.getElementById('equipos-individuales');
                const emptyState = document.getElementById('empty-equipos');
                const equiposSinGrupo = this.getEquiposSinGrupo();
                
                if (equiposSinGrupo.size === 0) {
                    emptyState.style.display = 'block';
                    container.innerHTML = '';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                const equiposOrdenados = Array.from(equiposSinGrupo.entries())
                    .sort(([a], [b]) => {
                        const numA = parseInt(a.split('-')[0]);
                        const numB = parseInt(b.split('-')[0]);
                        return numA - numB;
                    });
                
                let html = '';
                equiposOrdenados.forEach(([key, equipo]) => {
                    const mostrarNombre = equipo.cliente && !equipo.cliente.startsWith('Equipo ');
                    
                    html += `
                        <div class="equipo-card" onclick="GrupoManager.mostrarDetalleEquipo('${key}')">
                            <div class="equipo-number">${equipo.numero}</div>
                            ${mostrarNombre ? `<div class="equipo-nombre">${equipo.cliente}</div>` : ''}
                            <div class="equipo-total">$${equipo.total.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            renderGruposManagement() {
                const container = document.getElementById('grupos-list');
                
                if (this.grupos.size === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <div>No hay grupos creados</div>
                            <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Crea tu primer grupo para organizar los equipos</div>
                        </div>
                    `;
                    return;
                }
                
                const gruposOrdenados = Array.from(this.grupos.values())
                    .filter(grupo => grupo.activo)
                    .sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                let html = '';
                gruposOrdenados.forEach(grupo => {
                    const cantidadEquipos = grupo.equipos.length;
                    const equiposConFacturas = grupo.equipos.filter(equipoNum => {
                        let tieneFacturas = false;
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === equipoNum && equipo.total > 0) {
                                tieneFacturas = true;
                            }
                        });
                        return tieneFacturas;
                    }).length;
                    
                    html += `
                        <div class="grupo-management-item">
                            <div class="grupo-management-info">
                                <div class="grupo-management-name">${grupo.nombre}</div>
                                <div class="grupo-management-details">
                                    Equipos: ${cantidadEquipos} | Con facturas: ${equiposConFacturas} | Total: $${grupo.total.toFixed(2)}
                                </div>
                            </div>
                            <div class="grupo-management-actions">
                                <button class="icon-btn btn-edit" onclick="GrupoManager.editarGrupo('${grupo.id}')" title="Editar grupo">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn btn-delete" onclick="GrupoManager.eliminarGrupo('${grupo.id}')" title="Eliminar grupo">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="icon-btn btn-view" onclick="GrupoManager.mostrarDetalleGrupoCompleto('${grupo.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            async mostrarDetalleEquipo(key) {
                const equipo = this.equiposPendientes.get(key);
                
                let facturasHTML = '';
                if (equipo) {
                    equipo.facturas.forEach(factura => {
                        let productosHTML = '';
                        if (factura.products && factura.products.length > 0) {
                            factura.products.forEach(producto => {
                                productosHTML += `
                                    <div class="producto-item">
                                        <div>${producto.descripcion} x${producto.cantidad}</div>
                                        <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                    </div>
                                `;
                            });
                        }
                        
                        const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                        const tieneAbonos = factura.abonos && factura.abonos.length > 0;
                        
                        let abonosHTML = '';
                        if (tieneAbonos) {
                            factura.abonos.forEach(abono => {
                                const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES') : 'N/A';
                                abonosHTML += `
                                    <div style="font-size: 0.7rem; color: #666; margin-left: 10px;">
                                        Abono: $${abono.monto.toFixed(2)} (${fechaAbono})
                                    </div>
                                `;
                            });
                        }
                        
                        facturasHTML += `
                            <div class="factura-item">
                                <div><strong>Factura:</strong> ${factura.invoiceNumber}</div>
                                <div><strong>Total:</strong> $${factura.total.toFixed(2)}</div>
                                ${tieneAbonos ? `<div><strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}</div>` : ''}
                                <div><strong>Productos:</strong></div>
                                ${productosHTML}
                                ${abonosHTML}
                            </div>
                        `;
                    });
                }
                
                const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">Detalles del Equipo ${equipo.numero}</h3>
                    <div class="detalle-equipo">
                        <div><strong>Grupo:</strong> ${equipo.cliente}</div>
                        <div><strong>Total Pendiente:</strong> $${equipo ? equipo.total.toFixed(2) : '0.00'}</div>
                        <div><strong>Número de Facturas:</strong> ${equipo ? equipo.facturas.length : 0}</div>
                    </div>
                    <div class="grupo-facturas">
                        <h4>Facturas Pendientes:</h4>
                        ${facturasHTML || '<p>No hay facturas pendientes para este equipo</p>'}
                    </div>
                `;
                
                document.getElementById('detalle-modal-content').innerHTML = modalContent;
                document.getElementById('detalle-modal').style.display = 'block';
                AppState.currentDetalle = { tipo: 'equipo', data: key };
            },
            
            async mostrarDetalleGrupoCompleto(grupoId) {
                const grupo = this.grupos.get(grupoId);
                if (!grupo) return;
                
                this.currentGrupoDetalle = grupo;
                
                let equiposHTML = '';
                let totalGeneral = 0;
                let totalPendiente = 0;
                let cantidadFacturas = 0;
                let tieneAbonos = false;
                
                for (const equipoNum of grupo.equipos) {
                    let equipoEncontrado = null;
                    this.equiposPendientes.forEach((equipo, key) => {
                        if (equipo.numero === equipoNum && equipo.total > 0) {
                            equipoEncontrado = equipo;
                        }
                    });
                    
                    if (equipoEncontrado) {
                        totalGeneral += equipoEncontrado.total;
                        cantidadFacturas += equipoEncontrado.facturas.length;
                        
                        let facturasHTML = '';
                        equipoEncontrado.facturas.forEach(factura => {
                            const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                            totalPendiente += saldoPendiente;
                            
                            if (factura.abonos && factura.abonos.length > 0) {
                                tieneAbonos = true;
                            }
                            
                            let productosHTML = '';
                            if (factura.products && factura.products.length > 0) {
                                factura.products.forEach(producto => {
                                    productosHTML += `
                                        <div class="producto-item">
                                            <div>${producto.descripcion} x${producto.cantidad}</div>
                                            <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                        </div>
                                    `;
                                });
                            }
                            
                            facturasHTML += `
                                <div class="grupo-detalle-factura">
                                    <div><strong>Factura:</strong> ${factura.invoiceNumber}</div>
                                    <div><strong>Fecha:</strong> ${new Date(factura.timestamp.toDate ? factura.timestamp.toDate() : factura.timestamp).toLocaleDateString('es-ES')}</div>
                                    <div><strong>Total:</strong> $${factura.total.toFixed(2)}</div>
                                    ${factura.abonos && factura.abonos.length > 0 ? `<div><strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}</div>` : ''}
                                    <div><strong>Productos:</strong></div>
                                    ${productosHTML}
                                </div>
                            `;
                        });
                        
                        equiposHTML += `
                            <div class="grupo-detalle-equipo">
                                <h4>Equipo ${equipoEncontrado.numero} - ${equipoEncontrado.cliente}</h4>
                                <div><strong>Total:</strong> $${equipoEncontrado.total.toFixed(2)}</div>
                                <div><strong>Facturas:</strong> ${equipoEncontrado.facturas.length}</div>
                                ${facturasHTML}
                            </div>
                        `;
                    }
                }
                
                const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">${grupo.nombre} - Detalles Completos</h3>
                    <div class="grupo-resumen">
                        <div><strong>Total del Grupo:</strong> $${totalGeneral.toFixed(2)}</div>
                        ${tieneAbonos ? `<div><strong>Saldo Pendiente:</strong> $${totalPendiente.toFixed(2)}</div>` : ''}
                        <div><strong>Número de Equipos:</strong> ${grupo.equipos.length}</div>
                        <div><strong>Total de Facturas:</strong> ${cantidadFacturas}</div>
                    </div>
                    <div class="grupo-facturas">
                        <h4>Detalles por Equipo:</h4>
                        ${equiposHTML || '<p>No hay equipos con facturas pendientes en este grupo</p>'}
                    </div>
                `;
                
                document.getElementById('grupo-detalle-modal-content').innerHTML = modalContent;
                document.getElementById('grupo-detalle-modal').style.display = 'block';
            },
            
            async imprimirGrupoCompleto() {
                const grupo = this.currentGrupoDetalle;
                if (!grupo) return;
                
                for (const equipoNum of grupo.equipos) {
                    let equipoEncontrado = null;
                    this.equiposPendientes.forEach((equipo, key) => {
                        if (equipo.numero === equipoNum && equipo.total > 0) {
                            equipoEncontrado = equipo;
                        }
                    });
                    
                    if (equipoEncontrado) {
                        equipoEncontrado.facturas.forEach(factura => {
                            this.imprimirTicketFactura(factura, equipoEncontrado);
                        });
                    }
                }
            },

            imprimirTicketFactura(factura, equipo) {
                const printWindow = window.open('', '_blank');
                const fecha = factura.timestamp ? new Date(factura.timestamp.toDate ? factura.timestamp.toDate() : factura.timestamp) : new Date();
                const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
                
                const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                const tieneAbonos = factura.abonos && factura.abonos.length > 0;
                const tipoPago = tieneAbonos && saldoPendiente > 0 ? 'PENDIENTE' : 'CONTADO';
                
                let abonosHTML = '';
                if (tieneAbonos) {
                    factura.abonos.forEach(abono => {
                        const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
                        abonosHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 20px; margin: 2px 0;">
                                <div>ABONO: $${abono.monto.toFixed(2)} (${fechaAbono})</div>
                            </div>
                        `;
                    });
                }
                
                let productosHTML = '';
                if (factura.products && factura.products.length > 0) {
                    factura.products.forEach(producto => {
                        const descripcion = producto.descripcion.length > 25 ? producto.descripcion.substring(0, 25) + '...' : producto.descripcion;
                        productosHTML += `
                            <div style="margin: 4px 0;">
                                <div style="font-size: 20px;">• ${descripcion}</div>
                                <div style="display: flex; justify-content: space-between; font-size: 18px;">
                                    <div>x${producto.cantidad}</div>
                                    <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="border-bottom: 1px dotted #000; margin: 2px 0;"></div>
                        `;
                    });
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket #${factura.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILIAN</h3>
                            <div class="small-text">Factura: ${factura.invoiceNumber}</div>
                            <div class="small-text">${fechaFormateada}, ${tipoPago}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Grupo:</strong> ${equipo.cliente}<br>
                            <strong>Equipo:</strong> ${equipo.numero}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 8px 0;">
                            ${productosHTML}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total large-text">
                            TOTAL: $${factura.total.toFixed(2)}
                        </div>

                        ${abonosHTML}

                        ${tieneAbonos && saldoPendiente > 0 ? `
                            <div class="saldo-info">
                                <div>SALDO PENDIENTE:</div>
                                <div class="large-text">$${saldoPendiente.toFixed(2)}</div>
                            </div>
                        ` : ''}
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            },
            
            async actualizarDesdeVenta(ventaData) {
                if (ventaData.paymentType === 'pendiente' && ventaData.status === 'pendiente') {
                    const equipo = ventaData.equipoNumber;
                    if (equipo) {
                        await this.loadEquiposPendientes();
                        await this.actualizarTotalesGrupos(); // ACTUALIZAR TOTALES DE GRUPOS
                        this.updateUI();
                    }
                }
            },
            
            generarGridEquipos(modalType = 'crear') {
                const grid = document.getElementById(modalType === 'crear' ? 'all-equipos-grid' : 'editar-all-equipos-grid');
                let html = '';
                
                for (let i = 1; i <= 130; i++) {
                    const equipoNum = i.toString();
                    let equipoEncontrado = null;
                    this.equiposPendientes.forEach((equipo, key) => {
                        if (equipo.numero === equipoNum && equipo.total > 0) {
                            equipoEncontrado = equipo;
                        }
                    });
                    
                    const tieneFacturas = equipoEncontrado && equipoEncontrado.facturas.length > 0;
                    const estaSeleccionado = modalType === 'crear' 
                        ? AppState.equiposSeleccionados.has(equipoNum)
                        : AppState.equiposEditSeleccionados.has(equipoNum);
                    
                    html += `
                        <div class="all-equipo-item ${estaSeleccionado ? 'selected' : ''} ${tieneFacturas ? 'has-facturas' : ''}" 
                             onclick="GrupoManager.toggleEquipoGrid('${equipoNum}', '${modalType}')"
                             style="${tieneFacturas ? 'border-color: #27ae60; background: #f0fff0;' : 'border-color: #ccc; background: #f5f5f5;'}">
                            ${equipoNum}
                            ${tieneFacturas ? '<br><small style="color: #27ae60;">$' + equipoEncontrado.total.toFixed(2) + '</small>' : '<br><small style="color: #999;">$0.00</small>'}
                        </div>
                    `;
                }
                
                grid.innerHTML = html;
            },
            
            toggleEquipoGrid(equipoNum, modalType = 'crear') {
                const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;
                
                if (selectedSet.has(equipoNum)) {
                    selectedSet.delete(equipoNum);
                } else {
                    if (selectedSet.size >= 130) {
                        UIService.showStatus("Máximo 130 equipos permitidos", "error");
                        return;
                    }
                    selectedSet.add(equipoNum);
                }
                
                this.actualizarListaSeleccionados(modalType);
                this.actualizarGridSeleccion(modalType);
            },
            
            actualizarGridSeleccion(modalType = 'crear') {
                const selector = modalType === 'crear' ? '.all-equipo-item' : '#editar-all-equipos-grid .all-equipo-item';
                const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;
                
                document.querySelectorAll(selector).forEach(item => {
                    const equipoNum = item.textContent.split('\n')[0].trim();
                    if (selectedSet.has(equipoNum)) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            },
            
            actualizarListaSeleccionados(modalType = 'crear') {
                const selectedList = document.getElementById(modalType === 'crear' ? 'selected-equipos-list' : 'editar-selected-equipos-list');
                const contador = document.getElementById(modalType === 'crear' ? 'contador-equipos' : 'editar-contador-equipos');
                const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;
                
                contador.textContent = selectedSet.size;
                
                if (selectedSet.size === 0) {
                    selectedList.innerHTML = '<div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos seleccionados</div>';
                } else {
                    let badgesHTML = '';
                    const equiposOrdenados = Array.from(selectedSet).sort((a, b) => parseInt(a) - parseInt(b));
                    
                    equiposOrdenados.forEach(num => {
                        let equipoEncontrado = null;
                        this.equiposPendientes.forEach((equipo, key) => {
                            if (equipo.numero === num && equipo.total > 0) {
                                equipoEncontrado = equipo;
                            }
                        });
                        
                        if (equipoEncontrado) {
                            badgesHTML += `<span class="selected-equipo-badge">${num} ($${equipoEncontrado.total.toFixed(2)})</span>`;
                        } else {
                            badgesHTML += `<span class="selected-equipo-badge" style="background: #95a5a6;">${num} ($0.00)</span>`;
                        }
                    });
                    selectedList.innerHTML = badgesHTML;
                }
            },

            async editarGrupo(grupoId) {
                const grupo = this.grupos.get(grupoId);
                if (!grupo) {
                    UIService.showStatus("No se encontró el grupo para editar", "error");
                    return;
                }

                this.currentEditingGroup = grupo;
                
                AppState.equiposEditSeleccionados = new Set(grupo.equipos);
                
                document.getElementById('editar-nombre-grupo').value = grupo.nombre;
                this.generarGridEquipos('editar');
                this.actualizarListaSeleccionados('editar');
                
                document.getElementById('editar-grupo-modal').style.display = 'block';
            },

            async actualizarGrupoDesdeModal() {
                const grupo = this.currentEditingGroup;
                if (!grupo) {
                    UIService.showStatus("No hay grupo seleccionado para editar", "error");
                    return;
                }

                const nombre = document.getElementById('editar-nombre-grupo').value.trim();
                if (!nombre) {
                    UIService.showStatus("Ingrese un nombre para el grupo", "error");
                    return;
                }

                if (AppState.equiposEditSeleccionados.size === 0) {
                    UIService.showStatus("Seleccione al menos un equipo", "error");
                    return;
                }

                try {
                    const equiposArray = Array.from(AppState.equiposEditSeleccionados);
                    await this.actualizarGrupo(grupo.id, nombre, equiposArray);
                    UIService.showStatus(`Grupo "${nombre}" actualizado correctamente`, "success");
                    document.getElementById('editar-grupo-modal').style.display = 'none';
                    this.currentEditingGroup = null;
                    AppState.equiposEditSeleccionados.clear();
                } catch (error) {
                    UIService.showStatus("Error al actualizar grupo: " + error.message, "error");
                }
            }
        };

        const ProductCache = {
            data: new Map(),
            lastUpdate: null,
            ttl: 10 * 60 * 1000,
            
            isExpired() {
                return !this.lastUpdate || (Date.now() - this.lastUpdate) > this.ttl;
            },
            
            async initialize() {
                if (this.isExpired() || this.data.size === 0) {
                    await this.refresh();
                }
                this.updateUI();
            },
            
            async refresh() {
                try {
                    if (!AppState.firebaseInitialized) return;
                    
                    const snapshot = await AppState.db.collection("INVENTARIO").get();
                    this.data.clear();
                    snapshot.forEach(doc => {
                        this.data.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    this.lastUpdate = Date.now();
                    this.updateUI();
                    console.log(`✅ Cache actualizado: ${this.data.size} productos`);
                    UIService.showStatus(`Cache actualizado: ${this.data.size} productos`, "success");
                } catch (error) {
                    console.error("❌ Error actualizando cache:", error);
                    UIService.showStatus("Error actualizando cache", "error");
                }
            },
            
            search(query) {
                const results = [];
                const searchTerm = query.toLowerCase().trim();
                
                if (!searchTerm) return results;
                
                this.data.forEach(product => {
                    const codigo = (product.codigo || '').toLowerCase();
                    const descripcion = (product.descripcion || '').toLowerCase();
                    
                    if (codigo.includes(searchTerm) || descripcion.includes(searchTerm)) {
                        results.push(product);
                    }
                });
                
                return results.slice(0, 10);
            },
            
            getByCode(codigo) {
                let found = null;
                this.data.forEach(product => {
                    if (product.codigo === codigo) {
                        found = product;
                    }
                });
                return found;
            },
            
            updateUI() {
                const cacheInfo = document.getElementById('cache-info');
                const cacheCount = document.getElementById('cache-count');
                
                if (this.data.size > 0) {
                    cacheInfo.style.display = 'flex';
                    cacheCount.textContent = this.data.size;
                } else {
                    cacheInfo.style.display = 'none';
                }
            }
        };

        const AppState = {
            firebaseInitialized: false,
            db: null,
            cart: [],
            searchResults: [],
            saleCounter: 0,
            currentEditingInvoice: null,
            historial: [],
            filteredHistorial: [],
            currentFilter: 'todo',
            currentAbonoInvoice: null,
            currentDetalle: null,
            equiposSeleccionados: new Set(),
            equiposEditSeleccionados: new Set()
        };

        const DataService = {
            async searchProducts(query) {
                if (!AppState.firebaseInitialized) {
                    return [{
                        id: 'manual-' + Date.now(),
                        codigo: 'MANUAL',
                        descripcion: query,
                        precio: 0,
                        cantidad: 1
                    }];
                }

                await ProductCache.initialize();
                let results = ProductCache.search(query);

                if (results.length === 0 && query.trim() !== '') {
                    results.push({
                        id: 'manual-' + Date.now(),
                        codigo: 'MANUAL',
                        descripcion: query,
                        precio: 0,
                        cantidad: 1
                    });
                }
                
                return results;
            },

            async saveSale(saleData) {
                if (AppState.firebaseInitialized) {
                    const existingInvoice = await this.checkInvoiceExists(saleData.invoiceNumber);
                    if (existingInvoice) {
                        throw new Error(`La factura ${saleData.invoiceNumber} ya existe`);
                    }
                    
                    const docRef = await AppState.db.collection("VENTAS").add(saleData);
                    
                    await this.updateSaleCounter(saleData.date);
                    
                    if (saleData.paymentType === 'pendiente') {
                        await GrupoManager.actualizarDesdeVenta(saleData);
                    }
                    
                    return docRef.id;
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async checkInvoiceExists(invoiceNumber) {
                const snapshot = await AppState.db.collection("VENTAS")
                    .where("invoiceNumber", "==", invoiceNumber)
                    .limit(1)
                    .get();
                return !snapshot.empty;
            },

            async updateSaleCounter(date = new Date().toISOString().split('T')[0]) {
                try {
                    const counterRef = AppState.db.collection("COUNTERS").doc("sales");
                    const counterDoc = await counterRef.get();
                    let currentCount = 0;
                    
                    if (counterDoc.exists) {
                        currentCount = counterDoc.data()[date] || 0;
                    }
                    
                    await counterRef.set({
                        [date]: currentCount + 1,
                        lastUpdate: new Date()
                    }, { merge: true });
                } catch (error) {
                    console.error("Error actualizando contador:", error);
                }
            },

            async getSaleCounter(date = new Date().toISOString().split('T')[0]) {
                try {
                    const counterRef = AppState.db.collection("COUNTERS").doc("sales");
                    const doc = await counterRef.get();
                    
                    if (doc.exists) {
                        return doc.data()[date] || 0;
                    }
                    return 0;
                } catch (error) {
                    console.error("Error obteniendo contador, usando fallback:", error);
                    const snapshot = await AppState.db.collection("VENTAS")
                        .where("date", "==", date)
                        .get();
                    return snapshot.size;
                }
            },

            async updateSale(saleId, saleData) {
                if (AppState.firebaseInitialized) {
                    await AppState.db.collection("VENTAS").doc(saleId).update(saleData);
                    
                    if (saleData.paymentType === 'pendiente') {
                        await GrupoManager.actualizarDesdeVenta({...saleData, id: saleId});
                    }
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async deleteSale(saleId) {
                if (AppState.firebaseInitialized) {
                    await AppState.db.collection("VENTAS").doc(saleId).delete();
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async loadSales(limit = 500) {
                if (AppState.firebaseInitialized) {
                    const snapshot = await AppState.db.collection("VENTAS")
                        .orderBy("timestamp", "desc")
                        .limit(limit)
                        .get();
                    
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    return [];
                }
            },

            async loadSalesByDate(date = new Date().toISOString().split('T')[0], limit = 500) {
                if (AppState.firebaseInitialized) {
                    const snapshot = await AppState.db.collection("VENTAS")
                        .where("date", "==", date)
                        .orderBy("timestamp", "desc")
                        .limit(limit)
                        .get();
                    
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    return [];
                }
            },

            async addAbono(invoiceId, abonoData) {
                if (AppState.firebaseInitialized) {
                    const ventaRef = AppState.db.collection("VENTAS").doc(invoiceId);
                    
                    const ventaDoc = await ventaRef.get();
                    if (!ventaDoc.exists) {
                        throw new Error("No se encontró la venta");
                    }
                    
                    const venta = ventaDoc.data();
                    
                    const nuevoSaldo = (venta.saldoPendiente || venta.total) - abonoData.monto;
                    
                    if (nuevoSaldo < 0) {
                        throw new Error("El monto del abono no puede ser mayor al saldo pendiente");
                    }
                    
                    await ventaRef.update({
                        abonos: firebase.firestore.FieldValue.arrayUnion(abonoData),
                        saldoPendiente: nuevoSaldo
                    });
                    
                    if (nuevoSaldo <= 0) {
                        await ventaRef.update({
                            paymentType: 'contado',
                            status: 'pagado'
                        });
                    }
                    
                    await GrupoManager.actualizarDesdeVenta(venta);
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async getSaleById(invoiceId) {
                if (AppState.firebaseInitialized) {
                    const doc = await AppState.db.collection("VENTAS").doc(invoiceId).get();
                    if (doc.exists) {
                        return { id: doc.id, ...doc.data() };
                    }
                    return null;
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async cancelInvoice(invoiceId) {
                if (AppState.firebaseInitialized) {
                    const ventaRef = AppState.db.collection("VENTAS").doc(invoiceId);
                    
                    await ventaRef.update({
                        paymentType: 'contado',
                        status: 'pagado',
                        saldoPendiente: 0,
                        cancelada: true,
                        fechaCancelacion: new Date()
                    });
                    
                    const venta = await this.getSaleById(invoiceId);
                    if (venta) {
                        await GrupoManager.actualizarDesdeVenta(venta);
                    }
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            }
        };

        const UIService = {
            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
            },

            updateCartDisplay() {
                const cartItems = document.getElementById('cart-items');
                const totalAmount = document.getElementById('total-amount');
                
                if (AppState.cart.length === 0) {
                    cartItems.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <div>No hay productos agregados</div>
                        </div>
                    `;
                    totalAmount.textContent = 'TOTAL: $0.00';
                    return;
                }
                
                let total = 0;
                let itemsHTML = '';
                
                AppState.cart.forEach((item, index) => {
                    const itemTotal = item.precio * item.cantidad;
                    total += itemTotal;
                    
                    const tienePrecioCero = item.precio === 0;
                    
                    itemsHTML += `
                        <div class="cart-item">
                            <div>
                                <input type="number" class="quantity-input" value="${item.cantidad}" 
                                       min="1" data-index="${index}" onchange="SalesService.updateQuantity(${index}, this.value)">
                            </div>
                            <div class="product-desc">${item.descripcion}</div>
                            <div>
                                <input type="number" class="price-input ${tienePrecioCero ? 'price-warning' : ''}" value="${item.precio.toFixed(2)}" 
                                       step="0.01" min="0" data-index="${index}" onchange="SalesService.updatePrice(${index}, this.value)">
                            </div>
                            <div class="subtotal">$${itemTotal.toFixed(2)}</div>
                            <div class="cart-actions">
                                <button class="delete-item-btn" onclick="SalesService.removeFromCart(${index})" title="Eliminar producto">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = itemsHTML;
                totalAmount.textContent = `TOTAL: $${total.toFixed(2)}`;
            },

            showSearchResults(results) {
                const dropdown = document.getElementById('search-dropdown');
                dropdown.innerHTML = '';
                
                if (results.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-dropdown-item';
                    item.textContent = 'No se encontraron productos - Presione para agregar manualmente';
                    item.addEventListener('click', () => {
                        const searchInput = document.getElementById('buscar-producto');
                        SalesService.addManualProduct(searchInput.value);
                        dropdown.style.display = 'none';
                        searchInput.value = '';
                    });
                    dropdown.appendChild(item);
                } else {
                    results.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'search-dropdown-item';
                        const isManual = product.id.startsWith('manual-');
                        item.innerHTML = `
                            <strong>${product.descripcion || 'Sin descripción'}</strong>
                            <div style="font-size: 0.7rem; margin-top: 2px;">
                                ${isManual ? 'PRODUCTO MANUAL' : `Cód: ${product.codigo || 'N/A'} | Stock: ${product.cantidad || 0}`} | $${(product.precio || 0).toFixed(2)}
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            SalesService.addToCart(product);
                            dropdown.style.display = 'none';
                            document.getElementById('buscar-producto').value = '';
                        });
                        dropdown.appendChild(item);
                    });
                }
                
                dropdown.style.display = 'block';
            },

            updateHistorial(ventas) {
                const historialBody = document.getElementById('historial-body');
                AppState.historial = ventas;
                AppState.filteredHistorial = ventas;
                
                this.applyCurrentFilter();
            },

            applyCurrentFilter() {
                let filtered = AppState.historial;
                
                switch (AppState.currentFilter) {
                    case 'hoy':
                        const today = new Date().toISOString().split('T')[0];
                        filtered = filtered.filter(venta => venta.date === today);
                        break;
                    case 'ventas':
                        filtered = filtered.filter(venta => 
                            venta.paymentType === 'contado' || 
                            (venta.paymentType === 'pendiente' && (venta.saldoPendiente || venta.total) <= 0)
                        );
                        break;
                    case 'abonos':
                        filtered = filtered.filter(venta => 
                            venta.paymentType === 'pendiente' && 
                            venta.abonos && 
                            venta.abonos.length > 0 && 
                            (venta.saldoPendiente || venta.total) > 0
                        );
                        break;
                    case 'pendientes':
                        filtered = filtered.filter(venta => 
                            venta.paymentType === 'pendiente' && 
                            (venta.saldoPendiente || venta.total) > 0
                        );
                        break;
                }
                
                AppState.filteredHistorial = filtered;
                this.renderHistorial();
            },

            renderHistorial() {
                const historialBody = document.getElementById('historial-body');
                const ventas = AppState.filteredHistorial;
                
                if (ventas.length === 0) {
                    historialBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-cart">No hay ventas que coincidan con el filtro</td>
                        </tr>
                    `;
                    return;
                }
                
                let historialHTML = '';
                
                ventas.forEach(venta => {
                    const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES') : 'N/A';
                    
                    let estadoReal = venta.paymentType;
                    let tipoClass = 'pendiente-badge';
                    let tipoTexto = 'PENDIENTE';
                    let saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                    
                    if (venta.paymentType === 'contado') {
                        tipoClass = 'contado-badge';
                        tipoTexto = 'CONTADO';
                    } else if (venta.paymentType === 'pendiente') {
                        if (saldoPendiente <= 0) {
                            estadoReal = 'contado';
                            tipoClass = 'contado-badge';
                            tipoTexto = 'CONTADO';
                        }
                    }
                    
                    let montoMostrar = venta.total || 0;
                    let claseMonto = 'saldo-pendiente-negro';
                    
                    if (estadoReal === 'pendiente') {
                        montoMostrar = saldoPendiente;
                        if (venta.saldoPendiente < venta.total) {
                            claseMonto = 'saldo-pendiente-rojo';
                        }
                    }
                    
                    let botonesHTML = '';
                    
                    if (estadoReal === 'contado') {
                        botonesHTML = `
                            <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${venta.id}')" title="Ver factura">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="icon-btn btn-reprint" onclick="SalesService.reprintInvoice('${venta.id}')" title="Reimprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="icon-btn btn-delete" onclick="SalesService.deleteInvoice('${venta.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    } else {
                        botonesHTML = `
                            <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${venta.id}')" title="Ver factura">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="icon-btn btn-reprint" onclick="SalesService.reprintInvoice('${venta.id}')" title="Reimprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="icon-btn btn-edit" onclick="SalesService.editInvoice('${venta.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn btn-abono" onclick="SalesService.registrarAbono('${venta.id}')" title="Registrar abono">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="icon-btn btn-delete" onclick="SalesService.deleteInvoice('${venta.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="icon-btn btn-cancel" onclick="SalesService.cancelInvoice('${venta.id}')" title="Cancelar factura">
                                <i class="fas fa-ban"></i>
                            </button>
                        `;
                    }
                    
                    historialHTML += `
                        <tr>
                            <td><strong>${venta.invoiceNumber || 'N/A'}</strong></td>
                            <td>
                                <div class="cliente-equipo">${venta.equipoNumber || 'N/A'}</div>
                                <div class="cliente-nombre">${venta.clientName || 'Sin nombre'}</div>
                            </td>
                            <td>
                                <div class="${claseMonto}">$${montoMostrar.toFixed(2)}</div>
                            </td>
                            <td><span class="${tipoClass}">${tipoTexto}</span></td>
                            <td>${fecha}</td>
                            <td>
                                <div class="action-buttons historial-actions-container">
                                    ${botonesHTML}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                historialBody.innerHTML = historialHTML;
            },

            showInvoiceModal(content) {
                document.getElementById('invoice-modal-content').innerHTML = content;
                document.getElementById('invoice-modal').style.display = 'block';
            },

            showAbonoModal(content) {
                document.getElementById('abono-modal-content').innerHTML = content;
                document.getElementById('abono-modal').style.display = 'block';
                document.getElementById('monto-abono').value = '';
                document.getElementById('monto-abono').focus();
            },

            restorePaymentButtons() {
                const paymentButtons = document.querySelector('.payment-buttons');
                paymentButtons.innerHTML = `
                    <button class="btn btn-success" id="contado-btn">
                        GUARDAR CONTADO
                    </button>
                    <button class="btn btn-warning" id="pendiente-btn">
                        GUARDAR PENDIENTE
                    </button>
                `;
                
                document.getElementById('contado-btn').addEventListener('click', () => SalesService.processSale('contado'));
                document.getElementById('pendiente-btn').addEventListener('click', () => SalesService.processSale('pendiente'));
            },

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === AppState.currentFilter) {
                        btn.classList.add('active');
                    }
                });
            },

            showCrearGrupoModal() {
                AppState.equiposSeleccionados.clear();
                
                GrupoManager.generarGridEquipos();
                GrupoManager.actualizarListaSeleccionados();
                
                document.getElementById('crear-grupo-modal').style.display = 'block';
                document.getElementById('nombre-grupo').value = '';
                document.getElementById('nombre-grupo').focus();
            },

            // Nueva función para manejar pestañas
            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.getAttribute('data-tab');
                        
                        // Remover clase active de todos los botones y contenidos
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Agregar clase active al botón y contenido seleccionado
                        button.classList.add('active');
                        document.getElementById(`tab-${tabId}`).classList.add('active');
                    });
                });
            }
        };

        const SalesService = {
            addToCart(product) {
                const cartItem = {
                    id: product.id,
                    codigo: product.codigo || 'MANUAL',
                    descripcion: product.descripcion || 'Sin descripción',
                    precio: product.precio || 0,
                    cantidad: 1
                };
                
                AppState.cart.push(cartItem);
                UIService.updateCartDisplay();
                UIService.showStatus("Producto agregado al carrito", "success");
            },

            addManualProduct(descripcion) {
                if (!descripcion.trim()) {
                    UIService.showStatus("Ingrese una descripción para el producto", "error");
                    return;
                }
                
                this.addToCart({
                    id: 'manual-' + Date.now(),
                    codigo: 'MANUAL',
                    descripcion: descripcion,
                    precio: 0,
                    cantidad: 1
                });
            },

            removeFromCart(index) {
                AppState.cart.splice(index, 1);
                UIService.updateCartDisplay();
                UIService.showStatus("Producto eliminado del carrito", "info");
            },

            updateQuantity(index, newQuantity) {
                const quantity = parseInt(newQuantity) || 1;
                if (quantity < 1) {
                    UIService.showStatus("La cantidad debe ser al menos 1", "error");
                    AppState.cart[index].cantidad = 1;
                } else {
                    AppState.cart[index].cantidad = quantity;
                }
                UIService.updateCartDisplay();
            },

            updatePrice(index, newPrice) {
                const price = parseFloat(newPrice) || 0;
                if (price < 0) {
                    UIService.showStatus("El precio no puede ser negativo", "error");
                    AppState.cart[index].precio = 0;
                } else {
                    AppState.cart[index].precio = price;
                }
                UIService.updateCartDisplay();
            },

            async generateInvoiceNumber() {
                const fechaVenta = document.getElementById('fecha-venta').value;
                const date = fechaVenta || new Date().toISOString().split('T')[0];
                const datePart = date.replace(/-/g, '').substring(2);
                
                try {
                    const currentCounter = await DataService.getSaleCounter(date);
                    const counterPart = (currentCounter + 1).toString().padStart(4, '0');
                    
                    const invoiceNumber = datePart + counterPart;
                    
                    const exists = await DataService.checkInvoiceExists(invoiceNumber);
                    if (exists) {
                        return await this.generateInvoiceNumber();
                    }
                    
                    return invoiceNumber;
                } catch (error) {
                    const fallback = datePart + Date.now().toString().substr(-4);
                    console.error("Error generando factura, usando fallback:", fallback);
                    return fallback;
                }
            },

            validateSaleData(equipo, cliente, fechaVenta) {
                // Validar número de equipo (campo obligatorio)
                if (!equipo.trim()) {
                    throw new Error("El número de equipo es obligatorio");
                }
                
                // Validar que el equipo sea numérico
                if (!/^\d+$/.test(equipo.trim())) {
                    throw new Error("El número de equipo debe contener solo números");
                }
                
                // Validar fecha
                if (!fechaVenta) {
                    throw new Error("Seleccione una fecha para la venta");
                }
                
                // Validar que la fecha no sea futura
                const fechaSeleccionada = new Date(fechaVenta);
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                if (fechaSeleccionada > hoy) {
                    throw new Error("No puede seleccionar una fecha futura");
                }
                
                // Validar que no haya productos con precio cero
                const productosConPrecioCero = AppState.cart.filter(item => item.precio === 0);
                if (productosConPrecioCero.length > 0) {
                    throw new Error("Hay productos con precio $0.00. Modifique los precios antes de guardar.");
                }
                
                return true;
            },

            async processSale(paymentType) {
                if (AppState.cart.length === 0) {
                    UIService.showStatus("El carrito está vacío", "error");
                    return;
                }
                
                const equipo = document.getElementById('equipo').value.trim();
                const cliente = document.getElementById('cliente').value.trim();
                const fechaVenta = document.getElementById('fecha-venta').value;
                
                try {
                    // Validar datos antes de procesar
                    this.validateSaleData(equipo, cliente, fechaVenta);
                    
                    const finalCliente = cliente || `Equipo ${equipo}`;
                    const finalEquipo = equipo || '0000';
                    
                    // Pedir confirmación para ventas con total alto
                    const totalVenta = AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                    if (totalVenta > 1000) {
                        const confirmacion = confirm(`¿Está seguro de guardar esta venta por $${totalVenta.toFixed(2)}?`);
                        if (!confirmacion) {
                            return;
                        }
                    }
                    
                    const invoiceNumber = await this.generateInvoiceNumber();
                    
                    const saleData = {
                        invoiceNumber: invoiceNumber,
                        equipoNumber: finalEquipo,
                        clientName: finalCliente,
                        products: AppState.cart.map(item => ({
                            id: item.id,
                            codigo: item.codigo,
                            descripcion: item.descripcion,
                            precio: item.precio,
                            cantidad: item.cantidad
                        })),
                        total: totalVenta,
                        paymentType: paymentType,
                        timestamp: new Date(),
                        date: fechaVenta,
                        status: paymentType === 'contado' ? 'pagado' : 'pendiente'
                    };

                    if (paymentType === 'pendiente') {
                        saleData.saldoPendiente = saleData.total;
                        saleData.abonos = [];
                    }
                    
                    await DataService.saveSale(saleData);
                    
                    this.printTicket(saleData);
                    
                    UIService.showStatus(`Venta ${paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE'} procesada - Factura #${saleData.invoiceNumber}`, "success");
                    
                    // Limpiar formulario
                    AppState.cart = [];
                    UIService.updateCartDisplay();
                    document.getElementById('equipo').value = '';
                    document.getElementById('cliente').value = '';
                    document.getElementById('buscar-producto').value = '';
                    
                    await ProductCache.refresh();
                    
                    await this.loadHistorial();
                    
                } catch (error) {
                    UIService.showStatus("Error al procesar la venta: " + error.message, "error");
                    console.error("Error en processSale:", error);
                }
            },

            async updateInvoice(invoiceId) {
                if (AppState.cart.length === 0) {
                    UIService.showStatus("El carrito está vacío", "error");
                    return;
                }
                
                try {
                    const ventaActual = await DataService.getSaleById(invoiceId);
                    if (!ventaActual) {
                        throw new Error("No se encontró la factura a actualizar");
                    }

                    // Validar que no haya productos con precio cero
                    const productosConPrecioCero = AppState.cart.filter(item => item.precio === 0);
                    if (productosConPrecioCero.length > 0) {
                        throw new Error("Hay productos con precio $0.00. Modifique los precios antes de actualizar.");
                    }

                    const nuevoTotal = AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                    
                    let nuevoSaldoPendiente = nuevoTotal;
                    if (ventaActual.abonos && ventaActual.abonos.length > 0) {
                        const totalAbonado = ventaActual.abonos.reduce((sum, abono) => sum + abono.monto, 0);
                        nuevoSaldoPendiente = nuevoTotal - totalAbonado;
                    }
                    
                    const saleData = {
                        products: AppState.cart.map(item => ({
                            id: item.id,
                            codigo: item.codigo,
                            descripcion: item.descripcion,
                            precio: item.precio,
                            cantidad: item.cantidad
                        })),
                        total: nuevoTotal,
                        saldoPendiente: nuevoSaldoPendiente,
                        timestamp: new Date()
                    };
                    
                    if (nuevoSaldoPendiente <= 0) {
                        saleData.paymentType = 'contado';
                        saleData.status = 'pagado';
                    }
                    
                    await DataService.updateSale(invoiceId, saleData);
                    
                    UIService.showStatus("Factura actualizada correctamente", "success");
                    
                    const ventaActualizada = { ...ventaActual, ...saleData };
                    this.printTicket(ventaActualizada);
                    
                    this.cancelEdit();
                    
                    await this.loadHistorial();
                    
                } catch (error) {
                    UIService.showStatus("Error al actualizar la factura: " + error.message, "error");
                }
            },

            async loadHistorial() {
                try {
                    const ventas = await DataService.loadSales(500);
                    UIService.updateHistorial(ventas);
                } catch (error) {
                    UIService.showStatus("Error al cargar historial: " + error.message, "error");
                }
            },

            async viewInvoice(invoiceId) {
                let venta;
                try {
                    venta = await DataService.getSaleById(invoiceId);
                } catch (error) {
                    venta = AppState.historial.find(v => v.id === invoiceId);
                }
                
                if (!venta) return;
                
                let productsHTML = '';
                if (venta.products && venta.products.length > 0) {
                    venta.products.forEach(product => {
                        productsHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                <div>${product.descripcion} (x${product.cantidad})</div>
                                <div>$${(product.precio * product.cantidad).toFixed(2)}</div>
                            </div>
                        `;
                    });
                }

                let abonosHTML = '';
                if (venta.abonos && venta.abonos.length > 0) {
                    abonosHTML += `<div class="abono-section">
                        <h4>Historial de Abonos:</h4>`;
                    venta.abonos.forEach(abono => {
                        const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleString('es-ES') : 'N/A';
                        abonosHTML += `
                            <div class="abono-item">
                                <div>${fechaAbono}</div>
                                <div>$${abono.monto.toFixed(2)}</div>
                            </div>
                        `;
                    });
                    abonosHTML += `</div>`;
                }

                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                const saldoInfo = venta.paymentType === 'pendiente' && saldoPendiente > 0 ? 
                    `<div class="saldo-info">
                        Saldo Pendiente: $${saldoPendiente.toFixed(2)}
                    </div>` : '';
                
                const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleString('es-ES') : 'N/A';
                
                let estadoMostrar = venta.paymentType;
                if (venta.paymentType === 'pendiente' && saldoPendiente <= 0) {
                    estadoMostrar = 'contado';
                }
                const tipo = estadoMostrar === 'contado' ? 'CONTADO' : 'PENDIENTE';
                
                const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">Factura #${venta.invoiceNumber}</h3>
                    <div class="invoice-details">
                        <strong>Grupo:</strong> ${venta.clientName || 'N/A'}<br>
                        <strong>Equipo:</strong> ${venta.equipoNumber || 'N/A'}<br>
                        <strong>Tipo:</strong> ${tipo}<br>
                        <strong>Fecha:</strong> ${fecha}<br>
                        <strong>Total:</strong> $${(venta.total || 0).toFixed(2)}
                    </div>
                    ${saldoInfo}
                    <h4 style="margin: 15px 0 10px 0;">Productos:</h4>
                    ${productsHTML || '<p>No hay productos</p>'}
                    ${abonosHTML}
                `;
                
                UIService.showInvoiceModal(modalContent);
            },

            async editInvoice(invoiceId) {
                let venta = AppState.historial.find(v => v.id === invoiceId);
                if (!venta) {
                    UIService.showStatus("No se encontró la factura para editar", "error");
                    return;
                }
                
                AppState.cart = venta.products.map(p => ({
                    id: p.id,
                    codigo: p.codigo,
                    descripcion: p.descripcion,
                    precio: p.precio,
                    cantidad: p.cantidad
                }));
                
                document.getElementById('equipo').value = venta.equipoNumber || '';
                document.getElementById('cliente').value = venta.clientName || '';
                document.getElementById('fecha-venta').value = venta.date || new Date().toISOString().split('T')[0];
                
                AppState.currentEditingInvoice = invoiceId;
                
                UIService.updateCartDisplay();
                
                document.getElementById('contado-btn').style.display = 'none';
                document.getElementById('pendiente-btn').style.display = 'none';
                
                const updateBtn = document.createElement('button');
                updateBtn.className = 'btn btn-success btn-full';
                updateBtn.id = 'update-btn';
                updateBtn.textContent = 'ACTUALIZAR FACTURA';
                updateBtn.onclick = () => this.updateInvoice(invoiceId);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-danger';
                cancelBtn.style.marginTop = '10px';
                cancelBtn.textContent = 'CANCELAR EDICIÓN';
                cancelBtn.onclick = () => this.cancelEdit();
                
                const paymentButtons = document.querySelector('.payment-buttons');
                paymentButtons.innerHTML = '';
                paymentButtons.appendChild(updateBtn);
                paymentButtons.appendChild(cancelBtn);
                
                UIService.showStatus("Modo edición activado - Editando factura pendiente", "success");
            },

            cancelEdit() {
                AppState.cart = [];
                AppState.currentEditingInvoice = null;
                this.setTodayDate();
                UIService.updateCartDisplay();
                document.getElementById('equipo').value = '';
                document.getElementById('cliente').value = '';
                document.getElementById('buscar-producto').value = '';
                
                UIService.restorePaymentButtons();
                
                UIService.showStatus("Edición cancelada", "info");
            },

            async deleteInvoice(invoiceId) {
                if (!confirm("¿Está seguro de eliminar esta factura? Esta acción no se puede deshacer.")) return;
                
                try {
                    await DataService.deleteSale(invoiceId);
                    UIService.showStatus("Factura eliminada correctamente", "success");
                    await this.loadHistorial();
                } catch (error) {
                    UIService.showStatus("Error al eliminar factura: " + error.message, "error");
                }
            },

            async cancelInvoice(invoiceId) {
                if (!confirm("¿Está seguro de cancelar esta factura? Se cambiará el estado a CONTADO.")) return;
                
                try {
                    await DataService.cancelInvoice(invoiceId);
                    UIService.showStatus("Factura cancelada correctamente", "success");
                    await this.loadHistorial();
                } catch (error) {
                    UIService.showStatus("Error al cancelar factura: " + error.message, "error");
                }
            },

            async reprintInvoice(invoiceId) {
                let venta;
                try {
                    venta = await DataService.getSaleById(invoiceId);
                } catch (error) {
                    venta = AppState.historial.find(v => v.id === invoiceId);
                }
                
                if (venta) {
                    this.printTicket(venta);
                    UIService.showStatus("Ticket reimpreso", "success");
                }
            },

            async registrarAbono(invoiceId) {
                let venta;
                try {
                    venta = await DataService.getSaleById(invoiceId);
                } catch (error) {
                    venta = AppState.historial.find(v => v.id === invoiceId);
                }
                
                if (!venta) return;
                
                AppState.currentAbonoInvoice = venta;
                
                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                
                const modalContent = `
                    <div class="invoice-details">
                        <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                        <strong>Grupo:</strong> ${venta.clientName}<br>
                        <strong>Total:</strong> $${venta.total.toFixed(2)}<br>
                        <strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}
                    </div>
                `;
                
                UIService.showAbonoModal(modalContent);
            },

            async processAbono() {
                const montoInput = document.getElementById('monto-abono');
                const monto = parseFloat(montoInput.value);
                
                if (!monto || monto <= 0) {
                    UIService.showStatus("Ingrese un monto válido", "error");
                    return;
                }
                
                const venta = AppState.currentAbonoInvoice;
                if (!venta) {
                    UIService.showStatus("No hay factura seleccionada para el abono", "error");
                    return;
                }
                
                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                
                if (monto > saldoPendiente) {
                    UIService.showStatus("El monto del abono no puede ser mayor al saldo pendiente", "error");
                    return;
                }
                
                try {
                    const abonoData = {
                        monto: monto,
                        fecha: new Date(),
                        fechaString: new Date().toLocaleString('es-ES')
                    };
                    
                    await DataService.addAbono(venta.id, abonoData);
                    
                    this.printAbonoTicket(venta, abonoData, saldoPendiente - monto);
                    
                    UIService.showStatus(`Abono de $${monto.toFixed(2)} registrado correctamente`, "success");
                    
                    closeAbonoModal();
                    
                    const ventaActualizada = await DataService.getSaleById(venta.id);
                    if (ventaActualizada) {
                        const indexHistorial = AppState.historial.findIndex(v => v.id === venta.id);
                        if (indexHistorial !== -1) {
                            AppState.historial[indexHistorial] = ventaActualizada;
                        }
                        
                        UIService.updateHistorial(AppState.historial);
                    }
                    
                } catch (error) {
                    UIService.showStatus("Error al procesar abono: " + error.message, "error");
                }
            },

            async printCurrentHistorial() {
                const ventas = AppState.filteredHistorial;
                
                if (ventas.length === 0) {
                    UIService.showStatus("No hay ventas para imprimir", "warning");
                    return;
                }
                
                this.printHistorialReport(ventas, 'HISTORIAL ACTUAL');
            },

            printHistorialReport(ventas, titulo) {
                const printWindow = window.open('', '_blank');
                
                let totalContado = 0;
                let totalPendiente = 0;
                let totalAbonos = 0;
                let ventasContado = 0;
                let ventasPendiente = 0;
                let ventasConAbonos = 0;
                
                ventas.forEach(venta => {
                    if (venta.paymentType === 'contado') {
                        totalContado += venta.total || 0;
                        ventasContado++;
                    } else {
                        totalPendiente += venta.total || 0;
                        ventasPendiente++;
                        
                        if (venta.abonos && venta.abonos.length > 0) {
                            ventasConAbonos++;
                            venta.abonos.forEach(abono => {
                                totalAbonos += abono.monto;
                            });
                        }
                    }
                });
                
                const fechaActual = new Date().toLocaleDateString('es-ES');
                
                let reportHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${titulo}</title>
                        <style>
                            body { 
                                font-family: 'Arial', sans-serif; 
                                font-size: 12px; 
                                margin: 0;
                                padding: 15px;
                                color: #000;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 20px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 10px;
                            }
                            .header h1 {
                                font-size: 24px;
                                margin: 10px 0;
                                color: #2c3e50;
                            }
                            .header h2 {
                                font-size: 18px;
                                margin: 8px 0;
                                color: #34495e;
                            }
                            .header h3 {
                                font-size: 14px;
                                margin: 5px 0;
                                color: #7f8c8d;
                            }
                            .table-container {
                                width: 100%;
                                margin-bottom: 20px;
                            }
                            .ventas-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 15px 0;
                                font-size: 11px;
                            }
                            .ventas-table th {
                                background: #2c3e50;
                                color: white;
                                padding: 10px 8px;
                                text-align: left;
                                font-weight: bold;
                                border: 1px solid #34495e;
                            }
                            .ventas-table td {
                                padding: 8px;
                                border: 1px solid #ddd;
                                vertical-align: top;
                            }
                            .ventas-table tr:nth-child(even) {
                                background: #f8f9fa;
                            }
                            .producto-item {
                                padding: 2px 0;
                                font-size: 10px;
                            }
                            .contado-badge {
                                background: #27ae60;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .pendiente-badge {
                                background: #f39c12;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .resumen-section {
                                margin-top: 25px;
                                padding: 15px;
                                background: #e8f4fd;
                                border-radius: 8px;
                                border: 1px solid #b8daff;
                            }
                            .resumen-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr 1fr;
                                gap: 15px;
                                margin-top: 10px;
                            }
                            .resumen-item {
                                text-align: center;
                                padding: 10px;
                                background: white;
                                border-radius: 6px;
                                border: 1px solid #dee2e6;
                            }
                            .resumen-valor {
                                font-size: 18px;
                                font-weight: bold;
                                color: #2c3e50;
                                margin-top: 5px;
                            }
                            .page-break {
                                page-break-before: always;
                            }
                            @page {
                                size: A4 landscape;
                                margin: 1cm;
                            }
                            .footer {
                                text-align: center;
                                margin-top: 20px;
                                padding-top: 10px;
                                border-top: 1px solid #ddd;
                                font-size: 10px;
                                color: #7f8c8d;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>TALLER WILIAN</h1>
                            <h2>HISTORIAL DE VENTAS ${fechaActual}</h2>
                        </div>
                `;
                
                reportHTML += `
                    <div class="table-container">
                        <table class="ventas-table">
                            <thead>
                                <tr>
                                    <th width="40%">Productos (completos)</th>
                                    <th width="10%">Factura</th>
                                    <th width="8%">Equipo</th>
                                    <th width="10%">Total</th>
                                    <th width="8%">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                ventas.forEach((venta, index) => {
                    if (index > 0 && index % 20 === 0) {
                        reportHTML += `</tbody></table></div><div class="page-break"></div><div class="table-container"><table class="ventas-table"><thead><tr><th width="40%">Productos (completos)</th><th width="10%">Factura</th><th width="8%">Equipo</th><th width="10%">Total</th><th width="8%">Estado</th></tr></thead><tbody>`;
                    }
                    
                    const tipoBadge = venta.paymentType === 'contado' ? 'contado-badge' : 'pendiente-badge';
                    const tipoText = venta.paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE';
                    
                    let productosHTML = '';
                    if (venta.products && venta.products.length > 0) {
                        venta.products.forEach(producto => {
                            productosHTML += `
                                <div class="producto-item">
                                    • ${producto.descripcion} x${producto.cantidad} - $${(producto.precio * producto.cantidad).toFixed(2)}
                                </div>
                            `;
                        });
                    }
                    
                    reportHTML += `
                        <tr>
                            <td>${productosHTML || 'Sin productos'}</td>
                            <td><strong>${venta.invoiceNumber || 'N/A'}</strong></td>
                            <td>${venta.equipoNumber || 'N/A'}</td>
                            <td>$${(venta.total || 0).toFixed(2)}</td>
                            <td><span class="${tipoBadge}">${tipoText}</span></td>
                        </tr>
                    `;
                });
                
                reportHTML += `</tbody></table></div>`;
                
                let abonosHTML = '';
                const ventasConAbonosList = ventas.filter(venta => 
                    venta.abonos && venta.abonos.length > 0
                );
                
                if (ventasConAbonosList.length > 0) {
                    abonosHTML += `
                        <div class="page-break"></div>
                        <div class="header">
                            <h2>HISTORIAL DE ABONOS ${fechaActual}</h2>
                        </div>
                        <div class="table-container">
                            <table class="ventas-table">
                                <thead>
                                    <tr>
                                        <th width="15%">Fecha</th>
                                        <th width="10%">Equipo</th>
                                        <th width="15%">Total</th>
                                        <th width="15%">Abono</th>
                                        <th width="15%">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    ventasConAbonosList.forEach(venta => {
                        const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                        const totalAbonado = venta.abonos.reduce((sum, abono) => sum + abono.monto, 0);
                        
                        abonosHTML += `
                            <tr>
                                <td>${new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES')}</td>
                                <td>${venta.equipoNumber || 'N/A'}</td>
                                <td>$${venta.total.toFixed(2)}</td>
                                <td>$${totalAbonado.toFixed(2)}</td>
                                <td>$${saldoPendiente.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    abonosHTML += `</tbody></table></div>`;
                }
                
                reportHTML += abonosHTML;
                
                reportHTML += `
                    <div class="resumen-section">
                        <h3 style="margin: 0 0 15px 0; text-align: center; color: #2c3e50;">RESUMEN</h3>
                        <div class="resumen-grid">
                            <div class="resumen-item">
                                <div>VENTAS AL CONTADO</div>
                                <div class="resumen-valor">$${totalContado.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${ventasContado} ventas</div>
                            </div>
                            <div class="resumen-item">
                                <div>ABONOS</div>
                                <div class="resumen-valor">$${totalAbonos.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${ventasConAbonos} ventas</div>
                            </div>
                            <div class="resumen-item">
                                <div>VENTAS PENDIENTES</div>
                                <div class="resumen-valor">$${totalPendiente.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${ventasPendiente} ventas</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div>Documento generado automáticamente por el Sistema de Ventas Taller Wilian</div>
                        <div>Fecha de impresión: ${new Date().toLocaleString('es-ES')}</div>
                    </div>
                `;
                
                reportHTML += `</body></html>`;
                
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    UIService.showStatus("Historial enviado a impresión", "success");
                }, 500);
            },

            printTicket(saleData) {
                const printWindow = window.open('', '_blank');
                const fecha = saleData.timestamp ? new Date(saleData.timestamp.toDate ? saleData.timestamp.toDate() : saleData.timestamp) : new Date();
                const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
                
                const saldoPendiente = saleData.saldoPendiente !== undefined ? saleData.saldoPendiente : saleData.total;
                const tieneAbonos = saleData.abonos && saleData.abonos.length > 0;
                const tipoPago = saleData.paymentType === 'pendiente' ? 'PENDIENTE' : 'CONTADO';
                
                let abonosHTML = '';
                if (tieneAbonos) {
                    saleData.abonos.forEach(abono => {
                        const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
                        abonosHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 20px; margin: 2px 0;">
                                <div>ABONO: $${abono.monto.toFixed(2)} (${fechaAbono})</div>
                            </div>
                        `;
                    });
                }
                
                let productosHTML = '';
                if (saleData.products && saleData.products.length > 0) {
                    saleData.products.forEach(producto => {
                        const descripcion = producto.descripcion.length > 25 ? producto.descripcion.substring(0, 25) + '...' : producto.descripcion;
                        productosHTML += `
                            <div style="margin: 4px 0;">
                                <div style="font-size: 20px;">• ${descripcion}</div>
                                <div style="display: flex; justify-content: space-between; font-size: 18px;">
                                    <div>x${producto.cantidad}</div>
                                    <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="border-bottom: 1px dotted #000; margin: 2px 0;"></div>
                        `;
                    });
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket #${saleData.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILIAN</h3>
                            <div class="small-text">Factura: ${saleData.invoiceNumber}</div>
                            <div class="small-text">${fechaFormateada}, ${tipoPago}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Grupo:</strong> ${saleData.clientName}<br>
                            <strong>Equipo:</strong> ${saleData.equipoNumber}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 8px 0;">
                            ${productosHTML}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total large-text">
                            TOTAL: $${saleData.total.toFixed(2)}
                        </div>

                        ${abonosHTML}

                        ${saleData.paymentType === 'pendiente' && saldoPendiente > 0 ? `
                            <div class="saldo-info">
                                <div>SALDO PENDIENTE:</div>
                                <div class="large-text">$${saldoPendiente.toFixed(2)}</div>
                            </div>
                        ` : ''}
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            },

            printAbonoTicket(venta, abonoData, nuevoSaldo) {
                const printWindow = window.open('', '_blank');
                const fechaAbono = abonoData.fecha ? new Date(abonoData.fecha.toDate ? abonoData.fecha.toDate() : abonoData.fecha) : new Date();
                const fechaFormateada = fechaAbono.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Abono #${venta.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .abono-detail { 
                                margin: 8px 0;
                                font-size: 20px;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILIAN</h3>
                            <div class="small-text">COMPROBANTE DE ABONO</div>
                            <div class="small-text">${fechaFormateada}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                            <strong>Grupo:</strong> ${venta.clientName}<br>
                            <strong>Equipo:</strong> ${venta.equipoNumber}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="abono-detail">
                            <div style="text-align: center; font-size: 24px; margin: 10px 0;">
                                MONTO DEL ABONO
                            </div>
                            <div style="text-align: center; font-size: 28px; font-weight: bold;">
                                $${abonoData.monto.toFixed(2)}
                            </div>
                        </div>

                        <div class="saldo-info">
                            <div>SALDO ANTERIOR: $${(venta.saldoPendiente || venta.total).toFixed(2)}</div>
                            <div>NUEVO SALDO: $${nuevoSaldo.toFixed(2)}</div>
                        </div>
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            },

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fecha-venta').value = today;
                
                // Verificar si la fecha es futura y mostrar advertencia
                const fechaInput = document.getElementById('fecha-venta');
                const fechaSeleccionada = new Date(fechaInput.value);
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                if (fechaSeleccionada > hoy) {
                    fechaInput.classList.add('date-warning');
                } else {
                    fechaInput.classList.remove('date-warning');
                }
            }
        };

        const App = {
            async init() {
                try {
                    await this.initializeFirebase();
                    this.setupUI();
                    await this.loadInitialData();
                    this.setupEventListeners();
                    ConnectionManager.initialize();
                    UIService.showStatus("Sistema optimizado inicializado correctamente", "success");
                } catch (error) {
                    console.error("Error en inicialización:", error);
                    UIService.showStatus("Error al inicializar: " + error.message, "error");
                }
            },

            async initializeFirebase() {
                try {
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(CONFIG.firebase);
                    }
                    AppState.db = firebase.firestore();
                    
                    // Configurar persistencia offline
                    await AppState.db.enablePersistence()
                        .catch((err) => {
                            if (err.code == 'failed-precondition') {
                                console.log("Persistencia offline no disponible - Múltiples pestañas abiertas");
                            } else if (err.code == 'unimplemented') {
                                console.log("Persistencia offline no disponible - Navegador no compatible");
                            }
                        });
                    
                    AppState.firebaseInitialized = true;
                    console.log("✅ Firebase inicializado correctamente");
                } catch (error) {
                    console.error("❌ Error inicializando Firebase:", error);
                    AppState.firebaseInitialized = false;
                    UIService.showStatus("Modo offline activado", "warning");
                }
            },

            setupUI() {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES');
                SalesService.setTodayDate();
                
                // Configurar pestañas
                UIService.setupTabs();
            },

            async loadInitialData() {
                try {
                    await ProductCache.initialize();
                    
                    AppState.saleCounter = await DataService.getSaleCounter();
                    
                    await SalesService.loadHistorial();
                    
                    await GrupoManager.initialize();
                    
                    console.log("✅ Datos iniciales cargados correctamente");
                } catch (error) {
                    console.error("❌ Error cargando datos iniciales:", error);
                }
            },

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('search-dropdown').style.display = 'none';
                    }
                });

                const searchInput = document.getElementById('buscar-producto');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length < 2) {
                        document.getElementById('search-dropdown').style.display = 'none';
                        return;
                    }
                    
                    searchTimeout = setTimeout(async () => {
                        try {
                            AppState.searchResults = await DataService.searchProducts(query);
                            UIService.showSearchResults(AppState.searchResults);
                        } catch (error) {
                            document.getElementById('search-dropdown').style.display = 'none';
                        }
                    }, 500);
                });

                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = searchInput.value.trim();
                        if (query) {
                            SalesService.addManualProduct(query);
                            searchInput.value = '';
                        }
                        document.getElementById('search-dropdown').style.display = 'none';
                    }
                });

                document.getElementById('equipo').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value.length > 4) {
                        e.target.value = e.target.value.substring(0, 4);
                    }
                });

                // Validar fecha en tiempo real
                document.getElementById('fecha-venta').addEventListener('change', function() {
                    SalesService.setTodayDate();
                });

                document.getElementById('contado-btn').addEventListener('click', () => {
                    SalesService.processSale('contado');
                });

                document.getElementById('pendiente-btn').addEventListener('click', () => {
                    SalesService.processSale('pendiente');
                });

                document.getElementById('filter-historial').addEventListener('input', (e) => {
                    const filter = e.target.value;
                    if (filter === '') {
                        UIService.applyCurrentFilter();
                        return;
                    }
                    
                    const filtered = AppState.historial.filter(venta => {
                        const equipo = venta.equipoNumber || '';
                        return equipo.includes(filter);
                    });
                    
                    const historialBody = document.getElementById('historial-body');
                    
                    if (filtered.length === 0) {
                        historialBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="empty-cart">No hay ventas para el equipo ${filter}</td>
                            </tr>
                        `;
                    } else {
                        AppState.filteredHistorial = filtered;
                        UIService.renderHistorial();
                    }
                });

                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        AppState.currentFilter = e.target.dataset.filter;
                        UIService.updateFilterButtons();
                        UIService.applyCurrentFilter();
                    });
                });

                document.getElementById('print-historial-btn').addEventListener('click', () => {
                    SalesService.printCurrentHistorial();
                });

                document.getElementById('refresh-cache-btn').addEventListener('click', () => {
                    ProductCache.refresh();
                });

                document.getElementById('close-invoice-modal').addEventListener('click', () => {
                    document.getElementById('invoice-modal').style.display = 'none';
                });

                document.getElementById('process-abono-btn').addEventListener('click', () => {
                    SalesService.processAbono();
                });

                document.getElementById('close-abono-modal').addEventListener('click', () => {
                    document.getElementById('abono-modal').style.display = 'none';
                    AppState.currentAbonoInvoice = null;
                });

                document.getElementById('crear-grupo-btn').addEventListener('click', () => {
                    UIService.showCrearGrupoModal();
                });

                document.getElementById('guardar-grupo-btn').addEventListener('click', async () => {
                    const nombre = document.getElementById('nombre-grupo').value.trim();
                    if (!nombre) {
                        UIService.showStatus("Ingrese un nombre para el grupo", "error");
                        return;
                    }

                    if (AppState.equiposSeleccionados.size === 0) {
                        UIService.showStatus("Seleccione al menos un equipo", "error");
                        return;
                    }

                    try {
                        const equiposArray = Array.from(AppState.equiposSeleccionados);
                        await GrupoManager.crearGrupo(nombre, equiposArray);
                        UIService.showStatus(`Grupo "${nombre}" creado correctamente`, "success");
                        document.getElementById('crear-grupo-modal').style.display = 'none';
                    } catch (error) {
                        UIService.showStatus("Error al crear grupo: " + error.message, "error");
                    }
                });

                document.getElementById('cancelar-grupo-btn').addEventListener('click', () => {
                    document.getElementById('crear-grupo-modal').style.display = 'none';
                });

                document.getElementById('actualizar-grupo-btn').addEventListener('click', () => {
                    GrupoManager.actualizarGrupoDesdeModal();
                });

                document.getElementById('cancelar-editar-grupo-btn').addEventListener('click', () => {
                    document.getElementById('editar-grupo-modal').style.display = 'none';
                    GrupoManager.currentEditingGroup = null;
                    AppState.equiposEditSeleccionados.clear();
                });

                document.getElementById('close-detalle-modal').addEventListener('click', () => {
                    document.getElementById('detalle-modal').style.display = 'none';
                });

                document.getElementById('imprimir-detalle-modal').addEventListener('click', () => {
                    const detalle = AppState.currentDetalle;
                    if (detalle && detalle.tipo === 'equipo') {
                        const equipo = GrupoManager.equiposPendientes.get(detalle.data);
                        if (equipo) {
                            equipo.facturas.forEach(factura => {
                                GrupoManager.imprimirTicketFactura(factura, equipo);
                            });
                        }
                    }
                });

                document.getElementById('close-grupo-detalle-modal').addEventListener('click', () => {
                    document.getElementById('grupo-detalle-modal').style.display = 'none';
                    GrupoManager.currentGrupoDetalle = null;
                });

                document.getElementById('imprimir-grupo-detalle-modal').addEventListener('click', () => {
                    GrupoManager.imprimirGrupoCompleto();
                });
            }
        };

        // Funciones globales para los event listeners
        GrupoManager.toggleEquipoGrid = function(equipoNum, modalType = 'crear') {
            const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;
            
            if (selectedSet.has(equipoNum)) {
                selectedSet.delete(equipoNum);
            } else {
                if (selectedSet.size >= 130) {
                    UIService.showStatus("Máximo 130 equipos permitidos", "error");
                    return;
                }
                selectedSet.add(equipoNum);
            }
            
            this.actualizarListaSeleccionados(modalType);
            this.actualizarGridSeleccion(modalType);
        };

        GrupoManager.eliminarGrupo = async function(grupoId) {
            if (!confirm("¿Está seguro de eliminar este grupo? Los equipos volverán a estar disponibles individualmente.")) {
                return;
            }

            try {
                await this.eliminarGrupo(grupoId);
                UIService.showStatus("Grupo eliminado correctamente", "success");
                this.updateUI();
            } catch (error) {
                UIService.showStatus("Error al eliminar grupo: " + error.message, "error");
            }
        };

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        function closeAbonoModal() {
            document.getElementById('abono-modal').style.display = 'none';
            AppState.currentAbonoInvoice = null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
    </script>
</body>
</html>
