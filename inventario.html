<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Taller Wilian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f5f7fa;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, #4a5568, #718096);
            --card-bg: white;
            --border-color: #e2e8f0;
            --hover-color: #f7fafc;
            --success-color: #38a169;
            --danger-color: #e53e3e;
            --warning-color: #d69e2e;
            --info-color: #3182ce;
            --light-gray: #edf2f7;
            --medium-gray: #e2e8f0;
            --dark-gray: #4a5568;
        }

        .dark-mode {
            --bg-color: #2d3748;
            --text-color: #e2e8f0;
            --header-bg: linear-gradient(135deg, #2d3748, #4a5568);
            --card-bg: #4a5568;
            --border-color: #718096;
            --hover-color: #4a5568;
            --light-gray: #4a5568;
            --medium-gray: #718096;
            --dark-gray: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.4;
            /* Reducido de 1.6 */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--header-bg);
            color: white;
            padding: 15px 0;
            /* Reducido de 20px */
            border-radius: 10px;
            margin-bottom: 20px;
            /* Reducido de 30px */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        header h1 {
            text-align: center;
            font-size: 2rem;
            /* Reducido de 2.2rem */
            margin-bottom: 8px;
            /* Reducido de 10px */
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 0.85rem;
            /* Reducido de 0.9rem */
            opacity: 0.9;
        }

        .theme-toggle {
            position: absolute;
            top: 15px;
            /* Reducido de 20px */
            right: 15px;
            /* Reducido de 20px */
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            /* Reducido de 40px */
            height: 35px;
            /* Reducido de 40px */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            /* Reducido de 1.2rem */
        }

        .controls {
            display: flex;
            gap: 12px;
            /* Reducido de 15px */
            margin-bottom: 15px;
            /* Reducido de 20px */
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 280px;
            /* Reducido de 300px */
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            /* Reducido de 10px 15px */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95rem;
            /* Reducido de 1rem */
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .btn {
            padding: 8px 16px;
            /* Reducido de 10px 20px */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .btn-primary {
            background-color: var(--dark-gray);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2d3748;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #2f855a;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c53030;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #b7791f;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #2b6cb0;
        }

        .inventory-list {
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            /* Reducido de 30px */
        }

        .list-header {
            display: grid;
            grid-template-columns: 1fr 1.8fr 1.2fr 0.6fr 0.8fr 0.8fr;
            padding: 10px 12px;
            /* Reducido de 12px 15px */
            background-color: var(--dark-gray);
            color: white;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            /* Reducido de 0.9rem */
        }

        .list-item {
            display: grid;
            grid-template-columns: 1fr 1.8fr 1.2fr 0.6fr 0.8fr 0.8fr;
            padding: 8px 12px;
            /* Reducido de 12px 15px */
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            min-height: 45px;
            /* Añadido para mantener altura mínima */
        }

        .list-item:hover {
            background-color: var(--hover-color);
        }

        .low-stock-row {
            background-color: rgba(229, 62, 62, 0.15) !important;
        }

        .low-stock-row:hover {
            background-color: rgba(229, 62, 62, 0.25) !important;
        }

        .number-cell {
            text-align: center;
        }

        .editable-cell {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--medium-gray);
            border-radius: 3px;
            padding: 4px;
            /* Reducido de 5px */
            min-width: 70px;
            /* Reducido de 80px */
        }

        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text-color);
            text-align: center;
            font-size: 0.85rem;
            /* Reducido de 0.9rem */
        }

        .actions {
            display: flex;
            gap: 4px;
            /* Reducido de 5px */
            justify-content: center;
        }

        .actions button {
            padding: 6px;
            /* Reducido de 8px */
            border-radius: 4px;
            /* Reducido de 5px */
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            /* Reducido para botones más pequeños */
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: #212529;
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .credit-fiscal-btn {
            background-color: var(--info-color);
            color: white;
        }

        .stock-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            /* Reducido de 5px */
        }

        .stock-btn {
            width: 26px;
            /* Reducido de 30px */
            height: 26px;
            /* Reducido de 30px */
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            /* Reducido para botones más pequeños */
        }

        .decrease-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .increase-btn {
            background-color: var(--success-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 25px;
            color: var(--dark-gray);
            font-size: 1.7rem;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .form-row {
            display: flex;
            gap: 18px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
        }

        .floating-notification {
            position: fixed;
            top: 15px;
            /* Reducido de 20px */
            right: 15px;
            /* Reducido de 20px */
            padding: 12px 20px;
            /* Reducido de 15px 25px */
            border-radius: 5px;
            color: white;
            z-index: 1001;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            max-width: 280px;
            /* Reducido de 300px */
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .floating-notification.success {
            background-color: var(--success-color);
        }

        .floating-notification.error {
            background-color: var(--danger-color);
        }

        .loading {
            text-align: center;
            padding: 15px;
            /* Reducido de 20px */
            font-size: 1.1rem;
            /* Reducido de 1.2rem */
            color: var(--dark-gray);
        }

        .order-form {
            margin-bottom: 15px;
            /* Reducido de 20px */
        }

        .order-input-group {
            display: flex;
            gap: 8px;
            /* Reducido de 10px */
            margin-bottom: 12px;
            /* Reducido de 15px */
        }

        .order-input-group input {
            padding: 8px;
            /* Reducido de 10px */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .order-input-group input:focus {
            outline: 2px solid var(--dark-gray);
        }

        .code-input {
            flex: 2;
        }

        .quantity-input {
            flex: 1;
        }

        .price-input {
            flex: 1;
        }

        .current-product {
            background-color: rgba(74, 85, 104, 0.1);
            padding: 8px;
            /* Reducido de 10px */
            border-radius: 5px;
            margin-bottom: 12px;
            /* Reducido de 15px */
            border-left: 4px solid var(--dark-gray);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .order-items-container {
            max-height: 250px;
            /* Reducido de 300px */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px;
            /* Reducido de 10px */
            margin-bottom: 12px;
            /* Reducido de 15px */
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            /* Reducido de 8px */
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-actions {
            display: flex;
            gap: 8px;
            /* Reducido de 10px */
        }

        .remove-order-item {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            /* Reducido de 5px 10px */
            cursor: pointer;
            font-size: 0.8rem;
            /* Reducido para botón más pequeño */
        }

        .order-summary {
            background-color: rgba(56, 161, 105, 0.1);
            padding: 12px;
            /* Reducido de 15px */
            border-radius: 5px;
            border-left: 4px solid var(--success-color);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .bulk-order-section {
            margin-top: 15px;
            /* Reducido de 20px */
            padding: 12px;
            /* Reducido de 15px */
            background-color: var(--light-gray);
            border-radius: 5px;
        }

        .bulk-order-section h3 {
            margin-bottom: 8px;
            /* Reducido de 10px */
            color: var(--dark-gray);
            font-size: 1.1rem;
            /* Reducido de 1.3rem */
        }

        .file-input-container {
            margin-bottom: 8px;
            /* Reducido de 10px */
        }

        .file-input-container input {
            width: 100%;
            padding: 6px;
            /* Reducido de 8px */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            /* Reducido de 10px */
            margin-bottom: 12px;
            /* Reducido de 15px */
            align-items: center;
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        .sort-controls select {
            padding: 6px 10px;
            /* Reducido de 8px 12px */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            /* Reducido de 1rem */
        }

        footer {
            text-align: center;
            margin-top: 20px;
            /* Reducido de 30px */
            padding: 15px;
            /* Reducido de 20px */
            color: var(--medium-gray);
            font-size: 0.85rem;
            /* Reducido de 0.9rem */
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: 100%;
            }

            .actions {
                flex-direction: column;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr;
                gap: 4px;
                /* Reducido de 5px */
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .order-input-group {
                flex-direction: column;
            }

            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Estilos Conciliación Inteligente */
        .conciliation-modal {
            max-width: 95% !important;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .conciliation-step {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .conciliation-step.active {
            display: flex;
        }

        .conciliation-table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin: 15px 0;
            background: var(--card-bg);
        }

        .conciliation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .conciliation-table th {
            position: sticky;
            top: 0;
            background: var(--dark-gray);
            color: white;
            z-index: 10;
            padding: 10px;
            text-align: left;
        }

        .conciliation-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        /* Estados de fila */
        .status-new {
            border-left: 5px solid #3498db !important;
            background: rgba(52, 152, 219, 0.05);
        }

        .status-match {
            border-left: 5px solid #2ecc71 !important;
            background: rgba(46, 204, 113, 0.05);
        }

        .status-fuzzy {
            border-left: 5px solid #f1c40f !important;
            background: rgba(241, 196, 15, 0.1);
        }

        .status-conflict {
            border-left: 5px solid #e74c3c !important;
            background: rgba(231, 76, 60, 0.1);
        }

        .diff-old {
            color: #e74c3c;
            font-size: 0.8em;
            text-decoration: line-through;
            display: block;
        }

        .diff-new {
            color: #27ae60;
            font-weight: bold;
        }

        .action-cell {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .match-score {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #eee;
            color: #555;
            display: inline-block;
            margin-top: 4px;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .step-indicator {
            flex: 1;
            text-align: center;
            color: var(--medium-gray);
            font-weight: bold;
            position: relative;
        }

        .step-indicator.active {
            color: var(--info-color);
        }

        .step-indicator.done {
            color: var(--success-color);
        }

        /* Estilos para Tabla de Entrada y Sugerencias */
        .entry-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .entry-table th {
            background-color: var(--medium-gray);
            padding: 8px;
            text-align: left;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .entry-table td {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .entry-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }

        .entry-footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
        }

        .entry-totals {
            text-align: right;
            font-size: 1.1em;
        }

        .search-helper-btn {
            background: none;
            border: none;
            color: var(--info-color);
            cursor: pointer;
        }

        .suggestions-box {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ccc;
            z-index: 1000;
            width: 100%;
            min-width: 250px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 5px 5px;
        }

        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: #e2e8f0;
        }

        .suggestion-code {
            font-weight: bold;
            color: var(--dark-gray);
        }

        .suggestion-desc {
            color: #555;
        }

        .suggestion-price {
            color: var(--success-color);
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>Inventario Taller Wilian</h1>
            <div class="header-info">
                <span>Fecha: <span id="current-date"></span></span>
                <span>Total de productos: <span id="total-products">0</span></span>
            </div>
        </header>

        <div class="floating-notification" id="floating-notification"></div>

        <!-- Modal Registrar Entrada (Factura) - MOVIDO AQUÍ PARA EVITAR CONFLICTOS -->
        <div class="modal" id="entry-modal" style="display: none; z-index: 3000;">
            <div class="modal-content" style="max-width: 900px;">
                <h2>Registrar Entrada de Inventario</h2>

                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="entry-has-iva" onchange="calculateEntryTotals()"
                            style="width: 20px; height: 20px;">
                        <label for="entry-has-iva" style="font-weight: bold; cursor: pointer;">Precios incluyen IVA
                            (+13%)</label>
                    </div>
                    <div>
                        <!-- Botón JSON eliminado -->
                    </div>
                </div>

                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="entry-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">Código</th>
                                <th style="width: 35%">Descripción</th>
                                <th style="width: 10%">Cant.</th>
                                <th style="width: 15%">P. Unitario</th>
                                <th style="width: 15%">Total</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="entry-rows"></tbody>
                    </table>
                    <button class="btn btn-secondary" onclick="addEntryRow()"
                        style="margin-top: 10px; width: 100%; border: 1px dashed #ccc;">
                        <i class="fas fa-plus"></i> Agregar Fila
                    </button>
                </div>

                <div class="entry-footer">
                    <div class="form-group" style="width: 300px; margin-bottom: 0;">
                        <label>Referencia / Factura #</label>
                        <input type="text" id="entry-reference" placeholder="Ej: Factura F001-234">
                    </div>
                    <div class="entry-totals">
                        <div>Subtotal: <strong id="entry-subtotal">$0.00</strong></div>
                        <div>IVA (13%): <strong id="entry-iva">$0.00</strong></div>
                        <div style="font-size: 1.3em; color: var(--dark-gray); margin-top: 5px;">Total Compra: <strong
                                id="entry-total">$0.00</strong></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger"
                        onclick="document.getElementById('entry-modal').style.display='none'">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveEntry()">Guardar Entrada</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Buscar por código, descripción..."
                    onkeyup="filterInventory()">
            </div>
            <!-- Botones eliminados por solicitud del usuario, excepto Borrar Todo -->
            <button class="btn btn-success" onclick="openEntryModal()">
                <i class="fas fa-file-invoice"></i> Registrar Entrada
            </button>
            <!-- Restaurado: Importación de Excel -->
            <input type="file" id="hidden-import-input" accept=".xlsx, .xls, .json" style="display:none"
                onchange="importExcelNew(this)">
            <button class="btn btn-warning" id="import-excel-btn"
                onclick="document.getElementById('hidden-import-input').click()">
                <i class="fas fa-file-import"></i> Importar Excel
            </button>
            <button class="btn btn-danger" onclick="deleteAllInventory()" title="Eliminar todo el inventario">
                <i class="fas fa-trash-alt"></i> Borrar Todo
            </button>
        </div>

        <div class="sort-controls">
            <label for="sort-select">Ordenar por:</label>
            <select id="sort-select">
                <option value="description">Descripción (A-Z)</option>
                <option value="description-desc">Descripción (Z-A)</option>
                <option value="code">Código</option>
                <option value="stock">Stock</option>
            </select>
        </div>

        <div class="inventory-list">
            <div class="list-header">
                <div>Código</div>
                <div>Descripción</div>
                <div>Descripción Taller</div>

                <div style="text-align: center;">Stock</div>
                <div style="text-align: right;">Costo</div>
                <div style="text-align: right;">P. Venta</div>
            </div>
            <div id="inventory-body">
                <div class="loading">Cargando inventario...</div>
            </div>
        </div>

        <footer>
            <p>Sistema de Inventario Taller Wilian &copy; 2025</p>
        </footer>
    </div>

    <!-- Modal para agregar/editar producto -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <h2 id="modal-title">Agregar Producto</h2>
            <form id="product-form" style="display: flex; flex-direction: column; gap: 15px; padding: 10px;">
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="product-code"
                            style="font-weight: bold; display: block; margin-bottom: 5px;">Código</label>
                        <input type="text" id="product-code" required
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="product-description"
                        style="font-weight: bold; display: block; margin-bottom: 5px;">Descripción</label>
                    <input type="text" id="product-description" required
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <div class="form-group">
                    <label for="product-workshop-description"
                        style="font-weight: bold; display: block; margin-bottom: 5px;">Descripción Taller</label>
                    <textarea id="product-workshop-description" rows="2"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>

                <div class="form-group">
                    <label for="product-aliases" style="font-weight: bold; display: block; margin-bottom: 5px;">
                        Palabras Clave / Alias (Búsqueda)
                        <i class="fas fa-info-circle"
                            title="Escribe nombres alternativos separados por coma. Ejemplo: Empaque Maniful, Junta, Goma"
                            style="color: #666; cursor: help;"></i>
                    </label>
                    <input type="text" id="product-aliases" placeholder="Ej: empaque maniful, junta, goma..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fcfcfc;">
                    <small style="color: #666; font-size: 0.85em;">El buscador encontrará el producto usando cualquiera
                        de estas palabras.</small>
                </div>

                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="product-quantity"
                            style="font-weight: bold; display: block; margin-bottom: 5px;">Stock</label>
                        <input type="number" id="product-quantity" min="0" required
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="product-min-stock"
                            style="font-weight: bold; display: block; margin-bottom: 5px;">Stock Mínimo</label>
                        <input type="number" id="product-min-stock" min="0" value="10"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>

                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="product-cost" style="font-weight: bold; display: block; margin-bottom: 5px;">Precio
                            Unidad ($)</label>
                        <input type="number" id="product-cost" min="0" step="0.01"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="product-price" style="font-weight: bold; display: block; margin-bottom: 5px;">Precio
                            Venta ($)</label>
                        <input type="number" id="product-price" min="0" step="0.01"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="product-credit-fiscal"
                        style="font-weight: bold; display: block; margin-bottom: 5px;">Crédito Fiscal</label>
                    <select id="product-credit-fiscal"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="false">No</option>
                        <option value="true">Sí</option>
                    </select>
                </div>

                <div class="form-actions"
                    style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" id="cancel-btn"
                        style="padding: 10px 20px; cursor: pointer;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-btn"
                        style="padding: 10px 20px; cursor: pointer;">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ingresar pedido -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <h2>Ingresar Pedido</h2>

            <div class="order-form">
                <div class="order-input-group">
                    <input type="text" id="order-code" class="code-input"
                        placeholder="Código (escanea código de barras)" autofocus>
                    <input type="number" id="order-quantity" class="quantity-input" placeholder="Cantidad" min="1"
                        disabled>
                    <input type="number" id="order-price" class="price-input" placeholder="Precio Unitario" min="0"
                        step="0.01" disabled>
                </div>

                <div id="current-product-info" class="current-product" style="display: none;">
                    <strong>Producto encontrado:</strong>
                    <span id="product-found-info"></span>
                </div>
            </div>

            <div class="bulk-order-section">
                <h3>Ingreso Masivo de Pedidos</h3>
                <div class="file-input-container">
                    <input type="file" id="bulk-order-file" accept=".xlsx, .xls">
                </div>
                <button class="btn btn-info" id="process-bulk-order-btn">Procesar Archivo</button>
            </div>

            <h3>PEDIDO INGRESANDO</h3>
            <div class="order-items-container" id="order-items-container">
                <div style="text-align: center; padding: 15px; color: #666;">
                    No hay productos en el pedido
                </div>
            </div>

            <div class="order-summary">
                <strong>Resumen del Pedido:</strong>
                <div>Total de productos: <span id="order-total-items">0</span></div>
                <div>Total de unidades: <span id="order-total-quantity">0</span></div>
                <div>Inversión total: $<span id="order-total-cost">0.00</span></div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-danger" id="cancel-order-btn">Cancelar</button>
                <button type="button" class="btn btn-success" id="save-order-btn">Guardar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Historial (Kardex) -->
    <div class="modal" id="kardex-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="kardex-title">Historial de Movimientos</h2>
                <button onclick="document.getElementById('kardex-modal').style.display='none'"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div style="margin-bottom: 15px; display:flex; gap:10px;">
                <button id="btn-rebuild-stock" class="btn btn-warning" onclick="rebuildStockCurrent()">
                    <i class="fas fa-hammer"></i> Reconstruir Stock (Reparar)
                </button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                    <thead>
                        <tr style="background:var(--header-bg); color:white;">
                            <th style="padding:10px;">Fecha</th>
                            <th style="padding:10px;">Tipo</th>
                            <th style="padding:10px;">Cantidad</th>
                            <th style="padding:10px;">Referencia</th>
                            <th style="padding:10px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="kardex-table-body">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Entrada (Factura) -->


    <!-- Modal Smart Conciliation -->
    <div class="modal" id="smart-import-modal">
        <div class="modal-content conciliation-modal">
            <div class="stepper">
                <div class="step-indicator active" id="step-1-indicator">1. Carga de Archivo</div>
                <div class="step-indicator" id="step-2-indicator">2. Análisis y Conflictos</div>
                <div class="step-indicator" id="step-3-indicator">3. Confirmación</div>
            </div>

            <!-- PASO 1: CARGA -->
            <div class="conciliation-step active" id="step-1">
                <h2 style="text-align: center; color: #8e44ad;"><i class="fas fa-file-import"></i> Carga de
                    Inventario/Factura</h2>
                <div style="max-width: 500px; margin: 0 auto; text-align: center; padding: 40px;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-file-excel" style="font-size: 4rem; color: #27ae60;"></i>
                    </div>
                    <p style="margin-bottom: 20px;">Sube tu archivo Excel (.xlsx) o JSON de factura electrónica.</p>

                    <div class="file-input-container">
                        <input type="file" id="smart-import-file" accept=".xlsx, .xls, .json"
                            style="padding: 15px; border: 2px dashed #ccc;">
                    </div>

                    <div
                        style="text-align: left; margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="apply-iva-check" style="width: auto; margin-right: 10px;">
                            <strong>Sumar 13% IVA al Costo</strong> (Si el archivo trae precios netos)
                        </label>
                        <small style="color: #666; display: block; margin-left: 25px;">
                            Ej: Si el costo es $1.00, se guardará como $1.13
                        </small>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" id="analyze-file-btn"
                            style="width: 100%; padding: 15px; font-size: 1.1rem;">
                            ANALIZAR ARCHIVO <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PASO 2: ANÁLISIS (TABLA) -->
            <div class="conciliation-step" id="step-2">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2><i class="fas fa-glasses"></i> Revisión de Cambios</h2>
                    <div class="summary-badges">
                        <span class="badge"
                            style="background: #ebf5fb; color: #3498db; padding: 5px 10px; border-radius: 15px;">Nuevos:
                            <b id="count-new">0</b></span>
                        <span class="badge"
                            style="background: #eafaf1; color: #2ecc71; padding: 5px 10px; border-radius: 15px;">Coincidencias:
                            <b id="count-match">0</b></span>
                        <span class="badge"
                            style="background: #fef9e7; color: #f1c40f; padding: 5px 10px; border-radius: 15px;">Dudosos:
                            <b id="count-fuzzy">0</b></span>
                        <span class="badge"
                            style="background: #fdedec; color: #e74c3c; padding: 5px 10px; border-radius: 15px;">Conflictos:
                            <b id="count-conflict">0</b></span>
                    </div>
                </div>

                <div class="conciliation-table-container">
                    <table class="conciliation-table">
                        <thead>
                            <tr>
                                <th width="5%">Estado</th>
                                <th width="10%">Código (Excel)</th>
                                <th width="20%">Descripción (Excel)</th>
                                <th width="5%"><i class="fas fa-arrow-right"></i></th>
                                <th width="20%">Coincidencia Sistema</th>
                                <th width="10%">Stock Actual / Nuevo</th>
                                <th width="10%">Costo</th>
                                <th width="10%">P. Venta</th>
                                <th width="10%">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="conciliation-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="form-actions" style="justify-content: space-between;">
                    <button class="btn btn-danger" id="back-to-step-1">Atrás</button>
                    <div>
                        <span style="margin-right: 15px; font-size: 0.9rem; color: #666;">Se procesarán <b
                                id="total-to-process">0</b> filas seleccionadas</span>
                        <button class="btn btn-success" id="execute-import-btn"
                            style="background: #8e44ad; border: none;">
                            EJECUTAR IMPORTACIÓN <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PASO 3: CONFIRMACIÓN -->
            <div class="conciliation-step" id="step-3">
                <div style="text-align: center; padding: 50px;">
                    <i class="fas fa-check-circle" style="font-size: 5rem; color: #2ecc71; margin-bottom: 20px;"></i>
                    <h2 style="color: #27ae60;">¡Importación Completada!</h2>
                    <p style="font-size: 1.2rem;">Se han procesado correctamente los productos.</p>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="location.reload()">Recargar Inventario</button>
                    </div>
                </div>
            </div>

            <button class="btn-close-modal" id="close-smart-modal"
                style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
    </div>

    <!-- Modal Importación Simple -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="color: #2c3e50;"><i class="fas fa-file-excel"></i> Importar Inventario</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Sube un archivo Excel con las columnas: <br>
                <b>Codigo, Descripcion según inventario, Precio venta, Existencia, etc.</b>
            </p>

            <div class="file-input-container">
                <input type="file" id="import-excel-input" accept=".xlsx, .xls, .json"
                    style="width: 100%; border: 2px dashed #ddd; padding: 20px;">
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label style="cursor: pointer;">
                    <input type="checkbox" id="update-existing-check" checked>
                    Actualizar productos existentes (mismo Código)
                </label>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('importModal').style.display='none'">Cancelar</button>
                <button class="btn btn-success" onclick="processImport()">
                    <i class="fas fa-upload"></i> Importar Ahora
                </button>
            </div>
        </div>
    </div>




    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
            authDomain: "tallerwilliam-732b3.firebaseapp.com",
            projectId: "tallerwilliam-732b3",
            storageBucket: "tallerwilliam-732b3.firebasestorage.app",
            messagingSenderId: "822262666247",
            appId: "1:822262666247:web:6680487bbf1108006b86a2"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Referencias a elementos del DOM
        const inventoryBody = document.getElementById('inventory-body');
        const productModal = document.getElementById('product-modal');
        const orderModal = document.getElementById('order-modal');
        // const importModal = document.getElementById('import-modal'); // Eliminamos referencia vieja
        const productForm = document.getElementById('product-form');
        const modalTitle = document.getElementById('modal-title');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const addProductBtn = document.getElementById('add-product-btn');
        const orderBtn = document.getElementById('order-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const importExcelBtn = document.getElementById('import-excel-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const cancelOrderBtn = document.getElementById('cancel-order-btn');
        const saveOrderBtn = document.getElementById('save-order-btn');
        // Constantes del nuevo modal
        const simpleImportModal = document.getElementById('importModal');
        const simpleImportInput = document.getElementById('import-excel-input');
        const updateExistingCheck = document.getElementById('update-existing-check');

        const processBulkOrderBtn = document.getElementById('process-bulk-order-btn');
        const floatingNotification = document.getElementById('floating-notification');
        const totalProductsSpan = document.getElementById('total-products');
        const currentDateSpan = document.getElementById('current-date');
        const themeToggle = document.getElementById('theme-toggle');
        const orderItemsContainer = document.getElementById('order-items-container');

        // Elementos del formulario de pedido
        const orderCodeInput = document.getElementById('order-code');
        const orderQuantityInput = document.getElementById('order-quantity');
        const orderPriceInput = document.getElementById('order-price');
        const currentProductInfo = document.getElementById('current-product-info');
        const productFoundInfo = document.getElementById('product-found-info');
        const bulkOrderFileInput = document.getElementById('bulk-order-file');
        // const importFileInput = document.getElementById('import-file'); // Eliminamos referencia vieja
        // const updateExistingCheckbox = document.getElementById('update-existing'); // Eliminamos referencia vieja

        // Variables globales
        let currentEditingId = null;
        let inventoryData = [];
        let isDarkMode = false;
        let currentOrderItems = [];
        let currentProduct = null;
        let currentSort = 'description';

        // Mostrar fecha actual
        const now = new Date();
        currentDateSpan.textContent = now.toLocaleDateString('es-ES');

        // Cargar inventario al iniciar
        document.addEventListener('DOMContentLoaded', loadInventory);

        // Event Listeners
        // Event Listeners (Protegidos)
        if (addProductBtn) addProductBtn.addEventListener('click', () => openModal());
        if (orderBtn) orderBtn.addEventListener('click', () => openOrderModal());
        // Exportar e Importar ahora usan onclick en HTML para mayor robustez
        // if(exportExcelBtn) exportExcelBtn.addEventListener('click', exportToExcel);

        // Listeners de Modales
        if (cancelBtn) cancelBtn.addEventListener('click', () => closeModal());
        if (cancelOrderBtn) cancelOrderBtn.addEventListener('click', () => closeOrderModal());
        saveOrderBtn.addEventListener('click', saveOrder);
        // processImportBtn.addEventListener('click', processImport); // Eliminado por obsoleto (usa onclick)
        processBulkOrderBtn.addEventListener('click', processBulkOrder);
        productForm.addEventListener('submit', saveProduct);
        searchInput.addEventListener('input', filterInventory);
        themeToggle.addEventListener('click', toggleTheme);
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortInventory();
        });

        // Event Listeners para el formulario de pedido
        orderCodeInput.addEventListener('input', handleCodeInput);
        orderQuantityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                orderPriceInput.focus();
            }
        });
        orderPriceInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addToOrder();
            }
        });

        // Alternar modo oscuro/claro
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);

            const icon = themeToggle.querySelector('i');
            if (isDarkMode) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // Cargar inventario desde Firebase
        function loadInventory() {
            inventoryBody.innerHTML = '<div class="loading">Cargando inventario...</div>';

            db.collection('INVENTARIO').get()
                .then((querySnapshot) => {
                    inventoryData = [];
                    inventoryBody.innerHTML = '';

                    if (querySnapshot.empty) {
                        inventoryBody.innerHTML = '<div style="text-align: center; padding: 15px;">No hay productos en el inventario</div>';
                        updateTotalProducts();
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const product = doc.data();
                        product.id = doc.id;
                        inventoryData.push(product);
                    });

                    sortInventory();
                    updateTotalProducts();
                })
                .catch((error) => {
                    console.error("Error al cargar inventario: ", error);
                    showFloatingNotification("Error al cargar el inventario", "error");
                });
        }

        // Ordenar inventario
        function sortInventory() {
            const sortedData = [...inventoryData];

            switch (currentSort) {
                case 'description':
                    sortedData.sort((a, b) => (a.descripcion || '').localeCompare(b.descripcion || ''));
                    break;
                case 'description-desc':
                    sortedData.sort((a, b) => (b.descripcion || '').localeCompare(a.descripcion || ''));
                    break;
                case 'code':
                    sortedData.sort((a, b) => (a.codigo || '').localeCompare(b.codigo || ''));
                    break;

                case 'stock':
                    sortedData.sort((a, b) => (b.cantidad || 0) - (a.cantidad || 0));
                    break;
            }

            renderInventory(sortedData);
        }

        // Renderizar inventario en la lista (MODO SOLO LECTURA)
        function renderInventory(data) {
            inventoryBody.innerHTML = '';

            if (data.length === 0) {
                inventoryBody.innerHTML = '<div style="text-align: center; padding: 15px;">No hay productos en el inventario</div>';
                return;
            }

            data.forEach(product => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';

                // Opción: Doble clic para editar (función administrativa oculta)
                listItem.ondblclick = () => editProduct(product.id);
                listItem.title = "Doble clic para editar detalles";
                listItem.style.cursor = "pointer";

                // Determinar si es stock bajo
                const minStock = product.minStock || 10;
                const isLowStock = product.cantidad <= minStock;

                if (isLowStock) {
                    listItem.classList.add('low-stock-row');
                }

                listItem.innerHTML = `
                    <div style="font-weight: bold; color: var(--dark-gray);">${product.codigo || 'N/A'}</div>
                    <div style="font-weight: 500;">${product.descripcion}</div>
                    <div style="color: #666; font-size: 0.9em;">${product.descripcionTaller || '-'}</div>

                    <div style="text-align: center;">
                        <span style="font-weight: bold; font-size: 1.1em; ${isLowStock ? 'color: var(--danger-color);' : 'color: var(--dark-gray);'}">
                            ${product.cantidad}
                        </span>
                    </div>
                    <div style="text-align: right; font-family: monospace; font-size: 1em;">
                        $${(product.costo || 0).toFixed(2)}
                    </div>
                    <div style="text-align: right; font-family: monospace; font-size: 1em; font-weight: bold; color: var(--success-color);">
                        $${(product.precio || 0).toFixed(2)}
                    </div>
                `;

                inventoryBody.appendChild(listItem);
            });
        }

        // Actualizar campo individual sin recargar toda la lista
        function updateField(productId, field, value) {
            const updateData = {};
            updateData[field] = field === 'cantidad' ? parseInt(value) : parseFloat(value);

            db.collection('INVENTARIO').doc(productId).update(updateData)
                .then(() => {
                    // Actualizar solo la celda modificada en lugar de recargar toda la lista
                    const input = document.querySelector(`input[data-id="${productId}"][data-field="${field}"]`);
                    if (input) {
                        input.style.backgroundColor = 'var(--success-color)';
                        input.style.color = 'white';
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                            input.style.color = '';
                        }, 1000);
                    }

                    // Actualizar el dato en inventoryData
                    const productIndex = inventoryData.findIndex(p => p.id === productId);
                    if (productIndex !== -1) {
                        inventoryData[productIndex][field] = updateData[field];
                    }
                })
                .catch((error) => {
                    console.error(`Error al actualizar ${field}: `, error);
                    showFloatingNotification(`Error al actualizar ${field}`, "error");
                });
        }

        // Actualizar stock sin parpadeo
        function updateStock(productId, change) {
            const product = inventoryData.find(p => p.id === productId);
            if (!product) return;

            const newQuantity = Math.max(0, product.cantidad + change);

            db.collection('INVENTARIO').doc(productId).update({
                cantidad: newQuantity
            })
                .then(() => {
                    // Actualizar solo la celda de stock en lugar de recargar toda la lista
                    const stockSpan = document.querySelector(`.stock-controls button[data-id="${productId}"]`).nextElementSibling;
                    stockSpan.textContent = newQuantity;

                    // Actualizar el dato en inventoryData
                    product.cantidad = newQuantity;

                    // Actualizar clase de stock bajo si es necesario
                    const minStock = product.minStock || 10;
                    const listItem = stockSpan.closest('.list-item');

                    if (newQuantity <= minStock) {
                        listItem.classList.add('low-stock-row');
                    } else {
                        listItem.classList.remove('low-stock-row');
                    }
                })
                .catch((error) => {
                    console.error("Error al actualizar stock: ", error);
                    showFloatingNotification("Error al actualizar stock", "error");
                });
        }

        // Filtrar inventario por búsqueda
        function filterInventory() {
            const searchTerm = searchInput.value.toLowerCase();

            if (!searchTerm) {
                renderInventory(inventoryData);
                return;
            }

            const filteredData = inventoryData.filter(product => {
                // Verificar si algún alias coincide
                const hasAliasMatch = product.aliases && product.aliases.some(alias => alias.includes(searchTerm));

                return (
                    (product.codigo && product.codigo.toLowerCase().includes(searchTerm)) ||
                    (product.descripcion && product.descripcion.toLowerCase().includes(searchTerm)) ||
                    (product.descripcionTaller && product.descripcionTaller.toLowerCase().includes(searchTerm)) ||
                    hasAliasMatch
                );
            });

            renderInventory(filteredData);
        }

        // Actualizar contador de productos
        function updateTotalProducts() {
            totalProductsSpan.textContent = inventoryData.length;
        }

        // Abrir modal para agregar/editar producto
        function openModal(productId = null) {
            currentEditingId = productId;

            if (productId) {
                modalTitle.textContent = 'Editar Producto';
                const product = inventoryData.find(p => p.id === productId);

                document.getElementById('product-code').value = product.codigo || '';

                document.getElementById('product-description').value = product.descripcion || '';
                document.getElementById('product-workshop-description').value = product.descripcionTaller || '';

                // Cargar alias si existen
                const aliases = product.aliases || [];
                document.getElementById('product-aliases').value = aliases.join(', ');

                document.getElementById('product-quantity').value = product.cantidad || 0;
                document.getElementById('product-min-stock').value = product.minStock || 10;
                document.getElementById('product-cost').value = product.costo || 0;
                document.getElementById('product-price').value = product.precio || 0;
                document.getElementById('product-credit-fiscal').value = product.creditoFiscal ? 'true' : 'false';
            } else {
                modalTitle.textContent = 'Agregar Producto';
                productForm.reset();
            }

            productModal.style.display = 'flex';
        }

        // Cerrar modal de producto
        function closeModal() {
            productModal.style.display = 'none';
            currentEditingId = null;
        }

        // Guardar producto (agregar o editar)
        function saveProduct(e) {
            e.preventDefault();

            // Procesar alias: convertir string separado por comas a array
            const aliasesInput = document.getElementById('product-aliases').value || '';
            const aliasesArray = aliasesInput.split(',')
                .map(s => s.trim().toLowerCase()) // Limpiar espacios y normalizar a minúsculas
                .filter(s => s.length > 0); // Eliminar vacíos

            const productData = {
                codigo: document.getElementById('product-code').value,
                descripcion: document.getElementById('product-description').value,
                descripcionTaller: document.getElementById('product-workshop-description').value,
                aliases: aliasesArray, // Guardar array de palabras clave
                cantidad: parseInt(document.getElementById('product-quantity').value),
                minStock: parseInt(document.getElementById('product-min-stock').value),
                costo: parseFloat(document.getElementById('product-cost').value) || 0,
                precio: parseFloat(document.getElementById('product-price').value) || 0,
                creditoFiscal: document.getElementById('product-credit-fiscal').value === 'true'
            };

            if (currentEditingId) {
                // Editar producto existente
                db.collection('INVENTARIO').doc(currentEditingId).update(productData)
                    .then(() => {
                        showFloatingNotification("Producto actualizado correctamente", "success");
                        closeModal();
                        loadInventory();
                    })
                    .catch((error) => {
                        console.error("Error al actualizar producto: ", error);
                        showFloatingNotification("Error al actualizar producto", "error");
                    });
            } else {
                // Agregar nuevo producto
                db.collection('INVENTARIO').add(productData)
                    .then(() => {
                        showFloatingNotification("Producto agregado correctamente", "success");
                        closeModal();
                        loadInventory();
                    })
                    .catch((error) => {
                        console.error("Error al agregar producto: ", error);
                        showFloatingNotification("Error al agregar producto", "error");
                    });
            }
        }

        // Editar producto
        function editProduct(productId) {
            openModal(productId);
        }

        // Eliminar producto
        function deleteProduct(productId) {
            if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                db.collection('INVENTARIO').doc(productId).delete()
                    .then(() => {
                        showFloatingNotification("Producto eliminado correctamente", "success");
                        loadInventory();
                    })
                    .catch((error) => {
                        console.error("Error al eliminar producto: ", error);
                        showFloatingNotification("Error al eliminar producto", "error");
                    });
            }
        }

        // Alternar crédito fiscal
        function toggleCreditFiscal(productId) {
            const product = inventoryData.find(p => p.id === productId);
            if (!product) return;

            const newValue = !product.creditoFiscal;

            db.collection('INVENTARIO').doc(productId).update({
                creditoFiscal: newValue
            })
                .then(() => {
                    showFloatingNotification(`Crédito fiscal ${newValue ? 'activado' : 'desactivado'}`, "success");
                    loadInventory();
                })
                .catch((error) => {
                    console.error("Error al actualizar crédito fiscal: ", error);
                    showFloatingNotification("Error al actualizar crédito fiscal", "error");
                });
        }

        // Abrir modal de pedido
        function openOrderModal() {
            currentOrderItems = [];
            currentProduct = null;
            orderCodeInput.value = '';
            orderQuantityInput.value = '';
            orderPriceInput.value = '';
            orderQuantityInput.disabled = true;
            orderPriceInput.disabled = true;
            currentProductInfo.style.display = 'none';
            updateOrderItemsDisplay();
            orderModal.style.display = 'flex';
            orderCodeInput.focus();
        }

        // Cerrar modal de pedido
        function closeOrderModal() {
            orderModal.style.display = 'none';
        }

        // Manejar entrada de código en el pedido
        function handleCodeInput() {
            const code = orderCodeInput.value.trim();

            if (code.length < 3) {
                currentProductInfo.style.display = 'none';
                orderQuantityInput.disabled = true;
                orderPriceInput.disabled = true;
                return;
            }

            // Buscar producto por código, descripción o ALIAs
            const product = inventoryData.find(p => {
                const search = code.toLowerCase();
                const hasAliasMatch = p.aliases && p.aliases.some(alias => alias.includes(search));

                return (p.codigo && p.codigo.toLowerCase().includes(search)) ||
                    (p.descripcion && p.descripcion.toLowerCase().includes(search)) ||
                    hasAliasMatch;
            });

            if (product) {
                currentProduct = product;
                productFoundInfo.textContent = `${product.descripcion} - ${product.marca || 'Sin marca'}`;
                currentProductInfo.style.display = 'block';
                orderQuantityInput.disabled = false;
                orderPriceInput.disabled = false;
                orderQuantityInput.focus();
            } else {
                currentProduct = null;
                currentProductInfo.style.display = 'none';
                orderQuantityInput.disabled = true;
                orderPriceInput.disabled = true;
            }
        }

        // Agregar producto al pedido
        function addToOrder() {
            if (!currentProduct) {
                showFloatingNotification("Primero busca un producto válido", "error");
                return;
            }

            const quantity = parseInt(orderQuantityInput.value);
            const price = parseFloat(orderPriceInput.value) || currentProduct.costo || 0;

            if (!quantity || quantity <= 0) {
                showFloatingNotification("Ingresa una cantidad válida", "error");
                return;
            }

            // Verificar si el producto ya está en el pedido
            const existingItemIndex = currentOrderItems.findIndex(item => item.id === currentProduct.id);

            if (existingItemIndex !== -1) {
                // Actualizar cantidad y precio si ya existe
                currentOrderItems[existingItemIndex].quantity += quantity;
                currentOrderItems[existingItemIndex].price = price;
                currentOrderItems[existingItemIndex].total = currentOrderItems[existingItemIndex].quantity * currentOrderItems[existingItemIndex].price;
            } else {
                // Agregar nuevo producto al pedido
                if (!quantity || quantity <= 0) {
                    showFloatingNotification("Ingresa una cantidad válida", "error");
                    return;
                }

                const total = quantity * price;

                currentOrderItems.push({
                    product: currentProduct,
                    quantity: quantity,
                    price: price,
                    total: total
                });
            }

            // Limpiar campos
            orderCodeInput.value = '';
            orderQuantityInput.value = '';
            orderPriceInput.value = '';
            currentProductInfo.style.display = 'none';
            orderQuantityInput.disabled = true;
            orderPriceInput.disabled = true;
            currentProduct = null;

            // Actualizar visualización
            updateOrderItemsDisplay();

            // Volver a enfocar el campo de código
            orderCodeInput.focus();
        }

        // Actualizar visualización de productos en el pedido
        function updateOrderItemsDisplay() {
            orderItemsContainer.innerHTML = '';
            let totalItems = 0;
            let totalQuantity = 0;
            let totalCost = 0;

            if (currentOrderItems.length === 0) {
                orderItemsContainer.innerHTML = '<div style="text-align: center; padding: 15px; color: #666;">No hay productos en el pedido</div>';
            } else {
                currentOrderItems.forEach((item, index) => {
                    totalItems++;
                    totalQuantity += item.quantity;
                    totalCost += item.total;

                    const div = document.createElement('div');
                    div.className = 'order-item';
                    div.innerHTML = `
                        <div class="order-item-info">
                            <div style="font-weight: bold;">${item.product.descripcion}</div>
                            <div style="font-size: 0.85em; color: #666;">
                                ${item.quantity} x $${item.price.toFixed(2)} = $${item.total.toFixed(2)}
                            </div>
                        </div>
                        <div class="order-item-actions">
                            <button class="remove-order-item" onclick="removeOrderItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    orderItemsContainer.appendChild(div);
                });
            }

            document.getElementById('order-total-items').textContent = totalItems;
            document.getElementById('order-total-quantity').textContent = totalQuantity;
            document.getElementById('order-total-cost').textContent = totalCost.toFixed(2);
        }

        // Eliminar producto del pedido
        function removeOrderItem(index) {
            currentOrderItems.splice(index, 1);
            updateOrderItemsDisplay();
        }

        // Guardar pedido
        function saveOrder() {
            if (currentOrderItems.length === 0) {
                showFloatingNotification("No hay productos en el pedido", "error");
                return;
            }

            const batch = db.batch();
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            currentOrderItems.forEach(item => {
                const productRef = db.collection('INVENTARIO').doc(item.product.id);
                const newQuantity = (item.product.cantidad || 0) + item.quantity;

                // Actualizar producto
                batch.update(productRef, {
                    cantidad: newQuantity,
                    costo: item.price, // Actualizamos costo con el último precio de compra? O promedio? Dejémoslo así por ahora.
                    ultimaActualizacion: timestamp
                });

                // Registrar movimiento en historial (opcional, si existiera colección historial_productos)
            });

            batch.commit()
                .then(() => {
                    showFloatingNotification("Pedido ingresado correctamente", "success");
                    closeOrderModal();
                    loadInventory();
                })
                .catch((error) => {
                    console.error("Error al guardar pedido: ", error);
                    showFloatingNotification("Error al guardar el pedido", "error");
                });
        }

        // Procesar archivo para pedido masivo
        function processBulkOrder() {
            // ... lógica dummy ...
            showFloatingNotification("Función en desarrollo", "info");
        }

        // Exportar a Excel
        function exportToExcel() {
            if (inventoryData.length === 0) {
                showFloatingNotification("No hay datos para exportar", "error");
                return;
            }

            // Preparar datos para Excel (mapeo limpio)
            const dataToExport = inventoryData.map(item => ({
                'Código': item.codigo,
                'Descripción': item.descripcion,
                'Descripción Taller': item.descripcionTaller,
                // 'Marca': item.marca, // Marca eliminada
                'Stock': item.cantidad,
                'Costo': item.costo,
                'Precio Venta': item.precio,
                'Crédito Fiscal': item.creditoFiscal ? 'Sí' : 'No'
            }));

            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(dataToExport);

            // Ajustar ancho de columnas (opcional pero util)
            const wscols = [
                { wch: 15 }, // Codigo
                { wch: 40 }, // Descripcion
                { wch: 40 }, // Descripcion Taller
                { wch: 10 }, // Stock
                { wch: 10 }, // Costo
                { wch: 10 }, // Precio
                { wch: 10 }  // CF
            ];
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, 'Inventario');

            // Descargar archivo
            XLSX.writeFile(wb, 'inventario_taller_wilian.xlsx');
            showFloatingNotification("Archivo Excel descargado correctamente", "success");
        }

        // Procesar importación desde Excel (y JSON)
        function processImport() {
            // Referencias del nuevo modal
            const fileInput = document.getElementById('import-excel-input');
            const updateCheck = document.getElementById('update-existing-check');

            const file = fileInput.files[0];
            const updateExisting = updateCheck ? updateCheck.checked : true;

            if (!file) {
                showFloatingNotification("Selecciona un archivo", "error");
                return;
            }

            const fileName = file.name.toLowerCase();
            const isJson = fileName.endsWith('.json');

            // Mostrar spinner en boton
            const btn = document.querySelector('#importModal .btn-success');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                btn.disabled = true;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    let jsonData = [];

                    if (isJson) {
                        // Procesar JSON
                        const text = new TextDecoder("utf-8").decode(new Uint8Array(e.target.result));
                        jsonData = JSON.parse(text);

                        // Normalizar estructura si viene anidada
                        if (!Array.isArray(jsonData) && jsonData.products) {
                            jsonData = jsonData.products;
                        } else if (!Array.isArray(jsonData)) {
                            // Intenta convertir objeto a array si es un mapa {id: {...}, id2: {...}}
                            jsonData = Object.values(jsonData);
                        }
                    } else {
                        // Procesar Excel
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        jsonData = XLSX.utils.sheet_to_json(worksheet);
                    }

                    if (!jsonData || jsonData.length === 0) {
                        showFloatingNotification("El archivo está vacío o formato inválido", "error");
                        if (btn) { btn.innerHTML = '<i class="fas fa-upload"></i> Importar Ahora'; btn.disabled = false; }
                        return;
                    }

                    // Procesamiento masivo (Batch)
                    const db = firebase.firestore();
                    const batchSize = 400;
                    let batch = db.batch();
                    let operationCount = 0;
                    let processedCount = 0;
                    const promises = [];

                    jsonData.forEach((row) => {
                        let productData = {};

                        if (isJson) {
                            // Asumimos estructura correcta de Firestore
                            productData = {
                                codigo: row.codigo || '',
                                descripcion: row.descripcion || '',
                                descripcionTaller: row.descripcionTaller || '',
                                marca: row.marca || 'General',
                                cantidad: parseInt(row.cantidad || 0),
                                minStock: parseInt(row.minStock || 5),
                                costo: parseFloat(row.costo || 0),
                                precio: parseFloat(row.precio || 0),
                                creditoFiscal: row.creditoFiscal || false,
                                ultimaActualizacion: new Date()
                            };
                        } else {
                            // Mapeo Excel (Columnas Usuario)
                            // "Codigo", "Descripcion según inventario", "Descripcion según factura", 
                            // "Precio costo", "Precio de venta", "Existencia Diciembre"

                            const code = row['Codigo'] || row['codigo'] || row['CODIGO'];
                            if (!code) return; // Saltar filas inválidas

                            productData = {
                                codigo: String(code).trim(),
                                descripcion: row['Descripcion según inventario'] || row['Descripcion'] || 'Sin descripción',
                                descripcionTaller: row['Descripcion según factura'] || '',
                                marca: row['Marca'] || 'General',
                                cantidad: parseInt(row['Existencia Diciembre'] || row['Existencia'] || row['STOCK'] || row['Stock'] || row['Cantidad'] || row['stock'] || 0),
                                minStock: 5,
                                costo: parseFloat(row['Precio costo'] || 0),
                                precio: parseFloat(row['Precio de venta'] || row['Precio'] || 0),
                                creditoFiscal: false,
                                ultimaActualizacion: new Date()
                            };
                        }

                        if (!productData.codigo) return;

                        // Buscar existencia en memoria para decidir update o set
                        const existingProduct = inventoryData.find(p => p.codigo === productData.codigo);
                        let docRef;

                        if (existingProduct && updateExisting) {
                            docRef = db.collection('INVENTARIO').doc(existingProduct.id);
                            batch.update(docRef, productData);
                        } else if (!existingProduct) {
                            docRef = db.collection('INVENTARIO').doc();
                            batch.set(docRef, productData);
                        } else {
                            return; // Ya existe y no queremos actualizar
                        }

                        operationCount++;
                        processedCount++;

                        if (operationCount >= batchSize) {
                            promises.push(batch.commit());
                            batch = db.batch();
                            operationCount = 0;
                        }
                    });

                    if (operationCount > 0) {
                        promises.push(batch.commit());
                    }

                    Promise.all(promises)
                        .then(() => {
                            showFloatingNotification(`Éxito: ${processedCount} productos procesados.`, "success");
                            const modal = document.getElementById('importModal');
                            if (modal) modal.style.display = 'none';
                            loadInventory();
                        })
                        .catch((err) => {
                            console.error(err);
                            showFloatingNotification("Error al guardar en base de datos", "error");
                        })
                        .finally(() => {
                            if (btn) { btn.innerHTML = '<i class="fas fa-upload"></i> Importar Ahora'; btn.disabled = false; }
                        });

                } catch (error) {
                    console.error("Error al procesar archivo: ", error);
                    showFloatingNotification("Error crítico: " + error.message, "error");
                    if (btn) { btn.innerHTML = '<i class="fas fa-upload"></i> Importar Ahora'; btn.disabled = false; }
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Borrar todo el inventario
        async function deleteAllInventory() {
            if (!confirm("⚠️ PRECAUCIÓN EXTREMA\n\n¿Estás seguro de que deseas ELIMINAR TODO EL INVENTARIO?\nEsta acción vaciará la base de datos y no se puede deshacer.")) {
                return;
            }

            const confirmation = prompt("Para confirmar, escribe 'BORRAR' (en mayúsculas):");
            if (confirmation !== 'BORRAR') {
                showFloatingNotification("Cancelado por seguridad", "info");
                return;
            }

            const btn = document.querySelector('.btn-danger'); // Botón borrar
            let originalText = "";
            if (btn) {
                originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrando...';
                btn.disabled = true;
            }

            try {
                const db = firebase.firestore();
                const snapshot = await db.collection("INVENTARIO").get();

                if (snapshot.empty) {
                    showFloatingNotification("El inventario ya está vacío", "info");
                } else {
                    const batchSize = 400;
                    let batch = db.batch();
                    let count = 0;

                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= batchSize) {
                            await batch.commit();
                            batch = db.batch();
                            count = 0;
                        }
                    }

                    if (count > 0) await batch.commit();

                    showFloatingNotification("Inventario eliminado completamente.", "success");
                    loadInventory();
                }
            } catch (error) {
                console.error(error);
                showFloatingNotification("Error al eliminar: " + error.message, "error");
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // Mostrar notificación flotante
        function showFloatingNotification(message, type) {
            const floatingNotification = document.getElementById('floating-notification');
            if (floatingNotification) {
                floatingNotification.textContent = message;
                floatingNotification.className = 'floating-notification ' + type;
                floatingNotification.style.display = 'block';

                setTimeout(() => {
                    floatingNotification.style.display = 'none';
                }, 3000);
            } else {
                alert(message);
            }
        }

        // Manejador de selección de archivo para importación directa
        async function handleImportFileSelect_OLD_DISABLED(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const shouldUpdate = confirm("¿Deseas actualizar los productos existentes que tengan el mismo Código?\n\n[Aceptar] = Sí, actualizar precios/stocks.\n[Cancelar] = No, saltar existentes y solo agregar nuevos.");

            // Reiniciar input para permitir re-seleccionar mismo archivo si falla
            input.value = '';

            const reader = new FileReader();

            reader.onload = async function (e) {
                try {
                    const data = e.target.result;
                    let products = [];
                    let jsonData = []; // Declarar variable para alcance global en el try

                    // Detectar tipo por extensión o contenido
                    if (file.name.endsWith('.json')) {
                        products = JSON.parse(data);
                    } else {
                        // Asumir Excel
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // Leer como array de arrays para buscar el encabezado
                        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // Buscar la fila que contiene "Codigo" y otros campos clave (búsqueda estricta)
                        let headerRowIndex = -1;
                        for (let i = 0; i < Math.min(30, rawData.length); i++) {
                            const row = rawData[i];
                            // Ignorar nulos o filas con menos de 2 columnas
                            if (!row || row.length < 2) continue;

                            const rowStr = JSON.stringify(row).toLowerCase();

                            // Criterio: Debe tener 'codigo' Y (alguna descripción O precio O costo O existencia)
                            if (rowStr.includes('codigo') &&
                                (rowStr.includes('descripci') || rowStr.includes('precio') || rowStr.includes('costo') || rowStr.includes('existencia'))) {
                                headerRowIndex = i;
                                break;
                            }
                        }

                        if (headerRowIndex === -1) {
                            // Fallback: Buscar solo 'codigo' si falla lo estricto
                            for (let i = 0; i < Math.min(30, rawData.length); i++) {
                                if (rawData[i] && rawData[i].length >= 2 && JSON.stringify(rawData[i]).toLowerCase().includes('codigo')) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                        }

                        if (headerRowIndex === -1) {
                            alert("No se encontró ninguna fila que parezca encabezado (buscando 'Codigo', 'Descripcion', etc).");
                            return;
                        }

                        console.log("Encabezados encontrados en fila:", headerRowIndex + 1);

                        // USAR rawData DIRECTAMENTE
                        const headers = rawData[headerRowIndex];
                        const rows = rawData.slice(headerRowIndex + 1);

                        // DEBUG TEMPORAL: Mostrar headers encontrados
                        // alert("Fila Header #" + (headerRowIndex + 1) + " detectada.\nColumnas: " + JSON.stringify(headers));

                        // Identificar nombres exactos de columnas basándonos en palabras clave
                        // Esto hace que funcione aunque haya espacios o tildes diferentes
                        const colCodigo = headers.find(h => h && h.toLowerCase().includes('codigo')) || 'Codigo';
                        // Mejorar detección para evitar confundir 'Descripcion Factura' con 'Descripcion Inventario'
                        const colDescInv = headers.find(h => h && (h.toLowerCase().includes('inventario') || (h.toLowerCase().includes('descripci') && !h.toLowerCase().includes('factura') && !h.toLowerCase().includes('taller')))) || 'Descripcion según inventario';
                        const colDescFact = headers.find(h => h && (h.toLowerCase().includes('factura') || h.toLowerCase().includes('taller'))) || 'Descripcion según factura';

                        const colCosto = headers.find(h => h && (h.toLowerCase().includes('costo') || h.toLowerCase().includes('compra'))) || 'Precio costo';
                        // Mejorar detección de precio para evitar 'Total Venta' u otras columnas similares
                        const colPrecio = headers.find(h => h && ((h.toLowerCase().includes('precio') && h.toLowerCase().includes('venta')) || h.toLowerCase().includes('p.v.p') || h.toLowerCase().includes('publico') || h.toLowerCase().includes('unitario') || h.toLowerCase() === 'venta' || h.toLowerCase() === 'precio')) || 'Precio de venta';

                        const colStock = headers.find(h => h && ((h.toLowerCase().includes('existencia') && !h.toLowerCase().includes('min')) || h.toLowerCase().includes('stock') || (h.toLowerCase().includes('cantidad') && !h.toLowerCase().includes('min')))) || 'Existencia Diciembre';

                        // DEBUG AVANZADO: Diagnóstico de precio
                        const colPrecioIndex = headers.indexOf(colPrecio);
                        const sampleVal = (rows.length > 0 && colPrecioIndex !== -1) ? rows[0][colPrecioIndex] : 'N/A';

                        // alert(`DEBUG PRECIO:\nColumna detectada: '${colPrecio}'\nValor en fila 1: '${sampleVal}'\n\nTodas las columnas: ${headers.join(' | ')}`);
                        alert(`Diagnóstico de Importación:\n1. Columna Precio: '${colPrecio}'\n2. Valor muestra (Fila 1): '${sampleVal}'\n3. Total Columnas: ${headers.length}\n\nRevisa si el 'Valor muestra' es correcto (debería ser un número).`);

                        console.log("Mapeo de columnas:", { colCodigo, colDescInv, colDescFact, colCosto, colPrecio, colStock });

                        // Convertir manualmente a objetos JSON para evitar ambigüedades de SheetJS
                        jsonData = rows.map(row => {
                            let obj = {};
                            headers.forEach((h, i) => {
                                if (h) obj[h] = row[i];
                            });
                            return obj;
                        });

                        // Mapear columnas de Excel a nuestro modelo
                        products = jsonData.map(row => {
                            let codigo = row[colCodigo] || '';
                            const desc1 = row[colDescInv] || '';
                            const desc2 = row[colDescFact] || '';

                            // Limpieza de valores numéricos (quitar signos $, comas, etc)
                            const cleanNumber = (val) => {
                                if (typeof val === 'number') return val;
                                if (!val) return 0;
                                return parseFloat(String(val).replace(/[$,]/g, '')) || 0;
                            };

                            const costo = cleanNumber(row[colCosto]);
                            const precio = cleanNumber(row[colPrecio]);
                            const stock = cleanNumber(row[colStock]);

                            // Si no hay código pero SÍ hay descripción, generar código automático
                            if (!codigo && (desc1 || desc2)) {
                                codigo = "GEN-" + Math.floor(Math.random() * 100000);
                            }

                            if (!codigo) return null; // Ignorar filas completamente vacías (ni código ni descripción)

                            return {
                                codigo: String(codigo).trim(),
                                descripcion: String(desc1).trim(),
                                descripcionTaller: String(desc2).trim(),
                                marca: '', // Eliminado visualmente
                                cantidad: stock,
                                costo: costo,
                                precio: precio,
                                fechaActualizacion: new Date().toISOString()
                            };
                        }).filter(p => p !== null);
                    }

                    if (products.length === 0) {
                        if (jsonData && jsonData.length > 0) {
                            const headers = Object.keys(jsonData[0]);
                            console.log("Columnas encontradas:", headers);
                            alert("No se encontraron productos válidos.\n\nIMPORTANTE: Verifica los nombres de tus columnas.\n\nColumnas detectadas en tu Excel:\n" + headers.join(" | ") + "\n\nColumnas esperadas (al menos 'Codigo'):\n- Codigo\n- Descripcion según inventario\n- Descripcion según factura");
                        } else {
                            alert("No se encontraron datos en la primera hoja del Excel.");
                        }
                        return;
                    }

                    // Confirmar cantidad
                    if (!confirm(`Se encontraron ${products.length} productos válidos.\n¿Proceder con la importación a Firebase?`)) return;

                    showFloatingNotification("Iniciando importación...", "info");

                    // Proceso de guardado en lotes (Batch)
                    const batchSize = 400; // Limite Firestore es 500
                    let batch = db.batch();
                    let count = 0;
                    let totalProcessed = 0;
                    let updatedCount = 0;
                    let newCount = 0;

                    // Obtener lista actual de IDs para saber si existe (optimización básica)
                    // Para ser exactos, deberíamos leer. Pero asumiremos 'shouldUpdate' lógica.
                    // Leyendo todo el inventario actual para comparar códigos rápidamente
                    const currentCodes = new Set(inventoryData.map(p => p.codigo));

                    for (const product of products) {
                        const productRef = db.collection('INVENTARIO').doc(product.codigo); // Usar Codigo como ID

                        // Si existe y NO actualizar
                        if (currentCodes.has(product.codigo) && !shouldUpdate) {
                            continue;
                        }

                        if (currentCodes.has(product.codigo)) updatedCount++;
                        else newCount++;

                        batch.set(productRef, product, { merge: true });
                        count++;
                        totalProcessed++;

                        if (count >= batchSize) {
                            await batch.commit();
                            batch = db.batch();
                            count = 0;
                            showFloatingNotification(`Procesados ${totalProcessed} de ${products.length}...`, "info");
                        }
                    }

                    if (count > 0) await batch.commit();

                    alert(`Importación completada.\nNuevos: ${newCount}\nActualizados: ${updatedCount}`);
                    showFloatingNotification("Importación exitosa", "success");
                    loadInventory(); // Recargar tabla

                } catch (error) {
                    console.error("Error importando:", error);
                    alert("Error al procesar archivo: " + error.message);
                }
            };

            reader.onerror = function (ex) {
                alert("Error leyendo archivo");
            };

            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // --- FUNCIONES DE ENTRADA Y AUTOCOMPLETADO ---

        function openEntryModal() {
            const modal = document.getElementById('entry-modal');
            modal.style.display = 'flex';
            modal.style.zIndex = "3000"; // Asegurar que quede encima de todo
            document.getElementById('entry-rows').innerHTML = '';
            document.getElementById('entry-reference').value = '';
            document.getElementById('entry-has-iva').checked = true;
            addEntryRow();
            calculateEntryTotals();
        }

        function addEntryRow(data = null) {
            const tbody = document.getElementById('entry-rows');
            const row = document.createElement('tr');

            const codigo = data ? (data.codigo || '') : '';
            const desc = data ? (data.descripcion || '') : '';
            const cant = data ? (data.cantidad || '') : '';
            const precio = data ? (data.precio || '') : '';

            row.dataset.productId = data ? (data.id || '') : '';

            row.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="entry-input entry-code" value="${codigo}" 
                            placeholder="Cod" onkeyup="searchProduct(this, 'code')" autocomplete="off">
                        <button class="search-helper-btn" onclick="openProductLookup(this)" style="position: absolute; right: 5px; top: 5px;">
                            <i class="fas fa-search"></i>
                        </button>
                        <div class="suggestions-container"></div>
                    </div>
                </td>
                <td>
                     <div style="position: relative;">
                        <input type="text" class="entry-input entry-desc" value="${desc}" 
                            placeholder="Descripción" onkeyup="searchProduct(this, 'desc')" autocomplete="off">
                        <div class="suggestions-container"></div>
                    </div>
                </td>
                <td><input type="number" class="entry-input entry-qty" value="${cant}" min="1" placeholder="0" onchange="calculateEntryTotals()" onkeyup="calculateEntryTotals()"></td>
                <td><input type="number" class="entry-input entry-price" value="${precio}" min="0" step="0.01" placeholder="0.00" onchange="calculateEntryTotals()" onkeyup="calculateEntryTotals()"></td>
                <td style="text-align: right; font-weight: bold;" class="entry-row-total">$0.00</td>
                <td style="text-align: center;">
                    <button class="btn-danger" style="border:none; border-radius:3px; padding: 2px 6px; cursor:pointer;" onclick="this.closest('tr').remove(); calculateEntryTotals();"><i class="fas fa-times"></i></button>
                </td>
            `;
            tbody.appendChild(row);

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.suggestions-box') && !e.target.closest('.entry-input')) closeAllSuggestions();
            });

            if (!data) setTimeout(() => row.querySelector('.entry-code').focus(), 50);
        }

        function calculateEntryTotals() {
            const rows = document.querySelectorAll('#entry-rows tr');
            let subtotal = 0;
            const includesIva = document.getElementById('entry-has-iva').checked;

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.entry-qty').value) || 0;
                const price = parseFloat(row.querySelector('.entry-price').value) || 0;
                let rowTotal = qty * price;
                row.querySelector('.entry-row-total').textContent = '$' + rowTotal.toFixed(2);
                subtotal += rowTotal;
            });

            let finalSubtotal = 0, finalIVA = 0, finalTotal = 0;

            if (includesIva) {
                finalTotal = subtotal;
                finalSubtotal = finalTotal / 1.13;
                finalIVA = finalTotal - finalSubtotal;
            } else {
                finalSubtotal = subtotal;
                finalIVA = finalSubtotal * 0.13;
                finalTotal = finalSubtotal + finalIVA;
            }

            document.getElementById('entry-subtotal').textContent = '$' + finalSubtotal.toFixed(2);
            document.getElementById('entry-iva').textContent = '$' + finalIVA.toFixed(2);
            document.getElementById('entry-total').textContent = '$' + finalTotal.toFixed(2);
        }

        function searchProduct(input, type) {
            const query = input.value.trim().toLowerCase();
            const container = input.nextElementSibling.classList.contains('search-helper-btn') ? input.nextElementSibling.nextElementSibling : input.nextElementSibling;
            container.innerHTML = '';
            if (query.length < 2) return;

            const matches = inventoryData.filter(p => {
                const code = (p.codigo || '').toLowerCase();
                const desc = (p.descripcion || '').toLowerCase();
                const codeTaller = (p.descripcionTaller || '').toLowerCase();
                if (type === 'code') return code.startsWith(query) || code.includes(query);
                else return desc.includes(query) || codeTaller.includes(query);
            }).slice(0, 8);

            if (matches.length === 0) return;

            const box = document.createElement('div');
            box.className = 'suggestions-box';
            matches.forEach(product => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `<div><div class="suggestion-code">${product.codigo || 'S/C'}</div><div class="suggestion-desc">${product.descripcion}</div></div><div class="suggestion-price">$${(product.costo || 0).toFixed(2)}</div>`;
                item.onclick = () => selectSuggestion(input, product);
                box.appendChild(item);
            });
            container.appendChild(box);
        }

        function selectSuggestion(input, product) {
            const row = input.closest('tr');
            row.querySelector('.entry-code').value = product.codigo || '';
            row.querySelector('.entry-desc').value = product.descripcion || '';
            row.querySelector('.entry-price').value = product.costo || '';
            row.dataset.productId = product.id;
            closeAllSuggestions();
            calculateEntryTotals();
            row.querySelector('.entry-qty').focus();
        }

        function closeAllSuggestions() {
            document.querySelectorAll('.suggestions-box').forEach(el => el.remove());
        }

        function openProductLookup(btn) {
            const row = btn.closest('tr');
            row.querySelector('.entry-desc').focus();
            showFloatingNotification("Usa el buscador por descripción.", "info");
        }

        async function saveEntry() {
            const rows = document.querySelectorAll('#entry-rows tr');
            if (rows.length === 0) return;

            // Validación: Verificar que todos tengan código/producto seleccionado
            let allValid = true;
            rows.forEach(row => {
                if (!row.dataset.productId && !row.querySelector('.entry-code').value) allValid = false;
            });

            if (!confirm("¿Confirmar el registro de esta entrada de inventario?")) return;

            const submitBtn = document.querySelector('#entry-modal .btn-success');
            submitBtn.disabled = true;
            submitBtn.textContent = "Guardando...";

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                const reference = document.getElementById('entry-reference').value || 'Sin Referencia';
                // Usaremos colecciones para historia
                const movementsCollection = db.collection('MOVIMIENTOS_INVENTARIO');
                const inventoryCollection = db.collection('INVENTARIO');

                let validItems = 0;
                const hasIva = document.getElementById('entry-has-iva').checked;

                for (const row of rows) {
                    const code = row.querySelector('.entry-code').value.trim();
                    const desc = row.querySelector('.entry-desc').value.trim();
                    const qty = parseFloat(row.querySelector('.entry-qty').value);
                    const price = parseFloat(row.querySelector('.entry-price').value);

                    if (!qty || isNaN(price)) continue;

                    // Buscar ID
                    let productId = row.dataset.productId;

                    // Intentar match por código si no hay ID
                    if (!productId && code) {
                        const found = inventoryData.find(p => p.codigo.toLowerCase() === code.toLowerCase());
                        if (found) productId = found.id;
                    }

                    if (!productId) {
                        alert(`El producto "${desc}" (${code}) no existe en el sistema. Debes crearlo primero.`);
                        throw new Error("Producto no encontrado: " + code);
                    }

                    const costUnit = hasIva ? (price / 1.13) : price;

                    // Actualizar Inventario
                    const prodRef = inventoryCollection.doc(productId);
                    batch.update(prodRef, {
                        cantidad: firebase.firestore.FieldValue.increment(qty),
                        costo: costUnit
                    });

                    // Registrar Movimiento
                    const movRef = movementsCollection.doc();
                    batch.set(movRef, {
                        productId: productId,
                        codigo: code,
                        descripcion: desc,
                        tipo: 'entrada',
                        cantidad: qty,
                        costo: costUnit,
                        referencia: reference,
                        fecha: timestamp,
                        usuario: 'Sistema'
                    });

                    validItems++;
                }

                if (validItems === 0) {
                    alert("No hay items válidos para guardar.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Guardar Entrada";
                    return;
                }

                await batch.commit();

                showFloatingNotification("Entrada registrada correctamente", "success");
                document.getElementById('entry-modal').style.display = 'none';
                loadInventory(); // Recargar datos del servidor

            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Guardar Entrada";
            }
        }

        function loadEntryJSON(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            addEntryRow({
                                codigo: item.codigo || item.code || '',
                                descripcion: item.descripcion || item.description || '',
                                cantidad: item.cantidad || item.qty || 1,
                                precio: item.precio || item.costo || item.cost || 0
                            });
                        });
                        calculateEntryTotals();
                    }
                } catch (err) { alert("Error JSON: " + err.message); }
            };
            reader.readAsText(file);
        }
    </script>
    <!-- Servicios de Inventario -->
    <script src="js/inventory/KardexService.js"></script>
    <script src="js/inventory/InventoryApp.js"></script>
    <!-- Inyección Directa de Función de Importación (Bypass de errores de carga de archivo externo) -->
    <script>
        async function importExcelNew(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const shouldUpdate = confirm("¿Deseas actualizar los productos existentes que tengan el mismo Código?\n\n[Aceptar] = Sí.\n[Cancelar] = No (saltar).");
            input.value = '';

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // 1. Leer matriz bruta y buscar encabezados
                    const rawMatrix = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (!rawMatrix || rawMatrix.length === 0) {
                        alert("Archivo vacío."); return;
                    }

                    let headerIdx = -1;
                    let headers = [];
                    // Buscar fila con 'codigo' y 'descripcion'
                    for (let i = 0; i < rawMatrix.length; i++) {
                        const rowStr = JSON.stringify(rawMatrix[i]).toLowerCase();
                        if (rowStr.includes('codigo') || rowStr.includes('descripcion')) {
                            headerIdx = i;
                            headers = rawMatrix[i].map(h => String(h).trim());
                            break;
                        }
                    }

                    if (headerIdx === -1) {
                        alert("No se detectaron columnas 'Codigo' / 'Descripcion'. Usando primera fila.");
                        headerIdx = 0;
                        headers = rawMatrix[0].map(h => String(h).trim());
                    }

                    // 2. Procesar filas de datos
                    let products = [];
                    const cleanNumber = (val) => {
                        if (val === undefined || val === null || val === '') return 0;
                        if (typeof val === 'number') return val;
                        const s = String(val).replace(/,/g, '').replace(/$/g, '').trim();
                        return parseFloat(s) || 0;
                    };

                    for (let i = headerIdx + 1; i < rawMatrix.length; i++) {
                        const rowArr = rawMatrix[i];
                        if (!rowArr || rowArr.length === 0) continue;

                        // Crear objeto temporal mapa
                        let rowObj = {};
                        headers.forEach((h, idx) => { if (h) rowObj[h] = rowArr[idx]; });

                        // Buscar CÓDIGO
                        let codigo = rowObj['Codigo'] || rowObj['codigo'];
                        if (!codigo) {
                            const k = Object.keys(rowObj).find(key => key.toLowerCase().includes('cod'));
                            if (k) codigo = rowObj[k];
                        }

                        // Generar código automático si sigue vacío -> ELIMINADO POR SOLICITUD USUARIO
                        // Se permite código vacío.

                        // Buscar CANTIDAD (Stock)
                        // Prioridad 1: Por nombre
                        let qtyVal = undefined;
                        const qtyKey = Object.keys(rowObj).find(k => {
                            const kl = k.toLowerCase();
                            return kl.includes('31/12') || (kl.includes('inventario') && !kl.includes('descrip')) || kl.includes('existencia') || kl.includes('stock');
                        });
                        if (qtyKey) qtyVal = rowObj[qtyKey];

                        // Prioridad 2: Fallback FORZOSO a Columna F (Indice 5) si no hay valor
                        if (qtyVal === undefined && rowArr.length > 5) {
                            qtyVal = rowArr[5];
                        }

                        // Costo y Precio
                        let costoVal = rowObj['Precio costo'];
                        if (!costoVal) {
                            const k = Object.keys(rowObj).find(key => key.toLowerCase().includes('costo') || key.toLowerCase().includes('compra'));
                            if (k) costoVal = rowObj[k];
                        }

                        let precioVal = rowObj['Precio de venta'];
                        if (!precioVal) {
                            const k = Object.keys(rowObj).find(key => key.toLowerCase().includes('precio') || key.toLowerCase().includes('venta'));
                            if (k) precioVal = rowObj[k];
                        }

                        products.push({
                            codigo: codigo ? String(codigo).trim() : "", // Código vacío permitido
                            descripcion: rowObj['Descripcion'] || rowObj['Descripcion según inventario'] || '',
                            descripcionTaller: rowObj['Descripcion según factura'] || '',
                            cantidad: parseInt(cleanNumber(qtyVal)),
                            costo: cleanNumber(costoVal),
                            precio: cleanNumber(precioVal)
                        });
                    }

                    if (products.length === 0) {
                        alert("No se encontraron productos válidos."); return;
                    }

                    // Guardar en Firebase
                    const batch = db.batch();
                    let count = 0;

                    // Obtener códigos actuales para verificar duplicados solo si hay código
                    const currentCodes = new Set(inventoryData.filter(p => p.codigo).map(p => p.codigo));

                    products.forEach(p => {
                        // Si tiene código y ya existe, verificar flag de update
                        if (p.codigo && currentCodes.has(p.codigo) && !shouldUpdate) return;

                        let ref;
                        if (p.codigo) {
                            // Si tiene código, usarlo como ID del documento (comportamiento estándar)
                            ref = db.collection('INVENTARIO').doc(p.codigo);
                        } else {
                            // Si NO tiene código, usar ID automático de Firebase
                            ref = db.collection('INVENTARIO').doc();
                        }

                        batch.set(ref, p, { merge: true });
                        count++;
                    });

                    if (count > 0) await batch.commit();
                    showFloatingNotification(`Importación completada. (${count} importados)`, "success");
                    loadInventory();

                } catch (error) {
                    console.error(error);
                    alert("Error: " + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }
    </script>
</body>

</html>