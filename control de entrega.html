<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos - Mototaxis</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* RESET Y BASE RESPONSIVE */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html,
        body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body {
            background-color: #1a202c;
            color: #e2e8f0;
            line-height: 1.4;
            padding: 0;
            margin: 0;
        }

        /* CONTENEDOR PRINCIPAL - 100% ANCHO */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background-color: #1a202c;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background: linear-gradient(135deg, #48bb78, #38b2ac);
            color: white;
            padding: 15px 20px;
            text-align: center;
            width: 100%;
        }

        h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        /* TABS RESPONSIVE */
        .tabs {
            display: flex;
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 0 0 auto;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 140px;
        }

        .tab.active {
            background-color: #1a202c;
            border-bottom: 3px solid #48bb78;
            color: #48bb78;
        }

        /* CONTENIDO DE TABS */
        .tab-content {
            display: none;
            padding: 15px;
            width: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* PANEL DE REGISTRO R√ÅPIDO - RESPONSIVE */
        .panel-registro-rapido {
            width: 100%;
        }

        .info-periodo-actual {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .info-periodo-actual h2 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .info-periodo-actual .fechas-periodo {
            font-size: 1rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .info-periodo-actual .dias-restantes {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* GRID DE EQUIPOS - RESPONSIVE */
        .grid-equipos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .grid-equipos {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .grid-equipos {
                grid-template-columns: 1fr;
            }
        }

        .equipo-card-rapido {
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .equipo-card-rapido:hover {
            border-color: #48bb78;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
        }

        .equipo-header-rapido {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a5568;
        }

        .equipo-numero-rapido {
            font-size: 1.1rem;
            font-weight: bold;
            color: #48bb78;
        }

        .equipo-estado {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .estado-completo {
            background-color: #d4edda;
            color: #155724;
        }

        .estado-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }

        .estado-sin-registros {
            background-color: #f8d7da;
            color: #721c24;
        }

        .equipo-info-rapido {
            margin-bottom: 10px;
        }

        .equipo-nombre-rapido {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .equipo-monto-actual {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1rem;
        }

        .equipo-progreso {
            margin-top: 10px;
        }

        .barra-progreso {
            height: 8px;
            background-color: #4a5568;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
            width: 100%;
        }

        .progreso-completado {
            height: 100%;
            background-color: #48bb78;
            transition: width 0.3s ease;
        }

        .estadisticas-equipo {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #a0aec0;
            width: 100%;
        }

        .total-equipo-periodo {
            text-align: right;
            font-weight: bold;
            color: #e2e8f0;
            margin-top: 5px;
            font-size: 0.9rem;
            width: 100%;
        }

        /* ===== NUEVO DISE√ëO DE CALENDARIO ===== */
        .calendario-periodo {
            margin-top: 20px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            background: #2d3748;
        }

        .header-calendario-simple {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            text-align: center;
            width: 100%;
        }

        .header-calendario-simple h3 {
            font-size: 1rem;
            margin: 0;
        }

        .nombre-equipo-seleccionado {
            font-weight: bold;
            color: #48bb78;
            background-color: #1a202c;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 5px;
        }

        /* ENCABEZADOS DE D√çAS DE LA SEMANA - DOMINGO PRIMERO */
        .dias-semana {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #4a5568;
            color: #e2e8f0;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
            border-bottom: 1px solid #2d3748;
        }

        .dia-semana {
            padding: 8px 5px;
            border-right: 1px solid #2c3e50;
        }

        .dia-semana:last-child {
            border-right: none;
        }

        /* GRID DE D√çAS DEL CALENDARIO - RESPONSIVE */
        .grid-dias-calendario {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #4a5568;
            width: 100%;
        }

        @media (max-width: 768px) {
            .grid-dias-calendario {
                grid-template-columns: repeat(7, 1fr);
            }
        }

        @media (max-width: 480px) {
            .grid-dias-calendario {
                grid-template-columns: repeat(7, 1fr);
            }

            .dia-calendario {
                min-height: 70px !important;
                padding: 5px !important;
            }

            .numero-dia {
                font-size: 0.9rem !important;
            }

            .monto-input-simple {
                width: 35px !important;
                height: 25px !important;
                font-size: 0.9rem !important;
            }
        }

        /* ESTILOS DE D√çAS SEG√öN TIPO - DISE√ëO SIMPLIFICADO */
        .dia-calendario {
            background-color: #2d3748;
            padding: 8px 5px;
            min-height: 80px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* D√çA CON ENTREGA REGISTRADA - VERDE (incluye s√°bados y domingos) */
        .dia-calendario.registrado {
            background-color: #2f4f3f;
            border-left: 2px solid #48bb78;
        }

        /* HOY - AZUL CLARO */
        .dia-calendario.hoy {
            background-color: #2c4a6e;
            border: 2px solid #38b2ac;
        }

        /* D√çA FUTURO - BLANCO */
        .dia-calendario.futuro {
            background-color: #2d3748;
        }

        /* D√çA PASADO SIN ENTREGA - ROJO */
        .dia-calendario.pasado-sin-entregas {
            background-color: #4a2c2c;
            border-left: 2px solid #e53e3e;
        }

        /* FIN DE SEMANA - GRIS CLARO (solo si no tiene entrega) */
        .dia-calendario.descanso {
            background-color: #1a202c;
            color: #718096;
        }

        /* Fin de semana CON ENTREGA debe ser verde, no gris */
        .dia-calendario.registrado.descanso {
            background-color: #2f4f3f !important;
            color: #48bb78 !important;
        }

        /* ELEMENTOS INTERNOS DEL D√çA */
        .numero-dia {
            font-size: 0.95rem;
            font-weight: bold;
            color: #e2e8f0;
            position: absolute;
            top: 5px;
            left: 5px;
        }

        /* INPUT DE MONTO SIMPLE - 2 D√çGITOS, SIN SPINNER */
        .monto-input-simple {
            width: 40px;
            height: 30px;
            border: 1px solid #4a5568;
            border-radius: 3px;
            font-size: 0.95rem;
            text-align: center;
            font-weight: bold;
            color: #e2e8f0;
            background: #1a202c;
            position: absolute;
            bottom: 5px;
            right: 5px;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .monto-input-simple::-webkit-outer-spin-button,
        .monto-input-simple::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .monto-input-simple:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
        }

        /* Input readonly (d√≠as ya registrados) */
        .monto-input-simple[readonly] {
            background-color: #2f4f3f;
            border-color: #48bb78;
            color: #48bb78;
            cursor: default;
        }

        /* Observaci√≥n peque√±a */
        .observacion-dia {
            font-size: 0.7rem;
            color: #a0aec0;
            position: absolute;
            bottom: 5px;
            left: 5px;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* BOT√ìN VOLVER */
        .btn-volver-equipos {
            margin-top: 15px;
            width: 100%;
            text-align: center;
        }

        /* MODAL RESPONSIVE */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-contenido {
            background-color: #2d3748;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            background: linear-gradient(135deg, #48bb78, #38b2ac);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .modal-cerrar {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-cerrar:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
        }

        .info-registro {
            background-color: #1a202c;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-registro p {
            margin: 5px 0;
        }

        /* FORMULARIOS RESPONSIVE */
        .form-group {
            margin-bottom: 15px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9rem;
            width: 100%;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            font-size: 0.95rem;
            width: 100%;
            max-width: 100%;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            width: 100%;
        }

        /* BOTONES RESPONSIVE */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-align: center;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-primary {
            background-color: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background-color: #38a169;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #38b2ac;
            color: white;
        }

        .btn-success:hover {
            background-color: #319795;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* MODAL FOOTER */
        .modal-footer {
            padding: 15px 20px;
            background-color: #1a202c;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
        }

        /* GESTI√ìN DE EQUIPOS - RESPONSIVE */
        .formulario-equipo {
            background-color: #2d3748;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 100%;
        }

        .form-inline {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px;
            flex-wrap: wrap;
            width: 100%;
        }

        .form-inline .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .form-inline .form-group {
                min-width: 100%;
            }
        }

        /* LISTA DE EQUIPOS RESPONSIVE */
        .lista-ingresos {
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
        }

        .ingreso-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #4a5568;
            font-size: 0.9rem;
            flex-wrap: wrap;
            width: 100%;
        }

        @media (max-width: 768px) {
            .ingreso-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .ingreso-equipo,
            .ingreso-cliente,
            .ingreso-monto {
                width: 100% !important;
                text-align: left !important;
            }
        }

        .ingreso-fecha {
            width: 80px;
            color: #666;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .ingreso-equipo {
            width: 80px;
            font-weight: bold;
            color: #27ae60;
            flex-shrink: 0;
        }

        .ingreso-cliente {
            width: 150px;
            font-weight: bold;
            color: #3498db;
            flex-shrink: 0;
        }

        .ingreso-monto {
            width: 100px;
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            flex-shrink: 0;
        }

        .ingreso-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #6c757d;
            font-size: 0.85rem;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 5px;
            flex-shrink: 0;
        }

        .edit-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 5px;
            flex-shrink: 0;
            margin-right: 5px;
        }

        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            font-size: 0.95rem;
            width: 100%;
        }

        .total-general {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            color: #27ae60;
            width: 100%;
        }

        /* FILTROS RESPONSIVE */
        .filtros {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
        }

        .filtro-group {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .filtro-group {
                min-width: 100%;
            }
        }

        /* DEP√ìSITOS POR EQUIPO - MEJORADO */
        .depositos-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .deposito-equipo-card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            color: #e2e8f0;
        }

        .deposito-equipo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a5568;
        }

        .deposito-equipo-numero {
            font-weight: bold;
            color: #48bb78;
            font-size: 1.1rem;
        }

        .deposito-equipo-total {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .deposito-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
        }

        .deposito-fecha {
            color: #a0aec0;
            font-size: 0.9rem;
            flex: 1;
        }

        .deposito-monto {
            font-weight: bold;
            color: #e2e8f0;
            margin-right: 10px;
        }

        .deposito-acciones {
            display: flex;
            gap: 5px;
        }

        .deposito-eliminar-btn {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .deposito-eliminar-btn:hover {
            background-color: rgba(229, 62, 62, 0.1);
        }

        .deposito-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #48bb78;
            font-weight: bold;
            text-align: right;
            color: #48bb78;
            font-size: 1rem;
        }

        /* Botones de per√≠odo */
        .periodos-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .periodo-btn {
            padding: 8px 15px;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .periodo-btn:hover {
            background-color: #374151;
            border-color: #48bb78;
        }

        .periodo-btn.active {
            background-color: #48bb78;
            border-color: #48bb78;
            color: white;
        }

        /* VISTA PREVIA CALENDARIO */
        .vista-previa-calendario {
            margin-top: 20px;
            border: 1px solid #4a5568;
            border-radius: 5px;
            padding: 15px;
            background-color: #2d3748;
            color: #e2e8f0;
        }

        .vista-previa-calendario h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #e2e8f0;
        }

        /* MODAL EDITAR EQUIPO */
        .modal-editar-equipo {
            max-width: 600px;
        }

        .modal-editar-equipo .form-group {
            margin-bottom: 15px;
        }

        /* UTILIDADES */
        .no-print {
            display: block;
        }

        .text-center {
            text-align: center;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .w-100 {
            width: 100%;
        }

        /* ===== ESTILOS PARA VISTA PREVIA DEL CALENDARIO ===== */
        .tabla-calendario-preview {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #2d3748;
        }

        .tabla-calendario-preview th {
            background: #4a5568;
            color: #e2e8f0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #1a202c;
        }

        .tabla-calendario-preview td {
            background: #2d3748;
            border: 1px solid #4a5568;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            vertical-align: top;
        }

        .tabla-calendario-preview td:hover {
            background: #374151;
        }

        .tabla-calendario-preview td.dia-descanso-preview {
            background: #2d3748 !important;
            color: #a0aec0 !important;
        }

        .cuadro-dia-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .dia-numero-preview {
            font-weight: bold;
            font-size: 1.1rem;
            color: #e2e8f0;
        }

        .dia-monto-preview {
            font-size: 0.9rem;
            color: #48bb78;
            font-weight: 600;
        }

        /* ===== ESTILOS DE IMPRESI√ìN ===== */
        @media screen {
            #recibo-print {
                display: none;
            }
        }

        @media print {

            /* Ocultar todos los hijos directos del body excepto el recibo */
            body>*:not(#recibo-print) {
                display: none !important;
            }

            /* Configurar body */
            body {
                background: white !important;
                margin: 0;
                padding: 0;
                height: auto;
                width: 100%;
                overflow: visible !important;
            }

            /* Mostrar y posicionar recibo */
            #recibo-print {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
                z-index: 9999;
            }

            /* Ajustes de impresi√≥n */
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Estilos espec√≠ficos para tabla de impresi√≥n */
            .tabla-dias th,
            .tabla-dias td {
                border: 1px solid black !important;
            }

            .monto-descanso,
            .dia-descanso-tabla {
                /* Sin estilos especiales - todos los d√≠as iguales */
                color: #000 !important;
                background-color: white !important;
            }
        }



        .recibo-mensual {
            width: 100%;
            font-family: 'Courier New', monospace;
            font-size: 10pt;
            color: black;
        }

        .encabezado-recibo {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
        }

        .encabezado-recibo .linea-1 {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .encabezado-recibo .linea-2 {
            font-size: 10pt;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .encabezado-recibo .info-mes {
            font-size: 10pt;
            margin-top: 5px;
        }

        .contenedor-principal {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .columna-tabla {
            flex: 2;
        }

        .columna-datos {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tabla-dias {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .tabla-dias th {
            background: #f0f0f0;
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            font-weight: bold;
        }

        .tabla-dias td {
            border: 1px solid black;
            padding: 4px 6px;
            text-align: center;
        }

        .tabla-dias .col-dia {
            width: 20%;
        }

        .tabla-dias .col-monto {
            width: 20%;
        }

        .tabla-dias .col-observacion {
            width: 60%;
            text-align: left;
        }



        .datos-conductor {
            border: 1px solid black;
            padding: 10px;
            font-size: 9pt;
        }

        .dato-item {
            margin-bottom: 8px;
            display: flex;
            gap: 5px;
        }

        .dato-label {
            font-weight: bold;
            min-width: 60px;
        }

        .dato-valor {
            flex: 1;
        }

        .seccion-firma {
            margin-top: auto;
        }

        .total-recibo {
            font-size: 11pt;
            font-weight: bold;
            text-align: right;
            margin-bottom: 15px;
            padding: 8px;
            border: 2px solid black;
            background: #f5f5f5;
        }

        .firma-recibo {
            margin-top: 20px;
            padding-top: 10px;
        }

        .linea-firma {
            border-top: 1px solid black;
            margin-top: 30px;
            padding-top: 5px;
        }

        /* RESTRICCIONES Y DISE√ëO CALENDARIO V2 */
        .layout-calendario {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            align-items: flex-start;
        }

        .sidebar-controles {
            flex: 0 0 280px;
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #4a5568;
            position: sticky;
            top: 20px;
        }

        .calendario-principal {
            flex: 1;
            min-width: 0;
        }

        .seccion-control {
            margin-bottom: 25px;
        }

        .seccion-control h4 {
            font-size: 0.9rem;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 5px;
        }

        .grid-botones {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
        }

        .btn-seleccion {
            background: #1a202c;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 8px 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-seleccion:hover {
            border-color: #48bb78;
            background: #2d3748;
        }

        .btn-seleccion.active {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.3);
        }

        /* Re-estilos para el grid de vista previa */
        .grid-dias-visual {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background: #4a5568;
            border: 1px solid #4a5568;
            border-radius: 8px;
            overflow: hidden;
        }

        .celda-dia-visual {
            background: #2d3748;
            min-height: 90px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .celda-dia-visual:hover {
            background: #374151;
        }

        .celda-dia-visual.dia-descanso {
            background: #1f2937;
        }

        .celda-dia-visual .numero {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 5px;
        }

        .celda-dia-visual.dia-descanso .numero {
            color: #718096;
        }

        .celda-dia-visual .badge-monto {
            align-self: flex-end;
            margin-top: auto;
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .celda-dia-visual.dia-descanso .badge-monto {
            background: transparent;
            color: #4a5568;
            border: 1px solid #4a5568;
        }

        @media (max-width: 900px) {
            .layout-calendario {
                flex-direction: column;
            }

            .sidebar-controles {
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Control de Ingresos - Mototaxis</h1>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="registro-rapido">Registro R√°pido</div>
            <div class="tab" data-tab="equipos">Gestionar Equipos</div>
            <div class="tab" data-tab="depositos-equipos">Dep√≥sitos por Equipo</div>
            <div class="tab" data-tab="calendario">Calendario Mensual</div>
        </div>

        <!-- Pesta√±a de Registro R√°pido -->
        <div class="tab-content active" id="registro-rapido">
            <div class="panel-registro-rapido">
                <div class="info-periodo-actual" style="display: none !important;">
                    <h2>Per√≠odo de Corte Actual</h2>
                    <div class="fechas-periodo" id="fechas-periodo-actual">
                        Cargando per√≠odo...
                    </div>
                    <div class="dias-restantes" id="dias-restantes-periodo">
                        Calculando d√≠as restantes...
                    </div>
                </div>

                <h2 class="mb-3" id="titulo-registro-rapido">Selecciona un Equipo para Registrar Entregas</h2>
                <div class="grid-equipos" id="grid-equipos-rapido">
                    <!-- Los equipos se cargar√°n aqu√≠ din√°micamente -->
                </div>

                <div class="calendario-periodo" id="calendario-periodo-container"
                    style="display: none; max-width: 1200px; margin: 0 auto; background: #2d3748; border-radius: 8px;">
                    <div class="header-calendario-simple"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-secondary btn-sm" id="cerrar-calendario" style="margin: 0;">
                            ‚Üê Volver
                        </button>
                        <h3 style="margin: 0; flex: 1; text-align: center;">Calendario del Per√≠odo:
                            <span class="nombre-equipo-seleccionado" id="nombre-equipo-calendario"></span>
                        </h3>
                        <div style="width: 80px;"></div> <!-- Spacer for alignment -->
                    </div>

                    <div class="layout-calendario-rapido" style="display: flex; gap: 20px; padding: 20px;">
                        <!-- BARRA LATERAL DE ESTAD√çSTICAS -->
                        <div class="sidebar-stats-rapido" id="sidebar-stats-rapido"
                            style="width: 250px; background: #1a202c; padding: 20px; border-radius: 8px; border: 1px solid #4a5568;">
                            <!-- Se poblar√° din√°micamente -->
                        </div>

                        <!-- LADO DERECHO: CALENDARIO -->
                        <div class="calendario-main-rapido" style="flex: 1;">
                            <div class="dias-semana">
                                <div class="dia-semana">DOM</div>
                                <div class="dia-semana">LUN</div>
                                <div class="dia-semana">MAR</div>
                                <div class="dia-semana">MI√â</div>
                                <div class="dia-semana">JUE</div>
                                <div class="dia-semana">VIE</div>
                                <div class="dia-semana">S√ÅB</div>
                            </div>
                            <div class="grid-dias-calendario" id="grid-dias-calendario">
                                <!-- Los d√≠as del per√≠odo se generar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Equipos -->
        <div class="tab-content" id="equipos">
            <h2 class="mb-3">Registrar Nuevo Equipo</h2>

            <div class="formulario-equipo">
                <div class="form-inline">
                    <div class="form-group">
                        <label for="numero-equipo">N√∫mero de Equipo:</label>
                        <input type="number" id="numero-equipo" placeholder="Ej: 1, 2, 3..." min="1">
                    </div>
                    <div class="form-group">
                        <label for="placa">Placa:</label>
                        <input type="text" id="placa" placeholder="Ej: M52795">
                    </div>
                    <div class="form-group">
                        <label for="nombre">Nombre del Conductor:</label>
                        <input type="text" id="nombre" placeholder="Nombre completo">
                    </div>
                </div>

                <div class="form-inline">
                    <div class="form-group">
                        <label for="dui">DUI:</label>
                        <input type="text" id="dui" placeholder="Ej: 12345678-9">
                    </div>
                    <div class="form-group">
                        <label for="monto-predeterminado-equipo">Monto Predeterminado ($):</label>
                        <input type="number" id="monto-predeterminado-equipo" min="0" step="1" placeholder="30"
                            value="30">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success w-100" id="guardar-equipo">Guardar Equipo</button>
                    </div>
                </div>
            </div>

            <div class="ingresos-list">
                <h2 class="mb-3">Equipos Registrados</h2>
                <div class="lista-ingresos" id="lista-equipos">
                    <!-- Los equipos se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Dep√≥sitos por Equipo -->
        <div class="tab-content" id="depositos-equipos">
            <h2 class="mb-3">Dep√≥sitos por Equipo</h2>
            <button class="btn btn-info no-print mb-3" id="imprimir-todos-equipos">Imprimir Todos</button>

            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-equipo-depositos">Filtrar por Equipo:</label>
                    <select id="filtro-equipo-depositos">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label for="filtro-periodo-depositos">Filtrar por Per√≠odo:</label>
                    <select id="filtro-periodo-depositos">
                        <option value="">Todos los per√≠odos</option>
                        <option value="actual">Per√≠odo Actual</option>
                    </select>
                </div>
            </div>

            <!-- Botones de per√≠odos disponibles -->
            <div class="periodos-buttons" id="periodos-buttons">
                <!-- Los botones de per√≠odos se generar√°n aqu√≠ din√°micamente -->
            </div>

            <div class="depositos-equipo">
                <div class="depositos-lista" id="depositos-lista-equipos">
                    <!-- Dep√≥sitos se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Calendario Mensual -->
        <div class="tab-content" id="calendario">
            <div class="layout-calendario">
                <!-- SIDEBAR: Controles -->
                <div class="sidebar-controles no-print">
                    <div class="seccion-control">
                        <h4>Mes de Trabajo</h4>
                        <div class="grid-botones" id="grid-meses-calendario">
                            <!-- Se generar√° por JS -->
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <span id="label-mes-seleccionado" style="font-weight: bold; color: #48bb78;"></span>
                        </div>
                    </div>

                    <div class="seccion-control">
                        <h4>Seleccionar Equipo</h4>
                        <div class="grid-botones" id="grid-equipos-calendario">
                            <!-- Se generar√° por JS -->
                        </div>
                    </div>

                    <div class="seccion-control" style="margin-top: 30px;">
                        <button class="btn btn-warning w-100" id="imprimir-calendario"
                            style="padding: 12px; font-weight: bold;" onclick="window.prepararImpresion()">
                            üñ®Ô∏è Imprimir Recibo
                        </button>
                        <button class="btn btn-info w-100" style="margin-top: 10px; padding: 10px;"
                            onclick="regenerarDescansos()">
                            üé≤ Aleatorizar Descansos
                        </button>
                    </div>

                    <p style="font-size: 0.8rem; color: #718096; text-align: center;">
                        * Puedes hacer clic en los d√≠as del calendario para cambiar manualmente su estado.
                    </p>
                </div>

                <!-- √ÅREA PRINCIPAL: Calendario -->
                <div class="calendario-principal">
                    <div class="header-calendario-visual"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Calendario de Entregas</h2>
                        <div style="text-align: right;">
                            <div id="info-equipo-header" style="font-size: 1.2rem; font-weight: bold; color: #48bb78;">
                            </div>
                            <div id="info-mes-header" style="color: #a0aec0;"></div>
                        </div>
                    </div>

                    <div class="grid-dias-visual-container">
                        <div class="dias-semana"
                            style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 5px;">
                            <div class="dia-semana">DOM</div>
                            <div class="dia-semana">LUN</div>
                            <div class="dia-semana">MAR</div>
                            <div class="dia-semana">MI√â</div>
                            <div class="dia-semana">JUE</div>
                            <div class="dia-semana">VIE</div>
                            <div class="dia-semana">S√ÅB</div>
                        </div>
                        <div class="grid-dias-visual" id="grid-dias-calendario-visual">
                            <!-- Se generar√° por JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor oculto para impresi√≥n -->
            <div id="recibo-print" class="recibo-print"></div>
        </div>
    </div>

    <!-- Modal para registro de entrega -->
    <div class="modal-overlay" id="modal-registro" style="display: none;">
        <div class="modal-contenido">
            <div class="modal-header">
                <h3 id="modal-titulo">Registrar Entrega</h3>
                <button class="modal-cerrar" id="cerrar-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-registro" id="info-registro">
                    <!-- Informaci√≥n del d√≠a seleccionado -->
                </div>

                <div class="form-group">
                    <label for="modal-monto">Monto de la Entrega ($):</label>
                    <input type="number" id="modal-monto" min="0" step="1" placeholder="0" value="30">
                </div>

                <div class="form-group">
                    <label for="modal-observacion">Observaci√≥n (opcional):</label>
                    <textarea id="modal-observacion" placeholder="Observaci√≥n o comentario..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelar-modal">Cancelar</button>
                <button class="btn btn-primary" id="guardar-modal">Guardar Entrega</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar equipo -->
    <div class="modal-overlay" id="modal-editar-equipo" style="display: none;">
        <div class="modal-contenido modal-editar-equipo">
            <div class="modal-header">
                <h3 id="modal-titulo-editar">Editar Equipo</h3>
                <button class="modal-cerrar" id="cerrar-modal-editar">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editar-numero-equipo">N√∫mero de Equipo:</label>
                    <input type="number" id="editar-numero-equipo" min="1" disabled>
                </div>

                <div class="form-group">
                    <label for="editar-placa">Placa:</label>
                    <input type="text" id="editar-placa" placeholder="Ej: M52795">
                </div>

                <div class="form-group">
                    <label for="editar-nombre">Nombre del Conductor:</label>
                    <input type="text" id="editar-nombre" placeholder="Nombre completo">
                </div>

                <div class="form-group">
                    <label for="editar-dui">DUI:</label>
                    <input type="text" id="editar-dui" placeholder="Ej: 12345678-9">
                </div>

                <div class="form-group">
                    <label for="editar-monto-predeterminado">Monto Predeterminado Diario ($):</label>
                    <input type="number" id="editar-monto-predeterminado" min="0" step="1" placeholder="30" value="30">
                    <small style="color: #6c757d; font-size: 0.85rem;">Monto sugerido para nuevas entregas. Se puede
                        cambiar al registrar.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelar-modal-editar">Cancelar</button>
                <button class="btn btn-primary" id="guardar-cambios-equipo">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
            authDomain: "tallerwilliam-732b3.firebaseapp.com",
            projectId: "tallerwilliam-732b3",
            storageBucket: "tallerwilliam-732b3.firebasestorage.app",
            messagingSenderId: "822262666247",
            appId: "1:822262666247:web:6680487bbf1108006b86a2"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let equipoSeleccionado = null;
        let diaSeleccionado = null;
        let periodoActual = null;
        let equipoAEditar = null;
        let periodoFiltroDepositos = null; // Nuevo: Para filtrar por per√≠odo

        document.addEventListener('DOMContentLoaded', function () {
            // FIX CR√çTICO IMPRESI√ìN: Mover #recibo-print al body para que no se oculte
            const reciboPrint = document.getElementById('recibo-print');
            if (reciboPrint && reciboPrint.parentElement !== document.body) {
                document.body.appendChild(reciboPrint);
            }
            // Configurar pesta√±as
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Remover clase active de todas las pesta√±as y contenidos
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));

                    // Agregar clase active a la pesta√±a y contenido seleccionados
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Actualizar seg√∫n la pesta√±a seleccionada
                    if (tabId === 'registro-rapido') {
                        cargarPanelRegistroRapido();
                    } else if (tabId === 'depositos-equipos') {
                        cargarDepositosPorEquipo();
                        actualizarFiltroEquipos('filtro-equipo-depositos');
                        cargarPeriodosDisponibles();
                    } else if (tabId === 'calendario') {
                        setTimeout(inicializarCalendarioVisual, 100);
                    }
                });
            });

            // Inicializar la aplicaci√≥n
            inicializarApp();

            // Event Listeners
            document.getElementById('cerrar-calendario').addEventListener('click', cerrarCalendario);
            document.getElementById('cerrar-modal').addEventListener('click', cerrarModal);
            document.getElementById('cancelar-modal').addEventListener('click', cerrarModal);

            document.getElementById('guardar-equipo').addEventListener('click', guardarEquipo);
            document.getElementById('imprimir-todos-equipos').addEventListener('click', () => window.print());
            // Eliminado listener antiguo PRINT que causaba error

            // Modal editar equipo
            document.getElementById('cerrar-modal-editar').addEventListener('click', cerrarModalEditar);
            document.getElementById('cancelar-modal-editar').addEventListener('click', cerrarModalEditar);
            document.getElementById('guardar-cambios-equipo').addEventListener('click', guardarCambiosEquipo);

            // Filtros
            document.getElementById('filtro-equipo-depositos').addEventListener('change', cargarDepositosPorEquipo);
            document.getElementById('filtro-periodo-depositos').addEventListener('change', function () {
                periodoFiltroDepositos = this.value;
                cargarDepositosPorEquipo();
            });


            // ===== FUNCIONES PRINCIPALES =====

            async function inicializarApp() {
                await cargarDatosFirebase();
                calcularPeriodoActual();
                cargarPanelRegistroRapido();
                cargarListaEquipos();
            }

            // Funci√≥n para calcular el per√≠odo actual (15 al 14)
            function calcularPeriodoActual() {
                const hoy = new Date();
                const a√±o = hoy.getFullYear();
                const mes = hoy.getMonth() + 1;
                const dia = hoy.getDate();

                let inicioPeriodo, finPeriodo;

                if (dia >= 15) {
                    // Per√≠odo actual: 15 del mes actual al 14 del mes siguiente
                    inicioPeriodo = new Date(a√±o, mes - 1, 15);
                    finPeriodo = new Date(a√±o, mes, 14);
                } else {
                    // Per√≠odo actual: 15 del mes anterior al 14 del mes actual
                    inicioPeriodo = new Date(a√±o, mes - 2, 15);
                    finPeriodo = new Date(a√±o, mes - 1, 14);
                }

                periodoActual = {
                    inicio: inicioPeriodo,
                    fin: finPeriodo,
                    inicioStr: formatoFechaSQL(inicioPeriodo),
                    finStr: formatoFechaSQL(finPeriodo),
                    clave: `${formatoFechaSQL(inicioPeriodo)}_a_${formatoFechaSQL(finPeriodo)}`
                };

                // Actualizar UI
                const fechaInicio = formatoFechaLegible(inicioPeriodo);
                const fechaFin = formatoFechaLegible(finPeriodo);
                document.getElementById('fechas-periodo-actual').textContent =
                    `${fechaInicio} al ${fechaFin}`;

                // Calcular d√≠as restantes
                const msPorDia = 1000 * 60 * 60 * 24;
                const diasRestantes = Math.ceil((finPeriodo - hoy) / msPorDia);
                document.getElementById('dias-restantes-periodo').textContent =
                    `${diasRestantes} d√≠as restantes para el cierre del per√≠odo`;
            }

            // Funci√≥n para obtener todos los per√≠odos √∫nicos de los ingresos
            function obtenerPeriodosDisponibles() {
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const periodosSet = new Set();

                // Agregar per√≠odos de los ingresos
                ingresos.forEach(ingreso => {
                    if (ingreso.periodo && ingreso.periodo.trim() !== '') {
                        periodosSet.add(ingreso.periodo);
                    }
                });

                // Agregar per√≠odo actual si existe
                if (periodoActual && periodoActual.clave) {
                    periodosSet.add(periodoActual.clave);
                }

                // Convertir a array y ordenar (m√°s reciente primero)
                const periodos = Array.from(periodosSet).sort((a, b) => {
                    try {
                        // Extraer fechas para ordenar
                        const fechaA = a.split('_a_')[0];
                        const fechaB = b.split('_a_')[0];
                        return new Date(fechaB) - new Date(fechaA);
                    } catch (e) {
                        return 0;
                    }
                });

                return periodos;
            }

            // Funci√≥n para cargar botones de per√≠odos disponibles
            function cargarPeriodosDisponibles() {
                const periodosButtons = document.getElementById('periodos-buttons');
                const periodos = obtenerPeriodosDisponibles();

                let html = '';

                // Agregar bot√≥n para "Todos los per√≠odos"
                html += `
                    <button class="periodo-btn ${!periodoFiltroDepositos ? 'active' : ''}" data-periodo="">
                        Todos los per√≠odos
                    </button>
                `;

                // Agregar bot√≥n para "Per√≠odo Actual"
                html += `
                    <button class="periodo-btn ${periodoFiltroDepositos === 'actual' ? 'active' : ''}" data-periodo="actual">
                        Per√≠odo Actual
                    </button>
                `;

                // Agregar botones para per√≠odos espec√≠ficos
                periodos.forEach(periodoKey => {
                    try {
                        const [inicioStr, finStr] = periodoKey.split('_a_');
                        const inicio = new Date(inicioStr);
                        const fin = new Date(finStr);

                        const nombrePeriodo = `${formatoFechaCorta(inicio)} - ${formatoFechaCorta(fin)}`;
                        const esActual = periodoActual && periodoKey === periodoActual.clave;

                        html += `
                            <button class="periodo-btn ${periodoFiltroDepositos === periodoKey ? 'active' : ''}" data-periodo="${periodoKey}">
                                ${nombrePeriodo}${esActual ? ' (Actual)' : ''}
                            </button>
                        `;
                    } catch (e) {
                        console.error('Error procesando per√≠odo:', periodoKey, e);
                    }
                });

                periodosButtons.innerHTML = html;

                // Agregar event listeners a los botones de per√≠odo
                document.querySelectorAll('.periodo-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const periodoSeleccionado = this.getAttribute('data-periodo');

                        // Establecer filtro de per√≠odo
                        periodoFiltroDepositos = periodoSeleccionado || '';
                        document.getElementById('filtro-periodo-depositos').value = periodoFiltroDepositos;

                        // Remover clase active de todos los botones
                        document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
                        // Agregar clase active al bot√≥n clickeado
                        this.classList.add('active');

                        // Recargar dep√≥sitos
                        cargarDepositosPorEquipo();
                    });
                });
            }

            // Funci√≥n para formatear fecha legible corta (solo d√≠a/mes)
            // Funci√≥n para formatear fecha legible corta (solo d√≠a/mes)
            function formatoFechaCorta(fecha) {
                // Manejo directo de strings YYYY-MM-DD para evitar problemas de zona horaria
                if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha.substring(0, 10))) {
                    const parts = fecha.substring(0, 10).split('-');
                    return `${parts[2]}/${parts[1]}`;
                }

                if (typeof fecha === 'string') {
                    // Intento de parseo seguro agregando hora si falta
                    if (fecha.length === 10) fecha += 'T00:00:00';
                    fecha = new Date(fecha);
                }
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                return `${dia}/${mes}`;
            }

            // Funci√≥n para formatear fecha legible completa
            function formatoFechaLegible(fecha) {
                // Manejo directo de strings YYYY-MM-DD para evitar problemas de zona horaria
                if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha.substring(0, 10))) {
                    const parts = fecha.substring(0, 10).split('-');
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }

                if (typeof fecha === 'string') {
                    if (fecha.length === 10) fecha += 'T00:00:00';
                    fecha = new Date(fecha);
                }
                const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
                return fecha.toLocaleDateString('es-ES', opciones);
            }

            // Funci√≥n para cargar el panel de registro r√°pido
            async function cargarPanelRegistroRapido() {
                const gridEquipos = document.getElementById('grid-equipos-rapido');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                if (equipos.length === 0) {
                    gridEquipos.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <p style="color: #7f8c8d; font-style: italic;">
                                No hay equipos registrados. Ve a la pesta√±a "Gestionar Equipos" para registrar el primero.
                            </p>
                        </div>
                    `;
                    return;
                }

                // Ordenar equipos por n√∫mero
                equipos.sort((a, b) => a.numero - b.numero);

                let html = '';

                equipos.forEach(equipo => {
                    // Obtener ingresos del equipo en el per√≠odo actual
                    const ingresosEquipo = ingresos.filter(ingreso =>
                        ingreso.equipo === equipo.numero &&
                        ingreso.fecha >= periodoActual.inicioStr &&
                        ingreso.fecha <= periodoActual.finStr
                    );

                    // Calcular estad√≠sticas solicitadas
                    const diasPeriodo = calcularDiasEnPeriodo();
                    const ingresosRegistrados = ingresosEquipo.length;

                    // D√≠as laborados (monto > 0)
                    const diasLaborados = ingresosEquipo.filter(ing => ing.monto > 0).length;

                    // D√≠as de descanso (monto == 0)
                    const diasDescanso = ingresosEquipo.filter(ing => ing.monto === 0).length;

                    const porcentajeCompletado = Math.round((ingresosRegistrados / diasPeriodo) * 100);

                    // Calcular total registrado (Saldo Acumulado)
                    const totalRegistrado = ingresosEquipo.reduce((sum, ingreso) => sum + ingreso.monto, 0);

                    // Calcular fechas pendientes de registro
                    const fechasPendientes = [];
                    const hoy = new Date();
                    const inicioDate = new Date(periodoActual.inicio);
                    const finDate = new Date(periodoActual.fin);

                    for (let d = new Date(inicioDate); d <= finDate; d.setDate(d.getDate() + 1)) {
                        const fechaStr = formatoFechaSQL(new Date(d));
                        const tieneIngreso = ingresosEquipo.some(ing => ing.fecha === fechaStr);
                        const esPasado = new Date(d) < hoy;

                        if (!tieneIngreso && esPasado) {
                            const diaPendiente = fechaStr.split('-')[2];
                            fechasPendientes.push(parseInt(diaPendiente));
                        }
                    }

                    html += `
                        <div class="equipo-card-rapido" data-equipo="${equipo.numero}" 
                            style="display: flex; flex-direction: column; min-height: 180px;">
                            <div class="equipo-header-rapido" style="margin-bottom: 5px;">
                                <div class="equipo-numero-rapido">Equipo ${equipo.numero}</div>
                            </div>
                            
                            <div class="equipo-info-rapido" style="flex-grow: 1; padding-top: 5px;">
                                ${fechasPendientes.length > 0 ? `
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <strong style="color: #F87171; font-size: 0.85rem;">Fechas pendientes:</strong>
                                        <div style="font-size: 0.8rem; color: #94A3B8; line-height: 1.2;">
                                            ${fechasPendientes.slice(0, 8).join(', ')}${fechasPendientes.length > 8 ? '...' : ''}
                                        </div>
                                    </div>
                                ` : `
                                    <div style="color: #4ADE80; font-size: 0.85rem; font-weight: 500;">
                                        ‚úì Todas las fechas registradas
                                    </div>
                                `}
                            </div>

                            <div class="equipo-progreso" style="margin-top: 10px;">
                                <div class="barra-progreso">
                                    <div class="progreso-completado" style="width: ${porcentajeCompletado}%"></div>
                                </div>
                                <div class="estadisticas-equipo">
                                    <span>${ingresosRegistrados}/${diasPeriodo} d√≠as</span>
                                    <span>${porcentajeCompletado}%</span>
                                </div>
                            </div>
                            <div class="total-equipo-periodo" style="text-align: right; margin-top: 5px; font-weight: bold; font-size: 1rem; color: #F1F5F9;">
                                Total: $${totalRegistrado}
                            </div>
                        </div>
                    `;
                });

                gridEquipos.innerHTML = html;

                // Agregar event listeners a las tarjetas de equipo
                document.querySelectorAll('.equipo-card-rapido').forEach(card => {
                    card.addEventListener('click', function () {
                        const numeroEquipo = parseInt(this.getAttribute('data-equipo'));
                        abrirCalendarioEquipo(numeroEquipo);
                    });
                });
            }

            // Funci√≥n para abrir calendario de un equipo
            function abrirCalendarioEquipo(numeroEquipo) {
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                equipoSeleccionado = equipos.find(e => e.numero === numeroEquipo);

                if (!equipoSeleccionado) {
                    alert('Equipo no encontrado');
                    return;
                }

                // Actualizar UI
                document.getElementById('nombre-equipo-calendario').textContent =
                    `Equipo ${equipoSeleccionado.numero} - ${equipoSeleccionado.nombre}`;

                // Mostrar calendario y ocultar grid de equipos y t√≠tulo
                document.getElementById('titulo-registro-rapido').style.display = 'none';
                document.getElementById('grid-equipos-rapido').style.display = 'none';
                document.getElementById('calendario-periodo-container').style.display = 'block';

                // Generar calendario
                generarCalendarioPeriodo();
            }

            // Funci√≥n para cerrar calendario y volver a equipos
            function cerrarCalendario() {
                document.getElementById('titulo-registro-rapido').style.display = 'block';
                document.getElementById('grid-equipos-rapido').style.display = 'grid';
                document.getElementById('calendario-periodo-container').style.display = 'none';
                equipoSeleccionado = null;
                diaSeleccionado = null;
            }

            // Funci√≥n para generar el calendario del per√≠odo con DOMINGO como primer d√≠a
            function generarCalendarioPeriodo() {
                if (!equipoSeleccionado || !periodoActual) return;

                const gridDias = document.getElementById('grid-dias-calendario');
                const sidebarStats = document.getElementById('sidebar-stats-rapido');
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);

                // Obtener ingresos del equipo en el per√≠odo actual para las estad√≠sticas
                const ingresosEquipo = ingresos.filter(ing =>
                    ing.equipo === equipoSeleccionado.numero &&
                    ing.fecha >= periodoActual.inicioStr &&
                    ing.fecha <= periodoActual.finStr
                );

                // C√°lculos de estad√≠sticas
                const diasLaborados = ingresosEquipo.filter(ing => ing.monto > 0).length;
                const diasDescanso = ingresosEquipo.filter(ing => ing.monto === 0).length;
                const totalAcumulado = ingresosEquipo.reduce((sum, ing) => sum + ing.monto, 0);
                const diasTotalesPeriodo = calcularDiasEnPeriodo();
                const porcentaje = Math.round((ingresosEquipo.length / diasTotalesPeriodo) * 100);

                // Poblar barra lateral
                if (sidebarStats) {
                    sidebarStats.innerHTML = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 0.8rem; color: #a0aec0; text-transform: uppercase; letter-spacing: 1px;">Saldo Acumulado</div>
                            <div style="font-size: 2.2rem; font-weight: bold; color: #48bb78; margin-top: 5px;">$${totalAcumulado}</div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div style="background: rgba(72, 187, 120, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid #48bb78;">
                                <div style="font-size: 0.75rem; color: #a0aec0;">D√≠as Laborados</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #e2e8f0;">${diasLaborados} d√≠as</div>
                            </div>

                            <div style="background: rgba(160, 174, 192, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid #a0aec0;">
                                <div style="font-size: 0.75rem; color: #a0aec0;">D√≠as de Descanso ($0)</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #e2e8f0;">${diasDescanso} d√≠as</div>
                            </div>

                            <div style="background: rgba(66, 153, 225, 0.1); padding: 12px; border-radius: 6px; border-left: 4px solid #4299e1;">
                                <div style="font-size: 0.75rem; color: #a0aec0;">Progreso del Per√≠odo</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #e2e8f0;">${porcentaje}%</div>
                                <div style="height: 4px; background: #2d3748; border-radius: 2px; margin-top: 8px;">
                                    <div style="width: ${porcentaje}%; height: 100%; background: #4299e1; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #4a5568;">
                            <div style="font-size: 0.75rem; color: #718096; line-height: 1.4;">
                                * Los datos se actualizan autom√°ticamente al registrar montos en el calendario.
                            </div>
                        </div>
                    `;
                }

                // Obtener monto predeterminado del equipo
                const montoPredeterminado = equipoSeleccionado.montoPredeterminado || 30;

                // Crear array de d√≠as del per√≠odo
                const diasPeriodo = [];
                const fechaActual = new Date(periodoActual.inicio);
                const fechaFin = new Date(periodoActual.fin);

                while (fechaActual <= fechaFin) {
                    diasPeriodo.push(new Date(fechaActual));
                    fechaActual.setDate(fechaActual.getDate() + 1);
                }

                // Determinar d√≠a de inicio (domingo = 0)
                const primerDia = new Date(diasPeriodo[0]);
                const diaInicio = primerDia.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S√°bado

                // Generar celdas vac√≠as para alinear el primer d√≠a en la columna correcta
                let html = '';

                // Agregar celdas vac√≠as antes del primer d√≠a para alinear con DOMINGO
                for (let i = 0; i < diaInicio; i++) {
                    html += '<div class="dia-calendario fuera-periodo"></div>';
                }

                // Generar d√≠as del per√≠odo
                diasPeriodo.forEach(fecha => {
                    const fechaStr = formatoFechaSQL(fecha);
                    const ingreso = ingresos.find(ing =>
                        ing.equipo === equipoSeleccionado.numero && ing.fecha === fechaStr
                    );

                    // Determinar el tipo de d√≠a
                    let claseDia = '';
                    const fechaSinHora = new Date(fecha);
                    fechaSinHora.setHours(0, 0, 0, 0);

                    if (ingreso) {
                        // D√≠a con entrega registrada - VERDE (incluye s√°bados y domingos)
                        claseDia = 'registrado';
                    } else if (fechaSinHora.getTime() === hoy.getTime()) {
                        // Hoy - AZUL
                        claseDia = 'hoy';
                    } else if (fechaSinHora > hoy) {
                        // D√≠a futuro - BLANCO
                        claseDia = 'futuro';
                    } else {
                        // D√≠a pasado sin entrega - ROJO
                        claseDia = 'pasado-sin-entregas';
                    }

                    // Verificar si es fin de semana
                    const diaSemana = fecha.getDay();
                    if ((diaSemana === 0 || diaSemana === 6) && !ingreso) {
                        // Solo agregar clase descanso si NO tiene entrega
                        claseDia += ' descanso';
                    }

                    // Monto para mostrar (ingreso real o predeterminado)
                    const montoMostrar = ingreso ? ingreso.monto : montoPredeterminado;

                    html += `
                        <div class="dia-calendario ${claseDia}" data-fecha="${fechaStr}">
                            <div class="numero-dia">${fecha.getDate()}</div>
                            <input type="number" 
                                   class="monto-input-simple" 
                                   value="${montoMostrar}" 
                                   data-fecha="${fechaStr}"
                                   min="0" 
                                   max="99"
                                   ${ingreso ? 'readonly' : ''}>
                            ${ingreso && ingreso.observacion !== 'Sin observaci√≥n' ?
                            `<div class="observacion-dia" title="${ingreso.observacion}">${ingreso.observacion}</div>` :
                            ''}
                        </div>
                    `;
                });

                gridDias.innerHTML = html;

                // Agregar event listeners a los inputs de monto
                document.querySelectorAll('.monto-input-simple:not([readonly])').forEach(input => {
                    input.addEventListener('change', function () {
                        const fecha = this.getAttribute('data-fecha');
                        let monto = parseInt(this.value) || 0;

                        // Validar rango (0-99)
                        if (monto < 0) monto = 0;
                        if (monto > 99) monto = 99;

                        this.value = monto;

                        // Abrir modal para confirmar/agregar observaci√≥n
                        abrirModalRegistro(fecha, monto);
                    });

                    input.addEventListener('click', function (e) {
                        e.stopPropagation();
                        this.select();
                    });
                });

                // Agregar event listeners a los d√≠as ya registrados (para ver/editar)
                document.querySelectorAll('.dia-calendario.registrado').forEach(dia => {
                    dia.addEventListener('click', function () {
                        const fecha = this.getAttribute('data-fecha');
                        const ingreso = ingresos.find(ing =>
                            ing.equipo === equipoSeleccionado.numero && ing.fecha === fecha
                        );

                        if (ingreso) {
                            abrirModalEditarEntrega(ingreso);
                        }
                    });
                });

                // NUEVO: Agregar event listeners a d√≠as vac√≠os (pasados y hoy) para registrar
                document.querySelectorAll('.dia-calendario:not(.registrado):not(.futuro)').forEach(dia => {
                    dia.addEventListener('click', function (e) {
                        // Evitar conflicto si se hace clic en el input
                        if (e.target.classList.contains('monto-input-simple')) return;

                        const fecha = this.getAttribute('data-fecha');
                        // Al hacer clic en el d√≠a (y no en el input), ignoramos el valor visual del input
                        // y forzamos el uso del monto predeterminado actual del equipo (pasando null).
                        abrirModalRegistro(fecha, null);
                    });
                });
            }

            // Funci√≥n para abrir modal de registro
            function abrirModalRegistro(fecha, montoPrecargado = null) {
                if (!equipoSeleccionado) return;

                diaSeleccionado = fecha;
                // Agregar T00:00:00 para asegurar que se interprete como hora local y no UTC
                const fechaObj = new Date(fecha + 'T00:00:00');
                const montoPredeterminado = equipoSeleccionado.montoPredeterminado || 30;

                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const ingresoExistente = ingresos.find(ing =>
                    ing.equipo === equipoSeleccionado.numero && ing.fecha === fecha
                );

                // Actualizar informaci√≥n del modal
                document.getElementById('modal-titulo').textContent =
                    ingresoExistente ? 'Editar Entrega' : 'Registrar Entrega';

                document.getElementById('info-registro').innerHTML = `
                    <p><strong>Fecha:</strong> ${formatoFechaLegible(fechaObj)}</p>
                    <p><strong>Equipo:</strong> ${equipoSeleccionado.numero} - ${equipoSeleccionado.nombre}</p>
                    <p><strong>Monto predeterminado:</strong> $${montoPredeterminado}</p>
                `;

                // Configurar campos
                if (ingresoExistente) {
                    document.getElementById('modal-monto').value = ingresoExistente.monto;
                    document.getElementById('modal-observacion').value = ingresoExistente.observacion;
                } else {
                    document.getElementById('modal-monto').value = montoPrecargado || montoPredeterminado;
                    document.getElementById('modal-observacion').value = '';
                }

                // Mostrar modal
                document.getElementById('modal-registro').style.display = 'flex';

                // Re-asegurar listener del bot√≥n guardar
                document.getElementById('guardar-modal').onclick = guardarEntregaModal;
            }

            // Funci√≥n para abrir modal de edici√≥n de entrega existente
            function abrirModalEditarEntrega(ingreso) {
                diaSeleccionado = ingreso.fecha;
                // Agregar T00:00:00 para asegurar que se interprete como hora local y no UTC
                const fechaObj = new Date(ingreso.fecha + 'T00:00:00');

                document.getElementById('modal-titulo').textContent = 'Editar Entrega';

                document.getElementById('info-registro').innerHTML = `
                    <p><strong>Fecha:</strong> ${formatoFechaLegible(fechaObj)}</p>
                    <p><strong>Equipo:</strong> ${ingreso.equipo} - ${ingreso.nombre}</p>
                    <p><strong>Registro existente</strong></p>
                `;

                document.getElementById('modal-monto').value = ingreso.monto;
                document.getElementById('modal-observacion').value = ingreso.observacion;

                document.getElementById('modal-registro').style.display = 'flex';

                // Re-asegurar listener del bot√≥n guardar
                document.getElementById('guardar-modal').onclick = guardarEntregaModal;
            }

            // Funci√≥n para cerrar modal
            function cerrarModal() {
                document.getElementById('modal-registro').style.display = 'none';
                diaSeleccionado = null;
            }

            // Variable global para evitar doble guardado
            let isSavingEntry = false;

            // Funci√≥n para guardar entrega desde modal
            async function guardarEntregaModal() {
                if (isSavingEntry) return;

                const btnGuardar = document.getElementById('guardar-modal');
                if (btnGuardar.disabled) return;

                // Set lock
                isSavingEntry = true;
                btnGuardar.disabled = true;

                if (!equipoSeleccionado || !diaSeleccionado) {
                    alert('Error: No hay equipo o d√≠a seleccionado');
                    isSavingEntry = false;
                    btnGuardar.disabled = false;
                    return;
                }

                const monto = parseInt(document.getElementById('modal-monto').value) || 0;
                const observacion = document.getElementById('modal-observacion').value.trim() || 'Sin observaci√≥n';

                if (monto < 0) {
                    alert('El monto no puede ser negativo');
                    isSavingEntry = false;
                    btnGuardar.disabled = false;
                    return;
                }

                // Validar que si el monto es 0, exista una observaci√≥n
                if (monto === 0 && (!observacion || observacion.trim() === '' || observacion === 'Sin observaci√≥n')) {
                    alert('Si el monto es $0, es obligatorio agregar una observaci√≥n o justificaci√≥n.');
                    isSavingEntry = false;
                    btnGuardar.disabled = false;
                    return;
                }

                // Confirmaci√≥n doble
                if (!confirm(`¬øConfirmar registro de entrega?\n\nEquipo: ${equipoSeleccionado.numero}\nFecha: ${diaSeleccionado}\nMonto: $${monto}`)) {
                    isSavingEntry = false;
                    btnGuardar.disabled = false;
                    return;
                }

                btnGuardar.textContent = 'Guardando...';

                try {
                    const montoPredeterminado = equipoSeleccionado.montoPredeterminado || 30;

                    // Buscar si existe un ingreso previo para mantener el ID y evitar duplicados
                    const ingresosLocal = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    const ingresoPrevio = ingresosLocal.find(ing =>
                        ing.equipo == equipoSeleccionado.numero && ing.fecha === diaSeleccionado
                    );

                    const idIngreso = ingresoPrevio ? ingresoPrevio.id : Date.now().toString();

                    const nuevoIngreso = {
                        id: idIngreso,
                        equipo: equipoSeleccionado.numero,
                        nombre: equipoSeleccionado.nombre,
                        fecha: diaSeleccionado,
                        monto: monto,
                        montoPredeterminado: montoPredeterminado,
                        observacion: observacion,
                        periodo: periodoActual.inicioStr + '_a_' + periodoActual.finStr,
                        fechaRegistro: formatoFechaSQL(new Date())
                    };

                    // Guardar en Firebase
                    const exito = await guardarEnFirebase('ingresos', nuevoIngreso, nuevoIngreso.id);

                    if (exito) {
                        // Guardar localmente
                        let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                        ingresos = ingresos.filter(ing =>
                            !(ing.equipo === equipoSeleccionado.numero && ing.fecha === diaSeleccionado)
                        );
                        ingresos.push(nuevoIngreso);
                        localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                        generarCalendarioPeriodo();
                        cargarPanelRegistroRapido();

                        cerrarModal();
                        alert('Entrega registrada correctamente');
                    } else {
                        alert('Error al guardar la entrega. Los datos se guardar√°n localmente.');

                        // Guardar solo localmente
                        let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                        ingresos = ingresos.filter(ing =>
                            !(ing.equipo === equipoSeleccionado.numero && ing.fecha === diaSeleccionado)
                        );
                        ingresos.push(nuevoIngreso);
                        localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                        generarCalendarioPeriodo();
                        cargarPanelRegistroRapido();
                        cerrarModal();
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error inesperado al guardar.');
                } finally {
                    isSavingEntry = false;
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Entrega';
                }
            }

            // ===== FUNCIONES DE GESTI√ìN DE EQUIPOS =====

            async function guardarEquipo() {
                const numero = parseInt(document.getElementById('numero-equipo').value) || 0;
                let placa = document.getElementById('placa').value.trim();
                const nombre = document.getElementById('nombre').value.trim();
                const dui = document.getElementById('dui').value.trim();
                const montoPredeterminado = parseInt(document.getElementById('monto-predeterminado-equipo').value) || 30;

                if (numero <= 0) {
                    alert('Por favor, ingrese un n√∫mero de equipo v√°lido.');
                    return;
                }

                // Confirmaci√≥n doble
                if (!confirm(`¬øConfirmar registro de nuevo equipo?\n\nN√∫mero: ${numero}\nNombre: ${nombre}\nPlaca: ${placa}`)) {
                    return;
                }

                // Formatear placa
                if (placa && !placa.toUpperCase().startsWith('M')) {
                    placa = 'M' + placa.toUpperCase();
                }

                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                if (equipos.some(equipo => equipo.numero === numero)) {
                    alert('Ya existe un equipo con ese n√∫mero.');
                    return;
                }

                const nuevoEquipo = {
                    numero: numero,
                    placa: placa || 'No registrada',
                    nombre: nombre || 'No registrado',
                    dui: dui || 'No registrado',
                    montoPredeterminado: montoPredeterminado,
                    fechaRegistro: formatoFechaSQL(new Date())
                };

                const id = Date.now().toString();
                const exito = await guardarEnFirebase('equipos', nuevoEquipo, id.toString());

                if (exito) {
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                    cargarListaEquipos();
                    cargarPanelRegistroRapido();

                    // Limpiar formulario
                    document.getElementById('numero-equipo').value = '';
                    document.getElementById('placa').value = '';
                    document.getElementById('nombre').value = '';
                    document.getElementById('dui').value = '';
                    document.getElementById('monto-predeterminado-equipo').value = '30';

                    alert('Equipo registrado correctamente.');
                } else {
                    alert('Error al guardar el equipo. Los datos se guardar√°n localmente.');
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                    cargarListaEquipos();
                    cargarPanelRegistroRapido();
                }
            }

            function cargarListaEquipos() {
                const listaEquipos = document.getElementById('lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                if (equipos.length === 0) {
                    listaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados.</div>';
                    return;
                }

                let html = '';
                equipos.sort((a, b) => a.numero - b.numero).forEach(equipo => {
                    html += `
                        <div class="ingreso-item">
                            <div class="ingreso-equipo">Equipo ${equipo.numero}</div>
                            <div class="ingreso-cliente">${equipo.nombre}</div>
                            <div class="ingreso-info">
                                Placa: ${equipo.placa} | DUI: ${equipo.dui} | 
                                Monto predeterminado: $${(equipo.montoPredeterminado || 30)}
                            </div>
                            <button class="edit-btn" data-id="${equipo.id}" data-numero="${equipo.numero}">Modificar</button>
                            <button class="delete-btn" data-id="${equipo.id}">Eliminar</button>
                        </div>
                    `;
                });

                listaEquipos.innerHTML = html;

                // Event listeners para botones de modificar
                document.querySelectorAll('#lista-equipos .edit-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        const numero = this.getAttribute('data-numero');
                        abrirModalEditarEquipo(id, numero);
                    });
                });

                // Event listeners para botones de eliminar
                document.querySelectorAll('#lista-equipos .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        eliminarEquipo(id);
                    });
                });
            }

            // Funci√≥n para abrir modal de edici√≥n de equipo
            function abrirModalEditarEquipo(id, numero) {
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                equipoAEditar = equipos.find(e => e.id === id);

                if (!equipoAEditar) {
                    alert('Equipo no encontrado');
                    return;
                }

                // Llenar formulario con datos actuales
                document.getElementById('editar-numero-equipo').value = equipoAEditar.numero;
                document.getElementById('editar-placa').value = equipoAEditar.placa;
                document.getElementById('editar-nombre').value = equipoAEditar.nombre;
                document.getElementById('editar-dui').value = equipoAEditar.dui;
                document.getElementById('editar-monto-predeterminado').value = equipoAEditar.montoPredeterminado || 30;

                // Mostrar modal
                document.getElementById('modal-editar-equipo').style.display = 'flex';
            }

            // Funci√≥n para cerrar modal de edici√≥n de equipo
            function cerrarModalEditar() {
                document.getElementById('modal-editar-equipo').style.display = 'none';
                equipoAEditar = null;
            }

            // Funci√≥n para guardar cambios en equipo
            async function guardarCambiosEquipo() {
                if (!equipoAEditar) return;

                const placa = document.getElementById('editar-placa').value.trim();
                const nombre = document.getElementById('editar-nombre').value.trim();
                const dui = document.getElementById('editar-dui').value.trim();
                const montoPredeterminado = parseInt(document.getElementById('editar-monto-predeterminado').value) || 30;

                // Formatear placa
                let placaFormateada = placa;
                if (placaFormateada && !placaFormateada.toUpperCase().startsWith('M')) {
                    placaFormateada = 'M' + placaFormateada.toUpperCase();
                }

                const equipoActualizado = {
                    ...equipoAEditar,
                    placa: placaFormateada || 'No registrada',
                    nombre: nombre || 'No registrado',
                    dui: dui || 'No registrado',
                    montoPredeterminado: montoPredeterminado,
                    fechaActualizacion: formatoFechaSQL(new Date())
                };

                // Guardar en Firebase
                const exito = await guardarEnFirebase('equipos', equipoActualizado, equipoAEditar.id);

                if (exito) {
                    // Actualizar localmente
                    let equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    equipos = equipos.map(e => e.id === equipoAEditar.id ? equipoActualizado : e);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Actualizar UI
                    cargarListaEquipos();
                    cargarPanelRegistroRapido();

                    // Si este equipo est√° seleccionado en el calendario, actualizarlo
                    if (equipoSeleccionado && equipoSeleccionado.numero === equipoAEditar.numero) {
                        equipoSeleccionado = equipoActualizado;
                        generarCalendarioPeriodo();
                    }

                    cerrarModalEditar();
                    alert('Equipo actualizado correctamente.');
                } else {
                    alert('Error al actualizar el equipo. Los cambios se guardar√°n localmente.');

                    // Actualizar solo localmente
                    let equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    equipos = equipos.map(e => e.id === equipoAEditar.id ? equipoActualizado : e);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    cargarListaEquipos();
                    cargarPanelRegistroRapido();
                    cerrarModalEditar();
                }
            }

            async function eliminarEquipo(id) {
                if (!confirm('¬øEst√° seguro de eliminar este equipo? Tambi√©n se eliminar√°n todos sus ingresos registrados.')) {
                    return;
                }

                // Obtener el equipo para saber su n√∫mero
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const equipo = equipos.find(e => e.id === id);

                if (!equipo) return;

                // Eliminar equipo de Firebase
                const exitoEquipo = await eliminarDeFirebase('equipos', id);

                // Eliminar ingresos de este equipo de Firebase
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const ingresosEquipo = ingresos.filter(ing => ing.equipo === equipo.numero);

                for (const ingreso of ingresosEquipo) {
                    await eliminarDeFirebase('ingresos', ingreso.id);
                }

                if (exitoEquipo) {
                    // Actualizar datos locales
                    let equiposActualizados = equipos.filter(e => e.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equiposActualizados));

                    let ingresosActualizados = ingresos.filter(ing => ing.equipo !== equipo.numero);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresosActualizados));

                    // Actualizar UI
                    cargarListaEquipos();
                    cargarPanelRegistroRapido();

                    alert('Equipo eliminado correctamente.');
                } else {
                    alert('Error al eliminar el equipo. Se eliminar√° solo localmente.');

                    // Eliminar solo localmente
                    let equiposActualizados = equipos.filter(e => e.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equiposActualizados));

                    let ingresosActualizados = ingresos.filter(ing => ing.equipo !== equipo.numero);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresosActualizados));

                    cargarListaEquipos();
                    cargarPanelRegistroRapido();
                }
            }

            // ===== FUNCIONES AUXILIARES =====

            function calcularDiasEnPeriodo() {
                if (!periodoActual) return 0;

                const msPorDia = 1000 * 60 * 60 * 24;
                const diferenciaMs = periodoActual.fin - periodoActual.inicio;
                return Math.floor(diferenciaMs / msPorDia) + 1;
            }

            // ===== FUNCIONES EXISTENTES (mantenidas para compatibilidad) =====

            async function cargarDatosFirebase() {
                try {
                    // Cargar equipos
                    const equiposSnapshot = await db.collection('equipos').get();
                    const equipos = [];
                    equiposSnapshot.forEach(doc => {
                        const equipoData = doc.data();
                        equipos.push({ id: doc.id, ...equipoData });
                    });
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));

                    // Cargar ingresos (entregas)
                    const ingresosSnapshot = await db.collection('ingresos').get();
                    const ingresos = [];
                    ingresosSnapshot.forEach(doc => {
                        ingresos.push({ id: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                } catch (error) {
                    console.error("Error cargando datos desde Firebase:", error);
                    if (!localStorage.getItem('equiposMototaxis')) {
                        localStorage.setItem('equiposMototaxis', JSON.stringify([]));
                    }
                    if (!localStorage.getItem('ingresosMototaxis')) {
                        localStorage.setItem('ingresosMototaxis', JSON.stringify([]));
                    }
                }
            }

            async function guardarEnFirebase(coleccion, datos, id) {
                try {
                    await db.collection(coleccion).doc(id.toString()).set(datos);
                    return true;
                } catch (error) {
                    console.error("Error guardando en Firebase:", error);
                    return false;
                }
            }

            async function eliminarDeFirebase(coleccion, id) {
                try {
                    await db.collection(coleccion).doc(id.toString()).delete();
                    return true;
                } catch (error) {
                    console.error("Error eliminando de Firebase:", error);
                    return false;
                }
            }

            function formatoFechaSQL(fecha) {
                const a√±o = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                return `${a√±o}-${mes}-${dia}`;
            }

            // ===== FUNCI√ìN DE DEP√ìSITOS POR EQUIPO MEJORADA =====
            function cargarDepositosPorEquipo() {
                const depositosListaEquipos = document.getElementById('depositos-lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                if (equipos.length === 0) {
                    depositosListaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados.</div>';
                    return;
                }

                // Aplicar filtro de equipo
                const filtroEquipo = document.getElementById('filtro-equipo-depositos').value;
                let equiposFiltrados = [...equipos];

                if (filtroEquipo) {
                    equiposFiltrados = equiposFiltrados.filter(equipo => equipo.numero == filtroEquipo);
                }

                // Ordenar equipos por n√∫mero
                equiposFiltrados.sort((a, b) => a.numero - b.numero);

                let html = '';

                equiposFiltrados.forEach(equipo => {
                    // Filtrar ingresos por equipo
                    let ingresosEquipo = ingresos.filter(ingreso => ingreso.equipo === equipo.numero);

                    // Aplicar filtro de per√≠odo si est√° activo
                    if (periodoFiltroDepositos && periodoFiltroDepositos !== '') {
                        if (periodoFiltroDepositos === 'actual') {
                            // Filtrar por per√≠odo actual
                            if (periodoActual && periodoActual.inicioStr && periodoActual.finStr) {
                                ingresosEquipo = ingresosEquipo.filter(ingreso =>
                                    ingreso.fecha >= periodoActual.inicioStr &&
                                    ingreso.fecha <= periodoActual.finStr
                                );
                            }
                        } else if (periodoFiltroDepositos.includes('_a_')) {
                            // Filtrar por per√≠odo espec√≠fico
                            const [inicioPeriodo, finPeriodo] = periodoFiltroDepositos.split('_a_');
                            ingresosEquipo = ingresosEquipo.filter(ingreso =>
                                ingreso.fecha >= inicioPeriodo &&
                                ingreso.fecha <= finPeriodo
                            );
                        }
                    }

                    if (ingresosEquipo.length === 0) {
                        return; // No mostrar equipos sin ingresos en el per√≠odo filtrado
                    }

                    // Calcular total del equipo
                    const totalEquipo = ingresosEquipo.reduce((sum, ingreso) => sum + ingreso.monto, 0);

                    // Ordenar ingresos por fecha (m√°s reciente primero)
                    ingresosEquipo.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                    let ingresosHtml = '';
                    ingresosEquipo.forEach(ingreso => {
                        ingresosHtml += `
                            <div class="deposito-item">
                                <div class="deposito-fecha">${formatoFechaLegible(ingreso.fecha)}</div>
                                <div class="deposito-monto">$${ingreso.monto}</div>
                                <div class="deposito-acciones">
                                    <button class="deposito-eliminar-btn" data-id="${ingreso.id}" title="Eliminar este dep√≥sito">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    // Obtener per√≠odo mostrado
                    let periodoInfo = '';
                    if (periodoFiltroDepositos === 'actual' && periodoActual) {
                        periodoInfo = `Per√≠odo Actual: ${formatoFechaLegible(periodoActual.inicio)} - ${formatoFechaLegible(periodoActual.fin)}`;
                    } else if (periodoFiltroDepositos && periodoFiltroDepositos.includes('_a_')) {
                        const [inicioStr, finStr] = periodoFiltroDepositos.split('_a_');
                        periodoInfo = `Per√≠odo: ${formatoFechaLegible(new Date(inicioStr))} - ${formatoFechaLegible(new Date(finStr))}`;
                    }

                    html += `
                        <div class="deposito-equipo-card">
                            <div class="deposito-equipo-header">
                                <div class="deposito-equipo-numero">Equipo ${equipo.numero}</div>
                                <div class="deposito-equipo-total">$${totalEquipo}</div>
                            </div>
                            <div class="deposito-equipo-info">
                                ${equipo.nombre} - ${equipo.placa}
                                ${periodoInfo ? `<div style="margin-top: 5px; font-size: 0.85rem; color: #a0aec0;">${periodoInfo}</div>` : ''}
                            </div>
                            ${ingresosHtml}
                            <div class="deposito-total">Total: $${totalEquipo}</div>
                        </div>
                    `;
                });

                if (html === '') {
                    const mensaje = periodoFiltroDepositos ?
                        'No hay ingresos registrados para los equipos y per√≠odo seleccionados.' :
                        'No hay ingresos registrados para los equipos seleccionados.';
                    html = `<div class="empty-message">${mensaje}</div>`;
                }

                depositosListaEquipos.innerHTML = html;

                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.deposito-eliminar-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        eliminarIngresoDeposito(id);
                    });
                });
            }

            // Funci√≥n para eliminar un ingreso desde la vista de dep√≥sitos
            async function eliminarIngresoDeposito(id) {
                if (!confirm('¬øEst√° seguro de eliminar este ingreso?')) {
                    return;
                }

                // Eliminar de Firebase
                const exito = await eliminarDeFirebase('ingresos', id);

                if (exito) {
                    // Eliminar localmente
                    let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    const ingresoEliminado = ingresos.find(ing => ing.id === id);
                    ingresos = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Actualizar interfaces
                    cargarPanelRegistroRapido();
                    cargarDepositosPorEquipo(); // Recargar la vista actual
                    cargarPeriodosDisponibles(); // Actualizar botones de per√≠odos

                    // Si este ingreso est√° en el calendario actual, actualizarlo
                    if (equipoSeleccionado && ingresoEliminado &&
                        ingresoEliminado.equipo === equipoSeleccionado.numero) {
                        generarCalendarioPeriodo();
                    }

                    alert('Ingreso eliminado correctamente.');
                } else {
                    alert('Error al eliminar el ingreso. Se eliminar√° solo localmente.');

                    // Eliminar solo localmente
                    let ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    const ingresoEliminado = ingresos.find(ing => ing.id === id);
                    ingresos = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));

                    // Actualizar interfaces
                    cargarPanelRegistroRapido();
                    cargarDepositosPorEquipo();
                    cargarPeriodosDisponibles();

                    if (equipoSeleccionado && ingresoEliminado &&
                        ingresoEliminado.equipo === equipoSeleccionado.numero) {
                        generarCalendarioPeriodo();
                    }
                }
            }

            function actualizarFiltroEquipos(idFiltro) {
                const filtro = document.getElementById(idFiltro);
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];

                // Limpiar opciones actuales (excepto la primera)
                while (filtro.options.length > 1) {
                    filtro.remove(1);
                }

                // Ordenar equipos por n√∫mero
                equipos.sort((a, b) => a.numero - b.numero);

                // Agregar opciones de equipos
                equipos.forEach(equipo => {
                    const option = document.createElement('option');
                    option.value = equipo.numero;
                    option.textContent = `Equipo ${equipo.numero} - ${equipo.nombre}`;
                    filtro.appendChild(option);
                });
            }

            // ===== FUNCI√ìN DE CALENDARIO MENSUAL REDISE√ëADO (V2) =====

            // Variables de estado
            let mesCalendarioVisual = null; // Formato "YYYY-MM"
            let equiposSeleccionadosVisual = new Set(); // IDs de equipos seleccionados
            let primeraCargaEquipos = true;
            if (!window.diasDescanso) {
                window.diasDescanso = {};
            }

            // Inicializar botones de la sidebar
            function inicializarCalendarioVisual() {
                // 1. Generar botones de meses
                const gridMeses = document.getElementById('grid-meses-calendario');
                if (!gridMeses) return;

                gridMeses.innerHTML = '';
                const fechaBase = new Date();

                for (let i = -3; i <= 0; i++) {
                    const d = new Date(fechaBase.getFullYear(), fechaBase.getMonth() + i, 1);
                    const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const nombresMesesCorte = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const label = nombresMesesCorte[d.getMonth()];

                    const btn = document.createElement('button');
                    btn.className = 'btn-seleccion';
                    btn.textContent = label;
                    btn.onclick = () => seleccionarMes(val, btn);
                    gridMeses.appendChild(btn);

                    if (i === 0) {
                        btn.classList.add('active');
                        mesCalendarioVisual = val;
                        document.getElementById('label-mes-seleccionado').textContent = val;
                    }
                }

                // 2. Generar botones de equipos
                cargarBotonesEquipos();
            }

            function cargarBotonesEquipos() {
                const gridEquipos = document.getElementById('grid-equipos-calendario');
                if (!gridEquipos) return;

                gridEquipos.innerHTML = '';
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                equipos.sort((a, b) => a.numero - b.numero);

                // Si es la primera vez, seleccionamos todos por defecto
                if (primeraCargaEquipos) {
                    equipos.forEach(e => equiposSeleccionadosVisual.add(e.numero.toString()));
                    primeraCargaEquipos = false;
                }

                // Bot√≥n "TODOS"
                const btnTodos = document.createElement('button');
                btnTodos.className = 'btn-seleccion';
                if (equiposSeleccionadosVisual.size === equipos.length && equipos.length > 0) {
                    btnTodos.classList.add('active');
                }
                btnTodos.textContent = 'TODOS';
                btnTodos.onclick = () => seleccionarEquipo(null, btnTodos);
                gridEquipos.appendChild(btnTodos);

                // Botones individuales
                equipos.forEach(e => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-seleccion';
                    const idStr = e.numero.toString();
                    if (equiposSeleccionadosVisual.has(idStr)) {
                        btn.classList.add('active');
                    }
                    btn.textContent = e.numero;
                    btn.onclick = () => seleccionarEquipo(idStr, btn);
                    gridEquipos.appendChild(btn);
                });

                generarRecibo();
            }

            function seleccionarMes(mes, btn) {
                document.querySelectorAll('#grid-meses-calendario .btn-seleccion').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mesCalendarioVisual = mes;
                document.getElementById('label-mes-seleccionado').textContent = mes;
                generarRecibo();
            }

            function seleccionarEquipo(id, btn) {
                if (id === null) {
                    // Si es "TODOS"
                    const esActivo = btn.classList.contains('active');
                    if (!esActivo) {
                        equiposSeleccionadosVisual.clear();
                        document.querySelectorAll('#grid-equipos-calendario .btn-seleccion').forEach(b => b.classList.add('active'));
                        const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                        equipos.forEach(e => equiposSeleccionadosVisual.add(e.numero.toString()));
                    } else {
                        equiposSeleccionadosVisual.clear();
                        document.querySelectorAll('#grid-equipos-calendario .btn-seleccion').forEach(b => b.classList.remove('active'));
                    }
                } else {
                    // Si es un equipo individual
                    const idStr = id.toString();
                    if (equiposSeleccionadosVisual.has(idStr)) {
                        equiposSeleccionadosVisual.delete(idStr);
                        btn.classList.remove('active');
                        // Desactivar el bot√≥n "TODOS" si se deselecciona uno
                        const btnTodos = Array.from(document.querySelectorAll('#grid-equipos-calendario .btn-seleccion')).find(b => b.textContent === 'TODOS');
                        if (btnTodos) btnTodos.classList.remove('active');
                    } else {
                        equiposSeleccionadosVisual.add(idStr);
                        btn.classList.add('active');
                    }
                }
                generarRecibo();
            }

            // Funci√≥n para toggle d√≠a de descanso (Global para acceso HTML)
            window.toggleDescanso = function (clave, dia) {
                if (!window.diasDescanso[clave]) {
                    window.diasDescanso[clave] = new Set();
                }

                if (window.diasDescanso[clave].has(dia)) {
                    window.diasDescanso[clave].delete(dia);
                } else {
                    window.diasDescanso[clave].add(dia);
                }

                generarRecibo();
            };

            window.regenerarDescansos = function () {
                if (!mesCalendarioVisual) return;
                const claveDescanso = `${mesCalendarioVisual}_${equipoCalendarioVisual || 'todos'}`;

                // Borrar configuraci√≥n actual para forzar regeneraci√≥n
                delete window.diasDescanso[claveDescanso];

                // Regenerar con la l√≥gica aleatoria
                generarRecibo();
                alert('¬°D√≠as de descanso aleatorios regenerados para este mes!');
            };

            function generarRecibo() {
                if (!mesCalendarioVisual) return;

                const [a√±o, mes] = mesCalendarioVisual.split('-').map(Number);
                const primerDia = new Date(a√±o, mes - 1, 1);
                const ultimoDia = new Date(a√±o, mes, 0);
                const diasEnMes = ultimoDia.getDate();

                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];

                let equiposFiltrados = equipos.filter(e => equiposSeleccionadosVisual.has(e.numero.toString()));

                const claveDescanso = `${mesCalendarioVisual}_todos`;

                // Autogeneraci√≥n de descansos
                if (!window.diasDescanso[claveDescanso]) {
                    window.diasDescanso[claveDescanso] = new Set();
                    const feriadosList = [{ m: 0, d: 1 }, { m: 4, d: 1 }, { m: 7, d: 6 }, { m: 8, d: 15 }, { m: 10, d: 2 }, { m: 11, d: 25 }];
                    for (let d = 1; d <= diasEnMes; d++) {
                        if (feriadosList.some(f => f.d === d && f.m === (mes - 1))) window.diasDescanso[claveDescanso].add(d);
                    }
                    let semanaDias = [];
                    for (let d = 1; d <= diasEnMes; d++) {
                        const dObj = new Date(a√±o, mes - 1, d);
                        semanaDias.push(d);
                        if (dObj.getDay() === 6 || d === diasEnMes) {
                            const disp = semanaDias.filter(dia => !window.diasDescanso[claveDescanso].has(dia));
                            if (disp.length > 0) window.diasDescanso[claveDescanso].add(disp[Math.floor(Math.random() * disp.length)]);
                            semanaDias = [];
                        }
                    }
                }

                // Renderizar Grid Visual
                const gridVisual = document.getElementById('grid-dias-calendario-visual');
                if (gridVisual) {
                    gridVisual.innerHTML = '';
                    for (let i = 0; i < primerDia.getDay(); i++) gridVisual.innerHTML += '<div style="background: transparent;"></div>';
                    for (let d = 1; d <= dEnMes(a√±o, mes); d++) {
                        const esDescanso = window.diasDescanso[claveDescanso].has(d);
                        const celda = document.createElement('div');
                        celda.className = `celda-dia-visual ${esDescanso ? 'dia-descanso' : 'dia-laboral'}`;
                        celda.onclick = () => window.toggleDescanso(claveDescanso, d);
                        celda.innerHTML = `
                            <div class="numero" style="font-weight: bold; font-size: 1.1rem;">${d}</div>
                            <div class="badge-monto" style="font-size: 0.9rem; opacity: 0.9;">$${esDescanso ? '0' : '30'}</div>
                        `;
                        gridVisual.appendChild(celda);
                    }
                }

                function dEnMes(y, m) { return new Date(y, m, 0).getDate(); }

                const nmFull = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

                // Actualizar encabezado visual
                let textoEquipo = '';
                if (equiposSeleccionadosVisual.size === 0) {
                    textoEquipo = 'Ning√∫n equipo seleccionado';
                } else if (equiposSeleccionadosVisual.size === 1) {
                    textoEquipo = `Equipo ${Array.from(equiposSeleccionadosVisual)[0]}`;
                } else {
                    textoEquipo = `${equiposSeleccionadosVisual.size} Equipos seleccionados`;
                }

                document.getElementById('info-equipo-header').textContent = textoEquipo;
                document.getElementById('info-mes-header').textContent = `${nmFull[mes - 1]} ${a√±o}`;

                generarContenidoImpresion(equiposFiltrados, a√±o, mes, dEnMes(a√±o, mes), ingresos, claveDescanso);
            }

            // Funci√≥n para generar contenido de impresi√≥n
            function generarContenidoImpresion(equipos, a√±o, mes, diasEnMes, ingresos, claveDescanso) {
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const nombreMes = meses[mes - 1];

                let htmlPrint = '';

                equipos.forEach(equipo => {
                    let totalMes = 0;
                    let filasTabla = '';

                    for (let dia = 1; dia <= diasEnMes; dia++) {
                        // L√≥gica SIMPLIFICADA: D√≠as laborales = $30, Descanso = $0
                        // Ignoramos montos reales de DB
                        const esDescanso = window.diasDescanso[claveDescanso] && window.diasDescanso[claveDescanso].has(dia);

                        let monto = 0;

                        if (esDescanso) {
                            monto = 0;
                        } else {
                            monto = 30; // Monto FIJO de $30
                        }

                        totalMes += monto;

                        const claseDescanso = esDescanso ? 'dia-descanso-tabla' : '';
                        const claseMonto = esDescanso ? 'monto-descanso' : '';

                        filasTabla += `
                                <tr class="${claseDescanso}">
                                    <td class="col-dia">${dia}</td>
                                    <td class="col-monto ${claseMonto}">$${monto}</td>
                                    <td class="col-observacion"></td>
                                </tr>
                            `;
                    }

                    // Formatear placa si es necesario (asegurar M)
                    let placa = equipo.placa || 'N/A';

                    htmlPrint += `
                        <div class="recibo-mensual" style="page-break-after: always;">
                            <div class="encabezado-recibo">
                                <div class="linea-1">RECIBO DE INGRESO EN CONCEPTO DE</div>
                                <div class="linea-2">TRANSPORTE P√öBLICO ALTERNATIVO LOCAL</div>
                                <div class="info-mes">Mes: ${nombreMes} ${a√±o}</div>
                            </div>

                            <div class="contenedor-principal">
                                <div class="columna-tabla">
                                    <table class="tabla-dias">
                                        <thead>
                                            <tr>
                                                <th class="col-dia" style="border: 1px solid black; padding: 5px; width: 20%;">D√≠a</th>
                                                <th class="col-monto" style="border: 1px solid black; padding: 5px; width: 20%;">Monto</th>
                                                <th class="col-observacion" style="border: 1px solid black; padding: 5px; width: 60%;">Observaci√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${filasTabla}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="columna-datos">
                                    <div class="datos-conductor">
                                        <div class="dato-item">
                                            <span class="dato-label">Placa:</span>
                                            <span class="dato-valor">${placa}</span>
                                        </div>
                                        <div class="dato-item">
                                            <span class="dato-label">Conductor:</span>
                                            <span class="dato-valor">${equipo.nombre || 'N/A'}</span>
                                        </div>
                                        <div class="dato-item">
                                            <span class="dato-label">DUI:</span>
                                            <span class="dato-valor">${equipo.dui || 'N/A'}</span>
                                        </div>
                                        <div class="firma-recibo" style="margin-top: 50px;">
                                            <div class="linea-firma" style="text-align: center; border-top: 1px solid black; padding-top: 5px;">
                                                Firma
                                            </div>
                                        </div>

                                        <div class="seccion-total" style="margin-top: 30px; text-align: center;">
                                            <div style="display: inline-block; border: 1px solid black; padding: 10px 20px; font-size: 9pt; font-weight: bold;">
                                                TOTAL: $${totalMes}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('recibo-print').innerHTML = htmlPrint;
            }

            // ===== L√ìGICA DE SELECCI√ìN DE IMPRESI√ìN =====

            // Reemplazar listener cuando el documento est√© listo
            document.addEventListener('DOMContentLoaded', function () {
                const tabsList = document.querySelectorAll('.tab');
                tabsList.forEach(t => {
                    t.addEventListener('click', () => {
                        if (t.getAttribute('data-tab') === 'calendario') {
                            setTimeout(inicializarCalendarioVisual, 100);
                        }
                    });
                });

                // Carga inicial
                setTimeout(inicializarCalendarioVisual, 500);
            });

            function iniciarSeleccionImpresion() {
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                equipos.sort((a, b) => a.numero - b.numero);

                const modalId = 'modal-seleccion-impresion';
                let mod = document.getElementById(modalId);
                if (mod) mod.remove();

                const hEquipos = equipos.map(e => `
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; color: black;">
                            <input type="checkbox" class="chk-impresion" value="${e.numero}" checked style="margin-right: 10px;">
                            <span>Equipo ${e.numero} - ${e.nombre}</span>
                        </label>
                    </div>
                `).join('');

                const mHtml = `
                    <div class="modal-overlay" id="${modalId}" style="display: flex; z-index: 10000;">
                        <div class="modal-contenido" style="max-width: 400px; background: white; color: black;">
                            <div class="modal-header">
                                <h3 style="color: black;">Seleccionar Equipos</h3>
                                <button class="modal-cerrar" onclick="document.getElementById('${modalId}').remove()">&times;</button>
                            </div>
                            <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
                                <div style="margin-bottom: 10px;">
                                    <button class="btn btn-secondary btn-sm" onclick="document.querySelectorAll('.chk-impresion').forEach(c => c.checked = true)">Todos</button>
                                    <button class="btn btn-secondary btn-sm" onclick="document.querySelectorAll('.chk-impresion').forEach(c => c.checked = false)">Ninguno</button>
                                </div>
                                ${hEquipos}
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="document.getElementById('${modalId}').remove()">Cancelar</button>
                                <button class="btn btn-primary" id="btn-confirmar-impresion">Imprimir</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', mHtml);

                document.getElementById('btn-confirmar-impresion').addEventListener('click', function () {
                    const sel = Array.from(document.querySelectorAll('.chk-impresion:checked')).map(c => c.value);
                    if (sel.length === 0) return alert('Seleccione al menos uno.');

                    const eqFiltrados = equipos.filter(e => sel.includes(e.numero.toString()));
                    const [a√±o, mes] = mesCalendarioVisual.split('-').map(Number);
                    const dMes = new Date(a√±o, mes, 0).getDate();
                    const clave = `${mesCalendarioVisual}_todos`;

                    generarContenidoImpresion(eqFiltrados, a√±o, mes, dMes, [], clave);

                    document.getElementById(modalId).remove();
                    setTimeout(() => window.print(), 500);
                });
            }

            // INYECCI√ìN FINAL DE FUNCI√ìN GLOBAL (Asegura funcionamiento)
            window.prepararImpresion = function () {
                if (equiposSeleccionadosVisual.size === 0) {
                    alert('Por favor, selecciona al menos un equipo en el panel lateral para imprimir.');
                    return;
                }
                // Asegurar que el contenido est√° actualizado y disparar impresi√≥n
                generarRecibo();
                setTimeout(() => window.print(), 300);
            };
        });
    </script>
</body>

</html>