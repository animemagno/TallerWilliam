<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos - Mototaxis</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.4;
            padding: 15px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            padding: 12px;
            text-align: center;
        }
        
        h1 {
            font-size: 18px;
            margin-bottom: 3px;
        }
        
        .tabs {
            display: flex;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 13px;
            min-width: 120px;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid #27ae60;
            color: #27ae60;
        }
        
        .tab-content {
            display: none;
            padding: 12px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
        }
        
        input, select, textarea {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 6px;
            font-size: 13px;
        }
        
        .btn-primary {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #219653;
        }
        
        .btn-success {
            background-color: #3498db;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2980b9;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .fila-compacta {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .monto-input {
            width: 120px;
            flex-shrink: 0;
        }
        
        .fecha-input {
            width: 120px;
            flex-shrink: 0;
        }
        
        .equipo-select, .cliente-select {
            flex: 1;
            min-width: 150px;
        }
        
        .resumen-equipos, .resumen-clientes {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }
        
        .resumen-equipos h2, .resumen-clientes h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .lista-equipos, .lista-clientes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .equipo-card, .cliente-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
        }
        
        .equipo-header, .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .equipo-numero, .cliente-nombre {
            font-weight: bold;
            color: #27ae60;
            font-size: 14px;
        }
        
        .equipo-total, .cliente-total {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .equipo-info, .cliente-info {
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .ingresos-list {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }
        
        .ingresos-list h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .lista-ingresos {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ingreso-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .ingreso-item:hover {
            background-color: #f8f9fa;
        }
        
        .ingreso-fecha {
            width: 80px;
            color: #666;
            font-size: 11px;
            flex-shrink: 0;
        }
        
        .ingreso-equipo {
            width: 80px;
            font-weight: bold;
            color: #27ae60;
            flex-shrink: 0;
        }
        
        .ingreso-cliente {
            width: 100px;
            font-weight: bold;
            color: #3498db;
            flex-shrink: 0;
        }
        
        .ingreso-monto {
            width: 80px;
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            flex-shrink: 0;
        }
        
        .ingreso-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #6c757d;
            font-size: 12px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
            flex-shrink: 0;
        }
        
        .edit-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
            flex-shrink: 0;
            margin-right: 5px;
        }
        
        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 12px;
            font-size: 13px;
        }
        
        .total-general {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #27ae60;
        }
        
        .fecha-hoy-btn {
            margin-left: 8px;
            padding: 4px 8px;
            font-size: 11px;
        }
        
        /* Estilos para la vista de depósitos por equipo */
        .depositos-equipo, .depositos-cliente {
            margin-top: 15px;
        }
        
        .depositos-equipo h2, .depositos-cliente h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .depositos-lista {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        @media (min-width: 768px) {
            .depositos-lista {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .deposito-equipo-card, .deposito-cliente-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
        }
        
        .deposito-equipo-header, .deposito-cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .deposito-equipo-numero, .deposito-cliente-nombre {
            font-weight: bold;
            color: #27ae60;
            font-size: 16px;
        }
        
        .deposito-equipo-total, .deposito-cliente-total {
            font-weight: bold;
            color: #e74c3c;
            font-size: 14px;
        }
        
        .deposito-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .deposito-fecha {
            color: #666;
        }
        
        .deposito-monto {
            font-weight: bold;
            color: #2d3748;
        }
        
        .deposito-total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #27ae60;
            font-weight: bold;
            text-align: right;
            color: #27ae60;
        }
        
        .imprimir-btn {
            margin-top: 10px;
            background-color: #6c757d;
            color: white;
        }
        
        .imprimir-btn:hover {
            background-color: #5a6268;
        }
        
        /* Estilos para impresión */
        @media print {
            body * {
                visibility: hidden;
            }
            .depositos-print, .depositos-print * {
                visibility: visible;
            }
            .depositos-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filtro-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* NUEVOS ESTILOS PARA EL FORMULARIO SIMPLIFICADO */
        .formulario-rapido {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }
        
        .campo-rapido {
            flex: 1;
            min-width: 120px;
        }
        
        .campo-rapido.pequeno {
            max-width: 100px;
        }
        
        .campo-rapido.medio {
            max-width: 200px;
        }
        
        .campo-rapido.grande {
            flex: 2;
        }
        
        .campo-rapido.observacion {
            min-width: 100%;
        }
        
        .resumen-equipos-saldos {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding: 12px;
        }
        
        .resumen-equipos-saldos h2 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .lista-equipos-saldos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .equipo-saldo-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
        }
        
        .equipo-saldo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .equipo-saldo-numero {
            font-weight: bold;
            color: #27ae60;
            font-size: 14px;
        }
        
        .equipo-saldo-total {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .equipo-saldo-info {
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .equipo-saldo-fecha {
            font-size: 11px;
            color: #3498db;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Control de Ingresos - Mototaxis</h1>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="ingresos">Registrar Ingreso</div>
            <div class="tab" data-tab="equipos">Gestionar Equipos</div>
            <div class="tab" data-tab="historial">Historial de Ingresos</div>
            <div class="tab" data-tab="depositos-equipos">Depósitos por Equipo</div>
        </div>
        
        <!-- Pestaña de Ingresos -->
        <div class="tab-content active" id="ingresos">
            <div class="form-group">
                <label for="fecha">Fecha:</label>
                <div class="fila-compacta">
                    <input type="date" id="fecha" class="fecha-input">
                    <button class="btn btn-warning fecha-hoy-btn" id="fecha-hoy">Hoy</button>
                </div>
            </div>
            
            <div class="formulario-rapido">
                <div class="campo-rapido pequeno">
                    <label for="equipo-rapido">Equipo:</label>
                    <input type="number" id="equipo-rapido" placeholder="Número" min="1">
                </div>
                
                <div class="campo-rapido medio">
                    <label for="nombre-rapido">Nombre:</label>
                    <input type="text" id="nombre-rapido" placeholder="Nombre del conductor" readonly>
                </div>
                
                <div class="campo-rapido pequeno">
                    <label for="monto-rapido">Monto ($):</label>
                    <input type="number" id="monto-rapido" placeholder="0.00" min="0" step="0.01">
                </div>
                
                <div class="campo-rapido">
                    <button class="btn btn-primary" id="guardar-rapido" style="margin-top: 20px;">Registrar</button>
                </div>
            </div>
            
            <div class="campo-rapido observacion">
                <label for="observacion-rapida">Observación (opcional):</label>
                <textarea id="observacion-rapida" placeholder="Observación o comentario..."></textarea>
            </div>
            
            <div class="resumen-equipos-saldos">
                <h2>Resumen de Equipos con Saldo</h2>
                <div class="lista-equipos-saldos" id="resumen-equipos-saldos">
                    <!-- Aquí se mostrará el resumen de equipos con saldo -->
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Equipos -->
        <div class="tab-content" id="equipos">
            <h2>Registrar Nuevo Equipo</h2>
            
            <div class="form-group">
                <label for="numero-equipo">Número de Equipo:</label>
                <input type="number" id="numero-equipo" placeholder="Ej: 1, 2, 3..." min="1">
            </div>
            
            <div class="form-group">
                <label for="placa">Placa:</label>
                <input type="text" id="placa" placeholder="Ej: P123456">
            </div>
            
            <div class="form-group">
                <label for="nombre">Nombre del Conductor:</label>
                <input type="text" id="nombre" placeholder="Nombre completo">
            </div>
            
            <div class="form-group">
                <label for="dui">DUI:</label>
                <input type="text" id="dui" placeholder="Ej: 12345678-9">
            </div>
            
            <div>
                <button class="btn btn-success" id="guardar-equipo">Guardar Equipo</button>
            </div>
            
            <div class="ingresos-list">
                <h2>Equipos Registrados</h2>
                <div class="lista-ingresos" id="lista-equipos">
                    <!-- Aquí se mostrarán los equipos -->
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Historial -->
        <div class="tab-content" id="historial">
            <h2>Historial de Ingresos</h2>
            
            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-equipo">Filtrar por Equipo:</label>
                    <select id="filtro-equipo">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="filtro-fecha">Filtrar por Fecha:</label>
                    <input type="month" id="filtro-fecha">
                </div>
            </div>
            
            <div class="lista-ingresos" id="historial-ingresos">
                <!-- Aquí se mostrará el historial -->
            </div>
        </div>
        
        <!-- Pestaña de Depósitos por Equipo -->
        <div class="tab-content" id="depositos-equipos">
            <h2>Depósitos por Equipo</h2>
            <button class="btn btn-info no-print" id="imprimir-todos-equipos">Imprimir Todos</button>
            
            <div class="filtros">
                <div class="filtro-group">
                    <label for="filtro-equipo-depositos">Filtrar por Equipo:</label>
                    <select id="filtro-equipo-depositos">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
            </div>
            
            <div class="depositos-equipo">
                <div class="depositos-lista" id="depositos-lista-equipos">
                    <!-- Aquí se mostrarán los depósitos por equipo -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
            authDomain: "tallerwilliam-732b3.firebaseapp.com",
            projectId: "tallerwilliam-732b3",
            storageBucket: "tallerwilliam-732b3.firebasestorage.app",
            messagingSenderId: "822262666247",
            appId: "1:822262666247:web:6680487bbf1108006b86a2"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            // Configurar pestañas
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remover clase active de todas las pestañas y contenidos
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Agregar clase active a la pestaña y contenido seleccionados
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Actualizar selectores si es necesario
                    if (tabId === 'ingresos') {
                        actualizarResumenEquiposSaldos();
                    } else if (tabId === 'depositos-equipos') {
                        cargarDepositosPorEquipo();
                        actualizarFiltroEquipos('filtro-equipo-depositos');
                    } else if (tabId === 'historial') {
                        actualizarFiltroEquipos('filtro-equipo');
                        cargarHistorialIngresos();
                    }
                });
            });
            
            // Función para obtener fecha actual en formato YYYY-MM-DD
            function obtenerFechaHoy() {
                const fechaActual = new Date();
                const año = fechaActual.getFullYear();
                const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaActual.getDate()).padStart(2, '0');
                return `${año}-${mes}-${dia}`;
            }
            
            // Función para formatear fecha de YYYY-MM-DD a dd/mm/aaaa
            function formatearFecha(fechaISO) {
                const [año, mes, dia] = fechaISO.split('-');
                return `${dia}/${mes}/${año}`;
            }
            
            // Establecer fecha actual en el formulario
            const fechaInput = document.getElementById('fecha');
            fechaInput.value = obtenerFechaHoy();
            
            // Botón para establecer fecha de hoy
            document.getElementById('fecha-hoy').addEventListener('click', function() {
                fechaInput.value = obtenerFechaHoy();
            });
            
            // Elementos del DOM
            const guardarRapidoBtn = document.getElementById('guardar-rapido');
            const guardarEquipoBtn = document.getElementById('guardar-equipo');
            const imprimirTodosEquiposBtn = document.getElementById('imprimir-todos-equipos');
            
            // Elementos del formulario rápido
            const equipoRapidoInput = document.getElementById('equipo-rapido');
            const nombreRapidoInput = document.getElementById('nombre-rapido');
            const montoRapidoInput = document.getElementById('monto-rapido');
            const observacionRapidaInput = document.getElementById('observacion-rapida');
            
            // Inicializar la aplicación
            inicializarApp();
            
            // Event listeners
            guardarRapidoBtn.addEventListener('click', guardarIngresoRapido);
            guardarEquipoBtn.addEventListener('click', guardarEquipo);
            imprimirTodosEquiposBtn.addEventListener('click', () => window.print());
            
            // Filtros
            document.getElementById('filtro-equipo').addEventListener('change', cargarHistorialIngresos);
            document.getElementById('filtro-fecha').addEventListener('change', cargarHistorialIngresos);
            document.getElementById('filtro-equipo-depositos').addEventListener('change', cargarDepositosPorEquipo);
            
            // Event listeners para navegación con ENTER
            equipoRapidoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    nombreRapidoInput.focus();
                }
            });
            
            nombreRapidoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    montoRapidoInput.focus();
                }
            });
            
            montoRapidoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    guardarIngresoRapido();
                }
            });
            
            // Event listener para autocompletar nombre cuando se ingresa número de equipo
            equipoRapidoInput.addEventListener('change', function() {
                const numeroEquipo = parseInt(this.value);
                if (numeroEquipo > 0) {
                    const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    const equipo = equipos.find(e => e.numero === numeroEquipo);
                    if (equipo) {
                        nombreRapidoInput.value = equipo.nombre;
                    } else {
                        nombreRapidoInput.value = '';
                    }
                }
            });
            
            // Enfocar en el campo de equipo al cargar la página
            equipoRapidoInput.focus();
            
            // Función para inicializar la aplicación
            async function inicializarApp() {
                // Cargar datos desde Firebase
                await cargarDatosFirebase();
                
                // Cargar datos iniciales
                actualizarResumenEquiposSaldos();
                cargarListaEquipos();
                cargarHistorialIngresos();
            }
            
            // Función para cargar datos desde Firebase
            async function cargarDatosFirebase() {
                try {
                    // Cargar equipos
                    const equiposSnapshot = await db.collection('equipos').get();
                    const equipos = [];
                    equiposSnapshot.forEach(doc => {
                        equipos.push({ id: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                    
                    // Cargar ingresos
                    const ingresosSnapshot = await db.collection('ingresos').get();
                    const ingresos = [];
                    ingresosSnapshot.forEach(doc => {
                        ingresos.push({ id: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                } catch (error) {
                    console.error("Error cargando datos desde Firebase:", error);
                    // Si no hay datos en Firebase, usar datos locales
                    if (!localStorage.getItem('equiposMototaxis')) {
                        localStorage.setItem('equiposMototaxis', JSON.stringify([]));
                    }
                    if (!localStorage.getItem('ingresosMototaxis')) {
                        localStorage.setItem('ingresosMototaxis', JSON.stringify([]));
                    }
                }
            }
            
            // Función para guardar datos en Firebase
            async function guardarEnFirebase(coleccion, datos, id = null) {
                try {
                    if (id) {
                        await db.collection(coleccion).doc(id.toString()).set(datos);
                    } else {
                        await db.collection(coleccion).add(datos);
                    }
                    return true;
                } catch (error) {
                    console.error("Error guardando en Firebase:", error);
                    return false;
                }
            }
            
            // Función para eliminar datos de Firebase
            async function eliminarDeFirebase(coleccion, id) {
                try {
                    await db.collection(coleccion).doc(id.toString()).delete();
                    return true;
                } catch (error) {
                    console.error("Error eliminando de Firebase:", error);
                    return false;
                }
            }
            
            // Función para guardar un nuevo equipo
            async function guardarEquipo() {
                const numero = parseInt(document.getElementById('numero-equipo').value) || 0;
                const placa = document.getElementById('placa').value.trim();
                const nombre = document.getElementById('nombre').value.trim();
                const dui = document.getElementById('dui').value.trim();
                
                // Validaciones mínimas - solo el número es obligatorio
                if (numero <= 0) {
                    alert('Por favor, ingrese un número de equipo válido.');
                    return;
                }
                
                // Obtener equipos actuales
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                
                // Verificar si ya existe el número de equipo
                if (equipos.some(equipo => equipo.numero === numero)) {
                    alert('Ya existe un equipo con ese número.');
                    return;
                }
                
                // Crear nuevo equipo
                const nuevoEquipo = {
                    numero: numero,
                    placa: placa || 'No registrada',
                    nombre: nombre || 'No registrado',
                    dui: dui || 'No registrado'
                };
                
                // Guardar equipo en Firebase
                const id = Date.now().toString();
                const exito = await guardarEnFirebase('equipos', nuevoEquipo, id);
                
                if (exito) {
                    // Guardar equipo localmente
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                    
                    // Actualizar interfaces
                    cargarListaEquipos();
                    
                    // Limpiar formulario
                    document.getElementById('numero-equipo').value = '';
                    document.getElementById('placa').value = '';
                    document.getElementById('nombre').value = '';
                    document.getElementById('dui').value = '';
                    
                    alert('Equipo registrado correctamente.');
                } else {
                    alert('Error al guardar el equipo. Los datos se guardarán localmente.');
                    
                    // Guardar solo localmente si falla Firebase
                    nuevoEquipo.id = id;
                    equipos.push(nuevoEquipo);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                    
                    // Actualizar interfaces
                    cargarListaEquipos();
                }
            }
            
            // Función para guardar un ingreso rápido
            async function guardarIngresoRapido() {
                const fecha = document.getElementById('fecha').value;
                const equipo = parseInt(equipoRapidoInput.value) || 0;
                const monto = parseFloat(montoRapidoInput.value) || 0;
                const observacion = observacionRapidaInput.value.trim();
                
                // Validaciones
                if (!fecha) {
                    alert('Por favor, seleccione una fecha.');
                    return;
                }
                
                if (equipo <= 0) {
                    alert('Por favor, ingrese un número de equipo válido.');
                    equipoRapidoInput.focus();
                    return;
                }
                
                // MODIFICACIÓN: Permitir monto 0
                if (monto < 0) {
                    alert('Por favor, ingrese un monto válido (no puede ser negativo).');
                    montoRapidoInput.focus();
                    return;
                }
                
                // Obtener nombre del equipo
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const equipoEncontrado = equipos.find(e => e.numero === equipo);
                const nombreEquipo = equipoEncontrado ? equipoEncontrado.nombre : 'No registrado';
                
                // Crear nuevo ingreso
                const nuevoIngreso = {
                    fecha: fecha,
                    equipo: equipo,
                    nombreEquipo: nombreEquipo,
                    monto: monto,
                    observacion: observacion,
                    tipo: 'cuota'
                };
                
                // Guardar ingreso en Firebase
                const id = Date.now().toString();
                const exito = await guardarEnFirebase('ingresos', nuevoIngreso, id);
                
                if (exito) {
                    // Guardar ingreso localmente
                    nuevoIngreso.id = id;
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos.push(nuevoIngreso);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                    
                    // Limpiar formulario
                    equipoRapidoInput.value = '';
                    nombreRapidoInput.value = '';
                    montoRapidoInput.value = '';
                    observacionRapidaInput.value = '';
                    
                    // Enfocar en el campo de equipo
                    equipoRapidoInput.focus();
                    
                    // Actualizar resumen
                    actualizarResumenEquiposSaldos();
                    
                    alert('Ingreso registrado correctamente.');
                } else {
                    alert('Error al guardar el ingreso. Los datos se guardarán localmente.');
                    
                    // Guardar solo localmente si falla Firebase
                    nuevoIngreso.id = id;
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    ingresos.push(nuevoIngreso);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                    
                    // Limpiar formulario
                    equipoRapidoInput.value = '';
                    nombreRapidoInput.value = '';
                    montoRapidoInput.value = '';
                    observacionRapidaInput.value = '';
                    
                    // Enfocar en el campo de equipo
                    equipoRapidoInput.focus();
                    
                    // Actualizar resumen
                    actualizarResumenEquiposSaldos();
                }
            }
            
            // Función para cargar la lista de equipos
            function cargarListaEquipos() {
                const listaEquipos = document.getElementById('lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                
                if (equipos.length === 0) {
                    listaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados</div>';
                    return;
                }
                
                listaEquipos.innerHTML = '';
                
                equipos.forEach(equipo => {
                    const equipoItem = document.createElement('div');
                    equipoItem.className = 'ingreso-item';
                    equipoItem.innerHTML = `
                        <div class="ingreso-fecha">#${equipo.numero}</div>
                        <div class="ingreso-equipo">${equipo.placa}</div>
                        <div class="ingreso-cliente">${equipo.nombre}</div>
                        <div class="ingreso-info">${equipo.dui}</div>
                        <button class="edit-btn" data-id="${equipo.id}">Editar</button>
                        <button class="delete-btn" data-id="${equipo.id}">Eliminar</button>
                    `;
                    listaEquipos.appendChild(equipoItem);
                });
                
                // Agregar event listeners para los botones de eliminar
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        eliminarEquipo(id);
                    });
                });
                
                // Agregar event listeners para los botones de editar
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        editarEquipo(id);
                    });
                });
            }
            
            // Función para eliminar un equipo
            async function eliminarEquipo(id) {
                if (!confirm('¿Está seguro de que desea eliminar este equipo?')) {
                    return;
                }
                
                // Eliminar de Firebase
                const exito = await eliminarDeFirebase('equipos', id);
                
                if (exito) {
                    // Eliminar localmente
                    const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    const equiposActualizados = equipos.filter(equipo => equipo.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equiposActualizados));
                    
                    // Actualizar lista
                    cargarListaEquipos();
                    
                    alert('Equipo eliminado correctamente.');
                } else {
                    alert('Error al eliminar el equipo de Firebase. Se eliminará solo localmente.');
                    
                    // Eliminar solo localmente
                    const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    const equiposActualizados = equipos.filter(equipo => equipo.id !== id);
                    localStorage.setItem('equiposMototaxis', JSON.stringify(equiposActualizados));
                    
                    // Actualizar lista
                    cargarListaEquipos();
                }
            }
            
            // Función para editar un equipo
            function editarEquipo(id) {
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const equipo = equipos.find(e => e.id === id);
                
                if (!equipo) return;
                
                document.getElementById('numero-equipo').value = equipo.numero;
                document.getElementById('placa').value = equipo.placa;
                document.getElementById('nombre').value = equipo.nombre;
                document.getElementById('dui').value = equipo.dui;
                
                // Cambiar el texto del botón
                guardarEquipoBtn.textContent = 'Actualizar Equipo';
                
                // Cambiar el evento del botón
                guardarEquipoBtn.onclick = async function() {
                    const numero = parseInt(document.getElementById('numero-equipo').value) || 0;
                    const placa = document.getElementById('placa').value.trim();
                    const nombre = document.getElementById('nombre').value.trim();
                    const dui = document.getElementById('dui').value.trim();
                    
                    // Validaciones
                    if (numero <= 0) {
                        alert('Por favor, ingrese un número de equipo válido.');
                        return;
                    }
                    
                    // Verificar si ya existe el número de equipo (excluyendo el actual)
                    if (equipos.some(e => e.numero === numero && e.id !== id)) {
                        alert('Ya existe un equipo con ese número.');
                        return;
                    }
                    
                    // Actualizar equipo
                    equipo.numero = numero;
                    equipo.placa = placa || 'No registrada';
                    equipo.nombre = nombre || 'No registrado';
                    equipo.dui = dui || 'No registrado';
                    
                    // Guardar en Firebase
                    const exito = await guardarEnFirebase('equipos', equipo, id);
                    
                    if (exito) {
                        // Actualizar localmente
                        localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                        
                        // Actualizar lista
                        cargarListaEquipos();
                        
                        // Limpiar formulario
                        document.getElementById('numero-equipo').value = '';
                        document.getElementById('placa').value = '';
                        document.getElementById('nombre').value = '';
                        document.getElementById('dui').value = '';
                        
                        // Restaurar botón
                        guardarEquipoBtn.textContent = 'Guardar Equipo';
                        guardarEquipoBtn.onclick = guardarEquipo;
                        
                        alert('Equipo actualizado correctamente.');
                    } else {
                        alert('Error al actualizar el equipo en Firebase. Se actualizará solo localmente.');
                        
                        // Actualizar solo localmente
                        localStorage.setItem('equiposMototaxis', JSON.stringify(equipos));
                        
                        // Actualizar lista
                        cargarListaEquipos();
                        
                        // Limpiar formulario
                        document.getElementById('numero-equipo').value = '';
                        document.getElementById('placa').value = '';
                        document.getElementById('nombre').value = '';
                        document.getElementById('dui').value = '';
                        
                        // Restaurar botón
                        guardarEquipoBtn.textContent = 'Guardar Equipo';
                        guardarEquipoBtn.onclick = guardarEquipo;
                    }
                };
            }
            
            // Función para actualizar el resumen de equipos con saldo
            function actualizarResumenEquiposSaldos() {
                const resumenEquiposSaldos = document.getElementById('resumen-equipos-saldos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                
                if (equipos.length === 0) {
                    resumenEquiposSaldos.innerHTML = '<div class="empty-message">No hay equipos registrados</div>';
                    return;
                }
                
                // Calcular totales por equipo
                const totalesPorEquipo = {};
                const ultimaFechaPorEquipo = {};
                
                ingresos.forEach(ingreso => {
                    if (!totalesPorEquipo[ingreso.equipo]) {
                        totalesPorEquipo[ingreso.equipo] = 0;
                    }
                    totalesPorEquipo[ingreso.equipo] += ingreso.monto;
                    
                    // Guardar la última fecha de pago
                    if (!ultimaFechaPorEquipo[ingreso.equipo] || ingreso.fecha > ultimaFechaPorEquipo[ingreso.equipo]) {
                        ultimaFechaPorEquipo[ingreso.equipo] = ingreso.fecha;
                    }
                });
                
                // Ordenar equipos por número
                equipos.sort((a, b) => a.numero - b.numero);
                
                resumenEquiposSaldos.innerHTML = '';
                
                equipos.forEach(equipo => {
                    const total = totalesPorEquipo[equipo.numero] || 0;
                    const ultimaFecha = ultimaFechaPorEquipo[equipo.numero] || 'Nunca';
                    
                    const equipoCard = document.createElement('div');
                    equipoCard.className = 'equipo-saldo-card';
                    equipoCard.innerHTML = `
                        <div class="equipo-saldo-header">
                            <div class="equipo-saldo-numero">Equipo #${equipo.numero}</div>
                            <div class="equipo-saldo-total">$${total.toFixed(2)}</div>
                        </div>
                        <div class="equipo-saldo-info">${equipo.nombre}</div>
                        <div class="equipo-saldo-info">${equipo.placa}</div>
                        <div class="equipo-saldo-fecha">Último pago: ${ultimaFecha !== 'Nunca' ? formatearFecha(ultimaFecha) : 'Nunca'}</div>
                    `;
                    resumenEquiposSaldos.appendChild(equipoCard);
                });
            }
            
            // Función para cargar el historial de ingresos
            function cargarHistorialIngresos() {
                const historialIngresos = document.getElementById('historial-ingresos');
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const filtroEquipo = document.getElementById('filtro-equipo').value;
                const filtroFecha = document.getElementById('filtro-fecha').value;
                
                // Filtrar ingresos
                let ingresosFiltrados = [...ingresos];
                
                if (filtroEquipo) {
                    ingresosFiltrados = ingresosFiltrados.filter(ingreso => ingreso.equipo == filtroEquipo);
                }
                
                if (filtroFecha) {
                    ingresosFiltrados = ingresosFiltrados.filter(ingreso => ingreso.fecha.startsWith(filtroFecha));
                }
                
                // Ordenar por fecha (más reciente primero)
                ingresosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                if (ingresosFiltrados.length === 0) {
                    historialIngresos.innerHTML = '<div class="empty-message">No hay ingresos registrados</div>';
                    return;
                }
                
                historialIngresos.innerHTML = '';
                
                let totalGeneral = 0;
                
                ingresosFiltrados.forEach(ingreso => {
                    totalGeneral += ingreso.monto;
                    
                    const ingresoItem = document.createElement('div');
                    ingresoItem.className = 'ingreso-item';
                    ingresoItem.innerHTML = `
                        <div class="ingreso-fecha">${formatearFecha(ingreso.fecha)}</div>
                        <div class="ingreso-equipo">#${ingreso.equipo}</div>
                        <div class="ingreso-cliente">${ingreso.nombreEquipo}</div>
                        <div class="ingreso-monto">$${ingreso.monto.toFixed(2)}</div>
                        <div class="ingreso-info">${ingreso.observacion || ''}</div>
                        <button class="edit-btn" data-id="${ingreso.id}">Editar</button>
                        <button class="delete-btn" data-id="${ingreso.id}">Eliminar</button>
                    `;
                    historialIngresos.appendChild(ingresoItem);
                });
                
                // Agregar total general
                const totalDiv = document.createElement('div');
                totalDiv.className = 'total-general';
                totalDiv.textContent = `Total General: $${totalGeneral.toFixed(2)}`;
                historialIngresos.appendChild(totalDiv);
                
                // Agregar event listeners para los botones de eliminar
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        eliminarIngreso(id);
                    });
                });
                
                // Agregar event listeners para los botones de editar
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        editarIngreso(id);
                    });
                });
            }
            
            // Función para eliminar un ingreso
            async function eliminarIngreso(id) {
                if (!confirm('¿Está seguro de que desea eliminar este ingreso?')) {
                    return;
                }
                
                // Eliminar de Firebase
                const exito = await eliminarDeFirebase('ingresos', id);
                
                if (exito) {
                    // Eliminar localmente
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    const ingresosActualizados = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresosActualizados));
                    
                    // Actualizar historial y resumen
                    cargarHistorialIngresos();
                    actualizarResumenEquiposSaldos();
                    
                    alert('Ingreso eliminado correctamente.');
                } else {
                    alert('Error al eliminar el ingreso de Firebase. Se eliminará solo localmente.');
                    
                    // Eliminar solo localmente
                    const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                    const ingresosActualizados = ingresos.filter(ingreso => ingreso.id !== id);
                    localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresosActualizados));
                    
                    // Actualizar historial y resumen
                    cargarHistorialIngresos();
                    actualizarResumenEquiposSaldos();
                }
            }
            
            // Función para editar un ingreso
            function editarIngreso(id) {
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const ingreso = ingresos.find(i => i.id === id);
                
                if (!ingreso) return;
                
                // Cambiar a la pestaña de ingresos
                document.querySelector('[data-tab="ingresos"]').click();
                
                // Llenar el formulario con los datos del ingreso
                document.getElementById('fecha').value = ingreso.fecha;
                equipoRapidoInput.value = ingreso.equipo;
                nombreRapidoInput.value = ingreso.nombreEquipo;
                montoRapidoInput.value = ingreso.monto;
                observacionRapidaInput.value = ingreso.observacion || '';
                
                // Cambiar el texto del botón
                guardarRapidoBtn.textContent = 'Actualizar Ingreso';
                
                // Cambiar el evento del botón
                guardarRapidoBtn.onclick = async function() {
                    const fecha = document.getElementById('fecha').value;
                    const equipo = parseInt(equipoRapidoInput.value) || 0;
                    const monto = parseFloat(montoRapidoInput.value) || 0;
                    const observacion = observacionRapidaInput.value.trim();
                    
                    // Validaciones
                    if (!fecha) {
                        alert('Por favor, seleccione una fecha.');
                        return;
                    }
                    
                    if (equipo <= 0) {
                        alert('Por favor, ingrese un número de equipo válido.');
                        return;
                    }
                    
                    // MODIFICACIÓN: Permitir monto 0
                    if (monto < 0) {
                        alert('Por favor, ingrese un monto válido (no puede ser negativo).');
                        return;
                    }
                    
                    // Obtener nombre del equipo
                    const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                    const equipoEncontrado = equipos.find(e => e.numero === equipo);
                    const nombreEquipo = equipoEncontrado ? equipoEncontrado.nombre : 'No registrado';
                    
                    // Actualizar ingreso
                    ingreso.fecha = fecha;
                    ingreso.equipo = equipo;
                    ingreso.nombreEquipo = nombreEquipo;
                    ingreso.monto = monto;
                    ingreso.observacion = observacion;
                    
                    // Guardar en Firebase
                    const exito = await guardarEnFirebase('ingresos', ingreso, id);
                    
                    if (exito) {
                        // Actualizar localmente
                        localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                        
                        // Limpiar formulario
                        equipoRapidoInput.value = '';
                        nombreRapidoInput.value = '';
                        montoRapidoInput.value = '';
                        observacionRapidaInput.value = '';
                        
                        // Restaurar botón
                        guardarRapidoBtn.textContent = 'Registrar';
                        guardarRapidoBtn.onclick = guardarIngresoRapido;
                        
                        // Actualizar resumen
                        actualizarResumenEquiposSaldos();
                        
                        alert('Ingreso actualizado correctamente.');
                    } else {
                        alert('Error al actualizar el ingreso en Firebase. Se actualizará solo localmente.');
                        
                        // Actualizar solo localmente
                        localStorage.setItem('ingresosMototaxis', JSON.stringify(ingresos));
                        
                        // Limpiar formulario
                        equipoRapidoInput.value = '';
                        nombreRapidoInput.value = '';
                        montoRapidoInput.value = '';
                        observacionRapidaInput.value = '';
                        
                        // Restaurar botón
                        guardarRapidoBtn.textContent = 'Registrar';
                        guardarRapidoBtn.onclick = guardarIngresoRapido;
                        
                        // Actualizar resumen
                        actualizarResumenEquiposSaldos();
                    }
                };
            }
            
            // Función para cargar depósitos por equipo
            function cargarDepositosPorEquipo() {
                const depositosListaEquipos = document.getElementById('depositos-lista-equipos');
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                const ingresos = JSON.parse(localStorage.getItem('ingresosMototaxis')) || [];
                const filtroEquipo = document.getElementById('filtro-equipo-depositos').value;
                
                // Filtrar equipos si hay un filtro
                let equiposFiltrados = [...equipos];
                if (filtroEquipo) {
                    equiposFiltrados = equiposFiltrados.filter(equipo => equipo.numero == filtroEquipo);
                }
                
                if (equiposFiltrados.length === 0) {
                    depositosListaEquipos.innerHTML = '<div class="empty-message">No hay equipos registrados</div>';
                    return;
                }
                
                depositosListaEquipos.innerHTML = '';
                
                // Ordenar equipos por número
                equiposFiltrados.sort((a, b) => a.numero - b.numero);
                
                equiposFiltrados.forEach(equipo => {
                    // Filtrar ingresos del equipo
                    const ingresosEquipo = ingresos.filter(ingreso => ingreso.equipo === equipo.numero);
                    
                    // Ordenar ingresos por fecha
                    ingresosEquipo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    
                    // Calcular total
                    const totalEquipo = ingresosEquipo.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                    
                    const depositoCard = document.createElement('div');
                    depositoCard.className = 'deposito-equipo-card depositos-print';
                    depositoCard.innerHTML = `
                        <div class="deposito-equipo-header">
                            <div class="deposito-equipo-numero">Equipo #${equipo.numero}</div>
                            <div class="deposito-equipo-total">$${totalEquipo.toFixed(2)}</div>
                        </div>
                        <div>${equipo.nombre}</div>
                        <div>${equipo.placa} - ${equipo.dui}</div>
                        <div class="deposito-total-detalle">
                            ${ingresosEquipo.map(ingreso => `
                                <div class="deposito-item">
                                    <div class="deposito-fecha">${formatearFecha(ingreso.fecha)}</div>
                                    <div class="deposito-monto">$${ingreso.monto.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="deposito-total">Total: $${totalEquipo.toFixed(2)}</div>
                    `;
                    depositosListaEquipos.appendChild(depositoCard);
                });
            }
            
            // Función para actualizar los filtros de equipos
            function actualizarFiltroEquipos(idFiltro) {
                const filtro = document.getElementById(idFiltro);
                const equipos = JSON.parse(localStorage.getItem('equiposMototaxis')) || [];
                
                // Limpiar opciones actuales (excepto la primera)
                while (filtro.options.length > 1) {
                    filtro.remove(1);
                }
                
                // Agregar equipos al filtro
                equipos.forEach(equipo => {
                    const option = document.createElement('option');
                    option.value = equipo.numero;
                    option.textContent = `Equipo ${equipo.numero} - ${equipo.nombre}`;
                    filtro.appendChild(option);
                });
            }
        });
    </script>
</body>
</html>
