<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taller Willian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #eef2f5;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 12px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        header h1 {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            height: 520px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .dashboard-section.full-width {
            grid-column: 1 / -1;
            height: auto;
            min-height: 600px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .fecha-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .fecha-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* NUEVA DISTRIBUCIÓN - VENTA HEADER */
        .venta-header {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .venta-line-1 {
            display: grid;
            grid-template-columns: 80px 1fr 100px;
            gap: 10px;
            align-items: end;
        }

        .venta-line-2 {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 10px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #333;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-container {
            position: relative;
        }

        .search-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            display: none;
        }

        .search-dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.2s;
        }

        .search-dropdown-item:hover {
            background-color: #3498db;
            color: white;
        }

        /* CARRITO EXPANDIDO */
        .cart-container {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .cart-items-container {
            flex: 1;
            overflow-y: auto;
            max-height: none;
            margin-bottom: 10px;
            min-height: 0;
        }

        .cart-header {
            display: grid;
            grid-template-columns: 80px 1fr 100px 100px 80px;
            gap: 10px;
            padding: 8px 12px;
            background: #2c3e50;
            color: white;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 80px 1fr 100px 100px 80px;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            border: 1px solid #e9ecef;
            align-items: center;
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .cart-item:last-child {
            margin-bottom: 0;
        }

        .quantity-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8rem;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .price-input {
            width: 90px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8rem;
        }

        .product-desc {
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .subtotal {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85rem;
        }

        .cart-actions {
            display: flex;
            gap: 4px;
        }

        .cart-total {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 2px solid #3498db;
            margin-top: auto;
            flex-shrink: 0;
        }

        .empty-cart {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 30px;
            background: white;
            border-radius: 4px;
            border: 2px dashed #ddd;
        }

        /* BOTONES COMPACTOS */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
            height: 38px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d35400;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.85rem;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            margin: 2px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 28px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin: 0 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 28px;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .btn-view {
            background-color: #3498db;
            color: white;
        }

        .btn-view:hover {
            background-color: #2980b9;
        }

        .btn-reprint {
            background-color: #f39c12;
            color: white;
        }

        .btn-reprint:hover {
            background-color: #d35400;
        }

        .btn-edit {
            background-color: #27ae60;
            color: white;
        }

        .btn-edit:hover {
            background-color: #219a52;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-abono {
            background-color: #17a2b8;
            color: white;
        }

        .btn-abono:hover {
            background-color: #138496;
        }

        .btn-cancel {
            background-color: #9b59b6;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #8e44ad;
        }

        .history-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .history-table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 10px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: 800px;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        .history-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .history-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .historial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .filter-btn:hover {
            background: #2980b9;
            color: white;
            border-color: #2980b9;
        }

        .contado-badge {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .pendiente-badge {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .abono-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .retiro-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .ingreso-badge {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .total-display {
            font-weight: bold;
        }

        .saldo-pendiente-rojo {
            color: #e74c3c;
            font-weight: bold;
        }

        .saldo-pendiente-negro {
            color: #333;
            font-weight: bold;
        }

        .cliente-equipo {
            font-weight: bold;
        }

        .cliente-nombre {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .historial-actions-container {
            min-width: 240px;
        }

        .delete-item-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .delete-item-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .tabs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #3498db;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: white;
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: #2980b9;
        }

        .tab-content {
            display: none;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .facturas-pendientes-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .facturas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .facturas-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .equipos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .equipo-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 80px;
        }

        .equipo-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            border-color: #2980b9;
        }

        .equipo-number {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            line-height: 1;
        }

        .equipo-nombre {
            font-size: 0.7rem;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 3px;
            line-height: 1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .equipo-total {
            font-size: 0.8rem;
            font-weight: bold;
            color: #27ae60;
            line-height: 1;
        }

        .grupos-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            padding-right: 5px;
        }

        .grupo-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .grupo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-color: #2980b9;
        }

        .grupo-header {
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .grupo-name {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .grupo-equipos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .grupo-equipo-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }

        .grupo-equipo-item:hover {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .grupo-equipo-number {
            font-size: 0.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .grupo-equipo-total {
            font-size: 0.7rem;
            font-weight: bold;
            color: #27ae60;
        }

        .grupo-total {
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #2c3e50;
            padding: 6px;
            background: #e8f4fd;
            border-radius: 4px;
            border-top: 2px solid #3498db;
            margin-top: 8px;
        }

        .grupo-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .grupo-card:hover .grupo-actions {
            opacity: 1;
        }

        .grupo-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
        }

        .grupo-action-btn:hover {
            transform: scale(1.1);
        }

        .btn-edit-grupo {
            color: #27ae60;
            border-color: #27ae60;
        }

        .btn-edit-grupo:hover {
            background: #27ae60;
            color: white;
        }

        .btn-delete-grupo {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .btn-delete-grupo:hover {
            background: #e74c3c;
            color: white;
        }

        .btn-detalle-grupo {
            color: #3498db;
            border-color: #3498db;
        }

        .btn-detalle-grupo:hover {
            background: #3498db;
            color: white;
        }

        .grupos-management {
            padding: 15px;
        }

        .grupos-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .grupos-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background: #f8f9fa;
        }

        .grupo-management-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grupo-management-info {
            flex: 1;
        }

        .grupo-management-name {
            font-weight: bold;
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .grupo-management-details {
            font-size: 0.8rem;
            color: #666;
        }

        .grupo-management-actions {
            display: flex;
            gap: 5px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .create-grupo-modal {
            max-width: 400px;
        }

        .equipos-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .equipo-selection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .equipo-selection-item:hover {
            background: #f8f9fa;
        }

        .equipo-selection-item.selected {
            background: #3498db;
            color: white;
        }

        .selected-equipos {
            margin: 10px 0;
            padding: 8px;
            background: #e8f4fd;
            border-radius: 4px;
            min-height: 40px;
            font-size: 0.85rem;
        }

        .selected-equipo-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            margin: 2px;
            font-size: 0.75rem;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 30px 20px;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .detalle-equipo {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .factura-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin: 6px 0;
            border-left: 3px solid #3498db;
            font-size: 0.85rem;
        }

        .producto-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.8rem;
        }

        .grupo-facturas {
            margin-top: 8px;
        }

        .all-equipos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
        }

        .all-equipo-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            width: 80px;
        }

        .all-equipo-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .all-equipo-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .edit-grupo-modal {
            max-width: 500px;
        }

        .grupo-detalle-equipo {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #3498db;
        }

        .grupo-detalle-factura {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin: 6px 0;
            border: 1px solid #e0e0e0;
        }

        .grupo-resumen {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2c3e50;
            font-weight: bold;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 10001;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }

        .connection-status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .price-warning {
            border: 2px solid #e74c3c !important;
            background-color: #fdf2f2 !important;
        }

        .date-warning {
            border: 2px solid #f39c12 !important;
            background-color: #fef9e7 !important;
        }

        .duplicate-warning {
            border: 2px solid #e74c3c !important;
            background-color: #fdf2f2 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                border-color: #e74c3c;
            }

            50% {
                border-color: #ff9999;
            }

            100% {
                border-color: #e74c3c;
            }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            transform: none;
        }

        .retiro-btn {
            background-color: #9b59b6;
            color: white;
        }

        .retiro-btn:hover {
            background-color: #8e44ad;
        }

        .ingreso-btn {
            background-color: #27ae60;
            color: white;
        }

        .ingreso-btn:hover {
            background-color: #219a52;
        }

        .equipo-en-grupo {
            background: #f8d7da !important;
            border-color: #e74c3c !important;
            color: #721c24 !important;
            cursor: not-allowed !important;
        }

        .equipo-en-grupo:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Modal de confirmación de abono inicial */
        .confirmacion-abono-modal {
            max-width: 400px;
            text-align: center;
        }

        .confirmacion-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .confirmacion-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }

        .concurrency-lock {
            pointer-events: none;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            header h1 {
                width: 100%;
                text-align: center;
                margin-bottom: 5px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .venta-header {
                flex-direction: column;
            }

            .venta-line-1,
            .venta-line-2 {
                grid-template-columns: 1fr;
            }
        }

        @media print {

            /* REGLA MAESTRA: Ocultar todo por defecto y resetear cajas */
            * {
                box-shadow: none !important;
                text-shadow: none !important;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                background: white;
            }

            /* Contenedores principales visibles y reseteados */
            .container,
            .dashboard,
            .dashboard-section,
            .history-container,
            .history-table-container,
            .tab-content {
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                display: block !important;
                position: static !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                flex: none !important;
                background: white !important;
            }

            /* Ocultar elementos de interfaz no imprimibles */
            header,
            .venta-header,
            .cart-container,
            .tabs-header,
            .filter-buttons,
            .historial-actions,
            .status,
            .loading-overlay,
            #panel-venta-section,
            #panel-derecho,
            .btn,
            .action-buttons,
            .search-container {
                display: none !important;
            }

            /* Asegurar visibilidad del contenido del historial */
            #historial-ventas-section {
                display: block !important;
            }

            /* Estilos específicos para la tabla de historial */
            .history-table {
                width: 100% !important;
                border-collapse: collapse !important;
                table-layout: fixed;
                /* O auto, según preferencia */
            }

            .history-table th {
                background-color: #f0f0f0 !important;
                color: black !important;
                font-weight: bold !important;
                border: 1px solid #999 !important;
                position: static !important;
                /* Quitar sticky header */
            }

            .history-table td {
                color: black !important;
                border: 1px solid #ccc !important;
                word-wrap: break-word;
            }

            .history-table tr {
                page-break-inside: avoid;
            }

            /* Ajustes para badges en blanco y negro/grises */
            .badge,
            .contado-badge,
            .pendiente-badge,
            .abono-badge,
            .retiro-badge,
            .ingreso-badge {
                border: 1px solid #000;
                color: #000 !important;
                background: #fff !important;
                padding: 2px 4px;
            }
        }
    </style>
</head>

<body>
    <div class="status" id="status-message"></div>
    <div class="connection-status" id="connection-status"></div>
    <div class="loading-overlay" id="loading-overlay">
        <div style="text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <div>Procesando...</div>
        </div>
    </div>

    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h1>Taller Willian</h1>
                    <button onclick="window.location.href='ventas_refactor.html'" class="btn btn-info btn-small"
                        title="Ir a la nueva versión refactorizada"
                        style="padding: 4px 10px; font-size: 0.8rem; border: none;">
                        <i class="fas fa-rocket"></i> Nueva Versión
                    </button>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                    <button class="btn btn-success btn-small ingreso-btn" onclick="UIService.showIngresoModal()"
                        title="Registrar ingreso de caja">
                        <i class="fas fa-plus-circle"></i> <span class="desktop-only">INGRESO</span>
                    </button>
                    <button class="btn btn-info btn-small" id="backup-btn" title="Descargar copia de seguridad">
                        <i class="fas fa-download"></i> <span class="desktop-only">RESPALDO</span>
                    </button>
                    <button class="btn btn-small retiro-btn" onclick="UIService.showRetiroModal()"
                        title="Registrar retiro de caja">
                        <i class="fas fa-hand-holding-usd"></i> <span class="desktop-only">RETIRO</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-section">
                <h2 class="section-title">NUEVA VENTA</h2>

                <input type="date" id="fecha-venta" class="fecha-input" style="display: none;">

                <div class="venta-header">
                    <div class="venta-line-1">
                        <div class="form-group">
                            <label for="equipo">Equipo</label>
                            <input type="text" id="equipo" placeholder="Número" maxlength="4" required>
                        </div>

                        <div class="form-group">
                            <label for="cliente">Grupo</label>
                            <input type="text" id="cliente" placeholder="Nombre del grupo">
                        </div>

                        <div>
                            <button class="btn btn-success" id="contado-btn">
                                CONTADO
                            </button>
                        </div>
                    </div>

                    <div class="venta-line-2">
                        <div class="form-group">
                            <label for="buscar-producto">Buscar Producto</label>
                            <div class="search-container">
                                <input type="text" id="buscar-producto"
                                    placeholder="Código, descripción o formato: 3 pernos de culata $3">
                                <div id="search-dropdown" class="search-dropdown"></div>
                            </div>
                        </div>

                        <div>
                            <button class="btn btn-warning" id="pendiente-btn">
                                PENDIENTE
                            </button>
                        </div>
                    </div>
                </div>

                <div class="cart-container" id="cart-container">
                    <div class="cart-header">
                        <div>CANT</div>
                        <div>DESCRIPCIÓN</div>
                        <div>PRECIO UNIT.</div>
                        <div>SUBTOTAL</div>
                        <div>ACCIÓN</div>
                    </div>
                    <div class="cart-items-container" id="cart-items">
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"
                                style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <div>No hay productos agregados</div>
                        </div>
                    </div>
                    <div class="cart-total" id="total-amount">
                        TOTAL: $0.00
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="facturas">FACTURAS PENDIENTES</button>
                    <button class="tab-btn" data-tab="grupos">GRUPO</button>
                </div>

                <div class="tabs-container">
                    <div class="tab-content active" id="tab-facturas">
                        <div class="facturas-pendientes-container" id="facturas-pendientes-container">
                            <div class="equipos-container">
                                <div id="equipos-individuales" class="equipos-grid">
                                </div>

                                <div id="empty-equipos" class="empty-state" style="display: none;">
                                    <i class="fas fa-cube"></i>
                                    <div>No hay facturas pendientes</div>
                                    <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Las ventas pendientes
                                        aparecerán aquí</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-grupos">
                        <div class="grupos-actions">
                            <button class="btn btn-success" id="crear-grupo-btn">
                                <i class="fas fa-plus"></i> CREAR GRUPO
                            </button>
                            <button class="btn btn-info" id="abonar-grupo-btn">
                                <i class="fas fa-money-bill-wave"></i> ABONAR A GRUPO
                            </button>
                        </div>
                        <div class="grupos-container" id="grupos-container">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <div>No hay grupos creados</div>
                                <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Crea tu primer grupo para
                                    organizar los equipos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section full-width">
                <h2 class="section-title">HISTORIAL DE VENTAS</h2>

                <div class="historial-actions">
                    <div class="filter-buttons">
                        <button class="filter-btn" data-filter="todo">TODO</button>
                        <button class="filter-btn active" data-filter="hoy">HOY</button>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: 15px;">
                            <label for="history-date-filter"
                                style="font-size: 0.9rem; color: #555; font-weight: 600;">Fecha:</label>
                            <input type="date" id="history-date-filter"
                                style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.9rem;" />
                            <button class="btn btn-primary" onclick="UIService.filterHistoryByDate()"
                                style="padding: 8px 16px; font-size: 0.9rem;">BUSCAR</button>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-info" id="print-historial-btn">
                            IMPRIMIR HISTORIAL
                        </button>
                    </div>
                </div>

                <!-- History Section - Full Width -->
                <div>
                    <!-- Right Main Content: History Table -->
                    <div>
                        <!-- Daily Summary (shown when filtering by date) -->
                        <div id="daily-summary-container"
                            style="display: none; background: #e8f4fd; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #3498db;">
                            <h4
                                style="margin-top: 0; margin-bottom: 8px; color: #2c3e50; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; font-size: 0.95rem;">
                                <i class="fas fa-chart-pie"></i> Resumen del Día
                            </h4>
                            <div id="daily-summary-content"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                            </div>
                            <div id="daily-cash-summary"
                                style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed #bdc3c7; font-weight: bold; display: flex; justify-content: space-around; font-size: 1rem;">
                            </div>
                        </div>

                        <!-- Product Search Results -->
                        <div id="product-search-results"
                            style="display: none; background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0; margin-bottom: 10px; color: #2c3e50;">
                                <i class="fas fa-list"></i> Resultados de Búsqueda
                            </h4>
                            <div id="product-search-results-content"></div>
                        </div>

                        <!-- Filter by Equipo -->
                        <div class="form-group">
                            <input type="text" id="filter-historial" placeholder="Filtrar por número de equipo...">
                        </div>

                        <div class="history-container">
                            <div class="history-table-container">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Factura</th>
                                            <th>Equipo</th>
                                            <th>Total</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                            <th width="250">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historial-body">
                                        <tr>
                                            <td colspan="6" class="empty-cart">Cargando historial...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de ingreso -->
                <div id="ingreso-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center; color: #27ae60;">Registrar Ingreso de Caja
                        </h3>

                        <div class="form-group">
                            <label for="concepto-ingreso">Razón / Concepto:</label>
                            <input type="text" id="concepto-ingreso" placeholder="Ej: Abono recibido, venta contado..."
                                class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="monto-ingreso">Monto:</label>
                            <input type="number" id="monto-ingreso" step="0.01" min="0.01" placeholder="0.00"
                                style="font-size: 1.2rem; text-align: center; font-weight: bold; color: #27ae60;">
                        </div>

                        <div class="form-group">
                            <label for="categoria-ingreso">Categoría:</label>
                            <select id="categoria-ingreso" class="form-control">
                                <option value="venta">Venta</option>
                                <option value="abono">Abono</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" id="process-ingreso-btn" style="flex: 1;">
                                <i class="fas fa-save"></i> REGISTRAR INGRESO
                            </button>
                            <button class="btn btn-danger" id="close-ingreso-modal" style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Editar Ingreso -->
                <div id="editar-ingreso-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center; color: #27ae60;">Editar Ingreso de Caja</h3>

                        <div class="form-group">
                            <label for="editar-concepto-ingreso">Concepto:</label>
                            <input type="text" id="editar-concepto-ingreso" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="editar-monto-ingreso">Monto:</label>
                            <input type="number" id="editar-monto-ingreso" step="0.01" min="0.01" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="editar-categoria-ingreso">Categoría:</label>
                            <select id="editar-categoria-ingreso" class="form-control">
                                <option value="venta">Venta</option>
                                <option value="abono">Abono</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" id="guardar-ingreso-btn" style="flex: 1;">GUARDAR
                                CAMBIOS</button>
                            <button class="btn btn-danger" id="cancelar-editar-ingreso-btn"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Editar Retiro -->
                <div id="editar-retiro-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center; color: #9b59b6;">Editar Retiro de Caja</h3>

                        <div class="form-group">
                            <label for="editar-concepto-retiro">Concepto:</label>
                            <input type="text" id="editar-concepto-retiro" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="editar-monto-retiro">Monto:</label>
                            <input type="number" id="editar-monto-retiro" step="0.01" min="0.01" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="editar-categoria-retiro">Categoría:</label>
                            <select id="editar-categoria-retiro" class="form-control">
                                <option value="compra">Compra de materiales</option>
                                <option value="gastos">Gastos operativos</option>
                                <option value="herramientas">Herramientas</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" id="guardar-retiro-btn" style="flex: 1;">GUARDAR
                                CAMBIOS</button>
                            <button class="btn btn-danger" id="cancelar-editar-retiro-btn"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Modal de confirmación de abono inicial -->
                <div id="confirmacion-abono-modal" class="modal-overlay">
                    <div class="modal-content confirmacion-abono-modal">
                        <h3 style="margin-bottom: 15px; text-align: center;">Factura Pendiente con Abono Inicial</h3>
                        <div style="margin-bottom: 20px;">
                            <p>¿Desea registrar un abono inicial para esta factura pendiente?</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                                <div><strong>Total de la venta:</strong> $<span id="confirmacion-total">0.00</span>
                                </div>
                                <div><strong>Equipo:</strong> <span id="confirmacion-equipo"></span></div>
                                <div><strong>Grupo:</strong> <span id="confirmacion-cliente"></span></div>
                            </div>
                        </div>

                        <div class="confirmacion-buttons">
                            <button class="btn btn-success" id="confirmar-con-abono-btn">
                                <i class="fas fa-money-bill-wave"></i> REGISTRAR ABONO
                            </button>
                            <button class="btn btn-warning" id="continuar-sin-abono-btn">
                                <i class="fas fa-forward"></i> CONTINUAR SIN ABONO
                            </button>
                        </div>

                        <button class="btn btn-danger" id="cancelar-confirmacion-btn"
                            style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-times"></i> CANCELAR
                        </button>
                    </div>
                </div>

                <!-- Modal de abono inicial -->
                <div id="abono-inicial-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center;">Registrar Abono Inicial</h3>
                        <div style="margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                <div><strong>Total de la venta:</strong> $<span id="abono-modal-total">0.00</span></div>
                                <div><strong>Equipo:</strong> <span id="abono-modal-equipo"></span></div>
                                <div><strong>Grupo:</strong> <span id="abono-modal-cliente"></span></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="monto-abono-inicial">Monto del Abono Inicial:</label>
                            <input type="number" id="monto-abono-inicial" step="0.01" min="0.01" placeholder="0.00"
                                style="font-size: 1.2rem; text-align: center; font-weight: bold;">
                        </div>

                        <div
                            style="background: #e8f4fd; padding: 12px; border-radius: 6px; margin: 15px 0; text-align: center;">
                            <div><strong>Saldo Pendiente después del abono:</strong></div>
                            <div style="font-size: 1.4rem; font-weight: bold; color: #2c3e50;" id="saldo-despues-abono">
                                $0.00
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" id="procesar-venta-con-abono-btn" style="flex: 1;">
                                <i class="fas fa-check"></i> PROCESAR VENTA CON ABONO
                            </button>
                            <button class="btn btn-danger" id="cancelar-abono-inicial-btn" style="flex: 1;">
                                <i class="fas fa-times"></i> CANCELAR
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Editar Ingreso -->
                <div id="editar-ingreso-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3>Editar Ingreso</h3>
                        <input type="hidden" id="edit-ingreso-id">
                        <div class="form-group">
                            <label for="edit-concepto-ingreso">Concepto:</label>
                            <input type="text" id="edit-concepto-ingreso" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-monto-ingreso">Monto:</label>
                            <input type="number" id="edit-monto-ingreso" step="0.01" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-categoria-ingreso">Categoría:</label>
                            <select id="edit-categoria-ingreso" class="form-control">
                                <option value="venta">Venta</option>
                                <option value="abono">Abono</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="SalesService.processEditarIngreso()"
                                style="flex: 1;">GUARDAR</button>
                            <button class="btn btn-danger" onclick="ModalService.closeEditarIngresoModal()"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Editar Retiro -->
                <div id="editar-retiro-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3>Editar Retiro</h3>
                        <input type="hidden" id="edit-retiro-id">
                        <div class="form-group">
                            <label for="edit-concepto-retiro">Concepto:</label>
                            <input type="text" id="edit-concepto-retiro" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-monto-retiro">Monto:</label>
                            <input type="number" id="edit-monto-retiro" step="0.01" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit-categoria-retiro">Categoría:</label>
                            <select id="edit-categoria-retiro" class="form-control">
                                <option value="compra">Compra de materiales</option>
                                <option value="gastos">Gastos operativos</option>
                                <option value="herramientas">Herramientas</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="SalesService.processEditarRetiro()"
                                style="flex: 1;">GUARDAR</button>
                            <button class="btn btn-danger" onclick="ModalService.closeEditarRetiroModal()"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Modales existentes -->
                <div class="modal-overlay" id="detalle-modal">
                    <div class="modal-content">
                        <div id="detalle-modal-content"></div>
                        <button class="btn btn-primary" id="close-detalle-modal"
                            style="margin-top: 15px; width: 100%;">CERRAR</button>
                        <button class="btn btn-success" id="imprimir-detalle-modal"
                            style="margin-top: 10px; width: 100%;">IMPRIMIR</button>
                    </div>
                </div>

                <div class="modal-overlay" id="grupo-detalle-modal">
                    <div class="modal-content">
                        <div id="grupo-detalle-modal-content"></div>
                        <button class="btn btn-primary" id="close-grupo-detalle-modal"
                            style="margin-top: 15px; width: 100%;">CERRAR</button>
                        <button class="btn btn-success" id="imprimir-grupo-detalle-modal"
                            style="margin-top: 10px; width: 100%;">IMPRIMIR GRUPO</button>
                    </div>
                </div>

                <div class="modal-overlay" id="crear-grupo-modal">
                    <div class="modal-content create-grupo-modal">
                        <h3 style="margin-bottom: 15px; text-align: center;">Crear Nuevo Grupo</h3>
                        <div class="form-group">
                            <label for="nombre-grupo">Nombre del Grupo:</label>
                            <input type="text" id="nombre-grupo" placeholder="Ej: Grupo A" class="form-control">
                        </div>

                        <div class="form-group">
                            <label>Seleccionar Equipos (Máx. 130):</label>
                            <div class="all-equipos-grid" id="all-equipos-grid">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Equipos Seleccionados: (<span id="contador-equipos">0</span>/130)</label>
                            <div class="selected-equipos" id="selected-equipos-list">
                                <div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos
                                    seleccionados
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" id="guardar-grupo-btn" style="flex: 1;">CREAR GRUPO</button>
                            <button class="btn btn-danger" id="cancelar-grupo-btn" style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <div class="modal-overlay" id="editar-grupo-modal">
                    <div class="modal-content edit-grupo-modal">
                        <h3 style="margin-bottom: 15px; text-align: center;">Editar Grupo</h3>
                        <div class="form-group">
                            <label for="editar-nombre-grupo">Nombre del Grupo:</label>
                            <input type="text" id="editar-nombre-grupo" placeholder="Ej: Grupo A" class="form-control">
                        </div>

                        <div class="form-group">
                            <label>Seleccionar Equipos (Máx. 130):</label>
                            <div class="all-equipos-grid" id="editar-all-equipos-grid">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Equipos Seleccionados: (<span id="editar-contador-equipos">0</span>/130)</label>
                            <div class="selected-equipos" id="editar-selected-equipos-list">
                                <div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos
                                    seleccionados
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" id="actualizar-grupo-btn" style="flex: 1;">ACTUALIZAR
                                GRUPO</button>
                            <button class="btn btn-danger" id="cancelar-editar-grupo-btn"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <div id="invoice-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div id="invoice-modal-content"></div>
                        <button class="btn btn-primary" id="close-invoice-modal"
                            style="margin-top: 15px; width: 100%;">CERRAR</button>
                    </div>
                </div>

                <div id="abono-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center;">Registrar Abono</h3>
                        <div id="abono-modal-content"></div>
                        <div class="form-group">
                            <label for="monto-abono">Monto del Abono:</label>
                            <input type="number" id="monto-abono" step="0.01" min="0.01" placeholder="0.00">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" id="process-abono-btn" style="flex: 1;">PROCESAR
                                ABONO</button>
                            <button class="btn btn-danger" id="close-abono-modal" style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <div id="bulk-abono-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center;">Abono Masivo</h3>
                        <div id="bulk-abono-info"
                            style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;"></div>

                        <div class="form-group">
                            <label for="monto-bulk-abono">Monto a Abonar:</label>
                            <input type="number" id="monto-bulk-abono" step="0.01" min="0.01" placeholder="0.00"
                                style="font-size: 1.2rem; text-align: center; font-weight: bold;">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" id="process-bulk-abono-btn" style="flex: 1;">PROCESAR
                                ABONO</button>
                            <button class="btn btn-danger" id="close-bulk-abono-modal"
                                style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>

                <div id="retiro-modal" class="modal-overlay">
                    <div class="modal-content">
                        <h3 style="margin-bottom: 15px; text-align: center; color: #9b59b6;">Registrar Retiro de Caja
                        </h3>

                        <div class="form-group">
                            <label for="concepto-retiro">Concepto / Razón:</label>
                            <input type="text" id="concepto-retiro"
                                placeholder="Ej: Compra de materiales, Pago de luz..." class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="monto-retiro">Monto a Retirar:</label>
                            <input type="number" id="monto-retiro" step="0.01" min="0.01" placeholder="0.00"
                                style="font-size: 1.2rem; text-align: center; font-weight: bold; color: #c0392b;">
                        </div>

                        <div class="form-group">
                            <label for="categoria-retiro">Categoría:</label>
                            <select id="categoria-retiro" class="form-control">
                                <option value="compra">Compra de materiales</option>
                                <option value="gastos">Gastos operativos</option>
                                <option value="herramientas">Herramientas</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn retiro-btn" id="process-retiro-btn" style="flex: 1;">
                                <i class="fas fa-save"></i> REGISTRAR RETIRO
                            </button>
                            <button class="btn btn-danger" id="close-retiro-modal" style="flex: 1;">CANCELAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Definir firebase globalmente
                const firebase = window.firebase;

                const CONFIG = {
                    firebase: {
                        apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
                        authDomain: "tallerwilliam-732b3.firebaseapp.com",
                        projectId: "tallerwilliam-732b3",
                        storageBucket: "tallerwilliam-732b3.firebasestorage.app",
                        messagingSenderId: "822262666247",
                        appId: "1:822262666247:web:6680487bbf1108006b86a2"
                    }
                };

                // CORRECCIÓN 1: Mejor manejo de errores y timeouts
                const ErrorHandler = {
                    async withTimeout(promise, timeoutMs = 10000, operationName = "Operación") {
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error(`${operationName} timeout después de ${timeoutMs}ms`)), timeoutMs);
                        });

                        try {
                            return await Promise.race([promise, timeoutPromise]);
                        } catch (error) {
                            console.error(`Error en ${operationName}:`, error);
                            throw error;
                        }
                    },

                    async withRetry(promiseFn, maxRetries = 3, operationName = "Operación") {
                        let lastError;

                        for (let attempt = 1; attempt <= maxRetries; attempt++) {
                            try {
                                return await promiseFn();
                            } catch (error) {
                                lastError = error;
                                console.warn(`Intento ${attempt}/${maxRetries} falló para ${operationName}:`, error);

                                if (attempt < maxRetries) {
                                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                                }
                            }
                        }

                        throw new Error(`${operationName} falló después de ${maxRetries} intentos: ${lastError.message}`);
                    }
                };

                const DateUtils = {
                    getCurrentDateElSalvador() {
                        const now = new Date();
                        const offset = -6 * 60;
                        const localTime = now.getTime();
                        const localOffset = now.getTimezoneOffset() * 60000;
                        const utc = localTime + localOffset;
                        const elSalvadorTime = utc + (offset * 60000);
                        return new Date(elSalvadorTime);
                    },

                    getCurrentDateStringElSalvador() {
                        const date = this.getCurrentDateElSalvador();
                        return this.formatDateToYYYYMMDD(date);
                    },

                    formatDateToYYYYMMDD(date) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    },

                    createDateFromStringElSalvador(dateString) {
                        const [year, month, day] = dateString.split('-').map(Number);
                        const date = new Date(year, month - 1, day, 12, 0, 0);
                        return this.adjustToElSalvadorTime(date);
                    },

                    adjustToElSalvadorTime(date) {
                        const offset = -6 * 60;
                        const localTime = date.getTime();
                        const localOffset = date.getTimezoneOffset() * 60000;
                        const utc = localTime + localOffset;
                        const elSalvadorTime = utc + (offset * 60000);
                        return new Date(elSalvadorTime);
                    },

                    isTodayInElSalvador(dateString) {
                        const today = this.getCurrentDateStringElSalvador();
                        return dateString === today;
                    },

                    // CORRECCIÓN 4: Restaurar validación de fechas futuras con mejor manejo
                    isFutureDateInElSalvador(dateString) {
                        const today = this.getCurrentDateStringElSalvador();
                        return dateString > today;
                    },

                    getCurrentTimestampElSalvador() {
                        return this.getCurrentDateElSalvador();
                    }
                };

                const ConnectionManager = {
                    isOnline: true,

                    initialize() {
                        this.checkConnection();
                        setInterval(() => this.checkConnection(), 30000);

                        window.addEventListener('online', () => this.handleOnline());
                        window.addEventListener('offline', () => this.handleOffline());
                    },

                    async checkConnection() {
                        try {
                            if (AppState.firebaseInitialized) {
                                await ErrorHandler.withTimeout(
                                    AppState.db.collection("VENTAS").limit(1).get(),
                                    10000, // Aumentado a 10s para conexiones lentas
                                    "Verificación de conexión"
                                );
                                this.handleOnline();
                            } else {
                                this.handleOffline();
                            }
                        } catch (error) {
                            this.handleOffline();
                        }
                    },

                    handleOnline() {
                        if (!this.isOnline) {
                            this.isOnline = true;
                            this.updateUI();
                            UIService.showStatus("Conexión restaurada", "success");
                        }
                    },

                    handleOffline() {
                        if (this.isOnline) {
                            this.isOnline = false;
                            this.updateUI();
                            UIService.showStatus("Sin conexión - Modo offline", "error");
                        }
                    },

                    updateUI() {
                        const statusElement = document.getElementById('connection-status');
                        if (this.isOnline) {
                            statusElement.textContent = "🟢 CONECTADO";
                            statusElement.className = "connection-status online";
                        } else {
                            statusElement.innerHTML = `
                        🔴 SIN CONEXIÓN 
                        <button onclick="ConnectionManager.checkConnection()" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8rem; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 4px; color: #333;">
                            <i class="fas fa-sync-alt"></i> Reconectar
                        </button>
                    `;
                            statusElement.className = "connection-status offline";
                        }
                        statusElement.style.display = 'block';
                    }
                };

                // CORRECCIÓN 8: Mejor gestión de memoria con paginación
                const MemoryManager = {
                    maxCacheSize: 1000,
                    cleanupThreshold: 0.8,

                    cleanupIfNeeded(cache) {
                        if (cache.size > this.maxCacheSize * this.cleanupThreshold) {
                            const entries = Array.from(cache.entries());
                            const toRemove = entries.slice(0, Math.floor(entries.length * 0.2));

                            toRemove.forEach(([key]) => {
                                cache.delete(key);
                            });

                            console.log(`MemoryManager: Limpiados ${toRemove.length} elementos del cache`);
                        }
                    },

                    paginateData(data, pageSize = 50) {
                        const pages = [];
                        for (let i = 0; i < data.length; i += pageSize) {
                            pages.push(data.slice(i, i + pageSize));
                        }
                        return pages;
                    }
                };

                const GrupoManager = {
                    grupos: new Map(),
                    equiposPendientes: new Map(),
                    currentEditingGroup: null,
                    currentGrupoDetalle: null,
                    unsubscribe: null,
                    // CORRECCIÓN 5: Cache para optimizar rendimiento
                    totalesCache: new Map(),
                    lastUpdateTime: null,

                    async initialize() {
                        await this.loadGrupos();
                        await this.loadEquiposPendientes();
                        this.setupRealTimeListener();
                        this.updateUI();
                    },

                    setupRealTimeListener() {
                        if (!AppState.firebaseInitialized) return;

                        this.unsubscribe = AppState.db.collection("VENTAS")
                            .where("paymentType", "==", "pendiente")
                            .where("status", "==", "pendiente")
                            .onSnapshot(async (snapshot) => {
                                await this.loadEquiposPendientes(true); // Force update
                                await this.actualizarTotalesGrupos(true); // Force update totals
                                this.updateUI();
                            }, (error) => {
                                console.error("Error en listener tiempo real:", error);
                            });
                    },

                    async loadGrupos() {
                        try {
                            if (!AppState.firebaseInitialized) return;

                            const snapshot = await ErrorHandler.withRetry(
                                () => AppState.db.collection("GRUPOS").get(),
                                3,
                                "Carga de grupos"
                            );

                            this.grupos.clear();
                            snapshot.forEach(doc => {
                                this.grupos.set(doc.id, { id: doc.id, ...doc.data() });
                            });

                            await this.actualizarTotalesGrupos();

                        } catch (error) {
                            console.error("Error cargando grupos:", error);
                            UIService.showStatus("Error cargando grupos: " + error.message, "error");
                        }
                    },

                    // CORRECCIÓN 5: Función optimizada para actualizar totales
                    async actualizarTotalesGrupos(force = false) {
                        try {
                            const now = Date.now();
                            // Usar cache si la actualización fue hace menos de 30 segundos, a menos que se fuerce
                            if (!force && this.lastUpdateTime && (now - this.lastUpdateTime < 30000)) {
                                return;
                            }

                            const batch = AppState.db.batch();
                            let updatesCount = 0;

                            for (const [grupoId, grupo] of this.grupos.entries()) {
                                // CORRECCIÓN: Siempre recalcular el total desde equiposPendientes
                                // No usar caché porque los saldos cambian con abonos
                                let nuevoTotal = 0;

                                for (const equipoNum of grupo.equipos) {
                                    let equipoEncontrado = null;
                                    this.equiposPendientes.forEach((equipo, key) => {
                                        if (equipo.numero === equipoNum && equipo.total > 0) {
                                            equipoEncontrado = equipo;
                                        }
                                    });

                                    if (equipoEncontrado) {
                                        nuevoTotal += equipoEncontrado.total;
                                    }
                                }

                                // Actualizar si hay diferencia
                                if (grupo.total !== nuevoTotal) {
                                    grupo.total = nuevoTotal;

                                    if (AppState.firebaseInitialized) {
                                        try {
                                            const grupoRef = AppState.db.collection("GRUPOS").doc(grupoId);
                                            batch.update(grupoRef, {
                                                total: nuevoTotal,
                                                fechaActualizacion: new Date()
                                            });
                                            updatesCount++;

                                            // Limitar tamaño del batch para evitar timeouts
                                            if (updatesCount >= 400) {
                                                await batch.commit();
                                                updatesCount = 0;
                                            }
                                        } catch (error) {
                                            console.error(`Error actualizando grupo ${grupo.nombre}:`, error);
                                        }
                                    }
                                }
                            }

                            // Commit batch final si hay updates pendientes
                            if (updatesCount > 0) {
                                await batch.commit();
                            }

                            this.lastUpdateTime = now;

                        } catch (error) {
                            console.error("Error actualizando totales de grupos:", error);
                        }
                    },

                    async loadEquiposPendientes(force = false) {
                        try {
                            if (!AppState.firebaseInitialized) return;

                            const snapshot = await ErrorHandler.withRetry(
                                () => AppState.db.collection("VENTAS")
                                    .where("paymentType", "==", "pendiente")
                                    .where("status", "==", "pendiente")
                                    .get(),
                                3,
                                "Carga de equipos pendientes"
                            );

                            this.equiposPendientes.clear();

                            snapshot.forEach(doc => {
                                const venta = doc.data();
                                const equipo = venta.equipoNumber;
                                const cliente = venta.clientName || '';

                                let saldoPendiente = venta.total || 0;
                                if (venta.abonos && venta.abonos.length > 0) {
                                    const totalAbonado = venta.abonos.reduce((sum, abono) => sum + abono.monto, 0);
                                    saldoPendiente = venta.total - totalAbonado;
                                }

                                if (equipo && saldoPendiente > 0) {
                                    const key = `${equipo}-${cliente}`;

                                    if (!this.equiposPendientes.has(key)) {
                                        this.equiposPendientes.set(key, {
                                            numero: equipo,
                                            cliente: cliente,
                                            total: 0,
                                            facturas: []
                                        });
                                    }

                                    const equipoData = this.equiposPendientes.get(key);
                                    equipoData.facturas.push({
                                        id: doc.id,
                                        ...venta,
                                        saldoPendiente: saldoPendiente
                                    });
                                    equipoData.total += saldoPendiente;
                                }
                            });

                            await this.actualizarTotalesGrupos(force);
                            MemoryManager.cleanupIfNeeded(this.equiposPendientes);

                        } catch (error) {
                            console.error("Error cargando equipos pendientes:", error);
                        }
                    },

                    async crearGrupo(nombre, equiposSeleccionados) {
                        try {
                            if (!AppState.firebaseInitialized) {
                                throw new Error("No hay conexión a la base de datos");
                            }

                            const equiposConFacturas = equiposSeleccionados.filter(equipoNum => {
                                let tieneFacturas = false;
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === equipoNum && equipo.total > 0) {
                                        tieneFacturas = true;
                                    }
                                });
                                return tieneFacturas;
                            });

                            if (equiposConFacturas.length === 0) {
                                throw new Error("Los equipos seleccionados no tienen facturas pendientes");
                            }

                            let totalGrupo = 0;
                            equiposConFacturas.forEach(equipoNum => {
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === equipoNum) {
                                        totalGrupo += equipo.total;
                                    }
                                });
                            });

                            const grupoData = {
                                nombre: nombre,
                                equipos: equiposConFacturas,
                                total: totalGrupo,
                                fechaCreacion: new Date(),
                                activo: true
                            };

                            const docRef = await ErrorHandler.withRetry(
                                () => AppState.db.collection("GRUPOS").add(grupoData),
                                3,
                                "Creación de grupo"
                            );

                            grupoData.id = docRef.id;
                            this.grupos.set(docRef.id, grupoData);

                            // Actualizar las facturas con la información del grupo
                            for (const equipoNum of equiposConFacturas) {
                                for (const [key, equipo] of this.equiposPendientes.entries()) {
                                    if (equipo.numero === equipoNum) {
                                        for (const factura of equipo.facturas) {
                                            try {
                                                await AppState.db.collection("VENTAS").doc(factura.id).update({
                                                    grupo: docRef.id,
                                                    grupoNombre: nombre
                                                });
                                            } catch (error) {
                                                console.error(`Error actualizando factura ${factura.id}:`, error);
                                            }
                                        }
                                    }
                                }
                            }

                            await this.loadEquiposPendientes();
                            await this.actualizarTotalesGrupos();
                            this.updateUI();

                            return docRef.id;
                        } catch (error) {
                            console.error("Error creando grupo:", error);
                            throw error;
                        }
                    },

                    async actualizarGrupo(grupoId, nombre, equiposSeleccionados) {
                        try {
                            if (!AppState.firebaseInitialized) {
                                throw new Error("No hay conexión a la base de datos");
                            }

                            const equiposConFacturas = equiposSeleccionados.filter(equipoNum => {
                                let tieneFacturas = false;
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === equipoNum && equipo.total > 0) {
                                        tieneFacturas = true;
                                    }
                                });
                                return tieneFacturas;
                            });

                            let totalGrupo = 0;
                            equiposConFacturas.forEach(equipoNum => {
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === equipoNum) {
                                        totalGrupo += equipo.total;
                                    }
                                });
                            });

                            const grupoData = {
                                nombre: nombre,
                                equipos: equiposConFacturas,
                                total: totalGrupo,
                                fechaActualizacion: new Date()
                            };

                            await ErrorHandler.withRetry(
                                () => AppState.db.collection("GRUPOS").doc(grupoId).update(grupoData),
                                3,
                                "Actualización de grupo"
                            );

                            const grupoExistente = this.grupos.get(grupoId);
                            if (grupoExistente) {
                                Object.assign(grupoExistente, grupoData);
                            }

                            // Actualizar facturas con el nuevo grupo
                            for (const equipoNum of equiposConFacturas) {
                                for (const [key, equipo] of this.equiposPendientes.entries()) {
                                    if (equipo.numero === equipoNum) {
                                        for (const factura of equipo.facturas) {
                                            try {
                                                await AppState.db.collection("VENTAS").doc(factura.id).update({
                                                    grupo: grupoId,
                                                    grupoNombre: nombre
                                                });
                                            } catch (error) {
                                                console.error(`Error actualizando factura ${factura.id}:`, error);
                                            }
                                        }
                                    }
                                }
                            }

                            // Remover grupo de facturas que ya no están en el grupo
                            const grupoOriginal = this.grupos.get(grupoId);
                            if (grupoOriginal) {
                                for (const equipoNum of grupoOriginal.equipos) {
                                    if (!equiposConFacturas.includes(equipoNum)) {
                                        for (const [key, equipo] of this.equiposPendientes.entries()) {
                                            if (equipo.numero === equipoNum) {
                                                for (const factura of equipo.facturas) {
                                                    try {
                                                        if (AppState.firebaseInitialized) {
                                                            // CORRECCIÓN 1: Usar firebase.firestore.FieldValue consistentemente
                                                            await AppState.db.collection("VENTAS").doc(factura.id).update({
                                                                grupo: firebase.firestore.FieldValue.delete(),
                                                                grupoNombre: firebase.firestore.FieldValue.delete()
                                                            });
                                                        }
                                                    } catch (error) {
                                                        console.error(`Error removiendo grupo de factura ${factura.id}:`, error);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            await this.loadEquiposPendientes();
                            await this.actualizarTotalesGrupos();
                            this.updateUI();

                            return grupoId;
                        } catch (error) {
                            console.error("Error actualizando grupo:", error);
                            throw error;
                        }
                    },

                    async eliminarGrupo(grupoId) {
                        try {
                            if (!AppState.firebaseInitialized) {
                                throw new Error("No hay conexión a la base de datos");
                            }

                            const grupo = this.grupos.get(grupoId);
                            if (grupo) {
                                for (const equipoNum of grupo.equipos) {
                                    for (const [key, equipo] of this.equiposPendientes.entries()) {
                                        if (equipo.numero === equipoNum) {
                                            for (const factura of equipo.facturas) {
                                                try {
                                                    if (AppState.firebaseInitialized) {
                                                        // CORRECCIÓN 1: Usar firebase.firestore.FieldValue consistentemente
                                                        await AppState.db.collection("VENTAS").doc(factura.id).update({
                                                            grupo: firebase.firestore.FieldValue.delete(),
                                                            grupoNombre: firebase.firestore.FieldValue.delete()
                                                        });
                                                    }
                                                } catch (error) {
                                                    console.error(`Error removiendo grupo de factura ${factura.id}:`, error);
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            await ErrorHandler.withRetry(
                                () => AppState.db.collection("GRUPOS").doc(grupoId).delete(),
                                3,
                                "Eliminación de grupo"
                            );

                            this.grupos.delete(grupoId);
                            this.totalesCache.clear(); // Limpiar cache

                            await this.loadEquiposPendientes();
                            await this.actualizarTotalesGrupos();
                            this.updateUI();

                        } catch (error) {
                            console.error("Error eliminando grupo:", error);
                            throw error;
                        }
                    },

                    getEquiposSinGrupo() {
                        const equiposSinGrupo = new Map();

                        this.equiposPendientes.forEach((equipo, key) => {
                            let tieneGrupo = false;

                            this.grupos.forEach(grupo => {
                                if (grupo.equipos.includes(equipo.numero)) {
                                    tieneGrupo = true;
                                }
                            });

                            if (!tieneGrupo && equipo.total > 0) {
                                equiposSinGrupo.set(key, equipo);
                            }
                        });

                        return equiposSinGrupo;
                    },

                    getEquiposEnGrupos() {
                        const equiposEnGrupos = new Set();

                        this.grupos.forEach(grupo => {
                            grupo.equipos.forEach(equipoNum => {
                                equiposEnGrupos.add(equipoNum);
                            });
                        });

                        return equiposEnGrupos;
                    },

                    updateUI() {
                        this.renderEquiposIndividuales();
                        this.renderGruposVisual();
                    },

                    renderEquiposIndividuales() {
                        const container = document.getElementById('equipos-individuales');
                        const emptyState = document.getElementById('empty-equipos');
                        const equiposSinGrupo = this.getEquiposSinGrupo();

                        if (equiposSinGrupo.size === 0) {
                            emptyState.style.display = 'block';
                            container.innerHTML = '';
                            return;
                        }

                        emptyState.style.display = 'none';

                        const equiposOrdenados = Array.from(equiposSinGrupo.entries())
                            .sort(([a], [b]) => {
                                const numA = parseInt(a.split('-')[0]);
                                const numB = parseInt(b.split('-')[0]);
                                return numA - numB;
                            });

                        let html = '';
                        equiposOrdenados.forEach(([key, equipo]) => {
                            const mostrarNombre = equipo.cliente && !equipo.cliente.startsWith('Equipo ');

                            html += `
                        <div class="equipo-card" onclick="GrupoManager.mostrarDetalleEquipo('${key}')">
                            <div class="equipo-number">${equipo.numero}</div>
                            ${mostrarNombre ? `<div class="equipo-nombre">${equipo.cliente}</div>` : ''}
                            <div class="equipo-total">$${equipo.total.toFixed(2)}</div>
                        </div>
                    `;
                        });

                        container.innerHTML = html;
                    },

                    renderGruposVisual() {
                        const container = document.getElementById('grupos-container');

                        if (this.grupos.size === 0) {
                            container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <div>No hay grupos creados</div>
                            <div style="font-size: 0.8rem; margin-top: 5px; color: #999;">Crea tu primer grupo para organizar los equipos</div>
                        </div>
                    `;
                            return;
                        }

                        const gruposOrdenados = Array.from(this.grupos.values())
                            .filter(grupo => grupo.activo)
                            .sort((a, b) => a.nombre.localeCompare(b.nombre));

                        let html = '';
                        gruposOrdenados.forEach(grupo => {
                            let equiposHTML = '';

                            grupo.equipos.forEach(equipoNum => {
                                let equipoEncontrado = null;
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === equipoNum && equipo.total > 0) {
                                        equipoEncontrado = equipo;
                                    }
                                });

                                if (equipoEncontrado) {
                                    equiposHTML += `
                                <div class="grupo-equipo-item" onclick="GrupoManager.mostrarDetalleEquipo('${equipoEncontrado.numero}-${equipoEncontrado.cliente}')">
                                    <div class="grupo-equipo-number">${equipoEncontrado.numero}</div>
                                    <div class="grupo-equipo-total">$${equipoEncontrado.total.toFixed(2)}</div>
                                </div>
                            `;
                                }
                            });

                            html += `
                        <div class="grupo-card">
                            <div class="grupo-actions">
                                <button class="grupo-action-btn btn-detalle-grupo" onclick="GrupoManager.mostrarDetalleGrupoCompleto('${grupo.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="grupo-action-btn btn-edit-grupo" onclick="GrupoManager.editarGrupo('${grupo.id}')" title="Editar grupo">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="grupo-action-btn btn-info" onclick="GrupoManager.showGroupPaymentModal('${grupo.id}')" title="Abonar a Grupo" style="background-color: #17a2b8; color: white;">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                                <button class="grupo-action-btn btn-delete-grupo" onclick="GrupoManager.solicitarEliminarGrupo('${grupo.id}')" title="Eliminar grupo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="grupo-header">
                                <div class="grupo-name">${grupo.nombre}</div>
                            </div>
                            <div class="grupo-equipos-grid">
                                ${equiposHTML}
                            </div>
                            <div class="grupo-total">
                                Total: $${grupo.total.toFixed(2)}
                            </div>
                        </div>
                    `;
                        });

                        container.innerHTML = html;
                    },

                    async mostrarDetalleEquipo(key) {
                        const equipo = this.equiposPendientes.get(key);
                        AppState.selectedInvoicesForPayment = new Set();

                        let facturasHTML = '';
                        if (equipo) {
                            // Sort invoices by date (oldest first)
                            const sortedFacturas = [...equipo.facturas].sort((a, b) => {
                                const dateA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)) : new Date(0);
                                const dateB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp)) : new Date(0);
                                return dateA - dateB;
                            });

                            facturasHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
                        <thead>
                            <tr style="background-color: #2c3e50; color: white;">
                                <th style="padding: 10px; text-align: center; width: 40px;">
                                    <i class="fas fa-check-square"></i>
                                </th>
                                <th style="padding: 10px; text-align: left;">Factura</th>
                                <th style="padding: 10px; text-align: left;">Productos</th>
                                <th style="padding: 10px; text-align: right;">Total</th>
                                <th style="padding: 10px; text-align: right;">Abonos</th>
                                <th style="padding: 10px; text-align: right;">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                            sortedFacturas.forEach((factura, index) => {
                                let productosHTML = '';
                                if (factura.products && factura.products.length > 0) {
                                    productosHTML = `<table style="width: 100%; font-size: 12px; border-collapse: collapse;">`;
                                    factura.products.forEach(producto => {
                                        const totalProducto = (producto.precio * producto.cantidad).toFixed(2);
                                        productosHTML += `
                            <tr>
                                <td style="width: 35px; text-align: center; vertical-align: top; color: #2c3e50; font-weight: bold; padding: 2px;">
                                    ${producto.cantidad}
                                </td>
                                <td style="vertical-align: top; padding: 2px;">
                                    ${producto.descripcion}
                                </td>
                                <td style="text-align: right; vertical-align: top; font-weight: bold; color: #555; padding: 2px; width: 60px;">
                                    $${totalProducto}
                                </td>
                            </tr>
                        `;
                                    });
                                    productosHTML += `</table>`;
                                }
                                const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                                const tieneAbonos = factura.abonos && factura.abonos.length > 0;

                                let abonosHTML = '-';
                                if (tieneAbonos) {
                                    abonosHTML = '';
                                    factura.abonos.forEach(abono => {
                                        const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }) : 'N/A';
                                        abonosHTML += `
                            <div style="font-size: 11px; color: #27ae60;">
                                +$${abono.monto.toFixed(2)} (${fechaAbono})
                            </div>
                        `;
                                    });
                                }

                                const rowStyle = index % 2 === 0 ? 'background-color: #f9f9f9;' : 'background-color: #ffffff;';

                                facturasHTML += `
                    <tr style="${rowStyle} border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px; text-align: center;">
                            <input type="checkbox" class="invoice-checkbox" data-id="${factura.id}" 
                                   onchange="GrupoManager.toggleInvoiceSelection('${factura.id}')" 
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td style="padding: 8px; font-weight: bold; color: #2c3e50;">
                            #${factura.invoiceNumber}
                            <div style="font-size: 11px; color: #95a5a6; font-weight: normal;">
                                ${factura.timestamp ? new Date(factura.timestamp.toDate ? factura.timestamp.toDate() : factura.timestamp).toLocaleDateString('es-ES') : ''}
                            </div>
                        </td>
                        <td style="padding: 8px;">
                            ${productosHTML}
                        </td>
                        <td style="padding: 8px; text-align: right; font-weight: bold;">
                            $${factura.total.toFixed(2)}
                        </td>
                        <td style="padding: 8px; text-align: right;">
                            ${abonosHTML}
                        </td>
                        <td style="padding: 8px; text-align: right; font-weight: bold; color: #e74c3c;">
                            $${saldoPendiente.toFixed(2)}
                        </td>
                    </tr>
                `;
                            });

                            facturasHTML += `
                        </tbody>
                    </table>
                </div>
            `;
                        }

                        const modalContent = `
            <h3 style="margin-bottom: 15px; text-align: center; color: #2c3e50;">
                <i class="fas fa-tools"></i> Equipo ${equipo.numero}
            </h3>
            <div class="detalle-equipo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                <div><strong><i class="fas fa-user"></i> Cliente:</strong> ${equipo.cliente}</div>
                <div><strong><i class="fas fa-file-invoice-dollar"></i> Facturas:</strong> ${equipo ? equipo.facturas.length : 0}</div>
                <div style="font-size: 1.1em; color: #e74c3c;"><strong><i class="fas fa-money-bill-wave"></i> Total Pendiente:</strong> $${equipo ? equipo.total.toFixed(2) : '0.00'}</div>
            </div>
            
            <div style="margin: 15px 0; text-align: right;">
                <button class="btn btn-info" id="pay-selected-btn" onclick="GrupoManager.showBulkPaymentModal()" style="display: none; background-color: #3498db; border: none; padding: 8px 15px; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fas fa-check-circle"></i> ABONAR SELECCIONADAS
                </button>
            </div>

            <div class="grupo-facturas">
                ${facturasHTML || '<p style="text-align: center; padding: 20px; color: #7f8c8d;">No hay facturas pendientes para este equipo</p>'}
            </div>
        `;

                        document.getElementById('detalle-modal-content').innerHTML = modalContent;
                        document.getElementById('detalle-modal').style.display = 'block';
                        AppState.currentDetalle = { tipo: 'equipo', data: key };
                    },

                    toggleInvoiceSelection(invoiceId) {
                        if (AppState.selectedInvoicesForPayment.has(invoiceId)) {
                            AppState.selectedInvoicesForPayment.delete(invoiceId);
                        } else {
                            AppState.selectedInvoicesForPayment.add(invoiceId);
                        }

                        const btn = document.getElementById('pay-selected-btn');
                        if (AppState.selectedInvoicesForPayment.size > 0) {
                            btn.style.display = 'inline-block';
                            btn.textContent = `ABONAR (${AppState.selectedInvoicesForPayment.size})`;
                        } else {
                            btn.style.display = 'none';
                        }
                    },

                    showBulkPaymentModal() {
                        if (AppState.selectedInvoicesForPayment.size === 0) return;

                        const modal = document.getElementById('bulk-abono-modal');
                        const info = document.getElementById('bulk-abono-info');

                        info.innerHTML = `
                    <strong>Facturas Seleccionadas:</strong> ${AppState.selectedInvoicesForPayment.size}<br>
                    Ingrese el monto total a abonar. Se distribuirá entre las facturas seleccionadas (más antiguas primero).
                `;

                        document.getElementById('monto-bulk-abono').value = '';
                        modal.style.display = 'block';

                        // Configurar el botón para procesar facturas seleccionadas
                        const processBtn = document.getElementById('process-bulk-abono-btn');
                        processBtn.onclick = async () => {
                            if (processBtn.disabled) return;
                            processBtn.disabled = true;

                            const monto = parseFloat(document.getElementById('monto-bulk-abono').value);
                            if (!monto || monto <= 0) {
                                UIService.showStatus("Ingrese un monto válido", "error");
                                processBtn.disabled = false;
                                return;
                            }

                            try {
                                UIService.showLoading(true);
                                const facturasIds = Array.from(AppState.selectedInvoicesForPayment);
                                await SalesService.processMultiAbono(facturasIds, monto);

                                UIService.showStatus("Abono masivo realizado correctamente", "success");
                                modal.style.display = 'none';
                                document.getElementById('detalle-modal').style.display = 'none';
                                AppState.selectedInvoicesForPayment.clear();

                            } catch (error) {
                                UIService.showStatus("Error: " + error.message, "error");
                            } finally {
                                UIService.showLoading(false);
                                processBtn.disabled = false;
                            }
                        };
                    },

                    showGroupPaymentModal(grupoId) {
                        const grupo = this.grupos.get(grupoId);
                        if (!grupo) return;

                        const modal = document.getElementById('bulk-abono-modal');
                        const info = document.getElementById('bulk-abono-info');

                        info.innerHTML = `
                    <strong>Abonar a Grupo:</strong> ${grupo.nombre}<br>
                    <strong>Total Pendiente del Grupo:</strong> $${grupo.total.toFixed(2)}<br>
                    Ingrese el monto total a abonar. Se distribuirá entre las facturas más antiguas del grupo.
                `;

                        document.getElementById('monto-bulk-abono').value = '';
                        modal.style.display = 'block';

                        const processBtn = document.getElementById('process-bulk-abono-btn');
                        processBtn.onclick = async () => {
                            if (processBtn.disabled) return;
                            processBtn.disabled = true;

                            const monto = parseFloat(document.getElementById('monto-bulk-abono').value);
                            if (!monto || monto <= 0) {
                                UIService.showStatus("Ingrese un monto válido", "error");
                                processBtn.disabled = false;
                                return;
                            }

                            if (monto > grupo.total) {
                                UIService.showStatus("El monto no puede ser mayor al total del grupo", "error");
                                processBtn.disabled = false;
                                return;
                            }

                            try {
                                UIService.showLoading(true);
                                await SalesService.processGroupAbono(grupoId, monto);

                                UIService.showStatus(`Abono de $${monto.toFixed(2)} aplicado al grupo correctamente`, "success");
                                modal.style.display = 'none';

                            } catch (error) {
                                UIService.showStatus("Error: " + error.message, "error");
                            } finally {
                                UIService.showLoading(false);
                                processBtn.disabled = false;
                            }
                        };
                    },

                    showGroupPaymentModalSelector() {
                        // Mostrar un modal simple con un select de grupos
                        // Por simplicidad, usaremos un prompt o un modal dinámico
                        // Dado que ya tenemos botones en las tarjetas, este botón global podría ser redundante
                        // pero lo implementaremos como un selector rápido.

                        const gruposActivos = Array.from(this.grupos.values()).filter(g => g.activo && g.total > 0);

                        if (gruposActivos.length === 0) {
                            UIService.showStatus("No hay grupos con saldo pendiente", "info");
                            return;
                        }

                        let options = gruposActivos.map(g => `<option value="${g.id}">${g.nombre} ($${g.total.toFixed(2)})</option>`).join('');

                        const modalContent = `
                    <h3 style="text-align: center; margin-bottom: 15px;">Seleccionar Grupo</h3>
                    <div class="form-group">
                        <label>Grupo:</label>
                        <select id="grupo-selector-abono" style="width: 100%; padding: 8px;">
                            ${options}
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" style="width: 100%;" id="continue-group-abono">CONTINUAR</button>
                    </div>
                 `;

                        // Reutilizamos el modal de factura que es genérico
                        UIService.showInvoiceModal(modalContent);

                        document.getElementById('continue-group-abono').onclick = () => {
                            const grupoId = document.getElementById('grupo-selector-abono').value;
                            ModalService.closeInvoiceModal();
                            this.showGroupPaymentModal(grupoId);
                        };
                    },

                    async mostrarDetalleGrupoCompleto(grupoId) {
                        const grupo = this.grupos.get(grupoId);
                        if (!grupo) return;

                        this.currentGrupoDetalle = grupo;

                        let equiposHTML = '';
                        let totalGeneral = 0;
                        let totalPendiente = 0;
                        let cantidadFacturas = 0;
                        let tieneAbonos = false;

                        for (const equipoNum of grupo.equipos) {
                            let equipoEncontrado = null;
                            this.equiposPendientes.forEach((equipo, key) => {
                                if (equipo.numero === equipoNum && equipo.total > 0) {
                                    equipoEncontrado = equipo;
                                }
                            });

                            if (equipoEncontrado) {
                                totalGeneral += equipoEncontrado.total;
                                cantidadFacturas += equipoEncontrado.facturas.length;

                                let facturasHTML = '';
                                equipoEncontrado.facturas.forEach(factura => {
                                    const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                                    totalPendiente += saldoPendiente;

                                    if (factura.abonos && factura.abonos.length > 0) {
                                        tieneAbonos = true;
                                    }

                                    let productosHTML = '';
                                    if (factura.products && factura.products.length > 0) {
                                        factura.products.forEach(producto => {
                                            productosHTML += `
                                        <div class="producto-item">
                                            <div>${producto.descripcion} x${producto.cantidad}</div>
                                            <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                        </div>
                                    `;
                                        });
                                    }

                                    facturasHTML += `
                                <div class="grupo-detalle-factura">
                                    <div><strong>Factura:</strong> ${factura.invoiceNumber}</div>
                                    <div><strong>Fecha:</strong> ${new Date(factura.timestamp.toDate ? factura.timestamp.toDate() : factura.timestamp).toLocaleDateString('es-ES')}</div>
                                    <div><strong>Total:</strong> $${factura.total.toFixed(2)}</div>
                                    ${factura.abonos && factura.abonos.length > 0 ? `<div><strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}</div>` : ''}
                                    <div><strong>Productos:</strong></div>
                                    ${productosHTML}
                                </div>
                            `;
                                });

                                equiposHTML += `
                            <div class="grupo-detalle-equipo">
                                <h4>Equipo ${equipoEncontrado.numero} - ${equipoEncontrado.cliente}</h4>
                                <div><strong>Total:</strong> $${equipoEncontrado.total.toFixed(2)}</div>
                                <div><strong>Facturas:</strong> ${equipoEncontrado.facturas.length}</div>
                                ${facturasHTML}
                            </div>
                        `;
                            }
                        }

                        const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">${grupo.nombre} - Detalles Completos</h3>
                    <div class="grupo-resumen">
                        <div><strong>Total del Grupo:</strong> $${totalGeneral.toFixed(2)}</div>
                        ${tieneAbonos ? `<div><strong>Saldo Pendiente:</strong> $${totalPendiente.toFixed(2)}</div>` : ''}
                        <div><strong>Número de Equipos:</strong> ${grupo.equipos.length}</div>
                        <div><strong>Total de Facturas:</strong> ${cantidadFacturas}</div>
                    </div>
                    <div class="grupo-facturas">
                        <h4>Detalles por Equipo:</h4>
                        ${equiposHTML || '<p>No hay equipos con facturas pendientes en este grupo</p>'}
                    </div>
                `;

                        document.getElementById('grupo-detalle-modal-content').innerHTML = modalContent;
                        document.getElementById('grupo-detalle-modal').style.display = 'block';
                    },

                    async imprimirGrupoCompleto() {
                        const grupo = this.currentGrupoDetalle;
                        if (!grupo) return;

                        for (const equipoNum of grupo.equipos) {
                            let equipoEncontrado = null;
                            this.equiposPendientes.forEach((equipo, key) => {
                                if (equipo.numero === equipoNum && equipo.total > 0) {
                                    equipoEncontrado = equipo;
                                }
                            });

                            if (equipoEncontrado) {
                                equipoEncontrado.facturas.forEach(factura => {
                                    this.imprimirTicketFactura(factura, equipoEncontrado);
                                });
                            }
                        }
                    },

                    imprimirTicketFactura(factura, equipo) {
                        const printWindow = window.open('', '_blank');
                        const fecha = factura.timestamp ? new Date(factura.timestamp.toDate ? factura.timestamp.toDate() : factura.timestamp) : new Date();
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });

                        const saldoPendiente = factura.saldoPendiente !== undefined ? factura.saldoPendiente : factura.total;
                        const tieneAbonos = factura.abonos && factura.abonos.length > 0;
                        const tipoPago = tieneAbonos && saldoPendiente > 0 ? 'PENDIENTE' : 'CONTADO';

                        let abonosHTML = '';
                        if (tieneAbonos) {
                            factura.abonos.forEach(abono => {
                                const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
                                abonosHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 20px; margin: 2px 0;">
                                <div>ABONO: $${abono.monto.toFixed(2)} (${fechaAbono})</div>
                            </div>
                        `;
                            });
                        }

                        let productosHTML = '';
                        if (factura.products && factura.products.length > 0) {
                            factura.products.forEach(producto => {
                                const descripcion = producto.descripcion.length > 25 ? producto.descripcion.substring(0, 25) + '...' : producto.descripcion;
                                productosHTML += `
                            <div style="margin: 4px 0;">
                                <div style="font-size: 16px;">• ${descripcion}</div>
                                <div style="display: flex; justify-content: space-between; font-size: 18px;">
                                    <div>x${producto.cantidad}</div>
                                    <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="border-bottom: 1px dotted #000; margin: 2px 0;"></div>
                        `;
                            });
                        }

                        printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Ticket #${factura.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .equipo-text { font-size: 32px; font-weight: 900; margin: 5px 0; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILLIAN</h3>
                            <div class="small-text">Factura: ${factura.invoiceNumber}</div>
                            <div class="small-text">${fechaFormateada}, ${tipoPago}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        ${equipo.cliente !== equipo.numero ? `
                            <div class="medium-text">
                                <strong>Grupo:</strong> ${equipo.cliente}
                            </div>
                        ` : ''}
                        <div class="equipo-text" style="text-align: center;">
                            ${equipo.numero}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 8px 0;">
                            ${productosHTML}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total large-text">
                            TOTAL: $${factura.total.toFixed(2)}
                        </div>

                        ${abonosHTML}

                        ${tieneAbonos && saldoPendiente > 0 ? `
                            <div class="saldo-info">
                                <div>SALDO PENDIENTE:</div>
                                <div class="large-text">$${saldoPendiente.toFixed(2)}</div>
                            </div>
                        ` : ''}
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);

                        printWindow.document.close();
                        printWindow.focus();

                        setTimeout(() => {
                            printWindow.print();
                            setTimeout(() => {
                                printWindow.close();
                            }, 500);
                        }, 500);
                    },

                    async actualizarDesdeVenta(ventaData) {
                        if (ventaData.paymentType === 'pendiente' && ventaData.status === 'pendiente') {
                            const equipo = ventaData.equipoNumber;
                            if (equipo) {
                                await this.loadEquiposPendientes();
                                await this.actualizarTotalesGrupos();
                                this.updateUI();
                            }
                        }
                    },

                    generarGridEquipos(modalType = 'crear') {
                        const grid = document.getElementById(modalType === 'crear' ? 'all-equipos-grid' : 'editar-all-equipos-grid');
                        const equiposEnGrupos = this.getEquiposEnGrupos();
                        const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;

                        let html = '';

                        for (let i = 1; i <= 130; i++) {
                            const equipoNum = i.toString();
                            let equipoEncontrado = null;
                            this.equiposPendientes.forEach((equipo, key) => {
                                if (equipo.numero === equipoNum && equipo.total > 0) {
                                    equipoEncontrado = equipo;
                                }
                            });

                            const tieneFacturas = equipoEncontrado && equipoEncontrado.facturas.length > 0;
                            const estaSeleccionado = selectedSet.has(equipoNum);
                            const estaEnOtroGrupo = equiposEnGrupos.has(equipoNum) &&
                                (modalType === 'crear' ||
                                    (modalType === 'editar' && this.currentEditingGroup &&
                                        !this.currentEditingGroup.equipos.includes(equipoNum)));

                            let estilo = '';
                            if (estaEnOtroGrupo) {
                                estilo = 'equipo-en-grupo';
                            } else if (tieneFacturas) {
                                estilo = 'has-facturas';
                            }

                            html += `
                        <div class="all-equipo-item ${estilo} ${estaSeleccionado ? 'selected' : ''}" 
                             onclick="${estaEnOtroGrupo ? '' : `GrupoManager.toggleEquipoSelection('${equipoNum}', '${modalType}')`}"
                             style="${tieneFacturas && !estaEnOtroGrupo ? 'border-color: #27ae60; background: #f0fff0;' : ''}${estaEnOtroGrupo ? 'border-color: #e74c3c; background: #f8d7da; color: #721c24; cursor: not-allowed;' : 'border-color: #ccc; background: #f5f5f5;'}">
                            ${equipoNum}
                            ${tieneFacturas ? '<br><small style="color: #27ae60;">$' + equipoEncontrado.total.toFixed(2) + '</small>' : '<br><small style="color: #999;">$0.00</small>'}
                            ${estaEnOtroGrupo ? '<br><small style="color: #e74c3c; font-size: 0.6rem;">EN GRUPO</small>' : ''}
                        </div>
                    `;
                        }

                        grid.innerHTML = html;
                    },

                    actualizarListaSeleccionados(modalType = 'crear') {
                        const selectedList = document.getElementById(modalType === 'crear' ? 'selected-equipos-list' : 'editar-selected-equipos-list');
                        const contador = document.getElementById(modalType === 'crear' ? 'contador-equipos' : 'editar-contador-equipos');
                        const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;

                        contador.textContent = selectedSet.size;

                        if (selectedSet.size === 0) {
                            selectedList.innerHTML = '<div style="color: #999; text-align: center; font-size: 0.8rem;">No hay equipos seleccionados</div>';
                        } else {
                            let badgesHTML = '';
                            const equiposOrdenados = Array.from(selectedSet).sort((a, b) => parseInt(a) - parseInt(b));

                            equiposOrdenados.forEach(num => {
                                let equipoEncontrado = null;
                                this.equiposPendientes.forEach((equipo, key) => {
                                    if (equipo.numero === num && equipo.total > 0) {
                                        equipoEncontrado = equipo;
                                    }
                                });

                                if (equipoEncontrado) {
                                    badgesHTML += `<span class="selected-equipo-badge">${num} ($${equipoEncontrado.total.toFixed(2)})</span>`;
                                } else {
                                    badgesHTML += `<span class="selected-equipo-badge" style="background: #95a5a6;">${num} ($0.00)</span>`;
                                }
                            });
                            selectedList.innerHTML = badgesHTML;
                        }
                    },

                    async editarGrupo(grupoId) {
                        const grupo = this.grupos.get(grupoId);
                        if (!grupo) {
                            UIService.showStatus("No se encontró el grupo para editar", "error");
                            return;
                        }

                        this.currentEditingGroup = grupo;

                        AppState.equiposEditSeleccionados = new Set(grupo.equipos);

                        document.getElementById('editar-nombre-grupo').value = grupo.nombre;
                        this.generarGridEquipos('editar');
                        this.actualizarListaSeleccionados('editar');

                        document.getElementById('editar-grupo-modal').style.display = 'block';
                    },

                    async actualizarGrupoDesdeModal() {
                        const grupo = this.currentEditingGroup;
                        if (!grupo) {
                            UIService.showStatus("No hay grupo seleccionado para editar", "error");
                            return;
                        }

                        const nombre = document.getElementById('editar-nombre-grupo').value.trim();
                        if (!nombre) {
                            UIService.showStatus("Ingrese un nombre para el grupo", "error");
                            return;
                        }

                        if (AppState.equiposEditSeleccionados.size === 0) {
                            UIService.showStatus("Seleccione al menos un equipo", "error");
                            return;
                        }

                        try {
                            const equiposArray = Array.from(AppState.equiposEditSeleccionados);
                            await this.actualizarGrupo(grupo.id, nombre, equiposArray);
                            UIService.showStatus(`Grupo "${nombre}" actualizado correctamente`, "success");
                            document.getElementById('editar-grupo-modal').style.display = 'none';
                            this.currentEditingGroup = null;
                            AppState.equiposEditSeleccionados.clear();
                        } catch (error) {
                            UIService.showStatus("Error al actualizar grupo: " + error.message, "error");
                        }
                    },

                    toggleEquipoSelection(equipoNum, modalType = 'crear') {
                        const selectedSet = modalType === 'crear' ? AppState.equiposSeleccionados : AppState.equiposEditSeleccionados;

                        if (selectedSet.has(equipoNum)) {
                            selectedSet.delete(equipoNum);
                        } else {
                            if (selectedSet.size >= 130) {
                                UIService.showStatus("Máximo 130 equipos permitidos", "error");
                                return;
                            }
                            selectedSet.add(equipoNum);
                        }

                        this.actualizarListaSeleccionados(modalType);

                        const selector = modalType === 'crear' ? '.all-equipo-item' : '#editar-all-equipos-grid .all-equipo-item';
                        document.querySelectorAll(selector).forEach(item => {
                            const num = item.textContent.split('\n')[0].trim();
                            if (num === equipoNum) {
                                if (selectedSet.has(num)) {
                                    item.classList.add('selected');
                                } else {
                                    item.classList.remove('selected');
                                }
                            }
                        });
                    },

                    solicitarEliminarGrupo(grupoId) {
                        if (!confirm("¿Está seguro de eliminar este grupo? Los equipos volverán a estar disponibles individualmente y se eliminarán las asociaciones de grupo.")) {
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            this.eliminarGrupo(grupoId);
                            UIService.showStatus("Grupo eliminado correctamente", "success");
                            this.updateUI();
                        } catch (error) {
                            UIService.showStatus("Error al eliminar grupo: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    }
                };

                const ProductCache = {
                    data: new Map(),
                    lastUpdate: null,
                    ttl: 10 * 60 * 1000, // 10 minutos
                    unsubscribe: null,

                    isExpired() {
                        return !this.lastUpdate || (Date.now() - this.lastUpdate) > this.ttl;
                    },

                    async initialize() {
                        if (this.isExpired() || this.data.size === 0) {
                            await this.refresh();
                        }
                        this.setupRealTimeListener();
                    },

                    // CORRECCIÓN 7: Listener en tiempo real para cache automático
                    setupRealTimeListener() {
                        if (!AppState.firebaseInitialized) return;

                        // Escuchar ambas colecciones
                        const inventarioUnsubscribe = AppState.db.collection("INVENTARIO")
                            .onSnapshot((snapshot) => {
                                snapshot.docChanges().forEach((change) => {
                                    if (change.type === 'added' || change.type === 'modified') {
                                        this.data.set(change.doc.id, { id: change.doc.id, ...change.doc.data() });
                                    } else if (change.type === 'removed') {
                                        this.data.delete(change.doc.id);
                                    }
                                });
                                this.lastUpdate = Date.now();
                            }, (error) => {
                                console.error("Error en listener de inventario:", error);
                            });

                        const provisionalUnsubscribe = AppState.db.collection("INVENTARIO_PROVICIONAL")
                            .onSnapshot((snapshot) => {
                                snapshot.docChanges().forEach((change) => {
                                    if (change.type === 'added' || change.type === 'modified') {
                                        this.data.set(change.doc.id, { id: change.doc.id, ...change.doc.data() });
                                    } else if (change.type === 'removed') {
                                        this.data.delete(change.doc.id);
                                    }
                                });
                                this.lastUpdate = Date.now();
                            }, (error) => {
                                console.error("Error en listener de inventario provisional:", error);
                            });

                        this.unsubscribe = () => {
                            inventarioUnsubscribe();
                            provisionalUnsubscribe();
                        };
                    },

                    async refresh() {
                        try {
                            if (!AppState.firebaseInitialized) return;

                            // Cargar ambas colecciones
                            const [inventarioSnap, provisionalSnap] = await Promise.all([
                                ErrorHandler.withRetry(() => AppState.db.collection("INVENTARIO").get(), 3, "Carga de inventario"),
                                ErrorHandler.withRetry(() => AppState.db.collection("INVENTARIO_PROVICIONAL").get(), 3, "Carga de inventario provisional")
                            ]);

                            this.data.clear();

                            inventarioSnap.forEach(doc => {
                                this.data.set(doc.id, { id: doc.id, ...doc.data() });
                            });

                            provisionalSnap.forEach(doc => {
                                this.data.set(doc.id, { id: doc.id, ...doc.data() });
                            });

                            this.lastUpdate = Date.now();
                            MemoryManager.cleanupIfNeeded(this.data);
                        } catch (error) {
                            console.error("Error actualizando cache:", error);
                        }
                    },

                    search(query) {
                        const results = [];
                        const searchTerm = query.toLowerCase().trim();

                        if (!searchTerm) return results;

                        this.data.forEach(product => {
                            const codigo = (product.codigo || '').toLowerCase();
                            const descripcion = (product.descripcion || '').toLowerCase();

                            if (codigo.includes(searchTerm) || descripcion.includes(searchTerm)) {
                                results.push(product);
                            }
                        });

                        return results.slice(0, 10);
                    },

                    getByCode(codigo) {
                        let found = null;
                        this.data.forEach(product => {
                            if (product.codigo === codigo) {
                                found = product;
                            }
                        });
                        return found;
                    },

                    cleanup() {
                        if (this.unsubscribe) {
                            this.unsubscribe();
                        }
                    }
                };

                const AppState = {
                    firebaseInitialized: false,
                    db: null,
                    cart: [],
                    searchResults: [],
                    saleCounter: 0,
                    currentEditingInvoice: null,
                    historial: [],
                    filteredHistorial: [],
                    currentFilter: 'hoy',
                    currentAbonoInvoice: null,
                    currentDetalle: null,
                    equiposSeleccionados: new Set(),
                    equiposEditSeleccionados: new Set(),
                    processingSale: false,
                    currentInvoiceNumber: null,
                    datosVentaPendiente: null,
                    selectedInvoicesForPayment: new Set(),
                    // CORRECCIÓN 6: Lock para concurrencia
                    operationLock: false
                };

                // CORRECCIÓN 6: Manejo de concurrencia
                const ConcurrencyManager = {
                    async acquireLock(operationName = "Operación") {
                        let attempts = 0;
                        const maxAttempts = 10;
                        const delay = 100;

                        while (AppState.operationLock && attempts < maxAttempts) {
                            attempts++;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }

                        if (AppState.operationLock) {
                            throw new Error(`No se pudo adquirir lock para ${operationName} después de ${maxAttempts} intentos`);
                        }

                        AppState.operationLock = true;
                        document.body.classList.add('concurrency-lock');
                        return true;
                    },

                    releaseLock() {
                        AppState.operationLock = false;
                        document.body.classList.remove('concurrency-lock');
                    },

                    async withLock(operationFn, operationName = "Operación") {
                        await this.acquireLock(operationName);
                        try {
                            return await operationFn();
                        } finally {
                            this.releaseLock();
                        }
                    }
                };

                const DataService = {
                    async searchProducts(query) {
                        if (!AppState.firebaseInitialized) {
                            return [{
                                id: 'manual-' + Date.now(),
                                codigo: 'MANUAL',
                                descripcion: query,
                                precio: 0,
                                cantidad: 1
                            }];
                        }

                        await ProductCache.initialize();
                        let results = ProductCache.search(query);

                        if (results.length === 0 && query.trim() !== '') {
                            results.push({
                                id: 'manual-' + Date.now(),
                                codigo: 'MANUAL',
                                descripcion: query,
                                precio: 0,
                                cantidad: 1
                            });
                        }

                        return results;
                    },

                    async saveSale(saleData) {
                        // CORRECCIÓN 6: Usar lock para prevenir concurrencia
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                const existingInvoice = await this.checkInvoiceExists(saleData.invoiceNumber);
                                if (existingInvoice) {
                                    throw new Error(`La factura ${saleData.invoiceNumber} ya existe`);
                                }

                                const docRef = await ErrorHandler.withRetry(
                                    () => AppState.db.collection("VENTAS").add(saleData),
                                    3,
                                    "Guardado de venta"
                                );

                                await this.updateSaleCounter(saleData.date);

                                if (saleData.paymentType === 'pendiente') {
                                    await GrupoManager.actualizarDesdeVenta(saleData);
                                }

                                return docRef.id;
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Guardar venta");
                    },

                    async checkInvoiceExists(invoiceNumber) {
                        try {
                            const exists = await ErrorHandler.withTimeout(
                                AppState.db.collection("VENTAS")
                                    .where("invoiceNumber", "==", invoiceNumber)
                                    .limit(1)
                                    .get(),
                                5000,
                                "Verificación de factura única"
                            );
                            return !exists.empty;
                        } catch (error) {
                            console.error("Error verificando factura duplicada:", error);
                            return false;
                        }
                    },

                    async updateSaleCounter(date = DateUtils.getCurrentDateStringElSalvador()) {
                        try {
                            const counterRef = AppState.db.collection("COUNTERS").doc("sales");
                            const counterDoc = await counterRef.get();
                            let currentCount = 0;

                            if (counterDoc.exists) {
                                currentCount = counterDoc.data()[date] || 0;
                            }

                            await counterRef.set({
                                [date]: currentCount + 1,
                                lastUpdate: new Date()
                            }, { merge: true });
                        } catch (error) {
                            console.error("Error actualizando contador:", error);
                        }
                    },

                    async getSaleCounter(date = DateUtils.getCurrentDateStringElSalvador()) {
                        try {
                            const counterRef = AppState.db.collection("COUNTERS").doc("sales");
                            const doc = await counterRef.get();

                            if (doc.exists) {
                                return doc.data()[date] || 0;
                            }
                            return 0;
                        } catch (error) {
                            console.error("Error obteniendo contador, usando fallback:", error);
                            const snapshot = await AppState.db.collection("VENTAS")
                                .where("date", "==", date)
                                .get();
                            return snapshot.size;
                        }
                    },

                    async updateSale(saleId, saleData) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                await ErrorHandler.withRetry(
                                    () => AppState.db.collection("VENTAS").doc(saleId).update(saleData),
                                    3,
                                    "Actualización de venta"
                                );

                                if (saleData.paymentType === 'pendiente') {
                                    await GrupoManager.actualizarDesdeVenta({ ...saleData, id: saleId });
                                }
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Actualizar venta");
                    },

                    async deleteSale(saleId) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                await ErrorHandler.withRetry(
                                    () => AppState.db.collection("VENTAS").doc(saleId).delete(),
                                    3,
                                    "Eliminación de venta"
                                );
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Eliminar venta");
                    },

                    async loadSales(limit = 2000) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("VENTAS")
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de ventas"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando ventas:", error);
                            return [];
                        }
                    },

                    async loadSalesByDate(date = DateUtils.getCurrentDateStringElSalvador(), limit = 500) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("VENTAS")
                                        .where("date", "==", date)
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de ventas por fecha"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando ventas por fecha:", error);
                            return [];
                        }
                    },

                    async addAbono(invoiceId, abonoData) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                const ventaRef = AppState.db.collection("VENTAS").doc(invoiceId);

                                const ventaDoc = await ventaRef.get();
                                if (!ventaDoc.exists) {
                                    throw new Error("No se encontró la venta");
                                }

                                const venta = ventaDoc.data();

                                const nuevoSaldo = (venta.saldoPendiente || venta.total) - abonoData.monto;

                                if (nuevoSaldo < 0) {
                                    throw new Error("El monto del abono no puede ser mayor al saldo pendiente");
                                }

                                const abonoDateString = abonoData.fechaString ? abonoData.fechaString.split(',')[0].trim().split('/').reverse().join('-') : DateUtils.getCurrentDateStringElSalvador();

                                // 1. Guardar en colección INGRESOS para que aparezca en historial y caja del día
                                const ingresoData = {
                                    monto: abonoData.monto,
                                    concepto: `Abono a EQUIPO ${venta.equipoNumber || '0000'}`,
                                    categoria: 'abono',
                                    timestamp: abonoData.fecha || DateUtils.getCurrentTimestampElSalvador(),
                                    date: abonoDateString,
                                    invoiceId: invoiceId,
                                    invoiceNumber: venta.invoiceNumber,
                                    clientName: venta.clientName || 'Cliente',
                                    equipoNumber: venta.equipoNumber || '0000',
                                    saldoAnterior: venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total,
                                    nuevoSaldo: nuevoSaldo
                                };

                                await AppState.db.collection("INGRESOS").add(ingresoData);

                                // 2. Actualizar venta
                                // CORRECCIÓN 1: Usar firebase.firestore.FieldValue consistentemente
                                await ErrorHandler.withRetry(
                                    () => ventaRef.update({
                                        abonos: firebase.firestore.FieldValue.arrayUnion({
                                            ...abonoData,
                                            savedInIngresos: true // Bandera para evitar duplicados en historial
                                        }),
                                        saldoPendiente: nuevoSaldo,
                                        fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                                    }),
                                    3,
                                    "Registro de abono"
                                );

                                if (nuevoSaldo <= 0) {
                                    await ventaRef.update({
                                        paymentType: 'contado',
                                        status: 'pagado'
                                    });
                                }

                                await GrupoManager.actualizarDesdeVenta(venta);
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Registrar abono");
                    },

                    async deleteAbono(abonoId, invoiceId) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                // 1. Obtener el ingreso (abono) para saber el monto
                                const ingresoDoc = await AppState.db.collection("INGRESOS").doc(abonoId).get();
                                if (!ingresoDoc.exists) {
                                    throw new Error("No se encontró el abono");
                                }

                                const ingresoData = ingresoDoc.data();
                                const montoAbono = ingresoData.monto;
                                const facturaId = ingresoData.invoiceId || invoiceId;

                                // 2. Verificar si la venta existe y actualizarla solo si existe
                                if (facturaId) {
                                    const ventaRef = AppState.db.collection("VENTAS").doc(facturaId);
                                    const ventaDoc = await ventaRef.get();

                                    if (ventaDoc.exists) {
                                        const venta = ventaDoc.data();

                                        // 3. Calcular el nuevo saldo (aumentar porque estamos eliminando el abono)
                                        const saldoActual = venta.saldoPendiente !== undefined ? venta.saldoPendiente : 0;
                                        const nuevoSaldo = saldoActual + montoAbono;

                                        // 4. Eliminar el abono del array de abonos en la venta
                                        const nuevosAbonos = (venta.abonos || []).filter(abono => {
                                            // Filtrar por fecha y monto para identificar el abono correcto
                                            const abonoFecha = abono.fechaString || '';
                                            const ingresoFecha = ingresoData.timestamp ?
                                                new Date(ingresoData.timestamp.toDate ? ingresoData.timestamp.toDate() : ingresoData.timestamp).toLocaleString('es-ES') : '';
                                            return !(abono.monto === montoAbono && abonoFecha === ingresoFecha);
                                        });

                                        // 5. Actualizar la venta
                                        await ErrorHandler.withRetry(
                                            () => ventaRef.update({
                                                abonos: nuevosAbonos,
                                                saldoPendiente: nuevoSaldo,
                                                paymentType: nuevoSaldo > 0 ? 'pendiente' : 'contado',
                                                status: nuevoSaldo > 0 ? 'pendiente' : 'pagado',
                                                fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                                            }),
                                            3,
                                            "Actualización de venta al eliminar abono"
                                        );

                                        // 7. Actualizar grupos si aplica
                                        await GrupoManager.actualizarDesdeVenta({ ...venta, id: facturaId });
                                    }
                                }

                                // 6. Eliminar el ingreso (siempre, incluso si la factura no existe)
                                await ErrorHandler.withRetry(
                                    () => AppState.db.collection("INGRESOS").doc(abonoId).delete(),
                                    3,
                                    "Eliminación de abono"
                                );

                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Eliminar abono");
                    },

                    async getSaleById(invoiceId) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const doc = await ErrorHandler.withTimeout(
                                    AppState.db.collection("VENTAS").doc(invoiceId).get(),
                                    5000,
                                    "Carga de venta por ID"
                                );
                                if (doc.exists) {
                                    return { id: doc.id, ...doc.data() };
                                }
                                return null;
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        } catch (error) {
                            console.error("Error obteniendo venta por ID:", error);
                            return null;
                        }
                    },



                    async cancelInvoice(invoiceId) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                const ventaRef = AppState.db.collection("VENTAS").doc(invoiceId);

                                await ErrorHandler.withRetry(
                                    () => ventaRef.update({
                                        paymentType: 'contado',
                                        status: 'pagado',
                                        saldoPendiente: 0,
                                        cancelada: true,
                                        fechaCancelacion: new Date(),
                                        fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                                    }),
                                    3,
                                    "Cancelación de factura"
                                );

                                const venta = await this.getSaleById(invoiceId);
                                if (venta) {
                                    await GrupoManager.actualizarDesdeVenta(venta);
                                }
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Cancelar factura");
                    },

                    async saveRetiro(retiroData) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                const docRef = await ErrorHandler.withRetry(
                                    () => AppState.db.collection("RETIROS").add(retiroData),
                                    3,
                                    "Guardado de retiro"
                                );
                                return docRef.id;
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Guardar retiro");
                    },

                    async loadRetiros(limit = 2000) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("RETIROS")
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de retiros"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando retiros:", error);
                            return [];
                        }
                    },

                    async loadRetirosByDate(date = DateUtils.getCurrentDateStringElSalvador(), limit = 500) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("RETIROS")
                                        .where("date", "==", date)
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de retiros por fecha"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando retiros por fecha:", error);
                            return [];
                        }
                    },

                    async saveIngreso(ingresoData) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (AppState.firebaseInitialized) {
                                const docRef = await ErrorHandler.withRetry(
                                    () => AppState.db.collection("INGRESOS").add(ingresoData),
                                    3,
                                    "Guardado de ingreso"
                                );
                                return docRef.id;
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        }, "Guardar ingreso");
                    },

                    async loadIngresos(limit = 2000) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("INGRESOS")
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de ingresos"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando ingresos:", error);
                            return [];
                        }
                    },

                    async loadIngresosByDate(date = DateUtils.getCurrentDateStringElSalvador(), limit = 500) {
                        try {
                            if (AppState.firebaseInitialized) {
                                const snapshot = await ErrorHandler.withTimeout(
                                    AppState.db.collection("INGRESOS")
                                        .where("date", "==", date)
                                        .orderBy("timestamp", "desc")
                                        .limit(limit)
                                        .get(),
                                    10000,
                                    "Carga de ingresos por fecha"
                                );

                                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            } else {
                                return [];
                            }
                        } catch (error) {
                            console.error("Error cargando ingresos por fecha:", error);
                            return [];
                        }
                    },

                    async loadAllMovements(limit = 2000) {
                        try {
                            const [ventas, retiros, ingresos] = await Promise.all([
                                this.loadSales(limit),
                                this.loadRetiros(limit),
                                this.loadIngresos(limit)
                            ]);

                            const allMovements = [
                                ...ventas.map(v => ({ ...v, tipo: 'venta' })),
                                ...retiros.map(r => ({ ...r, tipo: 'retiro' })),
                                ...ingresos.map(i => ({ ...i, tipo: i.categoria === 'abono' ? 'abono' : 'ingreso' }))
                            ];

                            return allMovements.sort((a, b) => {
                                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : a.timestamp;
                                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : b.timestamp;
                                return dateB - dateA;
                            }).slice(0, limit);
                        } catch (error) {
                            console.error("Error loading all movements:", error);
                            return [];
                        }
                    },

                    async searchProductInHistory(productName, startDate, endDate) {
                        try {
                            if (!productName) {
                                throw new Error("Ingrese un nombre de producto para buscar");
                            }

                            const searchTerm = productName.trim().toLowerCase();

                            // Cargar ventas en el rango de fechas
                            const ventasSnapshot = await AppState.db.collection("VENTAS")
                                .where("date", ">=", startDate)
                                .where("date", "<=", endDate)
                                .get();

                            let ventas = ventasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            // Ordenar client-side
                            ventas.sort((a, b) => {
                                // Primero por fecha (desc)
                                if (a.date !== b.date) {
                                    return b.date.localeCompare(a.date);
                                }
                                // Luego por timestamp (desc)
                                const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                                const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                                return timeB - timeA;
                            });

                            // Filtrar ventas que contengan el producto buscado
                            const resultados = [];

                            ventas.forEach(venta => {
                                if (venta.products && venta.products.length > 0) {
                                    const productosEncontrados = venta.products.filter(prod =>
                                        prod.descripcion && prod.descripcion.toLowerCase().includes(searchTerm)
                                    );

                                    if (productosEncontrados.length > 0) {
                                        // Agregar resultado con detalles de la venta y productos encontrados
                                        resultados.push({
                                            ...venta,
                                            productosEncontrados
                                        });
                                    }
                                }
                            });

                            return resultados;
                        } catch (error) {
                            console.error("Error buscando producto:", error);
                            throw error;
                        }
                    },

                    async loadMovementsByDate(date = DateUtils.getCurrentDateStringElSalvador(), limit = 500) {
                        try {
                            const [ventas, retiros, ingresos] = await Promise.all([
                                this.loadSalesByDate(date, limit),
                                this.loadRetirosByDate(date, limit),
                                this.loadIngresosByDate(date, limit)
                            ]);

                            const allMovements = [
                                ...ventas.map(v => ({ ...v, tipo: 'venta' })),
                                ...retiros.map(r => ({ ...r, tipo: 'retiro' })),
                                ...ingresos.map(i => ({ ...i, tipo: 'ingreso' }))
                            ];

                            return allMovements.sort((a, b) => {
                                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : a.timestamp;
                                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : b.timestamp;
                                return dateB - dateA;
                            }).slice(0, limit);
                        } catch (error) {
                            console.error("Error cargando movimientos por fecha:", error);
                            return [];
                        }
                    },

                    async processGroupAbono(grupoId, montoTotal) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (!AppState.firebaseInitialized) throw new Error("No hay conexión a la base de datos");

                            // 1. Obtener todas las facturas pendientes del grupo
                            const snapshot = await AppState.db.collection("VENTAS")
                                .where("grupo", "==", grupoId)
                                .where("paymentType", "==", "pendiente")
                                .where("status", "==", "pendiente")
                                .get();

                            if (snapshot.empty) throw new Error("El grupo no tiene facturas pendientes");

                            let facturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            // 2. Ordenar por fecha (más antiguas primero)
                            facturas.sort((a, b) => {
                                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                                return dateA - dateB;
                            });

                            let montoRestante = montoTotal;
                            const batch = AppState.db.batch();
                            let updatesCount = 0;
                            const facturasAfectadas = [];

                            // 3. Distribuir el abono
                            for (const factura of facturas) {
                                if (montoRestante <= 0.009) break; // Margen de error por decimales

                                let saldoPendiente = factura.total;
                                if (factura.abonos && factura.abonos.length > 0) {
                                    const totalAbonado = factura.abonos.reduce((sum, a) => sum + a.monto, 0);
                                    saldoPendiente = factura.total - totalAbonado;
                                }

                                const montoAbonar = Math.min(montoRestante, saldoPendiente);

                                if (montoAbonar > 0) {
                                    const facturaRef = AppState.db.collection("VENTAS").doc(factura.id);
                                    const nuevoSaldo = saldoPendiente - montoAbonar;

                                    const abonoData = {
                                        monto: montoAbonar,
                                        fecha: DateUtils.getCurrentTimestampElSalvador(),
                                        fechaString: DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES'),
                                        tipo: 'abono_grupal',
                                        grupoId: grupoId,
                                        savedInIngresos: true // Bandera para evitar duplicados en historial
                                    };

                                    // Guardar en INGRESOS
                                    const ingresoRef = AppState.db.collection("INGRESOS").doc();
                                    const ingresoData = {
                                        monto: montoAbonar,
                                        concepto: `Abono Grupal a EQUIPO ${factura.equipoNumber || '0000'}`,
                                        categoria: 'abono',
                                        timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                        date: DateUtils.getCurrentDateStringElSalvador(),
                                        invoiceId: factura.id,
                                        invoiceNumber: factura.invoiceNumber,
                                        clientName: factura.clientName || 'Cliente',
                                        equipoNumber: factura.equipoNumber || '0000',
                                        grupoId: grupoId
                                    };
                                    batch.set(ingresoRef, ingresoData);

                                    const updateData = {
                                        abonos: firebase.firestore.FieldValue.arrayUnion(abonoData),
                                        saldoPendiente: nuevoSaldo,
                                        fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                                    };

                                    if (nuevoSaldo <= 0.009) {
                                        updateData.paymentType = 'contado';
                                        updateData.status = 'pagado';
                                    }

                                    batch.update(facturaRef, updateData);
                                    updatesCount++;

                                    montoRestante -= montoAbonar;
                                    facturasAfectadas.push({ ...factura, abono: montoAbonar });
                                }
                            }

                            if (updatesCount > 0) {
                                await batch.commit();
                                await GrupoManager.loadEquiposPendientes(); // Recargar datos
                                return facturasAfectadas;
                            } else {
                                throw new Error("No se pudo aplicar el abono a ninguna factura");
                            }
                        }, "Abono Grupal");
                    },

                    async processMultiAbono(facturasIds, montoTotal) {
                        return await ConcurrencyManager.withLock(async () => {
                            if (!AppState.firebaseInitialized) throw new Error("No hay conexión a la base de datos");

                            // 1. Obtener las facturas
                            const facturas = [];
                            for (const id of facturasIds) {
                                const doc = await AppState.db.collection("VENTAS").doc(id).get();
                                if (doc.exists) {
                                    facturas.push({ id: doc.id, ...doc.data() });
                                }
                            }

                            if (facturas.length === 0) throw new Error("No se encontraron las facturas seleccionadas");

                            // 2. Ordenar por fecha (más antiguas primero)
                            facturas.sort((a, b) => {
                                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                                return dateA - dateB;
                            });

                            let montoRestante = montoTotal;
                            const batch = AppState.db.batch();
                            let updatesCount = 0;
                            const facturasAfectadas = [];

                            // 3. Distribuir el abono
                            for (const factura of facturas) {
                                if (montoRestante <= 0.009) break;

                                let saldoPendiente = factura.total;
                                if (factura.abonos && factura.abonos.length > 0) {
                                    const totalAbonado = factura.abonos.reduce((sum, a) => sum + a.monto, 0);
                                    saldoPendiente = factura.total - totalAbonado;
                                }

                                const montoAbonar = Math.min(montoRestante, saldoPendiente);

                                if (montoAbonar > 0) {
                                    const facturaRef = AppState.db.collection("VENTAS").doc(factura.id);
                                    const nuevoSaldo = saldoPendiente - montoAbonar;

                                    const abonoData = {
                                        monto: montoAbonar,
                                        fecha: DateUtils.getCurrentTimestampElSalvador(),
                                        fechaString: DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES'),
                                        tipo: 'abono_masivo',
                                        savedInIngresos: true // Bandera para evitar duplicados en historial
                                    };

                                    // Guardar en INGRESOS
                                    const ingresoRef = AppState.db.collection("INGRESOS").doc();
                                    const ingresoData = {
                                        monto: montoAbonar,
                                        concepto: `Abono Masivo a Factura #${factura.invoiceNumber}`,
                                        categoria: 'abono',
                                        timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                        date: DateUtils.getCurrentDateStringElSalvador(),
                                        invoiceId: factura.id,
                                        invoiceNumber: factura.invoiceNumber,
                                        clientName: factura.clientName || 'Cliente',
                                        equipoNumber: factura.equipoNumber || '0000'
                                    };
                                    batch.set(ingresoRef, ingresoData);

                                    const updateData = {
                                        abonos: firebase.firestore.FieldValue.arrayUnion(abonoData),
                                        saldoPendiente: nuevoSaldo,
                                        fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                                    };

                                    if (nuevoSaldo <= 0.009) {
                                        updateData.paymentType = 'contado';
                                        updateData.status = 'pagado';
                                    }

                                    batch.update(facturaRef, updateData);
                                    updatesCount++;

                                    montoRestante -= montoAbonar;
                                    facturasAfectadas.push({ ...factura, abono: montoAbonar });
                                }
                            }

                            if (updatesCount > 0) {
                                await batch.commit();
                                await GrupoManager.loadEquiposPendientes();
                                return facturasAfectadas;
                            } else {
                                throw new Error("No se pudo aplicar el abono a ninguna factura");
                            }
                        }, "Abono Masivo");
                    },

                    async exportBackup() {
                        try {
                            const ventas = await this.loadSales(10000); // Limit high enough to get all
                            const retiros = await this.loadRetiros(10000);
                            const grupos = Array.from(GrupoManager.grupos.entries());

                            const backupData = {
                                version: '1.0',
                                timestamp: new Date().toISOString(),
                                ventas: ventas,
                                retiros: retiros,
                                grupos: grupos
                            };

                            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                            const downloadAnchorNode = document.createElement('a');
                            downloadAnchorNode.setAttribute("href", dataStr);
                            downloadAnchorNode.setAttribute("download", "taller_willian_backup_" + DateUtils.getCurrentDateStringElSalvador() + ".json");
                            document.body.appendChild(downloadAnchorNode); // required for firefox
                            downloadAnchorNode.click();
                            downloadAnchorNode.remove();

                            return true;
                        } catch (error) {
                            console.error("Error exportando backup:", error);
                            throw error;
                        }
                    },

                    async checkConnection() {
                        try {
                            await AppState.db.collection("COUNTERS").doc("sales").get({ source: 'server' });
                            return true;
                        } catch (error) {
                            return false;
                        }
                    }
                };

                const ModalService = {
                    closeAbonoModal() {
                        document.getElementById('abono-modal').style.display = 'none';
                        AppState.currentAbonoInvoice = null;
                    },

                    closeRetiroModal() {
                        document.getElementById('retiro-modal').style.display = 'none';
                    },

                    closeIngresoModal() {
                        document.getElementById('ingreso-modal').style.display = 'none';
                    },

                    closeEditarRetiroModal() {
                        document.getElementById('editar-retiro-modal').style.display = 'none';
                    },

                    closeEditarIngresoModal() {
                        document.getElementById('editar-ingreso-modal').style.display = 'none';
                    },

                    closeInvoiceModal() {
                        document.getElementById('invoice-modal').style.display = 'none';
                    },

                    closeDetalleModal() {
                        document.getElementById('detalle-modal').style.display = 'none';
                        AppState.currentDetalle = null;
                    },

                    closeGrupoDetalleModal() {
                        document.getElementById('grupo-detalle-modal').style.display = 'none';
                        GrupoManager.currentGrupoDetalle = null;
                    },

                    closeCrearGrupoModal() {
                        document.getElementById('crear-grupo-modal').style.display = 'none';
                        AppState.equiposSeleccionados.clear();
                    },

                    closeEditarGrupoModal() {
                        document.getElementById('editar-grupo-modal').style.display = 'none';
                        GrupoManager.currentEditingGroup = null;
                        AppState.equiposEditSeleccionados.clear();
                    },

                    closeConfirmacionAbonoModal() {
                        document.getElementById('confirmacion-abono-modal').style.display = 'none';
                        delete AppState.datosVentaPendiente;
                    },

                    closeAbonoInicialModal() {
                        document.getElementById('abono-inicial-modal').style.display = 'none';
                        delete AppState.datosVentaPendiente;
                    }
                };

                const UIService = {
                    showStatus(message, type = 'info') {
                        const statusElement = document.getElementById('status-message');
                        statusElement.textContent = message;
                        statusElement.className = `status ${type}`;
                        statusElement.style.display = 'block';

                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 4000);
                    },

                    showLoading(show = true) {
                        const loadingOverlay = document.getElementById('loading-overlay');
                        loadingOverlay.style.display = show ? 'flex' : 'none';
                    },

                    showRetiroModal() {
                        document.getElementById('retiro-modal').style.display = 'flex';
                        document.getElementById('concepto-retiro').value = '';
                        document.getElementById('monto-retiro').value = '';
                        document.getElementById('categoria-retiro').value = 'compra';
                        document.getElementById('concepto-retiro').focus();
                    },

                    showIngresoModal() {
                        document.getElementById('ingreso-modal').style.display = 'flex';
                        document.getElementById('concepto-ingreso').value = '';
                        document.getElementById('monto-ingreso').value = '';
                        document.getElementById('categoria-ingreso').value = 'venta';
                        document.getElementById('concepto-ingreso').focus();
                    },

                    closeIngresoModal() {
                        document.getElementById('ingreso-modal').style.display = 'none';
                    },

                    showEditarRetiroModal(retiro) {
                        document.getElementById('edit-retiro-id').value = retiro.id;
                        document.getElementById('edit-concepto-retiro').value = retiro.concepto;
                        document.getElementById('edit-monto-retiro').value = retiro.monto;
                        document.getElementById('edit-categoria-retiro').value = retiro.categoria;
                        document.getElementById('editar-retiro-modal').style.display = 'flex';
                    },

                    showEditarIngresoModal(ingreso) {
                        document.getElementById('edit-ingreso-id').value = ingreso.id;
                        document.getElementById('edit-concepto-ingreso').value = ingreso.concepto;
                        document.getElementById('edit-monto-ingreso').value = ingreso.monto;
                        document.getElementById('edit-categoria-ingreso').value = ingreso.categoria;
                        document.getElementById('editar-ingreso-modal').style.display = 'flex';
                    },

                    updateCartDisplay() {
                        const cartItems = document.getElementById('cart-items');
                        const totalAmount = document.getElementById('total-amount');

                        if (AppState.cart.length === 0) {
                            cartItems.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <div>No hay productos agregados</div>
                        </div>
                    `;
                            totalAmount.textContent = 'TOTAL: $0.00';
                            return;
                        }

                        let total = 0;
                        let itemsHTML = '';

                        AppState.cart.forEach((item, index) => {
                            const itemTotal = item.precio * item.cantidad;
                            total += itemTotal;

                            const tienePrecioCero = item.precio === 0;

                            itemsHTML += `
                        <div class="cart-item">
                            <div>
                                <input type="number" class="quantity-input" value="${item.cantidad}" 
                                       min="1" data-index="${index}" onchange="SalesService.updateQuantity(${index}, this.value)">
                            </div>
                            <div class="product-desc">${item.descripcion}</div>
                            <div>
                                <input type="number" class="price-input ${tienePrecioCero ? 'price-warning' : ''}" value="${item.precio.toFixed(2)}" 
                                       step="0.01" min="0" data-index="${index}" onchange="SalesService.updatePrice(${index}, this.value)">
                            </div>
                            <div class="subtotal">$${itemTotal.toFixed(2)}</div>
                            <div class="cart-actions">
                                <button class="delete-item-btn" onclick="SalesService.removeFromCart(${index})" title="Eliminar producto">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                        });

                        cartItems.innerHTML = itemsHTML;
                        totalAmount.textContent = `TOTAL: $${total.toFixed(2)}`;

                        // SCROLL AUTOMÁTICO AL FINAL
                        const cartContainer = document.getElementById('cart-items');
                        cartContainer.scrollTop = cartContainer.scrollHeight;
                    },

                    showSearchResults(results) {
                        const dropdown = document.getElementById('search-dropdown');
                        dropdown.innerHTML = '';

                        if (results.length === 0) {
                            const item = document.createElement('div');
                            item.className = 'search-dropdown-item';
                            item.textContent = 'No se encontraron productos - Presione para agregar manualmente';
                            item.addEventListener('click', () => {
                                const searchInput = document.getElementById('buscar-producto');
                                SalesService.addManualProduct(searchInput.value);
                                dropdown.style.display = 'none';
                                searchInput.value = '';
                            });
                            dropdown.appendChild(item);
                        } else {
                            results.forEach(product => {
                                const item = document.createElement('div');
                                item.className = 'search-dropdown-item';
                                const isManual = product.id.startsWith('manual-');
                                item.innerHTML = `
                            <strong>${product.descripcion || 'Sin descripción'}</strong>
                            <div style="font-size: 0.7rem; margin-top: 2px;">
                                ${isManual ? 'PRODUCTO MANUAL' : `Cód: ${product.codigo || 'N/A'} | Stock: ${product.cantidad || 0}`} | $${(product.precio || 0).toFixed(2)}
                            </div>
                        `;
                                item.addEventListener('click', () => {
                                    SalesService.addToCart(product);
                                    dropdown.style.display = 'none';
                                    document.getElementById('buscar-producto').value = '';
                                });
                                dropdown.appendChild(item);
                            });
                        }

                        dropdown.style.display = 'block';
                    },

                    updateHistorial(movimientos) {
                        const historialBody = document.getElementById('historial-body');
                        AppState.historial = movimientos;
                        AppState.filteredHistorial = movimientos;

                        // Ocultar resumen diario si estamos viendo historial general
                        const dailySummary = document.getElementById('daily-summary-container');
                        if (dailySummary) {
                            dailySummary.style.display = 'none';
                        }
                        this.applyCurrentFilter();
                    },

                    applyCurrentFilter() {
                        let filtered = AppState.historial;

                        switch (AppState.currentFilter) {
                            case 'hoy':
                                const today = DateUtils.getCurrentDateStringElSalvador();
                                filtered = filtered.filter(mov => {
                                    return mov.date === today;
                                });
                                break;
                            case 'todo':
                                // Mostrar todo sin filtrar
                                break;
                        }

                        AppState.filteredHistorial = filtered;
                        this.renderHistorial();
                    },

                    async filterHistoryByDate() {
                        const dateInput = document.getElementById('history-date-filter');
                        const date = dateInput.value;

                        if (!date) {
                            this.showStatus("Por favor selecciona una fecha", "warning");
                            return;
                        }

                        try {
                            this.showLoading(true);
                            const movimientos = await DataService.getDailyCashFlow(date);

                            AppState.filteredHistorial = movimientos;
                            this.renderHistorial();
                            this.renderProductSummary(movimientos);

                            document.getElementById('daily-summary-container').style.display = 'block';
                            this.showStatus(`Mostrando movimientos del ${date}`, "success");
                        } catch (error) {
                            this.showStatus("Error al filtrar historial: " + error.message, "error");
                        } finally {
                            this.showLoading(false);
                        }
                    },

                    renderProductSummary(movimientos) {
                        const summaryContent = document.getElementById('daily-summary-content');
                        const cashSummary = document.getElementById('daily-cash-summary');
                        const productsMap = new Map();

                        let totalVentas = 0;
                        let totalAbonos = 0;
                        let totalRetiros = 0;
                        let totalIngresos = 0;

                        movimientos.forEach(mov => {
                            if (mov.tipo === 'venta') {
                                // Sumar productos
                                if (mov.products) {
                                    mov.products.forEach(prod => {
                                        const current = productsMap.get(prod.descripcion) || { cantidad: 0, total: 0 };
                                        productsMap.set(prod.descripcion, {
                                            cantidad: current.cantidad + prod.cantidad,
                                            total: current.total + (prod.precio * prod.cantidad)
                                        });
                                    });
                                }
                                // Sumar al total de ventas (contado + crédito)
                                // Para flujo de caja real, sumamos lo que entró hoy
                                if (mov.paymentType === 'contado') {
                                    totalVentas += mov.total;
                                }
                            } else if (mov.tipo === 'abono') {
                                totalAbonos += mov.monto;
                            } else if (mov.tipo === 'retiro') {
                                totalRetiros += Math.abs(mov.monto);
                            } else if (mov.tipo === 'ingreso') {
                                totalIngresos += mov.monto;
                            }
                        });

                        // Renderizar productos en tabla compacta
                        if (productsMap.size === 0) {
                            summaryContent.innerHTML = '<div style="color: #7f8c8d; font-style: italic;">No hubo ventas de productos este día.</div>';
                        } else {
                            // Ordenar por cantidad vendida
                            const sortedProducts = Array.from(productsMap.entries()).sort((a, b) => b[1].cantidad - a[1].cantidad);

                            // Determinar número de columnas basado en cantidad de productos
                            const numProducts = sortedProducts.length;
                            const numColumns = numProducts <= 12 ? 4 : 6;

                            let html = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background-color: #34495e; color: white;">
                                    <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">Cant.</th>
                                    <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">Producto</th>
                                    <th style="padding: 6px 8px; text-align: right; border: 1px solid #ddd;">Total</th>
                    `;

                            // Repetir encabezados según número de columnas
                            for (let i = 1; i < numColumns; i++) {
                                html += `
                                    <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">Cant.</th>
                                    <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd;">Producto</th>
                                    <th style="padding: 6px 8px; text-align: right; border: 1px solid #ddd;">Total</th>
                        `;
                            }

                            html += `
                                </tr>
                            </thead>
                            <tbody>
                    `;

                            // Dividir productos en filas
                            const productsPerRow = numColumns;
                            for (let i = 0; i < sortedProducts.length; i += productsPerRow) {
                                html += '<tr>';

                                for (let j = 0; j < productsPerRow; j++) {
                                    const index = i + j;
                                    if (index < sortedProducts.length) {
                                        const [nombre, data] = sortedProducts[index];
                                        html += `
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #27ae60; background-color: #f9f9f9;">x${data.cantidad}</td>
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; font-weight: 500; color: #2c3e50;">${nombre}</td>
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #2980b9;">$${data.total.toFixed(2)}</td>
                                `;
                                    } else {
                                        // Celdas vacías para completar la fila
                                        html += `
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; background-color: #f5f5f5;"></td>
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; background-color: #f5f5f5;"></td>
                                    <td style="padding: 5px 6px; border: 1px solid #ddd; background-color: #f5f5f5;"></td>
                                `;
                                    }
                                }

                                html += '</tr>';
                            }

                            html += `
                            </tbody>
                        </table>
                    `;

                            summaryContent.innerHTML = html;
                        }

                        // Renderizar resumen de caja
                        const saldoFinal = totalVentas + totalAbonos + totalIngresos - totalRetiros;
                        cashSummary.innerHTML = `
                    <div style="color: #27ae60;">Ventas Contado: $${totalVentas.toFixed(2)}</div>
                    <div style="color: #2980b9;">Abonos Recibidos: $${totalAbonos.toFixed(2)}</div>
                    <div style="color: #16a085;">Ingresos: +$${totalIngresos.toFixed(2)}</div>
                    <div style="color: #c0392b;">Retiros: -$${totalRetiros.toFixed(2)}</div>
                    <div style="color: #2c3e50; border-left: 2px solid #bdc3c7; padding-left: 15px;">Flujo Neto: $${saldoFinal.toFixed(2)}</div>
                `;
                    },

                    renderHistorial() {
                        const historialBody = document.getElementById('historial-body');
                        const movimientos = AppState.filteredHistorial;

                        if (movimientos.length === 0) {
                            historialBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-cart">No hay movimientos que coincidan con el filtro</td>
                        </tr>
                    `;
                            return;
                        }

                        let historialHTML = '';

                        movimientos.forEach(movimiento => {
                            const fecha = movimiento.timestamp ? new Date(movimiento.timestamp.toDate ? movimiento.timestamp.toDate() : movimiento.timestamp).toLocaleDateString('es-ES') : 'N/A';

                            if (movimiento.tipo === 'retiro') {
                                historialHTML += `
                            <tr style="background-color: #fff5f5;">
                                <td><strong>RET-${movimiento.id.substring(0, 6)}</strong></td>
                                <td>
                                    <div class="cliente-equipo">-</div>
                                    <div class="cliente-nombre">${movimiento.concepto || 'Sin concepto'}</div>
                                </td>
                                <td>
                                    <div class="saldo-pendiente-rojo">-$${Math.abs(movimiento.monto).toFixed(2)}</div>
                                </td>
                                <td><span class="retiro-badge">RETIRO</span></td>
                                <td>${fecha}</td>
                                <td>
                                    <div class="action-buttons historial-actions-container">
                                        <button class="icon-btn btn-view" onclick="SalesService.viewRetiro('${movimiento.id}')" title="Ver retiro">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="icon-btn btn-edit" onclick="SalesService.editRetiro('${movimiento.id}')" title="Editar retiro">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn btn-delete" onclick="SalesService.deleteRetiro('${movimiento.id}')" title="Eliminar retiro">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                            } else if (movimiento.tipo === 'ingreso') {
                                historialHTML += `
                            <tr style="background-color: #f0fff4;">
                                <td><strong>ING-${movimiento.id.substring(0, 6)}</strong></td>
                                <td>
                                    <div class="cliente-equipo">-</div>
                                    <div class="cliente-nombre">${movimiento.concepto || 'Sin concepto'}</div>
                                </td>
                                <td>
                                    <div class="saldo-pendiente-negro" style="color: #27ae60;">+$${Math.abs(movimiento.monto).toFixed(2)}</div>
                                </td>
                                <td><span class="ingreso-badge">INGRESO</span></td>
                                <td>${fecha}</td>
                                <td>
                                    <div class="action-buttons historial-actions-container">
                                        <button class="icon-btn btn-view" onclick="SalesService.viewIngreso('${movimiento.id}')" title="Ver ingreso">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="icon-btn btn-edit" onclick="SalesService.editIngreso('${movimiento.id}')" title="Editar ingreso">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="icon-btn btn-delete" onclick="SalesService.deleteIngreso('${movimiento.id}')" title="Eliminar ingreso">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                            } else if (movimiento.tipo === 'abono') {
                                historialHTML += `
                            <tr style="background-color: #f0fff4;">
                                <td><strong>ABO-${movimiento.id.substring(0, 6)}</strong></td>
                                <td>
                                    <div class="cliente-equipo">${movimiento.equipoNumber || '-'}</div>
                                    <div class="cliente-nombre">
                                        Abono a EQUIPO ${movimiento.equipoNumber || 'X'}
                                        ${movimiento.saldoAnterior !== undefined ? `
                                            <div style="font-size: 0.85em; color: #555; margin-top: 4px;">
                                                Saldo Anterior: <b>$${movimiento.saldoAnterior.toFixed(2)}</b> &rarr;
                                                Abono: <b>$${movimiento.monto.toFixed(2)}</b> &rarr;
                                                Nuevo: <b>$${movimiento.nuevoSaldo.toFixed(2)}</b>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div style="font-size: 0.75rem;">
                                        <a href="#" onclick="event.preventDefault(); SalesService.viewInvoice('${movimiento.invoiceId || movimiento.invoiceNumber}');" style="color: #7f8c8d; text-decoration: underline;">
                                            Fac. #${movimiento.invoiceNumber}
                                        </a>
                                    </div>
                                </td>
                                <td>
                                    <div class="saldo-pendiente-negro">+$${movimiento.monto.toFixed(2)}</div>
                                </td>
                                <td><span class="contado-badge" style="background-color: #27ae60;">ABONO</span></td>
                                <td>${fecha}</td>
                                <td>
                                    <div class="action-buttons historial-actions-container">
                                        <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${movimiento.invoiceNumber}')" title="Ver factura origen">
                                            <i class="fas fa-file-invoice"></i>
                                        </button>
                                        <button class="icon-btn btn-delete" onclick="SalesService.deleteAbono('${movimiento.id}', '${movimiento.invoiceId || ''}')" title="Eliminar abono">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                            } else {
                                // Es una VENTA
                                const venta = movimiento;
                                let estadoReal = venta.paymentType;
                                let tipoClass = 'pendiente-badge';
                                let tipoTexto = 'PENDIENTE';
                                let saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;

                                if (venta.paymentType === 'contado') {
                                    tipoClass = 'contado-badge';
                                    tipoTexto = 'CONTADO';
                                } else if (venta.paymentType === 'pendiente') {
                                    if (saldoPendiente <= 0) {
                                        estadoReal = 'contado';
                                        tipoClass = 'contado-badge';
                                        tipoTexto = 'PAGADO';
                                    }
                                }

                                let montoMostrar = venta.total || 0;
                                let claseMonto = 'saldo-pendiente-negro';

                                if (estadoReal === 'pendiente') {
                                    montoMostrar = saldoPendiente;
                                    if (venta.saldoPendiente < venta.total) {
                                        claseMonto = 'saldo-pendiente-rojo';
                                    }
                                }

                                let botonesHTML = '';
                                if (estadoReal === 'contado' || estadoReal === 'pagado') {
                                    botonesHTML = `
                                <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${venta.id}')" title="Ver factura">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="icon-btn btn-reprint" onclick="SalesService.reprintInvoice('${venta.id}')" title="Reimprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="icon-btn btn-delete" onclick="SalesService.deleteInvoice('${venta.id}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                                } else {
                                    botonesHTML = `
                                <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${venta.id}')" title="Ver factura">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="icon-btn btn-reprint" onclick="SalesService.reprintInvoice('${venta.id}')" title="Reimprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="icon-btn btn-edit" onclick="SalesService.editInvoice('${venta.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn btn-abono" onclick="SalesService.registrarAbono('${venta.id}')" title="Registrar abono">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                                <button class="icon-btn btn-delete" onclick="SalesService.deleteInvoice('${venta.id}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="icon-btn btn-cancel" onclick="SalesService.cancelInvoice('${venta.id}')" title="Cancelar factura">
                                    <i class="fas fa-ban"></i>
                                </button>
                            `;
                                }

                                historialHTML += `
                            <tr>
                                <td>
                                    <a href="#" onclick="event.preventDefault(); SalesService.viewInvoice('${venta.id}');" style="color: #2c3e50; text-decoration: none; font-weight: bold;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                                        #${venta.invoiceNumber}
                                    </a>
                                </td>
                                <td>
                                    <div class="cliente-equipo">${venta.equipoNumber || '-'}</div>
                                    <div class="cliente-nombre">${venta.clientName || 'Cliente General'}</div>
                                </td>
                                <td>
                                    <div class="${claseMonto}">$${montoMostrar.toFixed(2)}</div>
                                    ${venta.total !== montoMostrar ? `<div style="font-size: 0.7rem; color: #999;">Total: $${venta.total.toFixed(2)}</div>` : ''}
                                </td>
                                <td><span class="${tipoClass}">${tipoTexto}</span></td>
                                <td>${fecha}</td>
                                <td>
                                    <div class="action-buttons historial-actions-container">
                                        ${botonesHTML}
                                    </div>
                                </td>
                            </tr>
                        `;
                            }
                        });

                        historialBody.innerHTML = historialHTML;

                        // Agregar Resumen de Productos (siempre que haya movimientos)
                        if (movimientos.length > 0) {
                            const resumenHTML = this.generarResumenProductos(movimientos);
                            // Insertar como una fila al final que abarque todas las columnas
                            if (resumenHTML) {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="6" style="padding: 0;">${resumenHTML}</td>`;
                                historialBody.appendChild(row);
                            }
                        }
                    },

                    generarResumenProductos(movimientos) {
                        // Filtrar solo ventas
                        const ventas = movimientos.filter(m => !m.tipo || m.tipo === 'venta');
                        if (ventas.length === 0) return '';

                        const productosMap = {};

                        ventas.forEach(venta => {
                            if (venta.products && Array.isArray(venta.products)) {
                                venta.products.forEach(p => {
                                    if (p.codigo && p.codigo.toLowerCase() === 'manual') return;

                                    const key = p.codigo || p.descripcion;
                                    if (!productosMap[key]) {
                                        productosMap[key] = {
                                            codigo: p.codigo,
                                            descripcion: p.descripcion,
                                            cantidad: 0,
                                            totalVenta: 0
                                        };
                                    }
                                    productosMap[key].cantidad += (parseFloat(p.cantidad) || 0);
                                    // Usar precio * cantidad de la venta para exactitud
                                    productosMap[key].totalVenta += (parseFloat(p.precio) * parseFloat(p.cantidad));
                                });
                            }
                        });

                        const productos = Object.values(productosMap).sort((a, b) => b.totalVenta - a.totalVenta);

                        if (productos.length === 0) return '';

                        const totalGeneral = productos.reduce((sum, p) => sum + p.totalVenta, 0);
                        const totalCantidad = productos.reduce((sum, p) => sum + p.cantidad, 0);

                        let html = `
                            <div style="background-color: #f8f9fa; padding: 15px; border-top: 2px solid #ddd; margin-top: 20px;">
                                <h4 style="margin-bottom: 10px; color: #2c3e50; text-align: center;">RESUMEN DE PRODUCTOS VENDIDOS</h4>
                                <table class="table table-sm table-bordered" style="width: 100%; font-size: 0.9em; background: white;">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Cód.</th>
                                            <th>Descripción</th>
                                            <th class="text-center">Cant.</th>
                                            <th class="text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        productos.forEach(p => {
                            html += `
                                <tr>
                                    <td>${p.codigo || '-'}</td>
                                    <td>${p.descripcion}</td>
                                    <td class="text-center"><strong>${p.cantidad}</strong></td>
                                    <td class="text-right">$${p.totalVenta.toFixed(2)}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    <tr style="background-color: #e8f4fd; font-weight: bold;">
                                        <td colspan="2" class="text-right">TOTALES:</td>
                                        <td class="text-center">${totalCantidad}</td>
                                        <td class="text-right">$${totalGeneral.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        `;

                        return html;
                    },

                    async searchProductInHistory() {
                        const productName = document.getElementById('product-search-input').value.trim();
                        const startDate = document.getElementById('product-search-start-date').value;
                        const endDate = document.getElementById('product-search-end-date').value;

                        if (!productName) {
                            this.showStatus("Por favor ingresa el nombre del producto a buscar", "warning");
                            return;
                        }

                        if (!startDate || !endDate) {
                            this.showStatus("Por favor selecciona un rango de fechas", "warning");
                            return;
                        }

                        try {
                            this.showLoading(true);
                            const resultados = await DataService.searchProductInHistory(productName, startDate, endDate);
                            this.showProductSearchResults(resultados, productName);
                        } catch (error) {
                            this.showStatus("Error al buscar producto: " + error.message, "error");
                        } finally {
                            this.showLoading(false);
                        }
                    },

                    showProductSearchResults(resultados, productName) {
                        const historialBody = document.getElementById('historial-body');
                        const dailySummary = document.getElementById('daily-summary-container');
                        const productResults = document.getElementById('product-search-results');

                        // Ocultar resumen diario
                        if (dailySummary) {
                            dailySummary.style.display = 'none';
                        }

                        if (resultados.length === 0) {
                            productResults.style.display = 'block';
                            historialBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px; display: block; opacity: 0.3;"></i>
                                <p style="margin: 0;">No se encontraron ventas con el producto "<strong>${productName}</strong>" en el rango seleccionado.</p>
                            </td>
                        </tr>
                    `;
                            return;
                        }

                        // Mostrar indicador de resultados
                        productResults.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #2c3e50;">
                            <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                            ${resultados.length} venta(s) encontrada(s) con "${productName}"
                        </span>
                        <button class="btn btn-secondary" onclick="SalesService.loadHistorial()" style="padding: 5px 12px; font-size: 0.85rem;">
                            <i class="fas fa-times"></i> Cerrar búsqueda
                        </button>
                    </div>
                `;
                        productResults.style.display = 'block';

                        // Renderizar resultados en la tabla de historial
                        let historialHTML = '';
                        resultados.forEach((venta) => {
                            const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES') : 'N/A';
                            const tipoPago = venta.paymentType === 'contado' ? 'contado-badge' : 'pendiente-badge';
                            const tipoTexto = venta.paymentType === 'contado' ? 'CONTADO' : 'CRÉDITO';

                            // Construir lista de productos encontrados
                            let productosHTML = '';
                            venta.productosEncontrados.forEach(prod => {
                                productosHTML += `
                            <div style="padding: 4px 0; border-bottom: 1px dashed #ddd; margin-bottom: 4px;">
                                <strong style="color: #2980b9;">${prod.descripcion}</strong><br>
                                <span style="font-size: 0.8rem; color: #666;">
                                    Cant: <strong>${prod.cantidad}</strong> | 
                                    Precio: $${prod.precio.toFixed(2)} | 
                                    Total: <strong>$${(prod.cantidad * prod.precio).toFixed(2)}</strong>
                                </span>
                            </div>
                        `;
                            });

                            historialHTML += `
                        <tr style="background-color: #f0f8ff;">
                            <td><strong>#${venta.invoiceNumber}</strong></td>
                            <td>
                                <div class="cliente-equipo">${venta.equipoNumber || '-'}</div>
                                <div class="cliente-nombre">${venta.clientName || 'Cliente General'}</div>
                            </td>
                            <td>
                                <div style="margin-bottom: 8px;">
                                    ${productosHTML}
                                </div>
                                <div style="background: #ecf0f1; padding: 5px; border-radius: 3px; text-align: right; font-weight: bold;">
                                    Total Venta: $${venta.total.toFixed(2)}
                                </div>
                            </td>
                            <td><span class="${tipoPago}">${tipoTexto}</span></td>
                            <td>${fecha}</td>
                            <td>
                                <div class="action-buttons historial-actions-container">
                                    <button class="icon-btn btn-view" onclick="SalesService.viewInvoice('${venta.id}')" title="Ver factura">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="icon-btn btn-reprint" onclick="SalesService.reprintInvoice('${venta.id}')" title="Reimprimir">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                        });

                        historialBody.innerHTML = historialHTML;
                    },

                    setProductSearchMonth(type) {
                        const today = new Date();
                        let startDate, endDate;

                        if (type === 'current') {
                            // Primer día del mes actual
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                            // Último día del mes actual
                            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        } else if (type === 'last') {
                            // Primer día del mes pasado
                            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            // Último día del mes pasado
                            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        }

                        // Formatear fechas a YYYY-MM-DD
                        const formatDate = (date) => {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };

                        document.getElementById('product-search-start-date').value = formatDate(startDate);
                        document.getElementById('product-search-end-date').value = formatDate(endDate);
                    },

                    clearProductSearch() {
                        document.getElementById('product-search-input').value = '';
                        document.getElementById('product-search-start-date').value = '';
                        document.getElementById('product-search-end-date').value = '';
                        document.getElementById('product-search-results').style.display = 'none';
                        // Recargar historial normal
                        SalesService.loadHistorial();
                    },

                    showInvoiceModal(content) {
                        document.getElementById('invoice-modal-content').innerHTML = content;
                        document.getElementById('invoice-modal').style.display = 'block';
                    },

                    showAbonoModal(content) {
                        document.getElementById('abono-modal-content').innerHTML = content;
                        document.getElementById('abono-modal').style.display = 'block';
                        document.getElementById('monto-abono').value = '';
                        document.getElementById('monto-abono').focus();
                    },

                    showRetiroModal() {
                        document.getElementById('retiro-modal').style.display = 'block';
                        document.getElementById('monto-retiro').value = '';
                        document.getElementById('concepto-retiro').value = '';
                        document.getElementById('categoria-retiro').value = 'compra';
                        document.getElementById('monto-retiro').focus();
                    },

                    restorePaymentButtons() {
                        // Restaurar los botones originales en sus contenedores
                        const contadoContainer = document.querySelector('.venta-line-1').lastElementChild;
                        const pendienteContainer = document.querySelector('.venta-line-2').lastElementChild;

                        contadoContainer.innerHTML = '<button class="btn btn-success" id="contado-btn">CONTADO</button>';
                        pendienteContainer.innerHTML = '<button class="btn btn-warning" id="pendiente-btn">PENDIENTE</button>';

                        // Restaurar event listeners
                        document.getElementById('contado-btn').addEventListener('click', () => SalesService.processSale('contado'));
                        document.getElementById('pendiente-btn').addEventListener('click', () => SalesService.processSale('pendiente'));
                    },

                    // Retiro Listeners
                    // This section is typically in the main DOMContentLoaded block, but adding here as per instruction's context.
                    // If this causes issues, it should be moved to the main event listener setup.
                    // document.getElementById('process-bulk-abono-btn').addEventListener('click', () => SalesService.processGroupAbono()); // This line was in the instruction's context but not in the provided code.
                    // document.getElementById('close-bulk-abono-modal').addEventListener('click', () => ModalService.closeBulkAbonoModal()); // This line was in the instruction's context but not in the provided code.
                    // Retiro Listeners
                    // The following lines are added based on the instruction.
                    // They are placed here to match the instruction's provided context,
                    // assuming this is where other modal-related listeners are intended to be.
                    // If these are meant for the main DOMContentLoaded block, they should be moved there.
                    // document.getElementById('process-retiro-btn').addEventListener('click', () => SalesService.processRetiro());
                    // document.getElementById('close-retiro-modal').addEventListener('click', () => ModalService.closeRetiroModal());


                    updateFilterButtons() {
                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.filter === AppState.currentFilter) {
                                btn.classList.add('active');
                            }
                        });
                    },

                    setupTabs() {
                        const tabButtons = document.querySelectorAll('.tab-btn');
                        const tabContents = document.querySelectorAll('.tab-content');

                        tabButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const tabId = button.getAttribute('data-tab');

                                tabButtons.forEach(btn => btn.classList.remove('active'));
                                tabContents.forEach(content => content.classList.remove('active'));

                                button.classList.add('active');
                                document.getElementById(`tab-${tabId}`).classList.add('active');
                            });
                        });
                    },

                    updatePaymentButtonsState(processing = false) {
                        const contadoBtn = document.getElementById('contado-btn');
                        const pendienteBtn = document.getElementById('pendiente-btn');

                        if (processing) {
                            contadoBtn.disabled = true;
                            pendienteBtn.disabled = true;
                            contadoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFICANDO...';
                            pendienteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFICANDO...';
                        } else {
                            contadoBtn.disabled = false;
                            pendienteBtn.disabled = false;
                            contadoBtn.innerHTML = 'CONTADO';
                            pendienteBtn.innerHTML = 'PENDIENTE';
                        }
                    },

                    showDuplicateWarning(invoiceNumber) {
                        const statusElement = document.getElementById('status-message');
                        statusElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>ADVERTENCIA:</strong> La factura ${invoiceNumber} ya existe
                        </div>
                        <button onclick="SalesService.regenerateInvoiceNumber()" class="btn btn-warning btn-small" style="margin-left: 10px;">
                            <i class="fas fa-sync"></i> Generar Nueva
                        </button>
                    </div>
                `;
                        statusElement.className = 'status error duplicate-warning';
                        statusElement.style.display = 'block';
                    }
                };

                const SalesService = {
                    addToCart(product) {
                        const cartItem = {
                            id: product.id,
                            codigo: product.codigo || 'MANUAL',
                            descripcion: product.descripcion || 'Sin descripción',
                            precio: product.precio || 0,
                            cantidad: 1
                        };

                        AppState.cart.push(cartItem);
                        UIService.updateCartDisplay();
                        UIService.showStatus("Producto agregado al carrito", "success");
                    },

                    addManualProduct(descripcion) {
                        if (!descripcion.trim()) {
                            UIService.showStatus("Ingrese una descripción para el producto", "error");
                            return;
                        }

                        this.addToCart({
                            id: 'manual-' + Date.now(),
                            codigo: 'MANUAL',
                            descripcion: descripcion,
                            precio: 0,
                            cantidad: 1
                        });
                    },

                    removeFromCart(index) {
                        AppState.cart.splice(index, 1);
                        UIService.updateCartDisplay();
                        UIService.showStatus("Producto eliminado del carrito", "info");
                    },

                    updateQuantity(index, newQuantity) {
                        const quantity = parseInt(newQuantity) || 1;
                        if (quantity < 1) {
                            UIService.showStatus("La cantidad debe ser al menos 1", "error");
                            AppState.cart[index].cantidad = 1;
                        } else {
                            AppState.cart[index].cantidad = quantity;
                        }
                        UIService.updateCartDisplay();
                    },

                    updatePrice(index, newPrice) {
                        const price = parseFloat(newPrice) || 0;
                        if (price < 0) {
                            UIService.showStatus("El precio no puede ser negativo", "error");
                            AppState.cart[index].precio = 0;
                        } else {
                            AppState.cart[index].precio = price;
                        }
                        UIService.updateCartDisplay();
                    },

                    async generateInvoiceNumber() {
                        const fechaVenta = document.getElementById('fecha-venta').value;
                        const date = fechaVenta || DateUtils.getCurrentDateStringElSalvador();
                        const datePart = date.replace(/-/g, '').substring(2);

                        try {
                            const currentCounter = await DataService.getSaleCounter(date);
                            const counterPart = (currentCounter + 1).toString().padStart(4, '0');

                            const invoiceNumber = datePart + counterPart;

                            AppState.currentInvoiceNumber = invoiceNumber;
                            return invoiceNumber;
                        } catch (error) {
                            const fallback = datePart + Date.now().toString().substr(-4);
                            console.error("Error generando factura, usando fallback:", fallback);
                            AppState.currentInvoiceNumber = fallback;
                            return fallback;
                        }
                    },

                    async regenerateInvoiceNumber() {
                        try {
                            const newInvoiceNumber = await this.generateInvoiceNumber();
                            UIService.showStatus(`Nueva factura generada: ${newInvoiceNumber}`, "success");
                            return newInvoiceNumber;
                        } catch (error) {
                            UIService.showStatus("Error generando nueva factura", "error");
                            throw error;
                        }
                    },

                    async verifyInvoiceUnique(invoiceNumber) {
                        try {
                            const exists = await DataService.checkInvoiceExists(invoiceNumber);
                            if (exists) {
                                UIService.showDuplicateWarning(invoiceNumber);
                                return false;
                            }
                            return true;
                        } catch (error) {
                            console.error("Error verificando factura única:", error);
                            return true;
                        }
                    },

                    validateSaleData(equipo, cliente, fechaVenta) {
                        // CORRECCIÓN 9: Validaciones mejoradas de montos
                        if (!equipo.trim()) {
                            throw new Error("El número de equipo es obligatorio");
                        }

                        if (!/^\d+$/.test(equipo.trim())) {
                            throw new Error("El número de equipo debe contener solo números");
                        }

                        if (!fechaVenta) {
                            throw new Error("Seleccione una fecha para la venta");
                        }

                        // CORRECCIÓN 4: Restaurar validación de fechas futuras
                        if (DateUtils.isFutureDateInElSalvador(fechaVenta)) {
                            const confirmacion = confirm("La fecha seleccionada es futura. ¿Está seguro de continuar?");
                            if (!confirmacion) {
                                throw new Error("Fecha futura no confirmada");
                            }
                        }

                        const productosConPrecioCero = AppState.cart.filter(item => item.precio === 0);
                        if (productosConPrecioCero.length > 0) {
                            throw new Error("Hay productos con precio $0.00. Modifique los precios antes de guardar.");
                        }

                        // CORRECCIÓN 9: Validar formato de precios
                        const productosConPrecioInvalido = AppState.cart.filter(item =>
                            item.precio < 0 || isNaN(item.precio) || !isFinite(item.precio)
                        );
                        if (productosConPrecioInvalido.length > 0) {
                            throw new Error("Hay productos con precios inválidos. Verifique los montos.");
                        }

                        return true;
                    },

                    async processSale(paymentType) {
                        // CORRECCIÓN 6: Prevenir procesamiento concurrente
                        if (AppState.processingSale) {
                            UIService.showStatus("Ya hay una venta en proceso", "error");
                            return;
                        }

                        if (AppState.cart.length === 0) {
                            UIService.showStatus("El carrito está vacío", "error");
                            return;
                        }

                        const equipo = document.getElementById('equipo').value.trim();
                        const cliente = document.getElementById('cliente').value.trim();
                        const fechaVenta = document.getElementById('fecha-venta').value;

                        try {
                            this.validateSaleData(equipo, cliente, fechaVenta);

                            const finalCliente = cliente || `Equipo ${equipo}`;
                            const finalEquipo = equipo || '0000';

                            const totalVenta = AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                            if (totalVenta > 1000) {
                                const confirmacion = confirm(`¿Está seguro de guardar esta venta por $${totalVenta.toFixed(2)}?`);
                                if (!confirmacion) {
                                    return;
                                }
                            }

                            AppState.processingSale = true;
                            UIService.updatePaymentButtonsState(true);
                            UIService.showLoading(true);

                            // Bloqueo explícito de botones para prevenir doble clic
                            const contadoBtn = document.getElementById('contado-btn');
                            const pendienteBtn = document.getElementById('pendiente-btn');
                            if (contadoBtn) contadoBtn.disabled = true;
                            if (pendienteBtn) pendienteBtn.disabled = true;

                            // Para ventas contado, procesar directamente
                            if (paymentType === 'contado') {
                                await this.procesarVentaContado(equipo, cliente, fechaVenta, totalVenta);
                                return;
                            }

                            // Para ventas pendiente, mostrar modal de confirmación de abono
                            if (paymentType === 'pendiente') {
                                this.mostrarConfirmacionAbono(equipo, cliente, totalVenta, fechaVenta);
                                return;
                            }

                        } catch (error) {
                            UIService.showStatus("Error al procesar la venta: " + error.message, "error");
                            console.error("Error en processSale:", error);
                        } finally {
                            // Solo desbloquear si NO se mostró el modal de confirmación (que maneja su propio flujo)
                            // O si hubo un error. Si es pendiente y no hubo error, el modal está abierto y los botones deben seguir bloqueados o manejados por el modal.
                            // Pero processSale retorna antes para 'pendiente', así que este finally se ejecuta.
                            // Si es pendiente, el usuario debe interactuar con el modal. Los botones principales pueden reactivarse porque el modal es un overlay.

                            AppState.processingSale = false;
                            UIService.updatePaymentButtonsState(false);
                            UIService.showLoading(false);

                            const contadoBtn = document.getElementById('contado-btn');
                            const pendienteBtn = document.getElementById('pendiente-btn');
                            if (contadoBtn) contadoBtn.disabled = false;
                            if (pendienteBtn) pendienteBtn.disabled = false;
                        }
                    },

                    mostrarConfirmacionAbono(equipo, cliente, totalVenta, fechaVenta) {
                        // Guardar datos temporalmente para usar después
                        AppState.datosVentaPendiente = {
                            equipo: equipo,
                            cliente: cliente,
                            totalVenta: totalVenta,
                            fechaVenta: fechaVenta
                        };

                        // Actualizar información en el modal
                        document.getElementById('confirmacion-total').textContent = totalVenta.toFixed(2);
                        document.getElementById('confirmacion-equipo').textContent = equipo;
                        document.getElementById('confirmacion-cliente').textContent = cliente || `Equipo ${equipo}`;

                        // Mostrar modal
                        document.getElementById('confirmacion-abono-modal').style.display = 'block';
                    },

                    async procesarVentaContado(equipo, cliente, fechaVenta, totalVenta) {
                        AppState.processingSale = true;
                        UIService.updatePaymentButtonsState(true);
                        UIService.showLoading(true);

                        try {
                            const finalCliente = cliente || `Equipo ${equipo}`;
                            const finalEquipo = equipo || '0000';

                            const invoiceNumber = await this.generateInvoiceNumber();

                            const isUnique = await this.verifyInvoiceUnique(invoiceNumber);
                            if (!isUnique) {
                                AppState.processingSale = false;
                                UIService.updatePaymentButtonsState(false);
                                UIService.showLoading(false);
                                return;
                            }

                            const saleData = {
                                invoiceNumber: invoiceNumber,
                                equipoNumber: finalEquipo,
                                clientName: finalCliente,
                                products: AppState.cart.map(item => ({
                                    id: item.id,
                                    codigo: item.codigo,
                                    descripcion: item.descripcion,
                                    precio: item.precio,
                                    cantidad: item.cantidad
                                })),
                                total: totalVenta,
                                paymentType: 'contado',
                                timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                date: fechaVenta,
                                status: 'pagado',
                                fechaCreacion: DateUtils.getCurrentTimestampElSalvador()
                            };

                            await DataService.saveSale(saleData);

                            this.printTicket(saleData);

                            UIService.showStatus(`Venta CONTADO procesada - Factura #${saleData.invoiceNumber}`, "success");

                            this.limpiarFormularioVenta();
                            await ProductCache.refresh();
                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar venta contado: " + error.message, "error");
                            console.error("Error en procesarVentaContado:", error);
                        } finally {
                            AppState.processingSale = false;
                            UIService.updatePaymentButtonsState(false);
                            UIService.showLoading(false);
                        }
                    },

                    async procesarVentaPendienteSinAbono(equipo, cliente, fechaVenta, totalVenta) {
                        AppState.processingSale = true;
                        UIService.updatePaymentButtonsState(true);
                        UIService.showLoading(true);

                        try {
                            const finalCliente = cliente || `Equipo ${equipo}`;
                            const finalEquipo = equipo || '0000';

                            const invoiceNumber = await this.generateInvoiceNumber();

                            const isUnique = await this.verifyInvoiceUnique(invoiceNumber);
                            if (!isUnique) {
                                AppState.processingSale = false;
                                UIService.updatePaymentButtonsState(false);
                                UIService.showLoading(false);
                                return;
                            }

                            const saleData = {
                                invoiceNumber: invoiceNumber,
                                equipoNumber: finalEquipo,
                                clientName: finalCliente,
                                products: AppState.cart.map(item => ({
                                    id: item.id,
                                    codigo: item.codigo,
                                    descripcion: item.descripcion,
                                    precio: item.precio,
                                    cantidad: item.cantidad
                                })),
                                total: totalVenta,
                                paymentType: 'pendiente',
                                timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                date: fechaVenta,
                                status: 'pendiente',
                                saldoPendiente: totalVenta,
                                abonos: [],
                                fechaCreacion: DateUtils.getCurrentTimestampElSalvador()
                            };

                            await DataService.saveSale(saleData);

                            this.printTicket(saleData);

                            UIService.showStatus(`Venta PENDIENTE procesada - Factura #${saleData.invoiceNumber}`, "success");

                            this.limpiarFormularioVenta();
                            await ProductCache.refresh();
                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar venta pendiente: " + error.message, "error");
                            console.error("Error en procesarVentaPendienteSinAbono:", error);
                        } finally {
                            AppState.processingSale = false;
                            UIService.updatePaymentButtonsState(false);
                            UIService.showLoading(false);
                        }
                    },

                    async procesarVentaPendienteConAbono(equipo, cliente, fechaVenta, totalVenta, montoAbono) {
                        AppState.processingSale = true;
                        UIService.updatePaymentButtonsState(true);
                        UIService.showLoading(true);

                        try {
                            const finalCliente = cliente || `Equipo ${equipo}`;
                            const finalEquipo = equipo || '0000';
                            const saldoPendiente = totalVenta - montoAbono;

                            const invoiceNumber = await this.generateInvoiceNumber();

                            const isUnique = await this.verifyInvoiceUnique(invoiceNumber);
                            if (!isUnique) {
                                AppState.processingSale = false;
                                UIService.updatePaymentButtonsState(false);
                                UIService.showLoading(false);
                                return;
                            }

                            const abonoData = {
                                monto: montoAbono,
                                fecha: DateUtils.getCurrentTimestampElSalvador(),
                                fechaString: DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES')
                            };

                            const saleData = {
                                invoiceNumber: invoiceNumber,
                                equipoNumber: finalEquipo,
                                clientName: finalCliente,
                                products: AppState.cart.map(item => ({
                                    id: item.id,
                                    codigo: item.codigo,
                                    descripcion: item.descripcion,
                                    precio: item.precio,
                                    cantidad: item.cantidad
                                })),
                                total: totalVenta,
                                paymentType: saldoPendiente <= 0 ? 'contado' : 'pendiente',
                                timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                date: fechaVenta,
                                status: saldoPendiente <= 0 ? 'pagado' : 'pendiente',
                                saldoPendiente: saldoPendiente,
                                abonos: [abonoData],
                                fechaCreacion: DateUtils.getCurrentTimestampElSalvador()
                            };

                            await DataService.saveSale(saleData);

                            // Imprimir ticket de la venta
                            this.printTicket(saleData);

                            // Imprimir ticket del abono si es necesario
                            if (montoAbono > 0) {
                                this.printAbonoTicket(saleData, abonoData, saldoPendiente);
                            }

                            if (saldoPendiente <= 0) {
                                UIService.showStatus(`Venta con abono completo procesada - Factura #${saleData.invoiceNumber}`, "success");
                            } else {
                                UIService.showStatus(`Venta PENDIENTE con abono inicial procesada - Factura #${saleData.invoiceNumber}`, "success");
                            }

                            this.limpiarFormularioVenta();
                            await ProductCache.refresh();
                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar venta con abono: " + error.message, "error");
                            console.error("Error en procesarVentaPendienteConAbono:", error);
                        } finally {
                            AppState.processingSale = false;
                            UIService.updatePaymentButtonsState(false);
                            UIService.showLoading(false);
                        }
                    },

                    mostrarModalAbonoInicial(equipo, cliente, totalVenta, fechaVenta) {
                        // Guardar datos temporalmente
                        AppState.datosVentaPendiente = {
                            equipo: equipo,
                            cliente: cliente,
                            totalVenta: totalVenta,
                            fechaVenta: fechaVenta
                        };

                        // Actualizar información en el modal de abono
                        document.getElementById('abono-modal-total').textContent = totalVenta.toFixed(2);
                        document.getElementById('abono-modal-equipo').textContent = equipo;
                        document.getElementById('abono-modal-cliente').textContent = cliente || `Equipo ${equipo}`;

                        // Resetear campo de abono
                        document.getElementById('monto-abono-inicial').value = '';
                        document.getElementById('saldo-despues-abono').textContent = '$' + totalVenta.toFixed(2);

                        // Mostrar modal
                        document.getElementById('abono-inicial-modal').style.display = 'block';
                        document.getElementById('monto-abono-inicial').focus();
                    },

                    limpiarFormularioVenta() {
                        AppState.cart = [];
                        UIService.updateCartDisplay();
                        document.getElementById('equipo').value = '';
                        document.getElementById('cliente').value = '';
                        document.getElementById('buscar-producto').value = '';
                        delete AppState.datosVentaPendiente;
                    },

                    async updateInvoice(invoiceId) {
                        if (AppState.cart.length === 0) {
                            UIService.showStatus("El carrito está vacío", "error");
                            return;
                        }

                        try {
                            const ventaActual = await DataService.getSaleById(invoiceId);
                            if (!ventaActual) {
                                throw new Error("No se encontró la factura a actualizar");
                            }

                            const productosConPrecioCero = AppState.cart.filter(item => item.precio === 0);
                            if (productosConPrecioCero.length > 0) {
                                throw new Error("Hay productos con precio $0.00. Modifique los precios antes de actualizar.");
                            }

                            const nuevoTotal = AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);

                            let nuevoSaldoPendiente = nuevoTotal;
                            if (ventaActual.abonos && ventaActual.abonos.length > 0) {
                                const totalAbonado = ventaActual.abonos.reduce((sum, abono) => sum + abono.monto, 0);
                                nuevoSaldoPendiente = nuevoTotal - totalAbonado;
                            }

                            const saleData = {
                                products: AppState.cart.map(item => ({
                                    id: item.id,
                                    codigo: item.codigo,
                                    descripcion: item.descripcion,
                                    precio: item.precio,
                                    cantidad: item.cantidad
                                })),
                                total: nuevoTotal,
                                saldoPendiente: nuevoSaldoPendiente,
                                fechaActualizacion: DateUtils.getCurrentTimestampElSalvador()
                            };

                            if (nuevoSaldoPendiente <= 0) {
                                saleData.paymentType = 'contado';
                                saleData.status = 'pagado';
                            }

                            await DataService.updateSale(invoiceId, saleData);

                            UIService.showStatus("Factura actualizada correctamente", "success");

                            const ventaActualizada = { ...ventaActual, ...saleData };
                            this.printTicket(ventaActualizada);

                            this.cancelEdit();

                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al actualizar la factura: " + error.message, "error");
                        }
                    },

                    async loadHistorial() {
                        try {
                            UIService.showLoading(true);
                            const movimientos = await DataService.loadAllMovements(500);
                            UIService.updateHistorial(movimientos);
                        } catch (error) {
                            UIService.showStatus("Error al cargar historial: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async viewInvoice(invoiceId) {
                        let venta;
                        try {
                            venta = await DataService.getSaleById(invoiceId);
                        } catch (error) {
                            venta = AppState.historial.find(v => v.id === invoiceId && v.tipo === 'venta');
                        }

                        if (!venta) return;

                        // Generar lista de productos estilo tabla interna
                        let productosList = '';
                        if (venta.products && venta.products.length > 0) {
                            venta.products.forEach(p => {
                                const precioTotal = p.precio * p.cantidad;
                                productosList += `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 2px;">
                                        <div style="display: flex; gap: 10px;">
                                            <span style="font-weight: bold; min-width: 20px; text-align: center; color: #34495e;">${p.cantidad}</span>
                                            <span style="color: #2c3e50;">${p.descripcion}</span>
                                        </div>
                                        <span style="font-weight: bold; color: #555;">$${precioTotal.toFixed(2)}</span>
                                    </div>
                                `;
                            });
                        } else {
                            productosList = '<div style="color: #999; font-style: italic;">Sin productos detallados</div>';
                        }

                        let abonosSection = '';
                        if (venta.abonos && venta.abonos.length > 0) {
                            abonosSection = `
                                <div style="margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee;">
                                    <h5 style="margin-bottom: 8px; color: #34495e; font-size: 0.9em;">Historial de Abonos:</h5>
                                    ${venta.abonos.map(a => `
                                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 3px;">
                                            <span>${a.fecha ? new Date(a.fecha.toDate ? a.fecha.toDate() : a.fecha).toLocaleString('es-ES') : '-'}</span>
                                            <span style="font-weight: bold; color: #27ae60;">+$${a.monto.toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                        const totalAbonado = venta.total - saldoPendiente;
                        const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleString('es-ES') : 'N/A';

                        let estadoTexto = 'PENDIENTE';
                        let estadoColor = '#e74c3c'; // Rojo

                        if (venta.paymentType === 'contado') {
                            estadoTexto = 'CONTADO';
                            estadoColor = '#27ae60'; // Verde
                        } else if (saldoPendiente <= 0) {
                            estadoTexto = 'PAGADO';
                            estadoColor = '#27ae60'; // Verde
                        }

                        const modalContent = `
                            <div class="invoice-detail-view" style="font-family: 'Segoe UI', sans-serif;">
                                
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h3 style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">
                                        <i class="fas fa-tools"></i> Equipo ${venta.equipoNumber || 'N/A'}
                                    </h3>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #e9ecef; flex-wrap: wrap; gap: 10px;">
                                    <div style="text-align: center; flex: 1;">
                                        <div style="color: #7f8c8d; font-size: 0.85em; font-weight: bold; text-transform: uppercase;">CLIENTE</div>
                                        <div style="font-weight: bold; color: #2c3e50;">${venta.clientName || 'Cliente General'}</div>
                                    </div>
                                    <div style="height: 30px; width: 1px; background: #ddd;"></div>
                                    <div style="text-align: center; flex: 1;">
                                        <div style="color: #7f8c8d; font-size: 0.85em; font-weight: bold; text-transform: uppercase;">ESTADO</div>
                                        <div style="font-weight: bold; color: ${estadoColor};">
                                            ${estadoTexto}
                                        </div>
                                    </div>
                                    <div style="height: 30px; width: 1px; background: #ddd;"></div>
                                    <div style="text-align: center; flex: 1;">
                                         <div style="color: #7f8c8d; font-size: 0.85em; font-weight: bold; text-transform: uppercase;">TOTAL ${estadoTexto === 'PENDIENTE' ? 'PENDIENTE' : 'PAGADO'}</div>
                                         <div style="font-weight: bold; color: ${estadoColor}; font-size: 1.1em;">$${saldoPendiente.toFixed(2)}</div>
                                    </div>
                                </div>

                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #dfe6e9; border-radius: 6px; overflow: hidden;">
                                        <thead style="background-color: #34495e; color: white;">
                                            <tr>
                                                <th style="padding: 12px; text-align: left; font-weight: 500;">Factura</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 500;">Productos</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 500;">Total</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 500;">Abonos</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 500;">Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background-color: white;">
                                                <td style="padding: 15px; vertical-align: top; border-bottom: 1px solid #eee;">
                                                    <div style="font-weight: bold; color: #2c3e50; font-size: 1.1em;">#${venta.invoiceNumber}</div>
                                                    <div style="font-size: 0.85em; color: #95a5a6; margin-top: 4px;">${fecha}</div>
                                                </td>
                                                <td style="padding: 15px; vertical-align: top; border-bottom: 1px solid #eee; width: 40%;">
                                                    ${productosList}
                                                </td>
                                                <td style="padding: 15px; text-align: right; vertical-align: top; border-bottom: 1px solid #eee;">
                                                    <div style="font-weight: bold; font-size: 1.1em;">$${venta.total.toFixed(2)}</div>
                                                </td>
                                                <td style="padding: 15px; text-align: right; vertical-align: top; border-bottom: 1px solid #eee;">
                                                    <div style="color: #636e72;">${totalAbonado > 0 ? '$' + totalAbonado.toFixed(2) : '-'}</div>
                                                </td>
                                                <td style="padding: 15px; text-align: right; vertical-align: top; border-bottom: 1px solid #eee;">
                                                    <div style="font-weight: bold; font-size: 1.2em; color: ${estadoColor};">
                                                        $${saldoPendiente.toFixed(2)}
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                ${abonosSection}

                                <div style="display: flex; gap: 15px; margin-top: 25px;">
                                    <button onclick="ModalService.closeInvoiceModal()" style="flex: 1; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                                        CERRAR
                                    </button>
                                    <button onclick="SalesService.reprintInvoice('${venta.id}')" style="flex: 1; padding: 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                                        <i class="fas fa-print"></i> IMPRIMIR
                                    </button>
                                </div>
                            </div>
                        `;

                        UIService.showInvoiceModal(modalContent);
                    },

                    async viewRetiro(retiroId) {
                        let retiro;
                        try {
                            if (AppState.firebaseInitialized) {
                                const doc = await AppState.db.collection("RETIROS").doc(retiroId).get();
                                if (doc.exists) {
                                    retiro = { id: doc.id, ...doc.data() };
                                }
                            } else {
                                retiro = AppState.historial.find(r => r.id === retiroId && r.tipo === 'retiro');
                            }
                        } catch (error) {
                            retiro = AppState.historial.find(r => r.id === retiroId && r.tipo === 'retiro');
                        }

                        if (!retiro) return;

                        const fecha = retiro.timestamp ? new Date(retiro.timestamp.toDate ? retiro.timestamp.toDate() : retiro.timestamp).toLocaleString('es-ES') : 'N/A';
                        const categoriaText = {
                            'compra': 'Compra de materiales',
                            'gastos': 'Gastos operativos',
                            'herramientas': 'Herramientas',
                            'otros': 'Otros'
                        }[retiro.categoria] || retiro.categoria;

                        const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">Retiro de Fondos</h3>
                    <div class="invoice-details">
                        <strong>Concepto:</strong> ${retiro.concepto || 'Sin concepto'}<br>
                        <strong>Categoría:</strong> ${categoriaText}<br>
                        <strong>Fecha:</strong> ${fecha}<br>
                        <strong>Monto:</strong> $${(retiro.monto || 0).toFixed(2)}
                    </div>
                `;

                        UIService.showInvoiceModal(modalContent);
                    },

                    async editInvoice(invoiceId) {
                        let venta = AppState.historial.find(v => v.id === invoiceId && v.tipo === 'venta');
                        if (!venta) {
                            UIService.showStatus("No se encontró la factura para editar", "error");
                            return;
                        }

                        AppState.cart = venta.products.map(p => ({
                            id: p.id,
                            codigo: p.codigo,
                            descripcion: p.descripcion,
                            precio: p.precio,
                            cantidad: p.cantidad
                        }));

                        document.getElementById('equipo').value = venta.equipoNumber || '';
                        document.getElementById('cliente').value = venta.clientName || '';
                        document.getElementById('fecha-venta').value = venta.date || DateUtils.getCurrentDateStringElSalvador();

                        AppState.currentEditingInvoice = invoiceId;

                        UIService.updateCartDisplay();

                        // Ocultar botones originales
                        document.getElementById('contado-btn').style.display = 'none';
                        document.getElementById('pendiente-btn').style.display = 'none';

                        // Crear botones de edición en las mismas posiciones
                        const updateBtn = document.createElement('button');
                        updateBtn.className = 'btn btn-success';
                        updateBtn.id = 'update-btn';
                        updateBtn.textContent = 'ACTUALIZAR FACTURA';
                        updateBtn.onclick = () => this.updateInvoice(invoiceId);

                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'btn btn-danger';
                        cancelBtn.id = 'cancel-btn';
                        cancelBtn.textContent = 'CANCELAR EDICIÓN';
                        cancelBtn.onclick = () => this.cancelEdit();

                        // Insertar en las mismas posiciones de los botones originales
                        const contadoContainer = document.querySelector('.venta-line-1').lastElementChild;
                        const pendienteContainer = document.querySelector('.venta-line-2').lastElementChild;

                        contadoContainer.innerHTML = '';
                        pendienteContainer.innerHTML = '';

                        contadoContainer.appendChild(updateBtn);
                        pendienteContainer.appendChild(cancelBtn);

                        UIService.showStatus("Modo edición activado - Editando factura pendiente", "success");
                    },

                    cancelEdit() {
                        AppState.cart = [];
                        AppState.currentEditingInvoice = null;
                        this.setTodayDate();
                        UIService.updateCartDisplay();
                        document.getElementById('equipo').value = '';
                        document.getElementById('cliente').value = '';
                        document.getElementById('buscar-producto').value = '';

                        UIService.restorePaymentButtons();

                        UIService.showStatus("Edición cancelada", "info");
                    },

                    async deleteInvoice(invoiceId) {
                        if (!confirm("¿Está seguro de eliminar esta factura? Esta acción no se puede deshacer.")) return;

                        try {
                            UIService.showLoading(true);
                            await DataService.deleteSale(invoiceId);
                            UIService.showStatus("Factura eliminada correctamente", "success");
                            await this.loadHistorial();
                        } catch (error) {
                            UIService.showStatus("Error al eliminar factura: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async deleteRetiro(retiroId) {
                        if (!confirm("¿Está seguro de eliminar este retiro? Esta acción no se puede deshacer.")) return;

                        try {
                            UIService.showLoading(true);
                            if (AppState.firebaseInitialized) {
                                await AppState.db.collection("RETIROS").doc(retiroId).delete();
                                UIService.showStatus("Retiro eliminado correctamente", "success");
                                await this.loadHistorial();
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        } catch (error) {
                            UIService.showStatus("Error al eliminar retiro: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async viewRetiro(retiroId) {
                        const retiro = AppState.historial.find(r => r.id === retiroId && r.tipo === 'retiro');
                        if (!retiro) {
                            UIService.showStatus("No se encontró el retiro", "error");
                            return;
                        }

                        const categoriaText = {
                            'compra': 'Compra de materiales',
                            'gastos': 'Gastos operativos',
                            'herramientas': 'Herramientas',
                            'otros': 'Otros'
                        }[retiro.categoria] || retiro.categoria;

                        const fecha = retiro.timestamp ? new Date(retiro.timestamp.toDate ? retiro.timestamp.toDate() : retiro.timestamp).toLocaleString('es-ES') : 'N/A';

                        const modalContent = `
                            <div class="invoice-detail-view" style="font-family: 'Segoe UI', sans-serif;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h3 style="color: #c0392b; font-weight: bold; margin: 0;">
                                        <i class="fas fa-hand-holding-usd"></i> DETALLE DE RETIRO
                                    </h3>
                                    <div style="color: #7f8c8d; font-size: 0.9em; margin-top: 5px;">${fecha}</div>
                                </div>
                                
                                <div style="background: #fff5f5; padding: 20px; border-radius: 8px; border: 1px solid #feb2b2;">
                                    <div style="margin-bottom: 15px;">
                                        <div style="color: #7f8c8d; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">Concepto</div>
                                        <div style="font-size: 1.1em; color: #2d3748; font-weight: 500;">${retiro.concepto}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <div style="color: #7f8c8d; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">Categoría</div>
                                        <div style="font-size: 1.1em; color: #2d3748;">${categoriaText}</div>
                                    </div>

                                    <div style="border-top: 1px dashed #fc8181; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #c53030; font-weight: bold;">TOTAL RETIRADO</div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #c53030;">$${retiro.monto.toFixed(2)}</div>
                                    </div>
                                </div>

                                <div style="margin-top: 25px;">
                                    <button onclick="ModalService.closeInvoiceModal()" style="width: 100%; padding: 12px; background-color: #718096; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                                        CERRAR
                                    </button>
                                </div>
                            </div>
                        `;
                        UIService.showInvoiceModal(modalContent);
                    },

                    async viewIngreso(ingresoId) {
                        const ingreso = AppState.historial.find(i => i.id === ingresoId && i.tipo === 'ingreso');
                        if (!ingreso) {
                            UIService.showStatus("No se encontró el ingreso", "error");
                            return;
                        }

                        const categoriaText = {
                            'venta': 'Venta',
                            'abono': 'Abono',
                            'otro': 'Otro'
                        }[ingreso.categoria] || ingreso.categoria;

                        const fecha = ingreso.timestamp ? new Date(ingreso.timestamp.toDate ? ingreso.timestamp.toDate() : ingreso.timestamp).toLocaleString('es-ES') : 'N/A';

                        const modalContent = `
                            <div class="invoice-detail-view" style="font-family: 'Segoe UI', sans-serif;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h3 style="color: #27ae60; font-weight: bold; margin: 0;">
                                        <i class="fas fa-donate"></i> DETALLE DE INGRESO
                                    </h3>
                                    <div style="color: #7f8c8d; font-size: 0.9em; margin-top: 5px;">${fecha}</div>
                                </div>
                                
                                <div style="background: #f0fff4; padding: 20px; border-radius: 8px; border: 1px solid #9ae6b4;">
                                    <div style="margin-bottom: 15px;">
                                        <div style="color: #7f8c8d; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">Concepto</div>
                                        <div style="font-size: 1.1em; color: #2d3748; font-weight: 500;">${ingreso.concepto}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <div style="color: #7f8c8d; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">Categoría</div>
                                        <div style="font-size: 1.1em; color: #2d3748;">${categoriaText}</div>
                                    </div>

                                    <div style="border-top: 1px dashed #68d391; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #2f855a; font-weight: bold;">TOTAL INGRESADO</div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #2f855a;">$${ingreso.monto.toFixed(2)}</div>
                                    </div>
                                </div>

                                <div style="margin-top: 25px;">
                                    <button onclick="ModalService.closeInvoiceModal()" style="width: 100%; padding: 12px; background-color: #718096; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                                        CERRAR
                                    </button>
                                </div>
                            </div>
                        `;
                        UIService.showInvoiceModal(modalContent);
                    },

                    async deleteIngreso(ingresoId) {
                        if (!confirm("¿Está seguro de eliminar este ingreso? Esta acción no se puede deshacer.")) return;

                        try {
                            UIService.showLoading(true);
                            if (AppState.firebaseInitialized) {
                                await AppState.db.collection("INGRESOS").doc(ingresoId).delete();
                                UIService.showStatus("Ingreso eliminado correctamente", "success");
                                await this.loadHistorial();
                            } else {
                                throw new Error("No hay conexión a la base de datos");
                            }
                        } catch (error) {
                            UIService.showStatus("Error al eliminar ingreso: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async editRetiro(retiroId) {
                        const retiro = AppState.historial.find(r => r.id === retiroId && r.tipo === 'retiro');
                        if (!retiro) {
                            UIService.showStatus("No se encontró el retiro", "error");
                            return;
                        }
                        UIService.showEditarRetiroModal(retiro);
                    },

                    async editIngreso(ingresoId) {
                        const ingreso = AppState.historial.find(i => i.id === ingresoId && i.tipo === 'ingreso');
                        if (!ingreso) {
                            UIService.showStatus("No se encontró el ingreso", "error");
                            return;
                        }
                        UIService.showEditarIngresoModal(ingreso);
                    },

                    async processEditarRetiro() {
                        const retiroId = document.getElementById('edit-retiro-id').value;
                        const montoInput = document.getElementById('edit-monto-retiro');
                        const conceptoInput = document.getElementById('edit-concepto-retiro');
                        const categoriaInput = document.getElementById('edit-categoria-retiro');

                        const monto = parseFloat(montoInput.value);
                        const concepto = conceptoInput.value.trim();
                        const categoria = categoriaInput.value;

                        if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                            UIService.showStatus("Ingrese un monto válido mayor a 0", "error");
                            return;
                        }

                        if (!concepto) {
                            UIService.showStatus("Ingrese un concepto para el retiro", "error");
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            await AppState.db.collection("RETIROS").doc(retiroId).update({
                                monto: monto,
                                concepto: concepto,
                                categoria: categoria
                            });

                            UIService.showStatus("Retiro actualizado correctamente", "success");
                            ModalService.closeEditarRetiroModal();
                            await this.loadHistorial();
                        } catch (error) {
                            UIService.showStatus("Error al actualizar retiro: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async processEditarIngreso() {
                        const ingresoId = document.getElementById('edit-ingreso-id').value;
                        const montoInput = document.getElementById('edit-monto-ingreso');
                        const conceptoInput = document.getElementById('edit-concepto-ingreso');
                        const categoriaInput = document.getElementById('edit-categoria-ingreso');

                        const monto = parseFloat(montoInput.value);
                        const concepto = conceptoInput.value.trim();
                        const categoria = categoriaInput.value;

                        if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                            UIService.showStatus("Ingrese un monto válido mayor a 0", "error");
                            return;
                        }

                        if (!concepto) {
                            UIService.showStatus("Ingrese un concepto para el ingreso", "error");
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            await AppState.db.collection("INGRESOS").doc(ingresoId).update({
                                monto: monto,
                                concepto: concepto,
                                categoria: categoria
                            });

                            UIService.showStatus("Ingreso actualizado correctamente", "success");
                            ModalService.closeEditarIngresoModal();
                            await this.loadHistorial();
                        } catch (error) {
                            UIService.showStatus("Error al actualizar ingreso: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async cancelInvoice(invoiceId) {
                        if (!confirm("¿Está seguro de cancelar esta factura? Se cambiará el estado a CONTADO.")) return;

                        try {
                            UIService.showLoading(true);
                            await DataService.cancelInvoice(invoiceId);
                            UIService.showStatus("Factura cancelada correctamente", "success");
                            await this.loadHistorial();
                        } catch (error) {
                            UIService.showStatus("Error al cancelar factura: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async reprintInvoice(invoiceId) {
                        let venta;
                        try {
                            venta = await DataService.getSaleById(invoiceId);
                        } catch (error) {
                            venta = AppState.historial.find(v => v.id === invoiceId && v.tipo === 'venta');
                        }

                        if (venta) {
                            this.printTicket(venta);
                            UIService.showStatus("Ticket reimpreso", "success");
                        }
                    },

                    async registrarAbono(invoiceId) {
                        let venta;
                        try {
                            venta = await DataService.getSaleById(invoiceId);
                        } catch (error) {
                            venta = AppState.historial.find(v => v.id === invoiceId && v.tipo === 'venta');
                        }

                        if (!venta) return;

                        AppState.currentAbonoInvoice = venta;

                        const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;

                        const modalContent = `
                    <div class="invoice-details">
                        <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                        <strong>Grupo:</strong> ${venta.clientName}<br>
                        <strong>Total:</strong> $${venta.total.toFixed(2)}<br>
                        <strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}
                    </div>
                `;

                        UIService.showAbonoModal(modalContent);
                    },

                    async processAbono() {
                        const montoInput = document.getElementById('monto-abono');
                        const monto = parseFloat(montoInput.value);

                        // CORRECCIÓN 9: Validación mejorada de montos
                        if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                            UIService.showStatus("Ingrese un monto válido mayor a 0", "error");
                            return;
                        }

                        // Validar formato decimal
                        if (!/^\d+(\.\d{1,2})?$/.test(montoInput.value)) {
                            UIService.showStatus("El monto debe tener máximo 2 decimales", "error");
                            return;
                        }

                        const venta = AppState.currentAbonoInvoice;
                        if (!venta) {
                            UIService.showStatus("No hay factura seleccionada para el abono", "error");
                            return;
                        }

                        const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;

                        if (monto > saldoPendiente) {
                            UIService.showStatus("El monto del abono no puede ser mayor al saldo pendiente", "error");
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            const abonoData = {
                                monto: monto,
                                fecha: DateUtils.getCurrentTimestampElSalvador(),
                                fechaString: DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES')
                            };

                            await DataService.addAbono(venta.id, abonoData);

                            this.printAbonoTicket(venta, abonoData, saldoPendiente - monto);

                            UIService.showStatus(`Abono de $${monto.toFixed(2)} registrado correctamente`, "success");

                            ModalService.closeAbonoModal();

                            // Recargar historial completo para mostrar el nuevo abono
                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar abono: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async deleteAbono(abonoId, invoiceId) {
                        if (!confirm("¿Está seguro de eliminar este abono? El saldo de la factura aumentará.")) return;

                        try {
                            UIService.showLoading(true);
                            await DataService.deleteAbono(abonoId, invoiceId);
                            UIService.showStatus("Abono eliminado correctamente", "success");
                            await this.loadHistorial();
                        } catch (error) {
                            UIService.showStatus("Error al eliminar abono: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async processRetiro() {
                        const montoInput = document.getElementById('monto-retiro');
                        const conceptoInput = document.getElementById('concepto-retiro');
                        const categoriaInput = document.getElementById('categoria-retiro');

                        const monto = parseFloat(montoInput.value);
                        const concepto = conceptoInput.value.trim();
                        const categoria = categoriaInput.value;

                        // CORRECCIÓN 9: Validación mejorada de montos
                        if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                            UIService.showStatus("Ingrese un monto válido mayor a 0", "error");
                            return;
                        }

                        // Validar formato decimal
                        if (!/^\d+(\.\d{1,2})?$/.test(montoInput.value)) {
                            UIService.showStatus("El monto debe tener máximo 2 decimales", "error");
                            return;
                        }

                        if (!concepto) {
                            UIService.showStatus("Ingrese un concepto para el retiro", "error");
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            const retiroData = {
                                monto: monto,
                                concepto: concepto,
                                categoria: categoria,
                                timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                date: DateUtils.getCurrentDateStringElSalvador()
                            };

                            await DataService.saveRetiro(retiroData);

                            this.printRetiroTicket(retiroData);

                            UIService.showStatus(`Retiro de $${monto.toFixed(2)} registrado correctamente`, "success");

                            ModalService.closeRetiroModal();

                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar retiro: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async processIngreso() {
                        const montoInput = document.getElementById('monto-ingreso');
                        const conceptoInput = document.getElementById('concepto-ingreso');
                        const categoriaInput = document.getElementById('categoria-ingreso');

                        const monto = parseFloat(montoInput.value);
                        const concepto = conceptoInput.value.trim();
                        const categoria = categoriaInput.value;

                        if (!monto || monto <= 0 || isNaN(monto) || !isFinite(monto)) {
                            UIService.showStatus("Ingrese un monto válido mayor a 0", "error");
                            return;
                        }

                        if (!/^\d+(\.\d{1,2})?$/.test(montoInput.value)) {
                            UIService.showStatus("El monto debe tener máximo 2 decimales", "error");
                            return;
                        }

                        if (!concepto) {
                            UIService.showStatus("Ingrese un concepto para el ingreso", "error");
                            return;
                        }

                        try {
                            UIService.showLoading(true);
                            const ingresoData = {
                                monto: monto,
                                concepto: concepto,
                                categoria: categoria,
                                timestamp: DateUtils.getCurrentTimestampElSalvador(),
                                date: DateUtils.getCurrentDateStringElSalvador()
                            };

                            await DataService.saveIngreso(ingresoData);

                            UIService.showStatus(`Ingreso de $${monto.toFixed(2)} registrado correctamente`, "success");

                            UIService.closeIngresoModal();

                            await this.loadHistorial();

                        } catch (error) {
                            UIService.showStatus("Error al procesar ingreso: " + error.message, "error");
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async processGroupAbono(grupoId, montoTotal) {
                        try {
                            UIService.showLoading(true);
                            const facturasAfectadas = await DataService.processGroupAbono(grupoId, montoTotal);

                            // Recargar datos
                            await this.loadHistorial();

                            return facturasAfectadas;
                        } catch (error) {
                            console.error("Error en processGroupAbono:", error);
                            throw error;
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async processMultiAbono(facturasIds, montoTotal) {
                        try {
                            UIService.showLoading(true);
                            const facturasAfectadas = await DataService.processMultiAbono(facturasIds, montoTotal);

                            // Recargar datos
                            await this.loadHistorial();

                            return facturasAfectadas;
                        } catch (error) {
                            console.error("Error en processMultiAbono:", error);
                            throw error;
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    async printCurrentHistorial() {
                        const movimientos = AppState.filteredHistorial;

                        if (movimientos.length === 0) {
                            UIService.showStatus("No hay movimientos para imprimir", "warning");
                            return;
                        }

                        this.printHistorialReport(movimientos, 'HISTORIAL ACTUAL');
                    },

                    printHistorialReport(movimientos, titulo) {
                        const printWindow = window.open('', '_blank');

                        let totalContado = 0;
                        let totalPendiente = 0;
                        let totalAbonos = 0;
                        let totalRetiros = 0;
                        let totalIngresos = 0;
                        let ventasContado = 0;
                        let ventasPendiente = 0;
                        let ventasConAbonos = 0;
                        let cantidadRetiros = 0;
                        let cantidadIngresos = 0;
                        let cantidadAbonos = 0;

                        movimientos.forEach(movimiento => {
                            if (movimiento.tipo === 'retiro') {
                                totalRetiros += movimiento.monto || 0;
                                cantidadRetiros++;
                            } else if (movimiento.tipo === 'ingreso') {
                                totalIngresos += movimiento.monto || 0;
                                cantidadIngresos++;
                            } else if (movimiento.tipo === 'abono') {
                                totalAbonos += movimiento.monto || 0;
                                cantidadAbonos++;
                            } else if (movimiento.tipo === 'venta') {
                                if (movimiento.paymentType === 'contado') {
                                    totalContado += movimiento.total || 0;
                                    ventasContado++;
                                } else {
                                    totalPendiente += movimiento.total || 0;
                                    ventasPendiente++;

                                    if (movimiento.abonos && movimiento.abonos.length > 0) {
                                        ventasConAbonos++;
                                        movimiento.abonos.forEach(abono => {
                                            totalAbonos += abono.monto;
                                        });
                                    }
                                }
                            }
                        });

                        const fechaActual = DateUtils.getCurrentTimestampElSalvador().toLocaleDateString('es-ES');

                        let reportHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${titulo}</title>
                        <style>
                            body { 
                                font-family: 'Arial', sans-serif; 
                                font-size: 12px; 
                                margin: 0;
                                padding: 15px;
                                color: #000;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 20px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 10px;
                            }
                            .header h1 {
                                font-size: 24px;
                                margin: 10px 0;
                                color: #2c3e50;
                            }
                            .header h2 {
                                font-size: 18px;
                                margin: 8px 0;
                                color: #34495e;
                            }
                            .header h3 {
                                font-size: 14px;
                                margin: 5px 0;
                                color: #7f8c8d;
                            }
                            .table-container {
                                width: 100%;
                                margin-bottom: 20px;
                            }
                            .ventas-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 15px 0;
                                font-size: 11px;
                            }
                            .ventas-table th {
                                background: #2c3e50;
                                color: white;
                                padding: 10px 8px;
                                text-align: left;
                                font-weight: bold;
                                border: 1px solid #34495e;
                            }
                            .ventas-table td {
                                padding: 8px;
                                border: 1px solid #ddd;
                                vertical-align: top;
                            }
                            .ventas-table tr:nth-child(even) {
                                background: #f8f9fa;
                            }
                            .producto-item {
                                padding: 2px 0;
                                font-size: 10px;
                            }
                            .contado-badge {
                                background: #27ae60;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .pendiente-badge {
                                background: #f39c12;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .retiro-badge {
                                background: #e74c3c;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .ingreso-badge {
                                background: #27ae60;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .abono-badge {
                                background: #2ecc71;
                                color: white;
                                padding: 3px 6px;
                                border-radius: 3px;
                                font-size: 9px;
                                font-weight: bold;
                            }
                            .resumen-section {
                                margin-top: 25px;
                                padding: 15px;
                                background: #e8f4fd;
                                border-radius: 8px;
                                border: 1px solid #b8daff;
                            }
                            .resumen-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr 1fr 1fr;
                                gap: 15px;
                                margin-top: 10px;
                            }
                            .resumen-item {
                                text-align: center;
                                padding: 10px;
                                background: white;
                                border-radius: 6px;
                                border: 1px solid #dee2e6;
                            }
                            .resumen-valor {
                                font-size: 18px;
                                font-weight: bold;
                                color: #2c3e50;
                                margin-top: 5px;
                            }
                            .page-break {
                                page-break-before: always;
                            }
                            @page {
                                size: A4 portrait;
                                margin: 1.5cm 1cm;
                            }
                            .footer {
                                text-align: center;
                                margin-top: 20px;
                                padding-top: 10px;
                                border-top: 1px solid #ddd;
                                font-size: 10px;
                                color: #7f8c8d;
                            }
                            .movimiento-card {
                                margin-bottom: 15px;
                                border: 1px solid #ddd;
                                border-radius: 6px;
                                overflow: hidden;
                                page-break-inside: avoid;
                            }
                            .movimiento-header {
                                background: #f8f9fa;
                                padding: 10px 12px;
                                border-bottom: 1px solid #ddd;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .productos-table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 10px;
                            }
                            .productos-table th {
                                background: #ecf0f1;
                                padding: 6px 8px;
                                text-align: left;
                                font-weight: bold;
                                border-bottom: 2px solid #bdc3c7;
                            }
                            .productos-table td {
                                padding: 5px 8px;
                                border-bottom: 1px solid #ecf0f1;
                            }
                            .productos-table tr:last-child td {
                                border-bottom: none;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>TALLER WILIAN</h1>
                            <h2>HISTORIAL DE MOVIMIENTOS ${fechaActual}</h2>
                        </div>
                `;

                        movimientos.forEach((movimiento) => {
                            const fecha = movimiento.timestamp ? new Date(movimiento.timestamp.toDate ? movimiento.timestamp.toDate() : movimiento.timestamp).toLocaleString('es-ES') : 'N/A';

                            if (movimiento.tipo === 'retiro') {
                                const tipoBadge = 'retiro-badge';
                                const tipoText = 'RETIRO';
                                const color = '#e74c3c';

                                reportHTML += `
                            <div class="movimiento-card" style="border-left: 4px solid ${color};">
                                <div class="movimiento-header" style="background: white;">
                                    <div>
                                        <strong>${tipoText}</strong> - ${movimiento.concepto || 'Sin concepto'}
                                        <br><span style="font-size: 9px; color: #666;">${fecha}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: bold; color: ${color};">
                                            -$${movimiento.monto.toFixed(2)}
                                        </div>
                                        <span class="${tipoBadge}">${tipoText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            } else if (movimiento.tipo === 'ingreso') {
                                const tipoBadge = 'ingreso-badge';
                                const tipoText = 'INGRESO';
                                const color = '#27ae60';

                                reportHTML += `
                            <div class="movimiento-card" style="border-left: 4px solid ${color};">
                                <div class="movimiento-header" style="background: white;">
                                    <div>
                                        <strong>${tipoText}</strong> - ${movimiento.concepto || 'Sin concepto'}
                                        <br><span style="font-size: 9px; color: #666;">${fecha}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: bold; color: ${color};">
                                            +$${movimiento.monto.toFixed(2)}
                                        </div>
                                        <span class="${tipoBadge}">${tipoText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            } else if (movimiento.tipo === 'abono') {
                                const tipoBadge = 'abono-badge';
                                const tipoText = 'ABONO';
                                const color = '#2ecc71';

                                reportHTML += `
                            <div class="movimiento-card" style="border-left: 4px solid ${color};">
                                <div class="movimiento-header" style="background: white;">
                                    <div>
                                        <strong>${tipoText}</strong> - ${movimiento.concepto || 'Abono a cuenta'}
                                        <br><span style="font-size: 9px; color: #666;">${fecha}</span>
                                        <br><span style="font-size: 10px;">Cliente: ${movimiento.clientName || 'General'} (Eq: ${movimiento.equipoNumber || '-'})</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: bold; color: ${color};">
                                            +$${(movimiento.monto || 0).toFixed(2)}
                                        </div>
                                        <span class="${tipoBadge}">${tipoText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            } else if (movimiento.tipo === 'venta') {
                                const venta = movimiento;
                                const tipoBadge = venta.paymentType === 'contado' ? 'contado-badge' : 'pendiente-badge';
                                const tipoText = venta.paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE';

                                let productosRows = '';
                                if (venta.products && venta.products.length > 0) {
                                    venta.products.forEach(producto => {
                                        productosRows += `
                                    <tr>
                                        <td width="10%" style="text-align: center;">${producto.cantidad}</td>
                                        <td width="50%">${producto.descripcion}</td>
                                        <td width="20%" style="text-align: right;">$${producto.precio.toFixed(2)}</td>
                                        <td width="20%" style="text-align: right;">$${(producto.precio * producto.cantidad).toFixed(2)}</td>
                                    </tr>
                                `;
                                    });
                                } else {
                                    productosRows = '<tr><td colspan="4" style="text-align: center; color: #999;">Sin productos registrados</td></tr>';
                                }

                                reportHTML += `
                            <div class="movimiento-card">
                                <div class="movimiento-header">
                                    <div>
                                        <strong>Factura #${venta.invoiceNumber || 'N/A'}</strong> - Equipo: ${venta.equipoNumber || 'N/A'}
                                        <br><span style="font-size: 9px; color: #666;">${fecha} - ${venta.clientName || 'Cliente'}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: bold;">$${(venta.total || 0).toFixed(2)}</div>
                                        <span class="${tipoBadge}">${tipoText}</span>
                                    </div>
                                </div>
                                <div style="padding: 5px 10px;">
                                    <table class="productos-table">
                                        <thead>
                                            <tr>
                                                <th width="10%" style="text-align: center;">Cant.</th>
                                                <th width="50%">Descripción</th>
                                                <th width="20%">Precio</th>
                                                <th width="20%" style="text-align: right;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${productosRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                            }
                        });

                        let abonosHTML = '';
                        const ventasConAbonosList = movimientos.filter(mov =>
                            mov.tipo === 'venta' && mov.abonos && mov.abonos.length > 0
                        );

                        if (ventasConAbonosList.length > 0) {
                            abonosHTML += `
                        <div class="page-break"></div>
                        <div class="header">
                            <h2>HISTORIAL DE ABONOS ${fechaActual}</h2>
                        </div>
                        <div class="table-container">
                            <table class="ventas-table">
                                <thead>
                                    <tr>
                                        <th width="15%">Fecha</th>
                                        <th width="10%">Equipo</th>
                                        <th width="15%">Total</th>
                                        <th width="15%">Abono</th>
                                        <th width="15%">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                            ventasConAbonosList.forEach(venta => {
                                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                                const totalAbonado = venta.abonos.reduce((sum, abono) => sum + abono.monto, 0);

                                abonosHTML += `
                            <tr>
                                <td>${new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES')}</td>
                                <td>${venta.equipoNumber || 'N/A'}</td>
                                <td>$${venta.total.toFixed(2)}</td>
                                <td>$${totalAbonado.toFixed(2)}</td>
                                <td>$${saldoPendiente.toFixed(2)}</td>
                            </tr>
                        `;
                            });

                            abonosHTML += `</tbody></table></div>`;
                        }

                        reportHTML += abonosHTML;

                        const flujoNeto = totalContado + totalAbonos + totalIngresos - totalRetiros;
                        reportHTML += `
                    <div class="resumen-section">
                        <h3 style="margin: 0 0 15px 0; text-align: center; color: #2c3e50;">RESUMEN</h3>
                        <div class="resumen-grid">
                            <div class="resumen-item">
                                <div>VENTAS AL CONTADO</div>
                                <div class="resumen-valor">$${totalContado.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${ventasContado} ventas</div>
                            </div>
                            <div class="resumen-item">
                                <div>TOTAL ABONOS</div>
                                <div class="resumen-valor" style="color: #2ecc71;">$${totalAbonos.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${cantidadAbonos + ventasConAbonos} transacciones</div>
                            </div>
                            <div class="resumen-item">
                                <div>INGRESOS</div>
                                <div class="resumen-valor" style="color: #27ae60;">+$${totalIngresos.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${cantidadIngresos} ingresos</div>
                            </div>
                            <div class="resumen-item">
                                <div>RETIROS</div>
                                <div class="resumen-valor" style="color: #e74c3c;">-$${totalRetiros.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #666;">${cantidadRetiros} retiros</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #2c3e50; color: white; border-radius: 6px; text-align: center;">
                            <div style="font-size: 14px; margin-bottom: 5px;">FLUJO NETO DE CAJA</div>
                            <div style="font-size: 24px; font-weight: bold;">${flujoNeto >= 0 ? '+' : ''}$${flujoNeto.toFixed(2)}</div>
                            <div style="font-size: 11px; margin-top: 5px; opacity: 0.8;">Ventas + Abonos + Ingresos - Retiros</div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div>Documento generado automáticamente por el Sistema de Ventas Taller Wilian</div>
                        <div>Fecha de impresión: ${DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES')}</div>
                    </div>
                `;

                        reportHTML += `</body></html>`;

                        printWindow.document.open();
                        printWindow.document.write(reportHTML);
                        printWindow.document.close();

                        printWindow.focus();

                        printWindow.onload = function () {
                            setTimeout(() => {
                                printWindow.print();
                                UIService.showStatus("Historial enviado a impresión", "success");
                            }, 500);
                        };

                        if (printWindow.document.readyState === 'complete') {
                            printWindow.onload();
                        }
                    },

                    printTicket(saleData) {
                        const printWindow = window.open('', '_blank', 'width=300,height=600');
                        const fecha = saleData.timestamp ? new Date(saleData.timestamp.toDate ? saleData.timestamp.toDate() : saleData.timestamp) : DateUtils.getCurrentTimestampElSalvador();
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });

                        const saldoPendiente = saleData.saldoPendiente !== undefined ? saleData.saldoPendiente : saleData.total;
                        const tieneAbonos = saleData.abonos && saleData.abonos.length > 0;
                        const tipoPago = saleData.paymentType === 'pendiente' ? 'PENDIENTE' : 'CONTADO';

                        let abonosHTML = '';
                        if (tieneAbonos) {
                            saleData.abonos.forEach(abono => {
                                const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
                                abonosHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 20px; margin: 2px 0;">
                                <div>ABONO: $${abono.monto.toFixed(2)} (${fechaAbono})</div>
                            </div>
                        `;
                            });
                        }

                        let productosHTML = '';
                        if (saleData.products && saleData.products.length > 0) {
                            saleData.products.forEach(producto => {
                                const descripcion = producto.descripcion.length > 25 ? producto.descripcion.substring(0, 25) + '...' : producto.descripcion;
                                productosHTML += `
                            <div style="margin: 4px 0;">
                                <div style="font-size: 16px;">• ${descripcion}</div>
                                <div style="display: flex; justify-content: space-between; font-size: 18px;">
                                    <div>x${producto.cantidad}</div>
                                    <div>$${(producto.precio * producto.cantidad).toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="border-bottom: 1px dotted #000; margin: 2px 0;"></div>
                        `;
                            });
                        }

                        const contenido = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Ticket #${saleData.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .equipo-text { font-size: 32px; font-weight: 900; margin: 5px 0; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILLIAN</h3>
                            <div class="small-text">Factura: ${saleData.invoiceNumber}</div>
                            <div class="small-text">${fechaFormateada}, ${tipoPago}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        ${saleData.clientName !== saleData.equipoNumber ? `
                            <div class="medium-text">
                                <strong>Grupo:</strong> ${saleData.clientName}
                            </div>
                        ` : ''}
                        <div class="equipo-text" style="text-align: center;">
                            ${saleData.equipoNumber}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 8px 0;">
                            ${productosHTML}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total large-text">
                            TOTAL: $${saleData.total.toFixed(2)}
                        </div>

                        ${abonosHTML}

                        ${tieneAbonos && saldoPendiente > 0 ? `
                            <div class="saldo-info">
                                <div>SALDO PENDIENTE:</div>
                                <div class="large-text">$${saldoPendiente.toFixed(2)}</div>
                            </div>
                        ` : ''}
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                        `;

                        printWindow.document.open();
                        printWindow.document.write(contenido);
                        printWindow.document.close();
                        printWindow.focus();

                        printWindow.onload = function () {
                            setTimeout(() => {
                                printWindow.print();
                                printWindow.onafterprint = function () {
                                    printWindow.close(); // Cerrar solo después de imprimir
                                };
                            }, 500);
                        };

                        // Fallback
                        if (printWindow.document.readyState === 'complete') {
                            printWindow.onload();
                        }
                    },

                    printAbonoTicket(venta, abonoData, nuevoSaldo) {
                        const printWindow = window.open('', '_blank', 'width=300,height=600');
                        const fechaAbono = abonoData.fecha ? new Date(abonoData.fecha.toDate ? abonoData.fecha.toDate() : abonoData.fecha) : DateUtils.getCurrentTimestampElSalvador();
                        const fechaFormateada = fechaAbono.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });

                        printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Abono #${venta.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .abono-detail { 
                                margin: 8px 0;
                                font-size: 20px;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .equipo-text { font-size: 32px; font-weight: 900; margin: 5px 0; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILLIAN</h3>
                            <div class="small-text">COMPROBANTE DE ABONO</div>
                            <div class="small-text">${fechaFormateada}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                            ${venta.clientName !== venta.equipoNumber ? `<strong>Grupo:</strong> ${venta.clientName}` : ''}
                        </div>
                        <div class="equipo-text" style="text-align: center;">
                            ${venta.equipoNumber}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="abono-detail">
                            <div style="text-align: center; font-size: 24px; margin: 10px 0;">
                                MONTO DEL ABONO
                            </div>
                            <div style="text-align: center; font-size: 28px; font-weight: bold;">
                                $${abonoData.monto.toFixed(2)}
                            </div>
                        </div>

                        <div class="saldo-info">
                            <div>SALDO ANTERIOR: $${(venta.saldoPendiente || venta.total).toFixed(2)}</div>
                            <div>NUEVO SALDO: $${nuevoSaldo.toFixed(2)}</div>
                        </div>
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                        `);

                        printWindow.document.close();
                        printWindow.focus();

                        printWindow.onload = function () {
                            setTimeout(() => {
                                printWindow.print();
                                printWindow.onafterprint = function () {
                                    printWindow.close();
                                };
                            }, 500);
                        };

                        if (printWindow.document.readyState === 'complete') {
                            printWindow.onload();
                        }
                    },

                    printRetiroTicket(retiroData) {
                        const printWindow = window.open('', '_blank', 'width=300,height=600');
                        const fecha = retiroData.timestamp ? new Date(retiroData.timestamp.toDate ? retiroData.timestamp.toDate() : retiroData.timestamp) : DateUtils.getCurrentTimestampElSalvador();
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });

                        const categoriaText = {
                            'compra': 'Compra de materiales',
                            'gastos': 'Gastos operativos',
                            'herramientas': 'Herramientas',
                            'otros': 'Otros'
                        }[retiroData.categoria] || retiroData.categoria;

                        printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Retiro de Fondos</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .retiro-detail { 
                                margin: 8px 0;
                                font-size: 20px;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILLIAN</h3>
                            <div class="small-text">COMPROBANTE DE RETIRO</div>
                            <div class="small-text">${fechaFormateada}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Concepto:</strong><br>
                            ${retiroData.concepto || 'Sin descripción'}
                        </div>
                        
                        <div class="medium-text" style="margin-top: 5px;">
                            <strong>Categoría:</strong> ${categoriaText}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="retiro-detail">
                            <div style="text-align: center; font-size: 24px; margin: 10px 0;">
                                MONTO RETIRADO
                            </div>
                            <div style="text-align: center; font-size: 28px; font-weight: bold;">
                                $${Math.abs(retiroData.monto).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="footer">
                            Firma de Responsable
                            <br><br><br>
                            _____________________
                        </div>
                    </body>
                    </html>
                        `);

                        printWindow.document.close();
                        printWindow.focus();

                        printWindow.onload = function () {
                            setTimeout(() => {
                                printWindow.print();
                                printWindow.onafterprint = function () {
                                    printWindow.close();
                                };
                            }, 500);
                        };

                        if (printWindow.document.readyState === 'complete') {
                            printWindow.onload();
                        }
                    },


                    setTodayDate() {
                        const today = DateUtils.getCurrentDateStringElSalvador();
                        document.getElementById('fecha-venta').value = today;

                        // CORRECCIÓN 4: Mostrar advertencia para fechas futuras
                        const fechaInput = document.getElementById('fecha-venta');
                        if (DateUtils.isFutureDateInElSalvador(today)) {
                            fechaInput.classList.add('date-warning');
                        } else {
                            fechaInput.classList.remove('date-warning');
                        }
                    }
                };

                const App = {
                    async init() {
                        try {
                            await this.initializeFirebase();
                            this.setupUI();
                            await this.loadInitialData();
                            this.setupEventListeners();
                            ConnectionManager.initialize();
                            UIService.showStatus("Sistema optimizado inicializado correctamente", "success");
                        } catch (error) {
                            console.error("Error en inicialización:", error);
                            UIService.showStatus("Error al inicializar: " + error.message, "error");
                        }
                    },

                    async initializeFirebase() {
                        try {
                            if (firebase.apps.length === 0) {
                                firebase.initializeApp(CONFIG.firebase);
                            }
                            AppState.db = firebase.firestore();

                            // CORRECCIÓN 3: Mejor manejo de persistencia offline
                            try {
                                await ErrorHandler.withTimeout(
                                    AppState.db.enablePersistence()
                                        .catch((err) => {
                                            if (err.code == 'failed-precondition') {
                                                console.log("Persistencia offline no disponible - Múltiples pestañas abiertas");
                                            } else if (err.code == 'unimplemented') {
                                                console.log("Persistencia offline no disponible - Navegador no compatible");
                                            } else {
                                                console.log("Persistencia offline configurada");
                                            }
                                        }),
                                    5000,
                                    "Inicialización de Firebase"
                                );
                            } catch (persistenceError) {
                                console.warn("La persistencia no pudo activarse, pero continuamos en línea:", persistenceError);
                                // No lanzamos error, permitimos que continúe
                            }

                            AppState.firebaseInitialized = true;
                        } catch (error) {
                            console.error("Error inicializando Firebase:", error);
                            AppState.firebaseInitialized = false;
                            UIService.showStatus("Modo offline activado - Error crítico", "warning");
                        }
                    },

                    setupUI() {
                        SalesService.setTodayDate();
                        UIService.setupTabs();
                    },

                    async loadInitialData() {
                        try {
                            UIService.showLoading(true);
                            await ProductCache.initialize();
                            AppState.saleCounter = await DataService.getSaleCounter();
                            await SalesService.loadHistorial();
                            await GrupoManager.initialize();
                        } catch (error) {
                            console.error("Error cargando datos iniciales:", error);
                        } finally {
                            UIService.showLoading(false);
                        }
                    },

                    setupEventListeners() {
                        document.addEventListener('click', (e) => {
                            if (!e.target.closest('.search-container')) {
                                document.getElementById('search-dropdown').style.display = 'none';
                            }
                        });

                        const searchInput = document.getElementById('buscar-producto');
                        let searchTimeout;

                        searchInput.addEventListener('input', (e) => {
                            clearTimeout(searchTimeout);
                            const query = e.target.value.trim();

                            if (query.length < 2) {
                                document.getElementById('search-dropdown').style.display = 'none';
                                return;
                            }

                            searchTimeout = setTimeout(async () => {
                                try {
                                    AppState.searchResults = await DataService.searchProducts(query);
                                    UIService.showSearchResults(AppState.searchResults);
                                } catch (error) {
                                    document.getElementById('search-dropdown').style.display = 'none';
                                }
                            }, 500);
                        });

                        searchInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const query = searchInput.value.trim();
                                if (query) {
                                    SalesService.addManualProduct(query);
                                    searchInput.value = '';
                                }
                                document.getElementById('search-dropdown').style.display = 'none';
                            }
                        });

                        document.getElementById('equipo').addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/[^0-9]/g, '');
                            if (e.target.value.length > 4) {
                                e.target.value = e.target.value.substring(0, 4);
                            }
                        });

                        document.getElementById('fecha-venta').addEventListener('change', function () {
                            SalesService.setTodayDate();
                        });

                        document.getElementById('contado-btn').addEventListener('click', () => {
                            SalesService.processSale('contado');
                        });

                        document.getElementById('pendiente-btn').addEventListener('click', () => {
                            SalesService.processSale('pendiente');
                        });

                        document.getElementById('print-historial-btn').addEventListener('click', () => {
                            SalesService.printCurrentHistorial();
                        });

                        document.getElementById('filter-historial').addEventListener('input', (e) => {
                            const filter = e.target.value;
                            if (filter === '') {
                                UIService.applyCurrentFilter();
                                return;
                            }

                            const filtered = AppState.historial.filter(movimiento => {
                                if (movimiento.tipo === 'venta') {
                                    const equipo = movimiento.equipoNumber || '';
                                    return equipo.includes(filter);
                                }
                                return false;
                            });

                            const historialBody = document.getElementById('historial-body');

                            if (filtered.length === 0) {
                                historialBody.innerHTML = `
                    < tr >
                    <td colspan="6" class="empty-cart">No hay movimientos para el equipo ${filter}</td>
                            </tr >
                    `;
                            } else {
                                AppState.filteredHistorial = filtered;
                                UIService.renderHistorial();
                            }
                        });

                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                AppState.currentFilter = e.target.dataset.filter;
                                UIService.updateFilterButtons();
                                UIService.applyCurrentFilter();
                            });
                        });

                        document.getElementById('close-invoice-modal').addEventListener('click', () => {
                            ModalService.closeInvoiceModal();
                        });

                        document.getElementById('process-abono-btn').addEventListener('click', () => {
                            SalesService.processAbono();
                        });

                        document.getElementById('close-abono-modal').addEventListener('click', () => {
                            ModalService.closeAbonoModal();
                        });

                        document.getElementById('close-retiro-modal').addEventListener('click', () => {
                            ModalService.closeRetiroModal();
                        });

                        document.getElementById('process-retiro-btn').addEventListener('click', () => {
                            SalesService.processRetiro();
                        });

                        document.getElementById('process-ingreso-btn').addEventListener('click', () => {
                            SalesService.processIngreso();
                        });

                        document.getElementById('close-ingreso-modal').addEventListener('click', () => {
                            UIService.closeIngresoModal();
                        });

                        document.getElementById('close-detalle-modal').addEventListener('click', () => {
                            ModalService.closeDetalleModal();
                        });

                        document.getElementById('imprimir-detalle-modal').addEventListener('click', () => {
                            const detalle = AppState.currentDetalle;
                            if (detalle && detalle.tipo === 'equipo') {
                                const equipo = GrupoManager.equiposPendientes.get(detalle.data);
                                if (equipo) {
                                    equipo.facturas.forEach(factura => {
                                        GrupoManager.imprimirTicketFactura(factura, equipo);
                                    });
                                }
                            }
                        });

                        document.getElementById('close-grupo-detalle-modal').addEventListener('click', () => {
                            ModalService.closeGrupoDetalleModal();
                        });

                        document.getElementById('imprimir-grupo-detalle-modal').addEventListener('click', () => {
                            GrupoManager.imprimirGrupoCompleto();
                        });

                        document.getElementById('crear-grupo-btn').addEventListener('click', () => {
                            document.getElementById('crear-grupo-modal').style.display = 'block';
                            AppState.equiposSeleccionados.clear();
                            GrupoManager.generarGridEquipos('crear');
                            GrupoManager.actualizarListaSeleccionados('crear');
                            document.getElementById('nombre-grupo').value = '';
                        });

                        document.getElementById('guardar-grupo-btn').addEventListener('click', async () => {
                            const nombre = document.getElementById('nombre-grupo').value.trim();
                            if (!nombre) {
                                UIService.showStatus("Ingrese un nombre para el grupo", "error");
                                return;
                            }

                            if (AppState.equiposSeleccionados.size === 0) {
                                UIService.showStatus("Seleccione al menos un equipo", "error");
                                return;
                            }

                            try {
                                UIService.showLoading(true);
                                const equiposArray = Array.from(AppState.equiposSeleccionados);
                                await GrupoManager.crearGrupo(nombre, equiposArray);
                                UIService.showStatus(`Grupo "${nombre}" creado correctamente`, "success");
                                ModalService.closeCrearGrupoModal();
                            } catch (error) {
                                UIService.showStatus("Error al crear grupo: " + error.message, "error");
                            } finally {
                                UIService.showLoading(false);
                            }
                        });

                        document.getElementById('cancelar-grupo-btn').addEventListener('click', () => {
                            ModalService.closeCrearGrupoModal();
                        });

                        document.getElementById('actualizar-grupo-btn').addEventListener('click', () => {
                            GrupoManager.actualizarGrupoDesdeModal();
                        });

                        document.getElementById('cancelar-editar-grupo-btn').addEventListener('click', () => {
                            ModalService.closeEditarGrupoModal();
                        });

                        // Event listeners para los nuevos modales de abono inicial
                        document.getElementById('confirmar-con-abono-btn').addEventListener('click', (e) => {
                            if (e.target.disabled) return;
                            e.target.disabled = true;
                            const datos = AppState.datosVentaPendiente;
                            if (datos) {
                                document.getElementById('confirmacion-abono-modal').style.display = 'none';
                                SalesService.mostrarModalAbonoInicial(datos.equipo, datos.cliente, datos.totalVenta, datos.fechaVenta);
                            }
                            setTimeout(() => e.target.disabled = false, 1000);
                        });

                        document.getElementById('continuar-sin-abono-btn').addEventListener('click', async (e) => {
                            if (e.target.disabled) return;
                            e.target.disabled = true;
                            const datos = AppState.datosVentaPendiente;
                            if (datos) {
                                document.getElementById('confirmacion-abono-modal').style.display = 'none';
                                try {
                                    await SalesService.procesarVentaPendienteSinAbono(datos.equipo, datos.cliente, datos.fechaVenta, datos.totalVenta);
                                } finally {
                                    e.target.disabled = false;
                                }
                            } else {
                                e.target.disabled = false;
                            }
                        });

                        document.getElementById('cancelar-confirmacion-btn').addEventListener('click', () => {
                            ModalService.closeConfirmacionAbonoModal();
                        });

                        // Event listener para el campo de monto de abono inicial
                        document.getElementById('monto-abono-inicial').addEventListener('input', (e) => {
                            const montoAbono = parseFloat(e.target.value) || 0;
                            const totalVenta = AppState.datosVentaPendiente?.totalVenta || 0;
                            const saldoDespues = totalVenta - montoAbono;

                            document.getElementById('saldo-despues-abono').textContent = '$' + Math.max(0, saldoDespues).toFixed(2);

                            // Validar que el abono no sea mayor al total
                            if (montoAbono > totalVenta) {
                                e.target.classList.add('price-warning');
                            } else {
                                e.target.classList.remove('price-warning');
                            }
                        });

                        document.getElementById('procesar-venta-con-abono-btn').addEventListener('click', async (e) => {
                            if (e.target.disabled) return;
                            e.target.disabled = true;
                            const montoAbono = parseFloat(document.getElementById('monto-abono-inicial').value) || 0;
                            const datos = AppState.datosVentaPendiente;

                            if (!datos) {
                                UIService.showStatus("Error: No hay datos de venta disponibles", "error");
                                e.target.disabled = false;
                                return;
                            }

                            if (montoAbono <= 0) {
                                UIService.showStatus("Ingrese un monto de abono válido", "error");
                                e.target.disabled = false;
                                return;
                            }

                            if (montoAbono > datos.totalVenta) {
                                UIService.showStatus("El monto del abono no puede ser mayor al total de la venta", "error");
                                e.target.disabled = false;
                                return;
                            }

                            document.getElementById('abono-inicial-modal').style.display = 'none';
                            try {
                                await SalesService.procesarVentaPendienteConAbono(datos.equipo, datos.cliente, datos.fechaVenta, datos.totalVenta, montoAbono);
                            } finally {
                                e.target.disabled = false;
                            }
                        });

                        document.getElementById('cancelar-abono-inicial-btn').addEventListener('click', () => {
                            ModalService.closeAbonoInicialModal();
                        });

                        // Bulk Abono Modal Listener
                        document.getElementById('close-bulk-abono-modal').addEventListener('click', () => {
                            document.getElementById('bulk-abono-modal').style.display = 'none';
                        });

                        // CORRECCIÓN 8: Cleanup al cerrar la página
                        window.addEventListener('beforeunload', () => {
                            ProductCache.cleanup();
                            if (GrupoManager.unsubscribe) {
                                GrupoManager.unsubscribe();
                            }
                        });

                        document.getElementById('backup-btn').addEventListener('click', async () => {
                            try {
                                UIService.showLoading(true);
                                await DataService.exportBackup();
                                UIService.showStatus("Copia de seguridad descargada correctamente", "success");
                            } catch (error) {
                                UIService.showStatus("Error al crear copia de seguridad: " + error.message, "error");
                            } finally {
                                UIService.showLoading(false);
                            }
                        });

                        document.getElementById('abonar-grupo-btn').addEventListener('click', () => {
                            GrupoManager.showGroupPaymentModalSelector();
                        });
                    }
                };



                document.addEventListener('DOMContentLoaded', function () {
                    App.init();
                });
            </script>
</body>

</html><script src="js/fix_search.js"></script>
