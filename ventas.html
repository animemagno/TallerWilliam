<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas - Taller Wilian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --text-color: #333;
            --bg-color: #f5f7fa;
            --panel-bg: white;
            --border-color: #ddd;
            --header-gradient: linear-gradient(135deg, #3498db, #2c3e50);
        }

        [data-theme="dark"] {
            --primary-color: #1a1a1a;
            --secondary-color: #000000;
            --accent-color: #333333;
            --success-color: #2ecc71;
            --warning-color: #e67e22;
            --danger-color: #c0392b;
            --light-color: #2d2d2d;
            --dark-color: #ecf0f1;
            --text-color: #e0e0e0;
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --border-color: #444444;
            --header-gradient: linear-gradient(135deg, #000000, #333333);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.4;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        header {
            background: var(--header-gradient);
            color: white;
            padding: 10px 0;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        header h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
            margin: 2px;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .panel h2 {
            color: var(--text-color);
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 1.2rem;
        }

        .sales-process-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .sales-form-container, .pending-invoices-container {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
            background: var(--panel-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .client-fields {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 8px;
            margin-bottom: 15px;
            align-items: end;
        }

        .search-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d35400;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead {
            background-color: var(--secondary-color);
            color: white;
        }

        tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .product-item {
            background: var(--light-color);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
        }

        .search-dropdown {
            position: absolute;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 100px);
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
        }

        .search-dropdown-item {
            padding: 6px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .search-dropdown-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .search-dropdown-item:last-child {
            border-bottom: none;
        }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .payment-btn {
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .payment-btn.contado {
            background-color: var(--success-color);
            color: white;
        }

        .payment-btn.contado:hover {
            background-color: #219a52;
        }

        .payment-btn.pendiente {
            background-color: var(--warning-color);
            color: white;
        }

        .payment-btn.pendiente:hover {
            background-color: #d35400;
        }

        .status {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.85rem;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        [data-theme="dark"] .status.success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #90ee90;
            border: 1px solid #2ecc71;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        [data-theme="dark"] .status.error {
            background-color: rgba(192, 57, 43, 0.2);
            color: #ff6b6b;
            border: 1px solid #c0392b;
        }

        .loading {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            color: var(--primary-color);
        }

        .actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .actions button {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .credit-status {
            background: rgba(243, 156, 18, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            border: 1px solid var(--warning-color);
            font-size: 0.8rem;
        }

        [data-theme="dark"] .credit-status {
            background: rgba(230, 126, 34, 0.1);
        }

        .payment-history {
            background: var(--light-color);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .compact-table {
            font-size: 0.75rem;
        }

        .compact-table th, 
        .compact-table td {
            padding: 6px 8px;
        }

        .daily-closure {
            background: rgba(52, 152, 219, 0.1);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--primary-color);
            margin-top: 15px;
        }

        .processing {
            opacity: 0.6;
            pointer-events: none;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 10000;
        }

        .connection-status.online {
            background-color: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background-color: var(--danger-color);
            color: white;
        }

        .pending-equipos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .equipo-card {
            background: var(--light-color);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .equipo-card:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .equipo-card.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--accent-color);
        }

        .equipo-number {
            font-weight: bold;
            font-size: 1rem;
        }

        .equipo-count {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .equipo-invoices {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .equipo-invoices.active {
            display: block;
        }

        .invoice-item {
            background: var(--light-color);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 4px solid var(--warning-color);
            font-size: 0.8rem;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .invoice-number {
            font-weight: bold;
            font-size: 1rem;
        }

        .invoice-total {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .invoice-details {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .invoice-products {
            background: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.75rem;
        }

        .product-detail {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px dotted var(--border-color);
        }

        .product-detail:last-child {
            border-bottom: none;
        }

        .global-summary {
            background: rgba(52, 152, 219, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid var(--primary-color);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .summary-total-global {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
            text-align: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .payment-section {
            background: rgba(39, 174, 96, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            border: 1px solid var(--success-color);
        }

        .summary-total {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success-color);
            text-align: center;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .sales-process-container {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .payment-buttons {
                grid-template-columns: 1fr 1fr;
            }
            
            th, td {
                padding: 6px 8px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .client-fields, .search-container {
                grid-template-columns: 1fr;
            }
            
            .search-dropdown {
                width: 100%;
            }

            .container {
                padding: 5px;
            }

            .panel {
                padding: 10px;
            }

            .connection-status {
                position: relative;
                top: 0;
                right: 0;
                margin: 5px;
            }

            .pending-equipos-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Conectando...</div>
    
    <div class="container">
        <header>
            <button class="theme-toggle" id="theme-toggle">🌙</button>
            <h1>Sistema de Ventas - Taller Wilian</h1>
            <div class="header-info">
                <span>Fecha: <span id="current-date"></span></span>
                <span>Vendedor: <span id="current-user">Usuario</span></span>
            </div>
        </header>

        <div class="status" id="status-message"></div>

        <div class="tabs">
            <div class="tab active" data-tab="sales">Ventas</div>
            <div class="tab" data-tab="credits">Pendientes</div>
            <div class="tab" data-tab="history">Historial</div>
            <div class="tab" data-tab="summary">Resumen</div>
            <div class="tab" data-tab="equipos">Equipos</div>
            <div class="tab" data-tab="cierre">Cierre Diario</div>
        </div>

        <div class="tab-content active" id="sales-tab">
            <div class="sales-process-container">
                <div class="sales-form-container">
                    <h2>Proceso de Venta</h2>
                    
                    <div class="client-fields">
                        <div class="form-group">
                            <label for="equipo-number">N° Equipo</label>
                            <input type="text" id="equipo-number" placeholder="000000" maxlength="6" pattern="[0-9]*">
                        </div>
                        <div class="form-group">
                            <label for="client-name">Cliente/Equipo</label>
                            <input type="text" id="client-name" placeholder="Nombre cliente o equipo">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="search-product">Buscar Producto</label>
                        <div class="search-container">
                            <div style="position: relative;">
                                <input type="text" id="search-product" placeholder="Código o descripción">
                                <div id="search-dropdown" class="search-dropdown" style="display: none;"></div>
                            </div>
                            <button class="btn btn-primary" onclick="addProductFromSearch()" id="add-product-btn">
                                AGREGAR
                            </button>
                        </div>
                    </div>
                    
                    <h3 style="margin: 15px 0 8px 0; color: var(--text-color); font-size: 1rem;">Carrito</h3>
                    
                    <div id="cart-items" style="max-height: 200px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">No hay productos</p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <div class="summary-total" style="font-size: 1.3rem;">
                            Total: <span id="total-amount">$0.00</span>
                        </div>
                        
                        <div class="payment-buttons">
                            <button class="payment-btn contado" onclick="processSale('contado')" id="contado-btn">
                                CONTADO
                            </button>
                            <button class="payment-btn pendiente" onclick="processSale('pendiente')" id="pendiente-btn">
                                PENDIENTE
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pending-invoices-container">
                    <h2>Facturas Pendientes</h2>
                    <p style="font-size: 0.8rem; margin-bottom: 10px; color: var(--text-color);">
                        Seleccione un equipo para ver sus facturas pendientes
                    </p>
                    
                    <div class="pending-equipos-grid" id="pending-equipos-grid">
                        <div class="loading">Cargando equipos...</div>
                    </div>
                    
                    <div id="equipo-invoices-container">
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Ventas del Día</h2>
                <div id="daily-sales">
                    <table class="compact-table">
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Cliente/Equipo</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Tipo</th>
                                <th>Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="daily-sales-body">
                            <tr>
                                <td colspan="7" class="loading">Cargando ventas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-content" id="credits-tab">
            <div class="compact-grid">
                <div class="panel">
                    <h2>Ventas Pendientes</h2>
                    <div id="pending-credits">
                        <table class="compact-table">
                            <thead>
                                <tr>
                                    <th>Cliente/Equipo</th>
                                    <th>Saldo</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="credits-body">
                                <tr>
                                    <td colspan="4" class="loading">Cargando pendientes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel">
                    <h2>Registrar Abono</h2>
                    <div id="payment-form">
                        <div class="form-group">
                            <label for="credit-select">Venta Pendiente</label>
                            <select id="credit-select">
                                <option value="">Seleccione venta</option>
                            </select>
                        </div>
                        
                        <div id="credit-details" style="display: none;">
                            <div class="credit-status">
                                <strong>Cliente:</strong> <span id="detail-client"></span><br>
                                <strong>Saldo:</strong> <span id="detail-balance"></span><br>
                                <strong>Total:</strong> <span id="detail-total"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-amount">Monto Abono</label>
                                <input type="number" id="payment-amount" min="0" step="0.01">
                            </div>
                            
                            <div class="actions" style="margin-top: 12px;">
                                <button class="btn btn-success" onclick="registerPayment()" id="register-payment-btn">Registrar</button>
                                <button class="btn btn-danger" onclick="cancelPendingSale()" id="cancel-sale-btn">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <div class="payment-history" id="payment-history" style="display: none;">
                        <h4 style="margin-bottom: 8px;">Historial de Abonos</h4>
                        <div id="payments-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
            authDomain: "tallerwilliam-732b3.firebaseapp.com",
            projectId: "tallerwilliam-732b3",
            storageBucket: "tallerwilliam-732b3.firebasestorage.app",
            messagingSenderId: "822262666247",
            appId: "1:822262666247:web:6680487bbf1108006b86a2"
        };

        let firebaseInitialized = false;
        let db = null;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            console.log("Firebase inicializado correctamente");
            updateConnectionStatus(true);
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
            showStatus("Error de conexión con la base de datos", "error");
            updateConnectionStatus(false);
        }

        let cart = [];
        let dailySales = [];
        let pendingCredits = [];
        let searchResults = [];
        let selectedCreditId = null;
        let currentTheme = 'light';
        let equiposConPendientes = [];
        let selectedEquipo = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Página cargada correctamente");
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES');
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            loadExampleData();
            
            setupTabs();
            
            document.getElementById('search-product').addEventListener('input', function(e) {
                const searchTerm = this.value.trim();
                if (searchTerm.length >= 2) {
                    searchProducts(searchTerm);
                } else {
                    document.getElementById('search-dropdown').style.display = 'none';
                    searchResults = [];
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('search-dropdown').style.display = 'none';
                }
            });
            
            document.getElementById('equipo-number').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length > 6) {
                    this.value = this.value.substring(0, 6);
                }
            });

            document.getElementById('credit-select').addEventListener('change', function() {
                if (this.value) {
                    showCreditDetails(this.value);
                } else {
                    document.getElementById('credit-details').style.display = 'none';
                    document.getElementById('payment-history').style.display = 'none';
                    selectedCreditId = null;
                }
            });
        });

        function loadExampleData() {
            console.log("Cargando datos de ejemplo...");
            
            dailySales = [
                {
                    id: "1",
                    saleNumber: "F240101001",
                    clientName: "Equipo 123456 - Juan Pérez",
                    equipoNumber: "123456",
                    products: [
                        { description: "Aceite Motor 5W30", code: "001", quantity: 2, price: 25.00 },
                        { description: "Filtro Aire", code: "002", quantity: 1, price: 15.50 }
                    ],
                    total: 65.50,
                    paymentType: "contado",
                    date: new Date(),
                    timestamp: new Date()
                }
            ];
            
            pendingCredits = [
                {
                    id: "1",
                    saleId: "2",
                    saleNumber: "F240101002",
                    clientName: "Equipo 654321 - María García", 
                    equipoNumber: "654321",
                    originalAmount: 80.00,
                    pendingAmount: 80.00,
                    saleDate: new Date(),
                    status: "pendiente",
                    payments: []
                }
            ];
            
            equiposConPendientes = [
                { equipo: "123456", facturasPendientes: 1, totalPendiente: 47.00 },
                { equipo: "654321", facturasPendientes: 1, totalPendiente: 80.00 }
            ];
            
            displayDailySales();
            displayPendingCredits();
            displayEquiposConPendientes();
            updateCreditSelect();
            
            console.log("Datos de ejemplo cargados correctamente");
            showStatus("Sistema cargado", "success");
        }

        async function searchProducts(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) {
                document.getElementById('search-dropdown').style.display = 'none';
                searchResults = [];
                return;
            }

            if (!firebaseInitialized) {
                showStatus("Sin conexión a la base de datos", "error");
                return;
            }

            try {
                const searchLower = searchTerm.toLowerCase();
                const snapshot = await db.collection('INVENTARIO').get();
                
                searchResults = [];
                snapshot.forEach(doc => {
                    const product = doc.data();
                    product.id = doc.id;
                    
                    const codigo = (product.codigo || '').toLowerCase();
                    const descripcion = (product.descripcion || '').toLowerCase();
                    const categoria = (product.categoria || '').toLowerCase();
                    
                    if (codigo.includes(searchLower) || descripcion.includes(searchLower) || categoria.includes(searchLower)) {
                        searchResults.push(product);
                    }
                });

                displaySearchDropdown();
                
            } catch (error) {
                console.error("Error buscando productos:", error);
                showStatus("Error buscando productos: " + error.message, "error");
                document.getElementById('search-dropdown').style.display = 'none';
            }
        }

        function displaySearchDropdown() {
            const dropdown = document.getElementById('search-dropdown');
            
            if (searchResults.length === 0) {
                dropdown.innerHTML = '<div class="search-dropdown-item">No se encontraron productos</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = '';
            searchResults.forEach(product => {
                const item = document.createElement('div');
                item.className = 'search-dropdown-item';
                item.innerHTML = `
                    <strong>${product.descripcion || 'Sin descripción'}</strong>
                    <div style="font-size: 0.7rem; margin-top: 2px;">
                        Cód: ${product.codigo || 'N/A'} | Stock: ${product.cantidad || 0} | $${(product.precio || 0).toFixed(2)}
                    </div>
                `;
                item.onclick = () => {
                    addToCart(product.id);
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function addProductFromSearch() {
            const searchInput = document.getElementById('search-product');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                showStatus("Ingrese un término de búsqueda", "error");
                return;
            }

            if (searchResults.length === 0) {
                showStatus("No hay productos que coincidan con la búsqueda", "error");
                return;
            }

            addToCart(searchResults[0].id);
            searchInput.value = '';
            document.getElementById('search-dropdown').style.display = 'none';
        }

        function addToCart(productId) {
            const product = searchResults.find(p => p.id === productId);
            if (!product) {
                showStatus("Producto no encontrado", "error");
                return;
            }

            const currentStock = product.cantidad || 0;
            if (currentStock <= 0) {
                showStatus("Producto sin stock disponible", "error");
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < currentStock) {
                    existingItem.quantity++;
                } else {
                    showStatus("Stock insuficiente. Máximo disponible: " + currentStock, "error");
                    return;
                }
            } else {
                if (!product.precio || product.precio <= 0) {
                    showStatus("El producto no tiene precio válido", "error");
                    return;
                }

                cart.push({
                    id: productId,
                    code: product.codigo || 'N/A',
                    description: product.descripcion || 'Sin descripción',
                    price: product.precio || 0,
                    quantity: 1,
                    cost: product.costo || 0,
                    available: currentStock
                });
            }

            updateCartDisplay();
            showStatus("Producto agregado al carrito", "success");
            document.getElementById('search-dropdown').style.display = 'none';
            document.getElementById('search-product').value = '';
        }

        function updateCartDisplay() {
            const container = document.getElementById('cart-items');
            const totalElement = document.getElementById('total-amount');

            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">No hay productos</p>';
                totalElement.textContent = '$0.00';
                return;
            }

            let total = 0;
            container.innerHTML = '';

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'product-item';
                itemDiv.innerHTML = `
                    <strong>${item.description}</strong>
                    <div>Cód: ${item.code} | $${item.price.toFixed(2)} x ${item.quantity}</div>
                    <div>Total: $${itemTotal.toFixed(2)}</div>
                    <div class="actions">
                        <button class="btn btn-warning btn-sm" onclick="updateQuantity(${index}, -1)">-</button>
                        <span style="margin: 0 8px;">${item.quantity}</span>
                        <button class="btn btn-warning btn-sm" onclick="updateQuantity(${index}, 1)">+</button>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">X</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        function updateQuantity(index, change) {
            const newQuantity = cart[index].quantity + change;
            
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }

            if (newQuantity > cart[index].available) {
                showStatus("Stock insuficiente. Máximo disponible: " + cart[index].available, "error");
                return;
            }

            cart[index].quantity = newQuantity;
            updateCartDisplay();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            showStatus("Producto removido del carrito", "success");
        }

        function processSale(paymentType) {
            if (cart.length === 0) {
                showStatus("El carrito está vacío", "error");
                return;
            }

            const equipoNumber = document.getElementById('equipo-number').value.trim();
            const clientName = document.getElementById('client-name').value.trim();

            if (!equipoNumber && !clientName) {
                showStatus("Ingrese al menos un número de equipo o nombre de cliente", "error");
                return;
            }

            const total = parseFloat(document.getElementById('total-amount').textContent.replace('$', ''));

            let displayName = '';
            if (equipoNumber && clientName) {
                displayName = `Equipo ${equipoNumber} - ${clientName}`;
            } else if (equipoNumber) {
                displayName = `Equipo ${equipoNumber}`;
            } else {
                displayName = clientName;
            }

            const saleNumber = getNextSaleNumber();

            const sale = {
                id: 'sale-' + Date.now(),
                saleNumber: saleNumber,
                clientName: displayName,
                equipoNumber: equipoNumber,
                products: [...cart],
                total: total,
                paymentType: paymentType,
                date: new Date()
            };

            if (firebaseInitialized) {
                saveSaleToFirebase(sale, paymentType, equipoNumber);
            } else {
                if (paymentType === 'contado') {
                    dailySales.unshift(sale);
                }
                
                if (paymentType === 'pendiente') {
                    const credit = {
                        id: 'credit-' + Date.now(),
                        saleId: sale.id,
                        saleNumber: saleNumber,
                        clientName: displayName,
                        equipoNumber: equipoNumber,
                        originalAmount: total,
                        pendingAmount: total,
                        saleDate: new Date(),
                        status: 'pendiente',
                        payments: []
                    };
                    pendingCredits.push(credit);
                    
                    if (equipoNumber) {
                        updateEquiposConPendientes(equipoNumber);
                    }
                }
            }

            if (paymentType === 'contado') {
                showStatus(`Venta contado #${saleNumber} procesada correctamente`, "success");
            } else {
                showStatus(`Venta pendiente #${saleNumber} registrada correctamente`, "success");
            }
            
            cart = [];
            updateCartDisplay();
            document.getElementById('equipo-number').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('search-dropdown').style.display = 'none';
            document.getElementById('search-product').value = '';

            displayDailySales();
            displayPendingCredits();
            displayEquiposConPendientes();
            updateCreditSelect();
        }

        async function saveSaleToFirebase(sale, paymentType, equipoNumber) {
            try {
                const saleRef = await db.collection('ventas').add(sale);
                
                if (paymentType === 'pendiente') {
                    const credit = {
                        saleId: saleRef.id,
                        saleNumber: sale.saleNumber,
                        clientName: sale.clientName,
                        equipoNumber: equipoNumber,
                        originalAmount: sale.total,
                        pendingAmount: sale.total,
                        saleDate: new Date(),
                        status: 'pendiente',
                        payments: []
                    };
                    await db.collection('creditos').add(credit);
                }
                
                showStatus("Datos guardados en la nube", "success");
            } catch (error) {
                console.error("Error guardando en Firebase:", error);
                showStatus("Error guardando en la nube, usando almacenamiento local", "error");
            }
        }

        function getNextSaleNumber() {
            const now = new Date();
            const dateStr = now.toISOString().slice(2,10).replace(/-/g, '');
            const count = dailySales.length + 1;
            return 'F' + dateStr + count.toString().padStart(3, '0');
        }

        function displayDailySales() {
            const tbody = document.getElementById('daily-sales-body');
            
            const ventasContado = dailySales.filter(sale => sale.paymentType === 'contado');
            
            if (ventasContado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">No hay ventas de contado hoy</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            ventasContado.forEach(sale => {
                const productosText = sale.products.map(p => 
                    `${p.description} (${p.quantity})`
                ).join(', ');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${sale.saleNumber}</strong></td>
                    <td>${sale.clientName}</td>
                    <td title="${productosText}">${sale.products.length} producto(s)</td>
                    <td>$${sale.total.toFixed(2)}</td>
                    <td>${sale.paymentType === 'contado' ? 'Contado' : 'Pendiente'}</td>
                    <td>${sale.date.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-info btn-sm" onclick="viewSale('${sale.id}')">Ver</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSale('${sale.id}')">Del</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function displayEquiposConPendientes() {
            const grid = document.getElementById('pending-equipos-grid');
            
            if (equiposConPendientes.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d;">No hay equipos con facturas pendientes</div>';
                return;
            }
            
            let html = '';
            
            equiposConPendientes.forEach(equipo => {
                html += `
                    <div class="equipo-card" data-equipo="${equipo.equipo}" onclick="selectEquipo('${equipo.equipo}')">
                        <div class="equipo-number">EQ${equipo.equipo}</div>
                        <div class="equipo-count">$${equipo.totalPendiente.toFixed(2)}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            if (equiposConPendientes.length > 0 && !selectedEquipo) {
                selectEquipo(equiposConPendientes[0].equipo);
            }
        }

        function updateEquiposConPendientes(equipoNumber) {
            if (!equipoNumber) return;
            
            const existingEquipo = equiposConPendientes.find(e => e.equipo === equipoNumber);
            
            if (existingEquipo) {
                const facturasEquipo = pendingCredits.filter(credit => credit.equipoNumber === equipoNumber);
                const totalPendiente = facturasEquipo.reduce((total, credit) => total + credit.pendingAmount, 0);
                existingEquipo.totalPendiente = totalPendiente;
                existingEquipo.facturasPendientes = facturasEquipo.length;
            } else {
                const facturasEquipo = pendingCredits.filter(credit => credit.equipoNumber === equipoNumber);
                const totalPendiente = facturasEquipo.reduce((total, credit) => total + credit.pendingAmount, 0);
                
                equiposConPendientes.push({
                    equipo: equipoNumber,
                    facturasPendientes: facturasEquipo.length,
                    totalPendiente: totalPendiente
                });
            }
            
            displayEquiposConPendientes();
        }

        function selectEquipo(equipoNumber) {
            selectedEquipo = equipoNumber;
            
            document.querySelectorAll('.equipo-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const selectedCard = document.querySelector(`.equipo-card[data-equipo="${equipoNumber}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
            
            loadFacturasPorEquipo(equipoNumber);
        }

        function loadFacturasPorEquipo(equipoNumber) {
            const container = document.getElementById('equipo-invoices-container');
            
            const facturasPendientes = pendingCredits.filter(credit => {
                return credit.equipoNumber === equipoNumber;
            });
            
            let html = '<div class="equipo-invoices active">';
            html += `<h3 style="margin-bottom: 10px; font-size: 1rem;">Facturas Pendientes - EQ${equipoNumber}</h3>`;
            
            if (facturasPendientes.length === 0) {
                html += '<p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">No hay facturas pendientes para este equipo</p>';
            } else {
                let totalGlobal = 0;
                
                facturasPendientes.forEach(credit => {
                    totalGlobal += credit.pendingAmount;
                    
                    const sale = dailySales.find(s => s.id === credit.saleId) || 
                                { products: [{ description: "Producto no disponible", code: "N/A", quantity: 0, price: 0 }] };
                    const productos = sale.products;
                    
                    html += `
                        <div class="invoice-item">
                            <div class="invoice-header">
                                <div class="invoice-number">${credit.saleNumber}</div>
                                <div class="invoice-total">$${credit.pendingAmount.toFixed(2)}</div>
                            </div>
                            <div class="invoice-details">
                                <div><strong>Fecha:</strong> ${credit.saleDate.toLocaleDateString()}</div>
                                <div><strong>Cliente:</strong> ${credit.clientName}</div>
                                <div><strong>Saldo pendiente:</strong> $${credit.pendingAmount.toFixed(2)}</div>
                            </div>
                            <div class="invoice-products">
                                <strong>Productos:</strong>
                                ${productos.map(product => `
                                    <div class="product-detail">
                                        <div>
                                            <div>${product.description}</div>
                                            <div style="font-size: 0.7rem; color: #666;">Cód: ${product.code}</div>
                                        </div>
                                        <span>${product.quantity} x $${product.price.toFixed(2)} = $${(product.quantity * product.price).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="payment-section">
                                <div class="form-group">
                                    <label for="payment-amount-${credit.id}">Monto Abono</label>
                                    <input type="number" id="payment-amount-${credit.id}" min="0" max="${credit.pendingAmount}" step="0.01" placeholder="0.00">
                                </div>
                                <div class="actions">
                                    <button class="btn btn-success" onclick="registerPaymentForCredit('${credit.id}')">Registrar Abono</button>
                                    <button class="btn btn-info" onclick="printInvoice('${credit.id}')">Imprimir</button>
                                </div>
                            </div>
                            ${credit.payments && credit.payments.length > 0 ? `
                                <div class="payment-history">
                                    <strong>Historial de Abonos:</strong>
                                    ${credit.payments.map((payment, index) => `
                                        <div style="padding: 4px; border-bottom: 1px solid var(--border-color);">
                                            <strong>Abono ${index + 1}:</strong> $${payment.amount.toFixed(2)}<br>
                                            <small>Fecha: ${payment.date.toLocaleDateString()} | Saldo anterior: $${payment.previousBalance.toFixed(2)} | Nuevo saldo: $${payment.newBalance.toFixed(2)}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                    <div class="global-summary">
                        <div class="summary-row">
                            <span><strong>Total Facturas Pendientes:</strong></span>
                            <span><strong>${facturasPendientes.length}</strong></span>
                        </div>
                        <div class="summary-row">
                            <span><strong>Saldo Total Pendiente:</strong></span>
                            <span><strong>$${totalGlobal.toFixed(2)}</strong></span>
                        </div>
                        <div class="summary-total-global">
                            TOTAL GLOBAL: $${totalGlobal.toFixed(2)}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayPendingCredits() {
            const tbody = document.getElementById('credits-body');
            
            if (pendingCredits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #7f8c8d;">No hay ventas pendientes</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            pendingCredits.forEach(credit => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${credit.clientName}</td>
                    <td>$${credit.pendingAmount.toFixed(2)}</td>
                    <td>${credit.saleDate.toLocaleDateString()}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 0.7rem;" onclick="selectCredit('${credit.id}')">Abonar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCreditSelect() {
            const select = document.getElementById('credit-select');
            select.innerHTML = '<option value="">Seleccione venta</option>';
            
            pendingCredits.forEach(credit => {
                const option = document.createElement('option');
                option.value = credit.id;
                option.textContent = `${credit.clientName} - $${credit.pendingAmount.toFixed(2)}`;
                select.appendChild(option);
            });
        }

        function selectCredit(creditId) {
            selectedCreditId = creditId;
            document.getElementById('credit-select').value = creditId;
            showCreditDetails(creditId);
        }

        function showCreditDetails(creditId) {
            const credit = pendingCredits.find(c => c.id === creditId);
            if (!credit) return;

            document.getElementById('detail-client').textContent = credit.clientName;
            document.getElementById('detail-balance').textContent = `$${credit.pendingAmount.toFixed(2)}`;
            document.getElementById('detail-total').textContent = `$${credit.originalAmount.toFixed(2)}`;
            document.getElementById('credit-details').style.display = 'block';
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-amount').max = credit.pendingAmount;

            showPaymentHistory(credit);
        }

        function showPaymentHistory(credit) {
            const paymentsList = document.getElementById('payments-list');
            const paymentHistory = document.getElementById('payment-history');
            
            if (!credit.payments || credit.payments.length === 0) {
                paymentsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.75rem;">No hay abonos registrados</p>';
            } else {
                let html = '';
                credit.payments.forEach((payment, index) => {
                    html += `
                        <div style="padding: 4px; border-bottom: 1px solid var(--border-color);">
                            <strong>Abono ${index + 1}:</strong> $${payment.amount.toFixed(2)}<br>
                            <small>Fecha: ${payment.date.toLocaleDateString()} | Saldo anterior: $${payment.previousBalance.toFixed(2)} | Nuevo saldo: $${payment.newBalance.toFixed(2)}</small>
                        </div>
                    `;
                });
                paymentsList.innerHTML = html;
            }
            
            paymentHistory.style.display = 'block';
        }

        function registerPaymentForCredit(creditId) {
            const amountInput = document.getElementById(`payment-amount-${creditId}`);
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showStatus("Ingrese un monto válido", "error");
                return;
            }
            
            const credit = pendingCredits.find(c => c.id === creditId);
            if (amount > credit.pendingAmount) {
                showStatus("El monto excede el saldo pendiente", "error");
                return;
            }
            
            const newBalance = credit.pendingAmount - amount;
            
            credit.pendingAmount = newBalance;
            if (newBalance === 0) {
                credit.status = 'pagado';
            }
            
            if (!credit.payments) {
                credit.payments = [];
            }
            
            credit.payments.push({
                amount: amount,
                date: new Date(),
                previousBalance: credit.pendingAmount + amount,
                newBalance: newBalance
            });

            if (firebaseInitialized) {
                savePaymentToFirebase(creditId, amount, newBalance);
            }

            showStatus(`Abono de $${amount.toFixed(2)} registrado correctamente`, "success");
            
            amountInput.value = '';
            
            displayPendingCredits();
            updateCreditSelect();
            displayEquiposConPendientes();
            
            if (selectedEquipo) {
                loadFacturasPorEquipo(selectedEquipo);
            }
        }

        async function savePaymentToFirebase(creditId, amount, newBalance) {
            try {
                const payment = {
                    amount: amount,
                    date: new Date(),
                    previousBalance: newBalance + amount,
                    newBalance: newBalance
                };
                
                await db.collection('creditos').doc(creditId).update({
                    pendingAmount: newBalance,
                    status: newBalance === 0 ? 'pagado' : 'pendiente',
                    payments: firebase.firestore.FieldValue.arrayUnion(payment)
                });
                
                showStatus("Abono guardado en la nube", "success");
            } catch (error) {
                console.error("Error guardando abono en Firebase:", error);
                showStatus("Error guardando en la nube, usando almacenamiento local", "error");
            }
        }

        function registerPayment() {
            if (!selectedCreditId) {
                showStatus("Seleccione una venta pendiente", "error");
                return;
            }
            
            const amount = parseFloat(document.getElementById('payment-amount').value);
            if (!amount || amount <= 0) {
                showStatus("Ingrese un monto válido", "error");
                return;
            }
            
            const credit = pendingCredits.find(c => c.id === selectedCreditId);
            if (amount > credit.pendingAmount) {
                showStatus("El monto excede el saldo pendiente", "error");
                return;
            }
            
            const newBalance = credit.pendingAmount - amount;
            
            credit.pendingAmount = newBalance;
            if (newBalance === 0) {
                credit.status = 'pagado';
            }
            
            if (!credit.payments) {
                credit.payments = [];
            }
            
            credit.payments.push({
                amount: amount,
                date: new Date(),
                previousBalance: credit.pendingAmount + amount,
                newBalance: newBalance
            });

            showStatus(`Abono de $${amount.toFixed(2)} registrado correctamente`, "success");
            
            document.getElementById('payment-amount').value = '';
            document.getElementById('credit-details').style.display = 'none';
            document.getElementById('payment-history').style.display = 'none';

            displayPendingCredits();
            updateCreditSelect();
            displayEquiposConPendientes();
        }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.textContent = theme === 'light' ? '🌙' : '☀️';
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = '🟢 Conectado';
                statusElement.className = 'connection-status online';
            } else {
                statusElement.textContent = '🔴 Sin conexión';
                statusElement.className = 'connection-status offline';
            }
        }

        function printInvoice(creditId) {
            showStatus("Función de impresión en desarrollo", "info");
        }

        function viewSale(saleId) {
            showStatus("Función de visualización en desarrollo", "info");
        }

        function deleteSale(saleId) {
            if (!confirm("¿Está seguro de eliminar esta venta?")) return;
            showStatus("Función de eliminación en desarrollo", "info");
        }

        function cancelPendingSale() {
            showStatus("Función de cancelación en desarrollo", "info");
        }
    </script>
</body>
</html>
