<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avanzado de Ventas - Taller Wilian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
            padding: 10px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header-info {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            flex: 1;
            text-align: center;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #333;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-container {
            position: relative;
        }

        .search-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            display: none;
        }

        .search-dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.2s;
        }

        .search-dropdown-item:hover {
            background-color: #3498db;
            color: white;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .products-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .products-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .total-row {
            background-color: #ecf0f1;
            font-weight: bold;
        }

        .total-row td {
            border-top: 2px solid #3498db;
            font-size: 1.1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d35400;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-full {
            width: 100%;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.85rem;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .empty-cart {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 20px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            margin: 2px;
        }

        .quantity-input, .price-input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.8rem;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .history-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .history-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .invoice-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .edit-mode {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .abono-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }

        .abono-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .saldo-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="status" id="status-message"></div>
    
    <div class="container">
        <header>
            <h1>Sistema Avanzado de Ventas</h1>
            <div class="header-info">
                Taller Wilian - <span id="current-date"></span>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="ventas">Nueva Venta</div>
            <div class="tab" data-tab="pendientes">Pendientes</div>
        </div>

        <div class="tab-content active" id="ventas-tab">
            <div class="form-group">
                <label for="equipo">Equipo</label>
                <input type="text" id="equipo" placeholder="Número de equipo" maxlength="6">
            </div>

            <div class="form-group">
                <label for="cliente">Nombre de Cliente</label>
                <input type="text" id="cliente" placeholder="Nombre del cliente">
            </div>

            <div class="form-group">
                <label for="buscar-producto">Buscar Producto</label>
                <div class="search-container">
                    <input type="text" id="buscar-producto" placeholder="Código o descripción del producto">
                    <div id="search-dropdown" class="search-dropdown"></div>
                </div>
            </div>

            <table class="products-table">
                <thead>
                    <tr>
                        <th width="100">CANTIDAD</th>
                        <th>DESCRIPCIÓN</th>
                        <th width="120">PRECIO UNIT.</th>
                        <th width="120">SUBTOTAL</th>
                        <th width="150">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="cart-items">
                    <tr>
                        <td colspan="5" class="empty-cart">No hay productos agregados</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="3"><strong>TOTAL</strong></td>
                        <td colspan="2" id="total-amount"><strong>$0.00</strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="payment-buttons">
                <button class="btn btn-success" id="contado-btn">
                    GUARDAR CONTADO
                </button>
                <button class="btn btn-warning" id="pendiente-btn">
                    GUARDAR PENDIENTE
                </button>
            </div>

            <div style="margin-top: 40px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Historial de Ventas</h3>
                <div class="form-group">
                    <input type="text" id="filter-historial" placeholder="Filtrar por cliente, equipo o factura...">
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Factura</th>
                            <th>Cliente/Equipo</th>
                            <th>Total</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historial-body">
                        <tr>
                            <td colspan="6" class="empty-cart">Cargando historial...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="pendientes-tab">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Factura</th>
                        <th>Cliente/Equipo</th>
                        <th>Total</th>
                        <th>Saldo</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="pendientes-body">
                    <tr>
                        <td colspan="6" class="empty-cart">Cargando facturas pendientes...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="invoice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div id="invoice-modal-content"></div>
                <button class="btn btn-primary" onclick="closeInvoiceModal()" style="margin-top: 15px; width: 100%;">CERRAR</button>
            </div>
        </div>

        <div id="abono-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
                <h3 style="margin-bottom: 15px; text-align: center;">Registrar Abono</h3>
                <div id="abono-modal-content"></div>
                <div class="form-group">
                    <label for="monto-abono">Monto del Abono:</label>
                    <input type="number" id="monto-abono" step="0.01" min="0.01" placeholder="0.00">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" onclick="SalesService.processAbono()" style="flex: 1;">PROCESAR ABONO</button>
                    <button class="btn btn-danger" onclick="closeAbonoModal()" style="flex: 1;">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
                authDomain: "tallerwilliam-732b3.firebaseapp.com",
                projectId: "tallerwilliam-732b3",
                storageBucket: "tallerwilliam-732b3.firebasestorage.app",
                messagingSenderId: "822262666247",
                appId: "1:822262666247:web:6680487bbf1108006b86a2"
            }
        };

        const AppState = {
            firebaseInitialized: false,
            db: null,
            cart: [],
            searchResults: [],
            saleCounter: 0,
            currentEditingInvoice: null,
            historial: [],
            pendientes: [],
            currentAbonoInvoice: null
        };

        const DataService = {
            async searchProducts(query) {
                if (!AppState.firebaseInitialized) {
                    return [{
                        id: 'manual-' + Date.now(),
                        codigo: 'MANUAL',
                        descripcion: query,
                        precio: 0,
                        cantidad: 1
                    }];
                }

                const searchTerm = query.toLowerCase().trim();
                const snapshot = await AppState.db.collection("INVENTARIO").get();
                
                const results = [];
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    const codigo = (product.codigo || '').toLowerCase();
                    const descripcion = (product.descripcion || '').toLowerCase();
                    
                    if (codigo.includes(searchTerm) || descripcion.includes(searchTerm)) {
                        results.push(product);
                    }
                });

                if (results.length === 0 && query.trim() !== '') {
                    results.push({
                        id: 'manual-' + Date.now(),
                        codigo: 'MANUAL',
                        descripcion: query,
                        precio: 0,
                        cantidad: 1
                    });
                }
                
                return results;
            },

            async saveSale(saleData) {
                if (AppState.firebaseInitialized) {
                    const docRef = await AppState.db.collection("VENTAS").add(saleData);
                    return docRef.id;
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async updateSale(saleId, saleData) {
                if (AppState.firebaseInitialized) {
                    await AppState.db.collection("VENTAS").doc(saleId).update(saleData);
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async deleteSale(saleId) {
                if (AppState.firebaseInitialized) {
                    await AppState.db.collection("VENTAS").doc(saleId).delete();
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            },

            async loadSales() {
                if (AppState.firebaseInitialized) {
                    const snapshot = await AppState.db.collection("VENTAS")
                        .orderBy("timestamp", "desc")
                        .get();
                    
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    return [];
                }
            },

            async loadSaleCounter(date = new Date().toISOString().split('T')[0]) {
                if (AppState.firebaseInitialized) {
                    const snapshot = await AppState.db.collection("VENTAS")
                        .where("date", "==", date)
                        .get();
                    return snapshot.size;
                } else {
                    return 0;
                }
            },

            async addAbono(invoiceId, abonoData) {
                if (AppState.firebaseInitialized) {
                    const ventaRef = AppState.db.collection("VENTAS").doc(invoiceId);
                    await ventaRef.update({
                        abonos: firebase.firestore.FieldValue.arrayUnion(abonoData),
                        saldoPendiente: firebase.firestore.FieldValue.increment(-abonoData.monto)
                    });
                } else {
                    throw new Error("No hay conexión a la base de datos");
                }
            }
        };

        const UIService = {
            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
            },

            updateCartDisplay() {
                const cartItems = document.getElementById('cart-items');
                const totalAmount = document.getElementById('total-amount');
                
                if (AppState.cart.length === 0) {
                    cartItems.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-cart">No hay productos agregados</td>
                        </tr>
                    `;
                    totalAmount.innerHTML = '<strong>$0.00</strong>';
                    return;
                }
                
                let total = 0;
                let itemsHTML = '';
                
                AppState.cart.forEach((item, index) => {
                    const itemTotal = item.precio * item.cantidad;
                    total += itemTotal;
                    
                    itemsHTML += `
                        <tr>
                            <td>
                                <input type="number" class="quantity-input" value="${item.cantidad}" 
                                       min="1" data-index="${index}" onchange="SalesService.updateQuantity(${index}, this.value)">
                            </td>
                            <td>${item.descripcion}</td>
                            <td>
                                <input type="number" class="price-input" value="${item.precio.toFixed(2)}" 
                                       step="0.01" min="0" data-index="${index}" onchange="SalesService.updatePrice(${index}, this.value)">
                            </td>
                            <td>$${itemTotal.toFixed(2)}</td>
                            <td>
                                <button class="action-btn btn-danger" onclick="SalesService.removeFromCart(${index})">
                                    ELIMINAR
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                cartItems.innerHTML = itemsHTML;
                totalAmount.innerHTML = `<strong>$${total.toFixed(2)}</strong>`;
            },

            showSearchResults(results) {
                const dropdown = document.getElementById('search-dropdown');
                dropdown.innerHTML = '';
                
                if (results.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-dropdown-item';
                    item.textContent = 'No se encontraron productos - Presione para agregar manualmente';
                    item.addEventListener('click', () => {
                        const searchInput = document.getElementById('buscar-producto');
                        SalesService.addManualProduct(searchInput.value);
                        dropdown.style.display = 'none';
                        searchInput.value = '';
                    });
                    dropdown.appendChild(item);
                } else {
                    results.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'search-dropdown-item';
                        const isManual = product.id.startsWith('manual-');
                        item.innerHTML = `
                            <strong>${product.descripcion || 'Sin descripción'}</strong>
                            <div style="font-size: 0.7rem; margin-top: 2px;">
                                ${isManual ? 'PRODUCTO MANUAL' : `Cód: ${product.codigo || 'N/A'} | Stock: ${product.cantidad || 0}`} | $${(product.precio || 0).toFixed(2)}
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            SalesService.addToCart(product);
                            dropdown.style.display = 'none';
                            document.getElementById('buscar-producto').value = '';
                        });
                        dropdown.appendChild(item);
                    });
                }
                
                dropdown.style.display = 'block';
            },

            updateHistorial(ventas) {
                const historialBody = document.getElementById('historial-body');
                AppState.historial = ventas;
                
                if (ventas.length === 0) {
                    historialBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-cart">No hay ventas registradas</td>
                        </tr>
                    `;
                    return;
                }
                
                let historialHTML = '';
                
                ventas.forEach(venta => {
                    const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES') : 'N/A';
                    const tipo = venta.paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE';
                    const tipoClass = venta.paymentType === 'contado' ? 'btn-success' : 'btn-warning';
                    
                    historialHTML += `
                        <tr>
                            <td><strong>${venta.invoiceNumber || 'N/A'}</strong></td>
                            <td>${venta.clientName || 'N/A'}<br><small>Equipo: ${venta.equipoNumber || 'N/A'}</small></td>
                            <td>$${(venta.total || 0).toFixed(2)}</td>
                            <td><span class="action-btn ${tipoClass}" style="cursor: default;">${tipo}</span></td>
                            <td>${fecha}</td>
                            <td>
                                <button class="action-btn btn-primary" onclick="SalesService.viewInvoice('${venta.id}')">
                                    VER
                                </button>
                                <button class="action-btn btn-warning" onclick="SalesService.reprintInvoice('${venta.id}')">
                                    REIMPRIMIR
                                </button>
                                ${venta.paymentType === 'contado' ? `
                                    <button class="action-btn btn-danger" onclick="SalesService.deleteInvoice('${venta.id}')">
                                        ELIMINAR
                                    </button>
                                ` : `
                                    <button class="action-btn btn-success" onclick="SalesService.editInvoice('${venta.id}')">
                                        EDITAR
                                    </button>
                                    <button class="action-btn btn-danger" onclick="SalesService.deleteInvoice('${venta.id}')">
                                        ELIMINAR
                                    </button>
                                `}
                            </td>
                        </tr>
                    `;
                });
                
                historialBody.innerHTML = historialHTML;
            },

            updatePendientes(ventas) {
                const pendientesBody = document.getElementById('pendientes-body');
                const pendientes = ventas.filter(v => v.paymentType === 'pendiente');
                AppState.pendientes = pendientes;
                
                if (pendientes.length === 0) {
                    pendientesBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-cart">No hay facturas pendientes</td>
                        </tr>
                    `;
                    return;
                }
                
                let pendientesHTML = '';
                
                pendientes.forEach(venta => {
                    const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleDateString('es-ES') : 'N/A';
                    const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                    
                    pendientesHTML += `
                        <tr>
                            <td><strong>${venta.invoiceNumber || 'N/A'}</strong></td>
                            <td>${venta.clientName || 'N/A'}<br><small>Equipo: ${venta.equipoNumber || 'N/A'}</small></td>
                            <td>$${(venta.total || 0).toFixed(2)}</td>
                            <td>$${saldoPendiente.toFixed(2)}</td>
                            <td>${fecha}</td>
                            <td>
                                <button class="action-btn btn-primary" onclick="SalesService.viewInvoice('${venta.id}')">
                                    VER
                                </button>
                                <button class="action-btn btn-success" onclick="SalesService.editInvoice('${venta.id}')">
                                    EDITAR
                                </button>
                                <button class="action-btn btn-info" onclick="SalesService.registrarAbono('${venta.id}')" style="background-color: #17a2b8; color: white;">
                                    ABONO
                                </button>
                                <button class="action-btn btn-danger" onclick="SalesService.deleteInvoice('${venta.id}')">
                                    ELIMINAR
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                pendientesBody.innerHTML = pendientesHTML;
            },

            showInvoiceModal(content) {
                document.getElementById('invoice-modal-content').innerHTML = content;
                document.getElementById('invoice-modal').style.display = 'block';
            },

            showAbonoModal(content) {
                document.getElementById('abono-modal-content').innerHTML = content;
                document.getElementById('abono-modal').style.display = 'block';
                document.getElementById('monto-abono').value = '';
                document.getElementById('monto-abono').focus();
            }
        };

        const SalesService = {
            addToCart(product) {
                const cartItem = {
                    id: product.id,
                    codigo: product.codigo || 'MANUAL',
                    descripcion: product.descripcion || 'Sin descripción',
                    precio: product.precio || 0,
                    cantidad: 1
                };
                
                AppState.cart.push(cartItem);
                UIService.updateCartDisplay();
                UIService.showStatus("Producto agregado al carrito", "success");
            },

            addManualProduct(descripcion) {
                if (!descripcion.trim()) {
                    UIService.showStatus("Ingrese una descripción para el producto", "error");
                    return;
                }
                
                this.addToCart({
                    id: 'manual-' + Date.now(),
                    codigo: 'MANUAL',
                    descripcion: descripcion,
                    precio: 0,
                    cantidad: 1
                });
            },

            removeFromCart(index) {
                AppState.cart.splice(index, 1);
                UIService.updateCartDisplay();
            },

            updateQuantity(index, newQuantity) {
                const quantity = parseInt(newQuantity) || 1;
                if (quantity < 1) {
                    UIService.showStatus("La cantidad debe ser al menos 1", "error");
                    return;
                }
                AppState.cart[index].cantidad = quantity;
                UIService.updateCartDisplay();
            },

            updatePrice(index, newPrice) {
                const price = parseFloat(newPrice) || 0;
                if (price < 0) {
                    UIService.showStatus("El precio no puede ser negativo", "error");
                    return;
                }
                AppState.cart[index].precio = price;
                UIService.updateCartDisplay();
            },

            generateInvoiceNumber() {
                const now = new Date();
                const datePart = now.getFullYear().toString().substr(-2) + 
                               (now.getMonth() + 1).toString().padStart(2, '0') + 
                               now.getDate().toString().padStart(2, '0');
                const counterPart = (AppState.saleCounter + 1).toString().padStart(4, '0');
                return datePart + counterPart;
            },

            async processSale(paymentType) {
                if (AppState.cart.length === 0) {
                    UIService.showStatus("El carrito está vacío", "error");
                    return;
                }
                
                const equipo = document.getElementById('equipo').value.trim();
                const cliente = document.getElementById('cliente').value.trim();
                
                if (!equipo && !cliente) {
                    UIService.showStatus("Ingrese un número de equipo o nombre de cliente", "error");
                    return;
                }
                
                const finalCliente = cliente || `Equipo ${equipo}`;
                const finalEquipo = equipo || '000000';
                
                try {
                    const saleData = {
                        invoiceNumber: this.generateInvoiceNumber(),
                        equipoNumber: finalEquipo,
                        clientName: finalCliente,
                        products: AppState.cart.map(item => ({
                            id: item.id,
                            codigo: item.codigo,
                            descripcion: item.descripcion,
                            precio: item.precio,
                            cantidad: item.cantidad
                        })),
                        total: AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0),
                        paymentType: paymentType,
                        timestamp: new Date(),
                        date: new Date().toISOString().split('T')[0],
                        status: paymentType === 'contado' ? 'pagado' : 'pendiente'
                    };

                    if (paymentType === 'pendiente') {
                        saleData.saldoPendiente = saleData.total;
                        saleData.abonos = [];
                    }
                    
                    await DataService.saveSale(saleData);
                    this.printTicket(saleData);
                    
                    UIService.showStatus(`Venta ${paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE'} procesada - Factura #${saleData.invoiceNumber}`, "success");
                    
                    AppState.cart = [];
                    UIService.updateCartDisplay();
                    document.getElementById('equipo').value = '';
                    document.getElementById('cliente').value = '';
                    
                    AppState.saleCounter = await DataService.loadSaleCounter();
                    await this.loadHistorial();
                    
                } catch (error) {
                    UIService.showStatus("Error al procesar la venta: " + error.message, "error");
                }
            },

            async updateInvoice(invoiceId) {
                if (AppState.cart.length === 0) {
                    UIService.showStatus("El carrito está vacío", "error");
                    return;
                }
                
                try {
                    const saleData = {
                        products: AppState.cart.map(item => ({
                            id: item.id,
                            codigo: item.codigo,
                            descripcion: item.descripcion,
                            precio: item.precio,
                            cantidad: item.cantidad
                        })),
                        total: AppState.cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0),
                        timestamp: new Date()
                    };
                    
                    await DataService.updateSale(invoiceId, saleData);
                    
                    UIService.showStatus("Factura actualizada correctamente", "success");
                    
                    AppState.cart = [];
                    AppState.currentEditingInvoice = null;
                    UIService.updateCartDisplay();
                    document.getElementById('equipo').value = '';
                    document.getElementById('cliente').value = '';
                    
                    await this.loadHistorial();
                    UIService.activateTab('ventas');
                    
                } catch (error) {
                    UIService.showStatus("Error al actualizar la factura: " + error.message, "error");
                }
            },

            async loadHistorial() {
                try {
                    const ventas = await DataService.loadSales();
                    UIService.updateHistorial(ventas);
                    UIService.updatePendientes(ventas);
                } catch (error) {
                    UIService.showStatus("Error al cargar historial: " + error.message, "error");
                }
            },

            async viewInvoice(invoiceId) {
                const venta = AppState.historial.find(v => v.id === invoiceId) || 
                             AppState.pendientes.find(v => v.id === invoiceId);
                
                if (!venta) return;
                
                let productsHTML = '';
                if (venta.products && venta.products.length > 0) {
                    venta.products.forEach(product => {
                        productsHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                <div>${product.descripcion} (x${product.cantidad})</div>
                                <div>$${(product.precio * product.cantidad).toFixed(2)}</div>
                            </div>
                        `;
                    });
                }

                let abonosHTML = '';
                if (venta.abonos && venta.abonos.length > 0) {
                    abonosHTML += `<div class="abono-section">
                        <h4>Historial de Abonos:</h4>`;
                    venta.abonos.forEach(abono => {
                        const fechaAbono = abono.fecha ? new Date(abono.fecha.toDate ? abono.fecha.toDate() : abono.fecha).toLocaleString('es-ES') : 'N/A';
                        abonosHTML += `
                            <div class="abono-item">
                                <div>${fechaAbono}</div>
                                <div>$${abono.monto.toFixed(2)}</div>
                            </div>
                        `;
                    });
                    abonosHTML += `</div>`;
                }

                const saldoInfo = venta.paymentType === 'pendiente' ? 
                    `<div class="saldo-info">
                        Saldo Pendiente: $${(venta.saldoPendiente || venta.total).toFixed(2)}
                    </div>` : '';
                
                const fecha = venta.timestamp ? new Date(venta.timestamp.toDate ? venta.timestamp.toDate() : venta.timestamp).toLocaleString('es-ES') : 'N/A';
                const tipo = venta.paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE';
                
                const modalContent = `
                    <h3 style="margin-bottom: 15px; text-align: center;">Factura #${venta.invoiceNumber}</h3>
                    <div class="invoice-details">
                        <strong>Cliente:</strong> ${venta.clientName || 'N/A'}<br>
                        <strong>Equipo:</strong> ${venta.equipoNumber || 'N/A'}<br>
                        <strong>Tipo:</strong> ${tipo}<br>
                        <strong>Fecha:</strong> ${fecha}<br>
                        <strong>Total:</strong> $${(venta.total || 0).toFixed(2)}
                    </div>
                    ${saldoInfo}
                    <h4 style="margin: 15px 0 10px 0;">Productos:</h4>
                    ${productsHTML || '<p>No hay productos</p>'}
                    ${abonosHTML}
                `;
                
                UIService.showInvoiceModal(modalContent);
            },

            async editInvoice(invoiceId) {
                const venta = AppState.pendientes.find(v => v.id === invoiceId);
                if (!venta) return;
                
                AppState.cart = venta.products.map(p => ({
                    id: p.id,
                    codigo: p.codigo,
                    descripcion: p.descripcion,
                    precio: p.precio,
                    cantidad: p.cantidad
                }));
                
                document.getElementById('equipo').value = venta.equipoNumber || '';
                document.getElementById('cliente').value = venta.clientName || '';
                
                AppState.currentEditingInvoice = invoiceId;
                
                UIService.activateTab('ventas');
                UIService.updateCartDisplay();
                
                document.getElementById('contado-btn').style.display = 'none';
                document.getElementById('pendiente-btn').style.display = 'none';
                
                const updateBtn = document.createElement('button');
                updateBtn.className = 'btn btn-success btn-full';
                updateBtn.id = 'update-btn';
                updateBtn.textContent = 'ACTUALIZAR FACTURA';
                updateBtn.onclick = () => this.updateInvoice(invoiceId);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-danger';
                cancelBtn.style.marginTop = '10px';
                cancelBtn.textContent = 'CANCELAR EDICIÓN';
                cancelBtn.onclick = this.cancelEdit;
                
                const paymentButtons = document.querySelector('.payment-buttons');
                paymentButtons.innerHTML = '';
                paymentButtons.appendChild(updateBtn);
                paymentButtons.appendChild(cancelBtn);
                
                UIService.showStatus("Modo edición activado - Editando factura pendiente", "success");
            },

            cancelEdit() {
                AppState.cart = [];
                AppState.currentEditingInvoice = null;
                UIService.updateCartDisplay();
                document.getElementById('equipo').value = '';
                document.getElementById('cliente').value = '';
                
                const paymentButtons = document.querySelector('.payment-buttons');
                paymentButtons.innerHTML = `
                    <button class="btn btn-success" id="contado-btn">
                        GUARDAR CONTADO
                    </button>
                    <button class="btn btn-warning" id="pendiente-btn">
                        GUARDAR PENDIENTE
                    </button>
                `;
                
                document.getElementById('contado-btn').onclick = () => SalesService.processSale('contado');
                document.getElementById('pendiente-btn').onclick = () => SalesService.processSale('pendiente');
            },

            async deleteInvoice(invoiceId) {
                if (!confirm("¿Está seguro de eliminar esta factura?")) return;
                
                try {
                    await DataService.deleteSale(invoiceId);
                    UIService.showStatus("Factura eliminada correctamente", "success");
                    await this.loadHistorial();
                } catch (error) {
                    UIService.showStatus("Error al eliminar factura: " + error.message, "error");
                }
            },

            async reprintInvoice(invoiceId) {
                const venta = AppState.historial.find(v => v.id === invoiceId) || 
                             AppState.pendientes.find(v => v.id === invoiceId);
                
                if (venta) {
                    this.printTicket(venta);
                    UIService.showStatus("Ticket reimpreso", "success");
                }
            },

            async registrarAbono(invoiceId) {
                const venta = AppState.pendientes.find(v => v.id === invoiceId);
                if (!venta) return;
                
                AppState.currentAbonoInvoice = venta;
                
                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                
                const modalContent = `
                    <div class="invoice-details">
                        <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                        <strong>Cliente:</strong> ${venta.clientName}<br>
                        <strong>Total:</strong> $${venta.total.toFixed(2)}<br>
                        <strong>Saldo Pendiente:</strong> $${saldoPendiente.toFixed(2)}
                    </div>
                `;
                
                UIService.showAbonoModal(modalContent);
            },

            async processAbono() {
                const montoInput = document.getElementById('monto-abono');
                const monto = parseFloat(montoInput.value);
                
                if (!monto || monto <= 0) {
                    UIService.showStatus("Ingrese un monto válido", "error");
                    return;
                }
                
                const venta = AppState.currentAbonoInvoice;
                const saldoPendiente = venta.saldoPendiente !== undefined ? venta.saldoPendiente : venta.total;
                
                if (monto > saldoPendiente) {
                    UIService.showStatus("El monto del abono no puede ser mayor al saldo pendiente", "error");
                    return;
                }
                
                try {
                    const abonoData = {
                        monto: monto,
                        fecha: new Date(),
                        fechaString: new Date().toLocaleString('es-ES')
                    };
                    
                    await DataService.addAbono(venta.id, abonoData);
                    
                    this.printAbonoTicket(venta, abonoData, saldoPendiente - monto);
                    
                    UIService.showStatus(`Abono de $${monto.toFixed(2)} registrado correctamente`, "success");
                    
                    closeAbonoModal();
                    await this.loadHistorial();
                    
                } catch (error) {
                    UIService.showStatus("Error al procesar abono: " + error.message, "error");
                }
            },

            printTicket(saleData) {
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket #${saleData.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .product-row { 
                                margin: 4px 0;
                                font-size: 20px;
                            }
                            .product-desc { 
                                font-size: 18px;
                                margin-bottom: 2px;
                            }
                            .product-info {
                                display: flex;
                                justify-content: space-between;
                                font-size: 18px;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .dotted-line { border-bottom: 2px dotted #000; margin: 2px 0; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .abono-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILIAN</h3>
                            <div class="small-text">Factura: ${saleData.invoiceNumber}</div>
                            <div class="small-text">${new Date(saleData.timestamp.toDate ? saleData.timestamp.toDate() : saleData.timestamp).toLocaleString('es-ES')}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Cliente:</strong> ${saleData.clientName}<br>
                            <strong>Equipo:</strong> ${saleData.equipoNumber}<br>
                            <strong>Tipo:</strong> ${saleData.paymentType.toUpperCase()}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 8px 0;">
                            ${saleData.products.map(p => `
                                <div class="product-row">
                                    <div class="product-desc">${p.descripcion}</div>
                                    <div class="product-info">
                                        <div>x${p.cantidad}</div>
                                        <div>$${(p.precio * p.cantidad).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="dotted-line"></div>
                            `).join('')}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total large-text">
                            TOTAL: $${saleData.total.toFixed(2)}
                        </div>

                        ${saleData.paymentType === 'pendiente' ? `
                            <div class="abono-info">
                                <div>SALDO PENDIENTE:</div>
                                <div class="large-text">$${(saleData.saldoPendiente || saleData.total).toFixed(2)}</div>
                            </div>
                        ` : ''}
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            },

            printAbonoTicket(venta, abonoData, nuevoSaldo) {
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Abono #${venta.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 22px; 
                                margin: 0; 
                                padding: 6px;
                                width: 58mm;
                                font-weight: bold;
                            }
                            .header { text-align: center; margin-bottom: 12px; }
                            .line { border-bottom: 2px dashed #000; margin: 4px 0; }
                            .abono-detail { 
                                margin: 8px 0;
                                font-size: 20px;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 12px; font-size: 24px; }
                            .footer { text-align: center; margin-top: 12px; font-size: 18px; font-weight: bold; }
                            .text-center { text-align: center; }
                            .small-text { font-size: 18px; }
                            .medium-text { font-size: 20px; }
                            .large-text { font-size: 26px; }
                            .thank-you { text-align: center; margin-top: 15px; font-weight: bold; font-size: 20px; }
                            .saldo-info {
                                background: #f0f0f0;
                                padding: 8px;
                                margin: 8px 0;
                                border-radius: 4px;
                                font-size: 18px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 2px 0; font-size: 26px;">TALLER WILIAN</h3>
                            <div class="small-text">COMPROBANTE DE ABONO</div>
                            <div class="small-text">${abonoData.fechaString}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="medium-text">
                            <strong>Factura:</strong> ${venta.invoiceNumber}<br>
                            <strong>Cliente:</strong> ${venta.clientName}<br>
                            <strong>Equipo:</strong> ${venta.equipoNumber}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="abono-detail">
                            <div style="text-align: center; font-size: 24px; margin: 10px 0;">
                                MONTO DEL ABONO
                            </div>
                            <div style="text-align: center; font-size: 28px; font-weight: bold;">
                                $${abonoData.monto.toFixed(2)}
                            </div>
                        </div>

                        <div class="saldo-info">
                            <div>SALDO ANTERIOR: $${(venta.saldoPendiente || venta.total).toFixed(2)}</div>
                            <div>NUEVO SALDO: $${nuevoSaldo.toFixed(2)}</div>
                        </div>
                        
                        <div class="thank-you">
                            GRACIAS POR PREFERIRNOS
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            }
        };

        const App = {
            async init() {
                try {
                    await this.initializeFirebase();
                    this.setupUI();
                    await this.loadInitialData();
                    this.setupEventListeners();
                    UIService.showStatus("Sistema inicializado correctamente", "success");
                } catch (error) {
                    console.error("Error en inicialización:", error);
                    UIService.showStatus("Error al inicializar: " + error.message, "error");
                }
            },

            async initializeFirebase() {
                try {
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(CONFIG.firebase);
                    }
                    AppState.db = firebase.firestore();
                    AppState.firebaseInitialized = true;
                } catch (error) {
                    console.error("Error inicializando Firebase:", error);
                    AppState.firebaseInitialized = false;
                    UIService.showStatus("Modo offline activado", "warning");
                }
            },

            setupUI() {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES');
                
                UIService.activateTab = function(tabName) {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    if (tabName === 'historial' || tabName === 'pendientes') {
                        SalesService.loadHistorial();
                    }
                };
            },

            async loadInitialData() {
                AppState.saleCounter = await DataService.loadSaleCounter();
                await SalesService.loadHistorial();
            },

            setupEventListeners() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        UIService.activateTab(tab.getAttribute('data-tab'));
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('search-dropdown').style.display = 'none';
                    }
                });

                const searchInput = document.getElementById('buscar-producto');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    searchTimeout = setTimeout(async () => {
                        if (query.length >= 2) {
                            try {
                                AppState.searchResults = await DataService.searchProducts(query);
                                UIService.showSearchResults(AppState.searchResults);
                            } catch (error) {
                                document.getElementById('search-dropdown').style.display = 'none';
                                if (query.length > 0) {
                                    UIService.showStatus("Error en búsqueda: " + error.message, "error");
                                }
                            }
                        } else {
                            document.getElementById('search-dropdown').style.display = 'none';
                        }
                    }, 300);
                });

                document.getElementById('equipo').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value.length > 6) {
                        e.target.value = e.target.value.substring(0, 6);
                    }
                });

                document.getElementById('contado-btn').addEventListener('click', () => {
                    SalesService.processSale('contado');
                });

                document.getElementById('pendiente-btn').addEventListener('click', () => {
                    SalesService.processSale('pendiente');
                });

                document.getElementById('filter-historial').addEventListener('input', (e) => {
                    const filter = e.target.value.toLowerCase();
                    const filtered = AppState.historial.filter(venta => 
                        venta.clientName?.toLowerCase().includes(filter) ||
                        venta.equipoNumber?.includes(filter) ||
                        venta.invoiceNumber?.includes(filter)
                    );
                    UIService.updateHistorial(filtered);
                });
            }
        };

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        function closeAbonoModal() {
            document.getElementById('abono-modal').style.display = 'none';
            AppState.currentAbonoInvoice = null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
    </script>
</body>
</html>
