<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Taller Willian – Nueva Versión</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ----------  DISEÑO ORIGINAL (sin tarjetas visuales de abonos) ---------- */
:root{
  --azul:#3498db; --azulO:#2c3e50; --ver:#27ae60; --ama:#f39c12; --roj:#e74c3c;
  --bor:#ddd; --fnd:#eef2f5; --txt:#333; --clr:#fff;
  --fz:14px; --fz1:0.85rem; --fz2:0.8rem; --fz3:0.75rem;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:var(--fz);color:var(--txt);}
body{background:var(--fnd);padding:10px;line-height:1.4;}
.container{max-width:100%;margin:auto;background:var(--clr);border-radius:8px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
header{background:linear-gradient(135deg,var(--azul),var(--azulO));color:var(--clr);padding:12px 0;border-radius:8px;text-align:center;margin-bottom:20px;position:relative;}
header h1{font-size:1.3rem;margin-bottom:4px;}
.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.dashboard-section{background:var(--clr);border-radius:8px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);border:1px solid var(--bor);display:flex;flex-direction:column;overflow:hidden;}
.dashboard-section.full-width{grid-column:1/-1;height:auto;min-height:600px;}
.section-title{display:flex;justify-content:space-between;align-items:center;font-size:1.2rem;color:var(--azulO);margin-bottom:15px;padding-bottom:8px;border-bottom:2px solid var(--azul);}
.fecha-control{display:flex;align-items:center;gap:10px;font-size:var(--fz1);}
.fecha-input{padding:6px 10px;border:1px solid var(--bor);border-radius:4px;font-size:var(--fz3);}
.venta-header{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.venta-line-1{display:grid;grid-template-columns:80px 1fr 100px;gap:10px;align-items:end;}
.venta-line-2{display:grid;grid-template-columns:1fr 100px;gap:10px;align-items:end;}
.form-group{margin-bottom:0;}
.form-group label{display:block;margin-bottom:3px;font-weight:600;font-size:var(--fz1);}
.form-group input,.form-group select{width:100%;padding:8px;border:1px solid var(--bor);border-radius:4px;font-size:var(--fz1);background:var(--clr);}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--azul);}
.search-container{position:relative;}
.search-dropdown{position:absolute;background:var(--clr);border:1px solid var(--bor);border-radius:4px;max-height:200px;overflow-y:auto;width:100%;z-index:1000;box-shadow:0 2px 4px rgba(0,0,0,.1);font-size:var(--fz3);display:none;}
.search-dropdown-item{padding:10px;cursor:pointer;border-bottom:1px solid var(--bor);transition:background .2s;}
.search-dropdown-item:hover{background:var(--azul);color:var(--clr);}
.cart-container{background:#f8f9fa;border-radius:6px;padding:15px;margin:10px 0;border:1px solid #e9ecef;flex:1;display:flex;flex-direction:column;min-height:0;}
.cart-items-container{flex:1;overflow-y:auto;max-height:none;margin-bottom:10px;min-height:0;}
.cart-header{display:grid;grid-template-columns:80px 1fr 100px 100px 80px;gap:10px;padding:8px 12px;background:var(--azulO);color:var(--clr);border-radius:4px;font-weight:600;font-size:var(--fz3);margin-bottom:8px;position:sticky;top:0;z-index:10;}
.cart-item{display:grid;grid-template-columns:80px 1fr 100px 100px 80px;gap:10px;padding:10px 12px;background:var(--clr);border-radius:4px;margin-bottom:6px;border:1px solid #e9ecef;align-items:center;transition:all .2s ease;}
.cart-item:hover{background:#f8f9fa;border-color:var(--azul);}
.cart-item:last-child{margin-bottom:0;}
.quantity-input{width:70px;padding:6px;border:1px solid var(--bor);border-radius:3px;text-align:center;font-size:var(--fz3);}
.price-input{width:90px;padding:6px;border:1px solid var(--bor);border-radius:3px;text-align:center;font-size:var(--fz3);}
.product-desc{font-size:var(--fz1);line-height:1.3;}
.subtotal{font-weight:600;color:var(--azulO);font-size:var(--fz1);}
.cart-actions{display:flex;gap:4px;}
.cart-total{background:#ecf0f1;padding:12px;border-radius:4px;text-align:right;font-weight:bold;font-size:1.1rem;border-top:2px solid var(--azul);margin-top:auto;flex-shrink:0;}
.empty-cart{text-align:center;color:#7f8c8d;font-size:var(--fz1);padding:30px;background:var(--clr);border-radius:4px;border:2px dashed var(--bor);}
.btn{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:600;transition:all .3s ease;font-size:var(--fz1);text-align:center;height:38px;}
.btn-primary{background:var(--azul);color:var(--clr);}
.btn-primary:hover{background:#2980b9;}
.btn-success{background:var(--ver);color:var(--clr);}
.btn-success:hover{background:#219a52;}
.btn-warning{background:var(--ama);color:var(--clr);}
.btn-warning:hover{background:#d35400;}
.btn-danger{background:var(--roj);color:var(--clr);}
.btn-danger:hover{background:#c0392b;}
.btn-info{background:#17a2b8;color:var(--clr);}
.btn-info:hover{background:#138496;}
.btn-full{width:100%;}
.btn-small{padding:8px 12px;font-size:var(--fz3);}
.status{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;z-index:10000;font-size:var(--fz1);display:none;box-shadow:0 2px 10px rgba(0,0,0,.2);}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.icon-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:4px;transition:all .3s ease;margin:0 2px;display:inline-flex;align-items:center;justify-content:center;width:32px;height:28px;}
.icon-btn:hover{transform:scale(1.1);}
.btn-view{background:var(--azul);color:var(--clr);}
.btn-view:hover{background:#2980b9;}
.btn-reprint{background:var(--ama);color:var(--clr);}
.btn-reprint:hover{background:#d35400;}
.btn-edit{background:var(--ver);color:var(--clr);}
.btn-edit:hover{background:#219a52;}
.btn-delete{background:var(--roj);color:var(--clr);}
.btn-delete:hover{background:#c0392b;}
.btn-abono{background:#17a2b8;color:var(--clr);}
.btn-abono:hover{background:#138496;}
.btn-cancel{background:#9b59b6;color:var(--clr);}
.btn-cancel:hover{background:#8e44ad;}
.history-container{flex:1;display:flex;flex-direction:column;min-height:400px;}
.history-table-container{flex:1;overflow:auto;border:1px solid var(--bor);border-radius:6px;margin-top:10px;}
.history-table{width:100%;border-collapse:collapse;font-size:var(--fz3);min-width:800px;}
.history-table th,.history-table td{padding:10px;text-align:left;border-bottom:1px solid var(--bor);white-space:nowrap;}
.history-table th{background:var(--azulO);color:var(--clr);font-weight:600;position:sticky;top:0;z-index:10;}
.history-table tbody tr:hover{background:#f8f9fa;}
.historial-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:10px;}
.filter-buttons{display:flex;gap:8px;flex-wrap:wrap;}
.filter-btn{padding:8px 12px;border:1px solid var(--bor);border-radius:4px;background:var(--clr);cursor:pointer;font-size:var(--fz3);transition:all .3s ease;}
.filter-btn.active{background:var(--azul);color:var(--clr);border-color:var(--azul);}
.filter-btn:hover{background:#2980b9;color:var(--clr);border-color:#2980b9;}
.contado-badge{background:var(--ver);color:var(--clr);padding:4px 8px;border-radius:3px;font-size:.7rem;font-weight:bold;}
.pendiente-badge{background:var(--ama);color:var(--clr);padding:4px 8px;border-radius:3px;font-size:.7rem;font-weight:bold;}
.abono-badge{background:#17a2b8;color:var(--clr);padding:4px 8px;border-radius:3px;font-size:.7rem;font-weight:bold;}
.retiro-badge{background:var(--roj);color:var(--clr);padding:4px 8px;border-radius:3px;font-size:.7rem;font-weight:bold;}
.total-display{font-weight:bold;}
.saldo-pendiente-rojo{color:var(--roj);font-weight:bold;}
.saldo-pendiente-negro{color:var(--txt);font-weight:bold;}
.cliente-equipo{font-weight:bold;}
.cliente-nombre{font-size:.7rem;color:#666;margin-top:2px;}
.action-buttons{display:flex;gap:4px;flex-wrap:wrap;}
.historial-actions-container{min-width:240px;}
.delete-item-btn{background:var(--roj);color:var(--clr);border:none;border-radius:3px;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:all .2s ease;}
.delete-item-btn:hover{background:#c0392b;transform:scale(1.1);}
.tabs-container{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;}
.tabs-header{display:flex;border-bottom:2px solid var(--azul);margin-bottom:15px;flex-shrink:0;}
.tab-btn{padding:10px 20px;background:#f8f9fa;border:none;border-bottom:2px solid transparent;cursor:pointer;font-weight:600;color:#666;transition:all .3s ease;font-size:var(--fz1);}
.tab-btn.active{background:var(--clr);color:var(--azul);border-bottom:2px solid var(--azul);}
.tab-btn:hover{background:#e9ecef;color:#2980b9;}
.tab-content{display:none;flex:1;min-height:0;overflow:hidden;}
.tab-content.active{display:flex;flex-direction:column;}
.facturas-pendientes-container{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;}
.equipos-container{flex:1;display:flex;flex-direction:column;}
.equipos-grid{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;overflow-y:auto;flex:1;min-height:0;}
.equipo-card{background:var(--clr);border:2px solid var(--azul);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all .3s ease;box-shadow:0 1px 3px rgba(0,0,0,.1);min-height:60px;display:flex;flex-direction:column;justify-content:center;align-items:center;width:80px;}
.equipo-card:hover{transform:translateY(-1px);box-shadow:0 2px 5px rgba(0,0,0,.15);border-color:#2980b9;}
.equipo-number{font-size:1rem;font-weight:bold;color:var(--azulO);margin-bottom:3px;line-height:1;}
.equipo-nombre{font-size:.7rem;color:var(--roj);font-weight:bold;margin-bottom:3px;line-height:1;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.equipo-total{font-size:.8rem;font-weight:bold;color:var(--ver);line-height:1;}
.empty-state{text-align:center;color:#7f8c8d;padding:30px 20px;}
.empty-state i{font-size:2.5rem;margin-bottom:10px;opacity:.5;}
.grupos-actions{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.grupos-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-top:15px;overflow-y:auto;flex:1;min-height:0;padding-right:5px;}
.grupo-card{background:var(--clr);border:2px solid var(--azul);border-radius:8px;padding:12px;box-shadow:0 2px 4px rgba(0,0,0,.1);transition:all .3s ease;position:relative;display:flex;flex-direction:column;justify-content:space-between;}
.grupo-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15);border-color:#2980b9;}
.grupo-header{text-align:center;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--bor);}
.grupo-name{font-size:1rem;font-weight:bold;color:var(--azulO);}
.grupo-equipos-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px;}
.grupo-equipo-item{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:4px;padding:5px;text-align:center;cursor:pointer;transition:all .2s ease;font-size:var(--fz3);}
.grupo-equipo-item:hover{background:#e8f4fd;border-color:var(--azul);}
.grupo-equipo-number{font-size:.8rem;font-weight:bold;color:var(--azulO);margin-bottom:2px;}
.grupo-equipo-total{font-size:.7rem;font-weight:bold;color:var(--ver);}
.grupo-total{text-align:center;font-weight:bold;font-size:.9rem;color:var(--azulO);padding:6px;background:#e8f4fd;border-radius:4px;border-top:2px solid var(--azulO);margin-top:8px;}
.grupo-actions{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .3s ease;}
.grupo-card:hover .grupo-actions{opacity:1;}
.grupo-action-btn{background:rgba(255,255,255,.9);border:1px solid var(--bor);border-radius:4px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;font-size:.7rem;}
.grupo-action-btn:hover{transform:scale(1.1);}
.btn-edit-grupo{color:var(--ver);border-color:var(--ver);}
.btn-edit-grupo:hover{background:var(--ver);color:var(--clr);}
.btn-delete-grupo{color:var(--roj);border-color:var(--roj);}
.btn-delete-grupo:hover{background:var(--roj);color:var(--clr);}
.btn-detalle-grupo{color:var(--azul);border-color:var(--azul);}
.btn-detalle-grupo:hover{background:var(--azul);color:var(--clr);}
.btn-abono{color:#17a2b8;border-color:#17a2b8;}
.btn-abono:hover{background:#17a2b8;color:var(--clr);}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;}
.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--clr);padding:20px;border-radius:8px;width:90%;max-width:800px;max-height:80vh;overflow-y:auto;}
.create-grupo-modal{max-width:400px;}
.equipos-selection{max-height:200px;overflow-y:auto;border:1px solid var(--bor);border-radius:4px;padding:10px;margin:10px 0;}
.equipo-selection-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #eee;cursor:pointer;font-size:var(--fz1);}
.equipo-selection-item:hover{background:#f8f9fa;}
.equipo-selection-item.selected{background:var(--azul);color:var(--clr);}
.selected-equipos{margin:10px 0;padding:8px;background:#e8f4fd;border-radius:4px;min-height:40px;font-size:var(--fz1);}
.selected-equipo-badge{display:inline-block;background:var(--azul);color:var(--clr);padding:3px 6px;border-radius:10px;margin:2px;font-size:var(--fz3);}
.empty-state{text-align:center;color:#7f8c8d;padding:30px 20px;}
.empty-state i{font-size:2.5rem;margin-bottom:10px;opacity:.5;}
.detalle-equipo{background:#f8f9fa;padding:12px;border-radius:6px;margin:8px 0;font-size:var(--fz1);}
.factura-item{background:var(--clr);padding:8px;border-radius:4px;margin:6px 0;border-left:3px solid var(--azul);font-size:var(--fz3);}
.producto-item{display:flex;justify-content:space-between;padding:3px 0;font-size:var(--fz3);}
.grupo-facturas{margin-top:8px;}
.all-equipos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin:10px 0;max-height:200px;overflow-y:auto;padding:10px;border:1px solid #e0e0e0;border-radius:4px;background:#fafafa;}
.all-equipo-item{background:var(--clr);border:1px solid var(--bor);border-radius:4px;padding:6px;text-align:center;cursor:pointer;transition:all .2s ease;font-size:var(--fz3);width:80px;}
.all-equipo-item:hover{border-color:var(--azul);background:#f0f8ff;}
.all-equipo-item.selected{background:var(--azul);color:var(--clr);border-color:#2980b9;}
.edit-grupo-modal{max-width:500px;}
.grupo-detalle-equipo{background:#f8f9fa;padding:10px;border-radius:6px;margin:8px 0;border-left:4px solid var(--azul);}
.grupo-detalle-factura{background:var(--clr);padding:8px;border-radius:4px;margin:6px 0;border:1px solid #e0e0e0;}
.grupo-resumen{background:#e8f4fd;padding:12px;border-radius:6px;margin:15px 0;border-left:4px solid var(--azulO);font-weight:bold;}
.connection-status{position:fixed;top:10px;left:10px;padding:8px 12px;border-radius:4px;z-index:10001;font-size:.7rem;font-weight:bold;display:none;}
.connection-status.online{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.connection-status.offline{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.loading-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:3000;justify-content:center;align-items:center;color:var(--clr);font-size:1.2rem;}
.concurrency-lock{pointer-events:none;opacity:.7;}
.price-warning{border:2px solid var(--roj)!important;background:#fdf2f2!important;}
.date-warning{border:2px solid var(--ama)!important;background:#fef9e7!important;}
.duplicate-warning{border:2px solid var(--roj)!important;background:#fdf2f2!important;animation:pulse 1.5s infinite;}
@keyframes pulse{0%{border-color:#e74c3c}50%{border-color:#ff9999}100%{border-color:#e74c3c}}
.btn:disabled{opacity:.6;cursor:not-allowed;}
.btn:disabled:hover{transform:none;}
.retiro-btn{background:#9b59b6;color:var(--clr);}
.retiro-btn:hover{background:#8e44ad;}
.equipo-en-grupo{background:#f8d7da!important;border-color:var(--roj)!important;color:#721c24!important;cursor:not-allowed!important;}
.equipo-en-grupo:hover{transform:none!important;box-shadow:none!important;}
/* ----------  TICKET CSS (solo en impresión) ---------- */
@media print{
 body{width:58mm;margin:0;padding:0;font-size:20px!important;line-height:1.2;}
 .no-print{display:none!important;}
 .header{text-align:center;margin-bottom:8px;}
 .line{border-bottom:2px dashed #000;margin:4px 0;}
 .ticket-equipo{font-size:32px!important;font-weight:bold;text-align:center;margin:6px 0;}
 .ticket-producto{font-size:16px!important;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted #000;}
 .ticket-total{font-size:24px!important;text-align:center;margin-top:8px;font-weight:bold;}
 .ticket-footer{text-align:center;margin-top:10px;font-size:16px!important;font-weight:bold;}
}
</style>
</head>
<body>
<div class="status no-print" id="status-message"></div>
<div class="connection-status no-print" id="connection-status"></div>
<div class="loading-overlay no-print" id="loading-overlay"><div style="text-align:center"><i class="fas fa-spinner fa-spin" style="font-size:3rem;margin-bottom:15px"></i><div>Procesando...</div></div></div>

<div class="container">
  <header><h1>Taller Willian</h1></header>

  <div class="dashboard">
    <!-- NUEVA VENTA -->
    <div class="dashboard-section">
      <h2 class="section-title">NUEVA VENTA</h2>
      <input type="date" id="fecha-venta" class="fecha-input" style="display:none">
      <div class="venta-header">
        <div class="venta-line-1">
          <div class="form-group"><label>Equipo</label><input type="text" id="equipo" placeholder="Número" maxlength="4" required></div>
          <div class="form-group"><label>Grupo</label><input type="text" id="cliente" placeholder="Nombre del grupo"></div>
          <div><button class="btn btn-success" id="contado-btn">CONTADO</button></div>
        </div>
        <div class="venta-line-2">
          <div class="form-group"><label>Buscar Producto</label><div class="search-container"><input type="text" id="buscar-producto" placeholder="Código, descripción o formato: 3 pernos de culata $3"><div id="search-dropdown" class="search-dropdown"></div></div></div>
          <div><button class="btn btn-warning" id="pendiente-btn">PENDIENTE</button></div>
        </div>
      </div>
      <div class="cart-container"><div class="cart-header"><div>CANT</div><div>DESCRIPCIÓN</div><div>PRECIO UNIT.</div><div>SUBTOTAL</div><div>ACCIÓN</div></div><div class="cart-items-container" id="cart-items"><div class="empty-cart"><i class="fas fa-shopping-cart" style="font-size:2rem;margin-bottom:10px;opacity:.5"></i><div>No hay productos agregados</div></div></div><div class="cart-total" id="total-amount">TOTAL: $0.00</div></div>
    </div>

    <!-- FACTURAS PENDIENTES / GRUPOS -->
    <div class="dashboard-section">
      <div class="tabs-header"><button class="tab-btn active" data-tab="facturas">FACTURAS PENDIENTES</button><button class="tab-btn" data-tab="grupos">GRUPOS</button></div>
      <div class="tabs-container">
        <div class="tab-content active" id="tab-facturas"><div class="facturas-pendientes-container"><div class="equipos-container"><div id="equipos-individuales" class="equipos-grid"></div><div id="empty-equipos" class="empty-state" style="display:none"><i class="fas fa-cube"></i><div>No hay facturas pendientes</div><div style="font-size:.8rem;margin-top:5px;color:#999">Las ventas pendientes aparecerán aquí</div></div></div></div></div>
        <div class="tab-content" id="tab-grupos"><div class="grupos-actions"><button class="btn btn-success" id="crear-grupo-btn"><i class="fas fa-plus"></i> CREAR GRUPO</button></div><div class="grupos-container" id="grupos-container"><div class="empty-state"><i class="fas fa-users"></i><div>No hay grupos creados</div><div style="font-size:.8rem;margin-top:5px;color:#999">Crea tu primer grupo para organizar los equipos</div></div></div></div>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="dashboard-section full-width">
      <h2 class="section-title">HISTORIAL DE VENTAS</h2>
      <div class="historial-actions no-print">
        <div class="filter-buttons"><button class="filter-btn active" data-filter="hoy">HOY</button><button class="filter-btn" data-filter="todo">TODO</button><button class="filter-btn" data-filter="equipo">EQUIPO</button><button class="filter-btn" data-filter="producto">PRODUCTO</button><button class="filter-btn" data-filter="monto">MONTO</button><button class="filter-btn" data-filter="rango">RANGO</button></div>
        <div><button class="btn btn-info" id="print-historial-btn">IMPRIMIR CORTE</button></div>
      </div>
      <div class="form-group no-print"><input type="text" id="filter-historial" placeholder="Filtrar... (equipo, producto, monto)"></div>
      <div class="history-container"><div class="history-table-container"><table class="history-table"><thead><tr><th>Factura</th><th>Equipo</th><th>Total</th><th>Estado</th><th>Fecha</th><th width="250">Acciones</th></tr></thead><tbody id="historial-body"><tr><td colspan="6" class="empty-cart">Cargando historial...</td></tr></tbody></table></div></div>
    </div>
  </div>
</div>

<!-- MODALES -->
<!-- Modal confirmación abono inicial -->
<div id="confirmacion-abono-modal" class="modal-overlay"><div class="modal-content confirmacion-abono-modal"><h3 style="margin-bottom:15px;text-align:center">Factura Pendiente con Abono Inicial</h3><div style="margin-bottom:20px"><p>¿Desea registrar un abono inicial para esta factura pendiente?</p><div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:15px 0"><div><strong>Total de la venta:</strong> $<span id="confirmacion-total">0.00</span></div><div><strong>Equipo:</strong> <span id="confirmacion-equipo"></span></div><div><strong>Grupo:</strong> <span id="confirmacion-cliente"></span></div></div></div><div class="confirmacion-buttons"><button class="btn btn-success" id="confirmar-con-abono-btn"><i class="fas fa-money-bill-wave"></i> REGISTRAR ABONO</button><button class="btn btn-warning" id="continuar-sin-abono-btn"><i class="fas fa-forward"></i> CONTINUAR SIN ABONO</button></div><button class="btn btn-danger" id="cancelar-confirmacion-btn" style="margin-top:10px;width:100%"><i class="fas fa-times"></i> CANCELAR</button></div></div>
<!-- Modal abono inicial -->
<div id="abono-inicial-modal" class="modal-overlay"><div class="modal-content"><h3 style="margin-bottom:15px;text-align:center">Registrar Abono Inicial</h3><div style="margin-bottom:20px"><div style="background:#f8f9fa;padding:15px;border-radius:6px"><div><strong>Total de la venta:</strong> $<span id="abono-modal-total">0.00</span></div><div><strong>Equipo:</strong> <span id="abono-modal-equipo"></span></div><div><strong>Grupo:</strong> <span id="abono-modal-cliente"></span></div></div></div><div class="form-group"><label for="monto-abono-inicial">Monto del Abono Inicial:</label><input type="number" id="monto-abono-inicial" step="0.01" min="0.01" placeholder="0.00" style="font-size:1.2rem;text-align:center;font-weight:bold"></div><div style="background:#e8f4fd;padding:12px;border-radius:6px;margin:15px 0;text-align:center"><div><strong>Saldo Pendiente después del abono:</strong></div><div style="font-size:1.4rem;font-weight:bold;color:#2c3e50" id="saldo-despues-abono">$0.00</div></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="procesar-venta-con-abono-btn" style="flex:1"><i class="fas fa-check"></i> PROCESAR VENTA CON ABONO</button><button class="btn btn-danger" id="cancelar-abono-inicial-btn" style="flex:1"><i class="fas fa-times"></i> CANCELAR</button></div></div></div>
<!-- Modal detalle -->
<div id="detalle-modal" class="modal-overlay"><div class="modal-content"><div id="detalle-modal-content"></div><button class="btn btn-primary" id="close-detalle-modal" style="margin-top:15px;width:100%">CERRAR</button><button class="btn btn-success" id="imprimir-detalle-modal" style="margin-top:10px;width:100%">IMPRIMIR</button></div></div>
<!-- Modal grupo detalle -->
<div id="grupo-detalle-modal" class="modal-overlay"><div class="modal-content"><div id="grupo-detalle-modal-content"></div><button class="btn btn-primary" id="close-grupo-detalle-modal" style="margin-top:15px;width:100%">CERRAR</button><button class="btn btn-success" id="imprimir-grupo-detalle-modal" style="margin-top:10px;width:100%">IMPRIMIR GRUPO</button></div></div>
<!-- Modal crear grupo -->
<div id="crear-grupo-modal" class="modal-overlay"><div class="modal-content create-grupo-modal"><h3 style="margin-bottom:15px;text-align:center">Crear Nuevo Grupo</h3><div class="form-group"><label for="nombre-grupo">Nombre del Grupo:</label><input type="text" id="nombre-grupo" placeholder="Ej: Grupo A" class="form-control"></div><div class="form-group"><label>Seleccionar Equipos (Máx. 130):</label><div class="all-equipos-grid" id="all-equipos-grid"></div></div><div class="form-group"><label>Equipos Seleccionados: (<span id="contador-equipos">0</span>/130)</label><div class="selected-equipos" id="selected-equipos-list"><div style="color:#999;text-align:center;font-size:.8rem">No hay equipos seleccionados</div></div></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="guardar-grupo-btn" style="flex:1">CREAR GRUPO</button><button class="btn btn-danger" id="cancelar-grupo-btn" style="flex:1">CANCELAR</button></div></div></div>
<!-- Modal editar grupo -->
<div id="editar-grupo-modal" class="modal-overlay"><div class="modal-content edit-grupo-modal"><h3 style="margin-bottom:15px;text-align:center">Editar Grupo</h3><div class="form-group"><label for="editar-nombre-grupo">Nombre del Grupo:</label><input type="text" id="editar-nombre-grupo" placeholder="Ej: Grupo A" class="form-control"></div><div class="form-group"><label>Seleccionar Equipos (Máx. 130):</label><div class="all-equipos-grid" id="editar-all-equipos-grid"></div></div><div class="form-group"><label>Equipos Seleccionados: (<span id="editar-contador-equipos">0</span>/130)</label><div class="selected-equipos" id="editar-selected-equipos-list"><div style="color:#999;text-align:center;font-size:.8rem">No hay equipos seleccionados</div></div></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="actualizar-grupo-btn" style="flex:1">ACTUALIZAR GRUPO</button><button class="btn btn-danger" id="cancelar-editar-grupo-btn" style="flex:1">CANCELAR</button></div></div></div>
<!-- Modal abono -->
<div id="abono-modal" class="modal-overlay"><div class="modal-content"><h3 style="margin-bottom:15px;text-align:center">Registrar Abono</h3><div id="abono-modal-content"></div><div class="form-group"><label for="monto-abono">Monto del Abono:</label><input type="number" id="monto-abono" step="0.01" min="0.01" placeholder="0.00"></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="process-abono-btn" style="flex:1">PROCESAR ABONO</button><button class="btn btn-danger" id="close-abono-modal" style="flex:1">CANCELAR</button></div></div></div>
<!-- Modal retiro -->
<div id="retiro-modal" class="modal-overlay"><div class="modal-content"><h3 style="margin-bottom:15px;text-align:center">Registrar Retiro</h3><div class="form-group"><label for="monto-retiro">Monto del Retiro:</label><input type="number" id="monto-retiro" step="0.01" min="0.01" placeholder="0.00"></div><div class="form-group"><label for="concepto-retiro">Concepto:</label><input type="text" id="concepto-retiro" placeholder="Ej: Compra de materiales, Gastos operativos..."></div><div class="form-group"><label for="categoria-retiro">Categoría:</label><select id="categoria-retiro"><option value="compra">Compra de materiales</option><option value="gastos">Gastos operativos</option><option value="herramientas">Herramientas</option><option value="otros">Otros</option></select></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="process-retiro-btn" style="flex:1">PROCESAR RETIRO</button><button class="btn btn-danger" id="close-retiro-modal" style="flex:1">CANCELAR</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
/* ----------  CONFIG FIREBASE (TU PROYECTO REAL) ---------- */
const CONFIG={
  firebase:{
    apiKey:"AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
    authDomain:"tallerwilliam-732b3.firebaseapp.com",
    projectId:"tallerwilliam-732b3",
    storageBucket:"tallerwilliam-732b3.firebasestorage.app",
    messagingSenderId:"822262666247",
    appId:"1:822262666247:web:6680487bbf1108006b86a2"
  }
};
const firebase=window.firebase;
/* ----------  UTILS ---------- */
const DateUtils={
  getCurrentDateElSalvador:()=>{const now=new Date();const offset=-6*60;const localTime=now.getTime();const localOffset=now.getTimezoneOffset()*60000;const utc=localTime+localOffset;const es=utc+(offset*60000);return new Date(es);},
  getCurrentDateStringElSalvador:()=>DateUtils.getCurrentDateElSalvador().toISOString().split('T')[0],
  formatDateToYYYYMMDD:date=>{const y=date.getFullYear(),m=String(date.getMonth()+1).padStart(2,'0'),d=String(date.getDate()).padStart(2,'0');return `${y}-${m}-${d}`;},
  createDateFromStringElSalvador:dateString=>{const[y,m,d]=dateString.split('-').map(Number);const dt=new Date(y,m-1,d,12,0,0);return DateUtils.adjustToElSalvadorTime(dt);},
  adjustToElSalvadorTime:date=>{const offset=-6*60;const lt=date.getTime();const lo=date.getTimezoneOffset()*60000;const utc=lt+lo;const es=utc+(offset*60000);return new Date(es);},
  isTodayInElSalvador:dateString=>dateString===DateUtils.getCurrentDateStringElSalvador(),
  isFutureDateInElSalvador:dateString=>dateString>DateUtils.getCurrentDateStringElSalvador(),
  getCurrentTimestampElSalvador:()=>DateUtils.getCurrentDateElSalvador()
};
/* ----------  STATE ---------- */
const AppState={
  firebaseInitialized:false,db:null,cart:[],searchResults:[],saleCounter:0,currentEditingInvoice:null,historial:[],filteredHistorial:[],currentFilter:'hoy',currentAbonoInvoice:null,currentDetalle:null,equiposSeleccionados:new Set(),equiposEditSeleccionados:new Set(),processingSale:false,currentInvoiceNumber:null,datosVentaPendiente:null,operationLock:false
};
/* ----------  CONCURRENCY ---------- */
const ConcurrencyManager={
  async withLock(fn,op='Operación'){let attempts=0;while(AppState.operationLock&&attempts<10){attempts++;await new Promise(r=>setTimeout(r,100));} if(AppState.operationLock)throw new Error(`No se pudo adquirir lock para ${op}`);AppState.operationLock=true;document.body.classList.add('concurrency-lock');try{return await fn();}finally{AppState.operationLock=false;document.body.classList.remove('concurrency-lock');}}
};
/* ----------  UI SERVICE ---------- */
const UIService={
  showStatus(msg,type='info',time=3500){const s=document.getElementById('status-message');s.textContent=msg;s.className=`status ${type}`;s.style.display='block';setTimeout(()=>s.style.display='none',time);},
  showLoading(show=true){document.getElementById('loading-overlay').style.display=show?'flex':'none';},
  updateCartDisplay(){const cont=document.getElementById('cart-items'),totalEl=document.getElementById('total-amount');if(!AppState.cart.length){cont.innerHTML='<div class="empty-cart"><i class="fas fa-shopping-cart" style=font-size:2rem;margin-bottom:10px;opacity=.5></i><div>No hay productos agregados</div></div>';totalEl.textContent='TOTAL: $0.00';return;} let tot=0,html='';AppState.cart.forEach((it,ix)=>{const st=it.precio*it.cantidad;tot+=st;html+=`<div class="cart-item"><div><input type="number" class="quantity-input" value="${it.cantidad}" min="1" data-index="${ix}" onchange="SalesService.updateQuantity(${ix},this.value)"></div><div class="product-desc">${it.descripcion}</div><div><input type="number" class="price-input" value="${it.precio.toFixed(2)}" step="0.01" min="0" onchange="SalesService.updatePrice(${ix},this.value)"></div><div class="subtotal">$${st.toFixed(2)}</div><div class="cart-actions"><button class="delete-item-btn" onclick="SalesService.removeFromCart(${ix})" title="Eliminar producto"><i class="fas fa-trash"></i></button></div></div>`;});cont.innerHTML=html;totalEl.textContent=`TOTAL: $${tot.toFixed(2)}`;cont.scrollTop=cont.scrollHeight;},
  showSearchResults(res){const dd=document.getElementById('search-dropdown');dd.innerHTML='';if(!res.length){const it=document.createElement('div');it.className='search-dropdown-item';it.textContent='No se encontraron productos - Presione para agregar manualmente';it.addEventListener('click',()=>{SalesService.addManualProduct(document.getElementById('buscar-producto').value);dd.style.display='none';});dd.appendChild(it);}else{res.forEach(p=>{const it=document.createElement('div');it.className='search-dropdown-item';it.innerHTML=`<strong>${p.descripcion||'Sin descripción'}</strong><div style=font-size:.7rem;margin-top:2px>Cód: ${p.codigo||'N/A'} | Stock: ${p.cantidad||0} | $${(p.precio||0).toFixed(2)}</div>`;it.addEventListener('click',()=>{SalesService.addToCart(p);dd.style.display='none';document.getElementById('buscar-producto').value='';});dd.appendChild(it);}}dd.style.display='block';},
  updateHistorial(movs){AppState.historial=movs;AppState.filteredHistorial=movs;this.applyCurrentFilter();},
  applyCurrentFilter(){let f=AppState.historial;switch(AppState.currentFilter){case 'hoy':{const t=DateUtils.getCurrentDateStringElSalvador();f=f.filter(m=>m.date===t);break;}case 'todo':break;case 'equipo':{const eq=document.getElementById('filter-historial').value.trim();if(eq)f=f.filter(m=>m.tipo==='venta'&&m.equipoNumber&&m.equipoNumber.includes(eq));break;}case 'producto':{const pr=document.getElementById('filter-historial').value.trim().toLowerCase();if(pr)f=f.filter(m=>m.tipo==='venta'&&m.products&&m.products.some(p=>p.descripcion.toLowerCase().includes(pr)));break;}case 'monto':{const v=document.getElementById('filter-historial').value.trim();if(v){const[min,max]=v.split('-').map(Number);f=f.filter(m=>!isNaN(min)&&m.total>=min&&(isNaN(max)||m.total<=max));}break;}case 'rango':{const v=document.getElementById('filter-historial').value.trim();if(v.includes(' to ')){const[d1,d2]=v.split(' to ');if(d1&&d2)f=f.filter(m=>m.date>=d1&&m.date<=d2);}break;}}AppState.filteredHistorial=f;this.renderHistorial();},
  renderHistorial(){const tb=document.getElementById('historial-body'),m=AppState.filteredHistorial;if(!m.length){tb.innerHTML='<tr><td colspan=6 class=empty-cart>Sin movimientos para el filtro</td></tr>';return;} let h='';m.forEach(v=>{if(v.tipo==='retiro'){const f=v.timestamp?new Date(v.timestamp.toDate?v.timestamp.toDate():v.timestamp).toLocaleDateString('es-ES'):'N/A';h+=`<tr><td><strong>RET-${v.id.substring(0,8)}</strong></td><td><div class=cliente-equipo>-</div><div class=cliente-nombre>${v.concepto||'Sin concepto'}</div></td><td><div class=saldo-pendiente-rojo>-$${v.monto.toFixed(2)}</div></td><td><span class=retiro-badge>RETIRO</span></td><td>${f}</td><td><div class=action-buttons><button class=icon-btn btn-view onclick="SalesService.viewRetiro('${v.id}')" title="Ver retiro"><i class="fas fa-eye"></i></button><button class=icon-btn btn-delete onclick="SalesService.deleteRetiro('${v.id}')" title="Eliminar"><i class="fas fa-trash"></i></button></div></td></tr>`;}else{const f=v.timestamp?new Date(v.timestamp.toDate?v.timestamp.toDate():v.timestamp).toLocaleDateString('es-ES'):'N/A';const sp=v.saldoPendiente!==undefined?v.saldoPendiente:v.total;let estado=v.paymentType,clase='pendiente-badge',txt='PENDIENTE';if(v.paymentType==='contado'||(v.paymentType==='pendiente'&&sp<=0)){estado='contado';clase='contado-badge';txt='CONTADO';} let mm=v.total||0,clM='saldo-pendiente-negro';if(estado==='pendiente'){mm=sp;if(v.saldoPendiente<v.total)clM='saldo-pendiente-rojo';} const botones=estado==='contado'?`<button class=icon-btn btn-view onclick="SalesService.viewInvoice('${v.id}')" title="Ver factura"><i class="fas fa-eye"></i></button><button class=icon-btn btn-reprint onclick="SalesService.reprintInvoice('${v.id}')" title="Reimprimir"><i class="fas fa-print"></i></button><button class=icon-btn btn-delete onclick="SalesService.deleteInvoice('${v.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>`:`<button class=icon-btn btn-view onclick="SalesService.viewInvoice('${v.id}')" title="Ver factura"><i class="fas fa-eye"></i></button><button class=icon-btn btn-reprint onclick="SalesService.reprintInvoice('${v.id}')" title="Reimprimir"><i class="fas fa-print"></i></button><button class=icon-btn btn-edit onclick="SalesService.editInvoice('${v.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class=icon-btn btn-abono onclick="SalesService.registrarAbono('${v.id}')" title="Registrar abono"><i class="fas fa-money-bill-wave"></i></button><button class=icon-btn btn-delete onclick="SalesService.deleteInvoice('${v.id}')" title="Eliminar"><i class="fas fa-trash"></i></button><button class=icon-btn btn-cancel onclick="SalesService.cancelInvoice('${v.id}')" title="Cancelar factura"><i class="fas fa-ban"></i></button>`;h+=`<tr><td><strong>${v.invoiceNumber||'N/A'}</strong></td><td><div class=cliente-equipo>${v.equipoNumber||'N/A'}</div><div class=cliente-nombre>${v.clientName||'Sin nombre'}</div></td><td><div class=${clM}>$${mm.toFixed(2)}</div></td><td><span class=${clase}>${txt}</span></td><td>${f}</td><td><div class=action-buttons>${botones}</div></td></tr>`;}}tb.innerHTML=h;},
  showInvoiceModal(cnt){document.getElementById('invoice-modal-content').innerHTML=cnt;document.getElementById('invoice-modal').style.display='block';},
  showAbonoModal(cnt){document.getElementById('abono-modal-content').innerHTML=cnt;document.getElementById('abono-modal').style.display='block';document.getElementById('monto-abono').value='';document.getElementById('monto-abono').focus();},
  showRetiroModal(){document.getElementById('retiro-modal').style.display='block';document.getElementById('monto-retiro').value='';document.getElementById('concepto-retiro').value='';document.getElementById('categoria-retiro').value='compra';document.getElementById('monto-retiro').focus();},
  updateFilterButtons(){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));document.querySelector(`.filter-btn[data-filter="${AppState.currentFilter}"]`)?.classList.add('active');},
  setupTabs(){document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{const t=b.dataset.tab;document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.getElementById(`tab-${t}`).classList.add('active');if(t==='grupos')GrupoManager.renderGruposVisual();}));},
  updateMiniDashboard(movs){const hoy=DateUtils.getCurrentDateStringElSalvador();let contado=0,abono=0,retiro=0,pendiente=0,cCont=0,cAbon=0,cRet=0,cPend=0;movs.forEach(m=>{if(m.date!==hoy)return;if(m.tipo==='retiro'){retiro+=m.monto;cRet++;}else{if(m.paymentType==='contado'){contado+=m.total;cCont++;}else{const sp=m.saldoPendiente!==undefined?m.saldoPendiente:m.total;pendiente+=sp;if(m.abonos&&m.abonos.length){m.abonos.forEach(a=>{abono+=a.monto;cAbon++;});}cPend++;}}});document.getElementById('md-contado').textContent=`$${contado.toFixed(2)}`;document.getElementById('md-abono').textContent=`$${abono.toFixed(2)}`;document.getElementById('md-retiro').textContent=`$${retiro.toFixed(2)}`;document.getElementById('md-pendiente').textContent=`$${pendiente.toFixed(2)}`;const maxVal=Math.max(contado+abono+retiro+pendiente,1);document.getElementById('bar-contado').style.width=`${(contado/maxVal)*100}%`;document.getElementById('bar-abono').style.width=`${(abono/maxVal)*100}%`;document.getElementById('bar-retiro').style.width=`${(retiro/maxVal)*100}%`;document.getElementById('bar-pendiente').style.width=`${(pendiente/maxVal)*100}%`;}
};
/* ----------  DATA SERVICE ---------- */
const DataService={
  async searchProducts(q){if(!AppState.firebaseInitialized)return[{id:'manual-'+Date.now(),codigo:'MANUAL',descripcion:q,precio:0,cantidad:1}];const cache=await ProductCache.search(q);if(!cache.length)cache.push({id:'manual-'+Date.now(),codigo:'MANUAL',descripcion:q,precio:0,cantidad:1});return cache;},
  async saveSale(sd){return ConcurrencyManager.withLock(async()=>{if(AppState.firebaseInitialized){const exists=await AppState.db.collection('VENTAS').where('invoiceNumber','==',sd.invoiceNumber).limit(1).get();if(!exists.empty)throw new Error(`Factura ${sd.invoiceNumber} ya existe`);const dr=await AppState.db.collection('VENTAS').add(sd);await DataService.updateSaleCounter(sd.date);if(sd.paymentType==='pendiente')await GrupoManager.actualizarDesdeVenta(sd);return dr.id;}throw new Error('Sin conexión');},'Guardar venta');},
  async updateSaleCounter(date=DateUtils.getCurrentDateStringElSalvador()){const ref=AppState.db.collection('COUNTERS').doc('sales');const doc=await ref.get();let c=0;if(doc.exists)c=doc.data()[date]||0;await ref.set({[date]:c+1,lastUpdate:new Date()},{merge:true});},
  async getSaleCounter(date=DateUtils.getCurrentDateStringElSalvador()){try{const ref=AppState.db.collection('COUNTERS').doc('sales');const doc=await ref.get();return doc.exists?(doc.data()[date]||0):0;}catch{const snap=await AppState.db.collection('VENTAS').where('date','==',date).get();return snap.size;}},
  async addAbono(invId,abonoData){return ConcurrencyManager.withLock(async()=>{const ref=AppState.db.collection('VENTAS').doc(invId),doc=await ref.get();if(!doc.exists)throw new Error('Venta no encontrada');const d=doc.data(),nuevoSaldo=(d.saldoPendiente||d.total)-abonoData.monto;if(nuevoSaldo<0)throw new Error('Abono excede saldo');await ref.update({abonos:firebase.firestore.FieldValue.arrayUnion(abonoData),saldoPendiente:nuevoSaldo,fechaActualizacion:DateUtils.getCurrentTimestampElSalvador()});if(nuevoSaldo<=0)await ref.update({paymentType:'contado',status:'pagado'});await GrupoManager.actualizarDesdeVenta(d);},'Abono');},
  async loadSales(limit=500){if(!AppState.firebaseInitialized)return[];const snap=await AppState.db.collection('VENTAS').orderBy('timestamp','desc').limit(limit).get();return snap.docs.map(d=>({id:d.id,...d.data()}));},
  async loadSalesByDate(date=DateUtils.getCurrentDateStringElSalvador(),limit=500){if(!AppState.firebaseInitialized)return[];const snap=await AppState.db.collection('VENTAS').where('date','==',date).orderBy('timestamp','desc').limit(limit).get();return snap.docs.map(d=>({id:d.id,...d.data()}));},
  async loadRetiros(limit=500){if(!AppState.firebaseInitialized)return[];const snap=await AppState.db.collection('RETIROS').orderBy('timestamp','desc').limit(limit).get();return snap.docs.map(d=>({id:d.id,...d.data()}));},
  async loadRetirosByDate(date=DateUtils.getCurrentDateStringElSalvador(),limit=500){if(!AppState.firebaseInitialized)return[];const snap=await AppState.db.collection('RETIROS').where('date','==',date).orderBy('timestamp','desc').limit(limit).get();return snap.docs.map(d=>({id:d.id,...d.data()}));},
  async saveRetiro(rd){return ConcurrencyManager.withLock(async()=>{if(AppState.firebaseInitialized){const dr=await AppState.db.collection('RETIROS').add(rd);return dr.id;}throw new Error('Sin conexión');},'Retiro');},
  async getSaleById(id){if(!AppState.firebaseInitialized)return null;const d=await AppState.db.collection('VENTAS').doc(id).get();return d.exists?{id:d.id,...d.data()}:null;},
  async deleteSale(id){return ConcurrencyManager.withLock(async()=>{if(AppState.firebaseInitialized)await AppState.db.collection('VENTAS').doc(id).delete();},'Delete venta');},
  async cancelInvoice(id){return ConcurrencyManager.withLock(async()=>{const ref=AppState.db.collection('VENTAS').doc(id);await ref.update({paymentType:'contado',status:'pagado',saldoPendiente:0,cancelada:true,fechaCancelacion:new Date(),fechaActualizacion:DateUtils.getCurrentTimestampElSalvador()});},'Cancelar');},
  async loadAllMovements(limit=500){const[v,r]=await Promise.all([DataService.loadSales(limit),DataService.loadRetiros(limit)]);const all=[...v.map(x=>({...x,tipo:'venta'})),...r.map(x=>({...x,tipo:'retiro'}))];return all.sort((a,b)=>{const da=a.timestamp?.toDate?a.timestamp.toDate():a.timestamp;const db=b.timestamp?.toDate?b.timestamp.toDate():b.timestamp;return db-da;}).slice(0,limit);}
};
/* ----------  PRODUCT CACHE ---------- */
const ProductCache={
  data:new Map(),lastUpdate:0,ttl:10*60*1000,unsub:null,
  async initialize(){if(!AppState.firebaseInitialized)return;const invSnap=await AppState.db.collection('INVENTARIO').get(),provSnap=await AppState.db.collection('INVENTARIO_PROVICIONAL').get();this.data.clear();invSnap.forEach(d=>this.data.set(d.id,{id:d.id,...d.data()}));provSnap.forEach(d=>this.data.set(d.id,{id:d.id,...d.data()}));this.lastUpdate=Date.now();this.setupListener();},
  setupListener(){if(!AppState.firebaseInitialized)return;this.unsub=[AppState.db.collection('INVENTARIO').onSnapshot(s=>{s.docChanges().forEach(c=>{if(c.type==='added'||c.type==='modified')this.data.set(c.doc.id,{id:c.doc.id,...c.doc.data()});else this.data.delete(c.doc.id);});this.lastUpdate=Date.now();}),AppState.db.collection('INVENTARIO_PROVICIONAL').onSnapshot(s=>{s.docChanges().forEach(c=>{if(c.type==='added'||c.type==='modified')this.data.set(c.doc.id,{id:c.doc.id,...c.doc.data()});else this.data.delete(c.doc.id);});this.lastUpdate=Date.now();})];},
  search(q){const res=[],qq=q.toLowerCase().trim();if(!qq)return res;this.data.forEach(p=>{const c=(p.codigo||'').toLowerCase(),d=(p.descripcion||'').toLowerCase();if(c.includes(qq)||d.includes(qq))res.push(p);});return res.slice(0,10);}
};
/* ----------  GRUPO MANAGER ---------- */
const GrupoManager={
  grupos:new Map(),equiposPendientes:new Map(),currentEditingGroup:null,currentGrupoDetalle:null,unsub:null,
  async initialize(){await this.loadGrupos();await this.loadEquiposPendientes();this.setupRealTimeListener();this.updateUI();},
  setupRealTimeListener(){if(!AppState.firebaseInitialized)return;this.unsub=AppState.db.collection('VENTAS').where('paymentType','==','pendiente').where('status','==','pendiente').onSnapshot(async()=>{await this.loadEquiposPendientes();await this.actualizarTotalesGrupos();this.updateUI();},e=>console.error('RT listener error:',e));},
  async loadGrupos(){if(!AppState.firebaseInitialized)return;const snap=await AppState.db.collection('GRUPOS').get();this.grupos.clear();snap.forEach(d=>this.grupos.set(d.id,{id:d.id,...d.data()}));await this.actualizarTotalesGrupos();},
  async loadEquiposPendientes(){if(!AppState.firebaseInitialized)return;const snap=await AppState.db.collection('VENTAS').where('paymentType','==','pendiente').where('status','==','pendiente').get();this.equiposPendientes.clear();snap.forEach(d=>{const v=d.data(),en=v.equipoNumber||'',cl=v.clientName||'';let sp=v.total||0;if(v.abonos&&v.abonos.length)sp=v.total-v.abonos.reduce((s,a)=>s+a.monto,0);if(en&&sp>0){const k=`${en}-${cl}`;if(!this.equiposPendientes.has(k))this.equiposPendientes.set(k,{numero:en,cliente:cl,total:0,facturas:[]});const eq=this.equiposPendientes.get(k);eq.facturas.push({id:d.id,...v,saldoPendiente:sp});eq.total+=sp;}});},
  async actualizarTotalesGrupos(){for(const[gId,g]of this.grupos.entries()){let nt=0;for(const en of g.equipos){this.equiposPendientes.forEach(eq=>{if(eq.numero===en)nt+=eq.total;});}if(g.total!==nt){g.total=nt;if(AppState.firebaseInitialized){await AppState.db.collection('GRUPOS').doc(gId).update({total:nt,fechaActualizacion:new Date()});}}}},
  async crearGrupo(nombre,equiposSeleccionados){if(!AppState.firebaseInitialized)throw new Error('Sin conexión');const equiposConFacturas=equiposSeleccionados.filter(en=>{let tiene=false;this.equiposPendientes.forEach(eq=>{if(eq.numero===en&&eq.total>0)tiene=true;});return tiene;});if(!equiposConFacturas.length)throw new Error('Equipos sin facturas pendientes');let nt=0;equiposConFacturas.forEach(en=>{this.equiposPendientes.forEach(eq=>{if(eq.numero===en)nt+=eq.total;});});const gData={nombre,equipos:equiposConFacturas,total:nt,fechaCreacion:new Date(),activo:true};const dr=await AppState.db.collection('GRUPOS').add(gData);gData.id=dr.id;this.grupos.set(dr.id,gData);for(const en of equiposConFacturas){this.equiposPendientes.forEach(async eq=>{if(eq.numero===en){for(const f of eq.facturas)await AppState.db.collection('VENTAS').doc(f.id).update({grupo:dr.id,grupoNombre:nombre});}});}await this.loadEquiposPendientes();await this.actualizarTotalesGrupos();this.updateUI();return dr.id;},
  async eliminarGrupo(gId){if(!confirm('¿Está seguro de eliminar este grupo?'))return;try{UIService.showLoading(true);const g=this.grupos.get(gId);if(g){for(const en of g.equipos){this.equiposPendientes.forEach(async eq=>{if(eq.numero===en){for(const f of eq.facturas)await AppState.db.collection('VENTAS').doc(f.id).update({grupo:firebase.firestore.FieldValue.delete(),grupoNombre:firebase.firestore.FieldValue.delete()});}});}}await AppState.db.collection('GRUPOS').doc(gId).delete();this.grupos.delete(gId);await this.loadEquiposPendientes();await this.actualizarTotalesGrupos();this.updateUI();UIService.showStatus('Grupo eliminado','success');}catch(e){UIService.showStatus('Error al eliminar grupo: '+e.message,'error');}finally{UIService.showLoading(false);}},
  getEquiposSinGrupo(){const sin=new Map();this.equiposPendientes.forEach((eq,k)=>{let tiene=false;this.grupos.forEach(g=>{if(g.equipos.includes(eq.numero))tiene=true;});if(!tiene&&eq.total>0)sin.set(k,eq);});return sin;},
  updateUI(){this.renderEquiposIndividuales();this.renderGruposVisual();},
  renderEquiposIndividuales(){const cont=document.getElementById('equipos-individuales'),empty=document.getElementById('empty-equipos');const sin=this.getEquiposSinGrupo();if(!sin.size){empty.style.display='block';cont.innerHTML='';return;}empty.style.display='none';const ordenados=Array.from(sin.entries()).sort((a,b)=>parseInt(a[0].split('-')[0])-parseInt(b[0].split('-')[0]));let html='';ordenados.forEach(([k,eq])=>{const mostrar=eq.cliente&&!eq.cliente.startsWith('Equipo ');html+=`<div class="equipo-card" onclick="GrupoManager.mostrarDetalleEquipo('${k}')"><div class="equipo-number">${eq.numero}</div>${mostrar?`<div class="equipo-nombre">${eq.cliente}</div>`:''}<div class="equipo-total">$${eq.total.toFixed(2)}</div></div>`;});cont.innerHTML=html;},
  renderGruposVisual(){const cont=document.getElementById('grupos-container');if(!this.grupos.size){cont.innerHTML='<div class="empty-state"><i class="fas fa-users"></i><div>No hay grupos creados</div></div>';return;} const ordenados=Array.from(this.grupos.values()).filter(g=>g.activo).sort((a,b)=>a.nombre.localeCompare(b.nombre));let html='';ordenados.forEach(g=>{let eqs='';g.equipos.forEach(en=>{let eqEn=null;this.equiposPendientes.forEach(eq=>{if(eq.numero===en&&eq.total>0)eqEn=eq;});if(eqEn){eqs+=`<div class="grupo-equipo-item" onclick="GrupoManager.mostrarDetalleEquipo('${eqEn.numero}-${eqEn.cliente}')"><div class="grupo-equipo-number">${eqEn.numero}</div><div class="grupo-equipo-total">$${eqEn.total.toFixed(2)}</div></div>`;}});html+=`<div class="grupo-card"><div class="grupo-actions"><button class="grupo-action-btn btn-detalle-grupo" onclick="GrupoManager.mostrarDetalleGrupoCompleto('${g.id}')" title="Ver detalles"><i class="fas fa-eye"></i></button><button class="grupo-action-btn btn-edit-grupo" onclick="GrupoManager.editarGrupo('${g.id}')" title="Editar grupo"><i class="fas fa-edit"></i></button><button class="grupo-action-btn btn-delete-grupo" onclick="eliminarGrupo('${g.id}')" title="Eliminar grupo"><i class="fas fa-trash"></i></button><button class="grupo-action-btn btn-abono" onclick="GrupoManager.registrarAbonoGrupo('${g.id}')" title="Abonar grupo"><i class="fas fa-money-bill-wave"></i></button></div><div class="grupo-header"><div class="grupo-name">${g.nombre}</div></div><div class="grupo-equipos-grid">${eqs}</div><div class="grupo-total">Total: $${g.total.toFixed(2)}</div></div>`;});cont.innerHTML=html;},
  async mostrarDetalleEquipo(key){const eq=this.equiposPendientes.get(key);if(!eq)return; let facturasHTML='';eq.facturas.forEach(f=>{const prod=f.products?f.products.map(p=>`<div class="producto-item"><span>${(p.descripcion.length>25?p.descripcion.slice(0,25)+'…':p.descripcion)} x${p.cantidad}</span><span>$${(p.precio*p.cantidad).toFixed(2)}</span></div>`).join(''):'';const sp=f.saldoPendiente!==undefined?f.saldoPendiente:f.total;const abonos=f.abonos&&f.abonos.length?f.abonos.map(a=>`<div style=font-size:.7rem;color:#666;margin-left:10px>Abono: $${a.monto.toFixed(2)} (${new Date(a.fecha.toDate?a.fecha.toDate():a.fecha).toLocaleDateString('es-ES')})</div>`).join(''):'';facturasHTML+=`<div class="factura-item"><div><strong>Factura:</strong> ${f.invoiceNumber}</div><div><strong>Total:</strong> $${f.total.toFixed(2)}</div>${abonos?`<div><strong>Saldo Pendiente:</strong> $${sp.toFixed(2)}</div>`:''}<div><strong>Productos:</strong></div>${prod||'<p>Sin productos</p>'}${abonos}</div>`;});const modalContent=`<h3 style="margin-bottom:15px;text-align:center">Detalles del Equipo ${eq.numero}</h3><div class="detalle-equipo"><div><strong>Grupo:</strong> ${eq.cliente}</div><div><strong>Total Pendiente:</strong> $${eq.total.toFixed(2)}</div><div><strong>Número de Facturas:</strong> ${eq.facturas.length}</div></div><div class="grupo-facturas"><h4>Facturas Pendientes:</h4>${facturasHTML||'<p>No hay facturas pendientes para este equipo</p>'}</div>`;document.getElementById('detalle-modal-content').innerHTML=modalContent;document.getElementById('detalle-modal').style.display='block';AppState.currentDetalle={tipo:'equipo',data:key};},
  async mostrarDetalleGrupoCompleto(gId){const g=this.grupos.get(gId);if(!g)return;this.currentGrupoDetalle=g; let equiposHTML='',totG=0,totPend=0,cantF=0,tieneAbonos=false;for(const en of g.equipos){let eqEn=null;this.equiposPendientes.forEach(eq=>{if(eq.numero===en&&eq.total>0)eqEn=eq;});if(eqEn){totG+=eqEn.total;cantF+=eqEn.facturas.length;let facturasHTML='';eqEn.facturas.forEach(f=>{const sp=f.saldoPendiente!==undefined?f.saldoPendiente:f.total;totPend+=sp;if(f.abonos&&f.abonos.length)tieneAbonos=true;const prod=f.products?f.products.map(p=>`<div class="producto-item"><span>${(p.descripcion.length>25?p.descripcion.slice(0,25)+'…':p.descripcion)} x${p.cantidad}</span><span>$${(p.precio*p.cantidad).toFixed(2)}</span></div>`).join(''):'';facturasHTML+=`<div class="grupo-detalle-factura"><div><strong>Factura:</strong> ${f.invoiceNumber}</div><div><strong>Fecha:</strong> ${new Date(f.timestamp.toDate?f.timestamp.toDate():f.timestamp).toLocaleDateString('es-ES')}</div><div><strong>Total:</strong> $${f.total.toFixed(2)}</div>${f.abonos&&f.abonos.length?`<div><strong>Saldo Pendiente:</strong> $${sp.toFixed(2)}</div>`:''}<div><strong>Productos:</strong></div>${prod||'<p>Sin productos</p>'}</div>`;});equiposHTML+=`<div class="grupo-detalle-equipo"><h4>Equipo ${eqEn.numero} - ${eqEn.cliente}</h4><div><strong>Total:</strong> $${eqEn.total.toFixed(2)}</div><div><strong>Facturas:</strong> ${eqEn.facturas.length}</div>${facturasHTML}</div>`;}}const modalContent=`<h3 style="margin-bottom:15px;text-align:center">${g.nombre} - Detalles Completos</h3><div class="grupo-resumen"><div><strong>Total del Grupo:</strong> $${totG.toFixed(2)}</div>${tieneAbonos?`<div><strong>Saldo Pendiente:</strong> $${totPend.toFixed(2)}</div>`:''}<div><strong>Número de Equipos:</strong> ${g.equipos.length}</div><div><strong>Total de Facturas:</strong> ${cantF}</div></div><div class="grupo-facturas"><h4>Detalles por Equipo:</h4>${equiposHTML||'<p>No hay equipos con facturas pendientes en este grupo</p>'}</div>`;document.getElementById('grupo-detalle-modal-content').innerHTML=modalContent;document.getElementById('grupo-detalle-modal').style.display='block';},
  imprimirGrupoCompleto(){const g=this.currentGrupoDetalle;if(!g)return; g.equipos.forEach(en=>{let eqEn=null;this.equiposPendientes.forEach(eq=>{if(eq.numero===en)eqEn=eq;});if(eqEn)eqEn.facturas.forEach(f=>this.imprimirTicketFactura(f,eqEn));});},
  imprimirTicketFactura(f,eq){const pw=window.open('','_blank');const fecha=new Date(f.timestamp.toDate?f.timestamp.toDate():f.timestamp).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});const sp=f.saldoPendiente!==undefined?f.saldoPendiente:f.total;const tieneAb=f.abonos&&f.abonos.length;const tipo=tieneAb&&sp>0?'PENDIENTE':'CONTADO';const prod=f.products?f.products.map(p=>`<div class="ticket-producto"><span>${(p.descripcion.length>25?p.descripcion.slice(0,25)+'…':p.descripcion)} x${p.cantidad}</span><span>$${(p.precio*p.cantidad).toFixed(2)}</span></div>`).join(''):'';let abonosHTML='';if(tieneAb){f.abonos.forEach(a=>{const fa=new Date(a.fecha.toDate?a.fecha.toDate():a.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});abonosHTML+=`<div class="ticket-producto"><span>ABONO: $${a.monto.toFixed(2)} (${fa})</span></div>`;});}pw.document.write(`<!DOCTYPE html><html><head><style>body{font-family:'Courier New',monospace;font-size:20px;margin:0;padding:6px;width:58mm;font-weight:bold}.header{text-align:center;margin-bottom:8px}.line{border-bottom:2px dashed #000;margin:4px 0}.ticket-equipo{font-size:32px!important;font-weight:bold;text-align:center;margin:6px 0}.ticket-producto{font-size:16px!important;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted #000}.ticket-total{font-size:24px!important;text-align:center;margin-top:8px;font-weight:bold}.ticket-footer{text-align:center;margin-top:10px;font-size:16px!important;font-weight:bold}</style></head><body><div class="header"><h3 class="ticket-equipo">EQUIPO ${eq.numero}</h3><div>Factura: ${f.invoiceNumber}</div><div>${fecha}, ${tipo}</div></div><div class="line"></div><div><strong>Grupo:</strong> ${eq.cliente}</div><div class="line"></div>${prod}${abonosHTML}<div class="line"></div><div class="ticket-total">TOTAL: $${f.total.toFixed(2)}</div>${tieneAb&&sp>0?`<div style="background:#f0f0f0;padding:8px;margin:8px 0;border-radius:4px"><div>SALDO PENDIENTE:</div><div class="ticket-total">$${sp.toFixed(2)}</div></div>`:''}<div class="ticket-footer">GRACIAS POR PREFERIRNOS</div></body></html>`);pw.document.close();pw.focus();setTimeout(()=>{pw.print();setTimeout(()=>pw.close(),500);},500);},
  async registrarAbonoGrupo(gId){const g=this.grupos.get(gId);if(!g){UIService.showStatus('Grupo no encontrado','error');return;} let totalGrupo=g.total;const pw=window.open('','_blank');const fecha=DateUtils.getCurrentTimestampElSalvador().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});const modalContent=`<h3 style="margin-bottom:15px;text-align:center">Abonar a Grupo ${g.nombre}</h3><div style="margin-bottom:15px;background:#f8f9fa;padding:15px;border-radius:6px"><div><strong>Total pendiente del grupo:</strong> $${totalGrupo.toFixed(2)}</div></div><div class="form-group"><label for="monto-abono-grupo">Monto del Abono:</label><input type="number" id="monto-abono-grupo" step="0.01" min="0.01" placeholder="0.00" style="font-size:1.2rem;text-align:center;font-weight:bold"></div><div style="display:flex;gap:10px;margin-top:15px"><button class="btn btn-success" id="process-abono-grupo-btn" style="flex:1"><i class="fas fa-check"></i> PROCESAR ABONO GRUPO</button><button class="btn btn-danger" onclick="ModalService.closeAbonoGrupoModal()" style="flex:1"><i class="fas fa-times"></i> CANCELAR</button></div>`;document.getElementById('abono-modal-content').innerHTML=modalContent;document.getElementById('abono-modal').style.display='block';document.getElementById('monto-abono-grupo').focus();document.getElementById('process-abono-grupo-btn').onclick=async()=>{const monto=parseFloat(document.getElementById('monto-abono-grupo').value)||0;if(!monto||monto<=0){UIService.showStatus('Ingrese monto válido','error');return;} if(monto>totalGrupo){UIService.showStatus('El abono no puede ser mayor al total del grupo','error');return;} try{UIService.showLoading(true);const abonoData={monto,fecha:DateUtils.getCurrentTimestampElSalvador(),fechaString:DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES'),tipo:'grupo',grupoId:g.id,grupoNombre:g.nombre};for(const en of g.equipos){this.equiposPendientes.forEach(async eq=>{if(eq.numero===en){for(const f of eq.facturas){const ref=AppState.db.collection('VENTAS').doc(f.id);const doc=await ref.get();if(doc.exists){const d=doc.data();const nuevoSaldo=(d.saldoPendiente||d.total)-abonoData.monto;if(nuevoSaldo<0)continue;await ref.update({abonos:firebase.firestore.FieldValue.arrayUnion(abonoData),saldoPendiente:nuevoSaldo,fechaActualizacion:DateUtils.getCurrentTimestampElSalvador()});if(nuevoSaldo<=0)await ref.update({paymentType:'contado',status:'pagado'});}}}});}this.imprimirAbonoGrupoTicket(g,abonoData,totalGrupo-monto);UIService.showStatus(`Abono de $${monto.toFixed(2)} al grupo ${g.nombre} registrado`,'success');ModalService.closeAbonoModal();await this.loadEquiposPendientes();await this.actualizarTotalesGrupos();this.updateUI();}catch(e){UIService.showStatus('Error al abonar grupo: '+e.message,'error');}finally{UIService.showLoading(false);}};},
  imprimirAbonoGrupoTicket(g,abonoData,nuevoSaldo){const pw=window.open('','_blank');const fecha=new Date(abonoData.fecha.toDate?abonoData.fecha.toDate():abonoData.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});pw.document.write(`<!DOCTYPE html><html><head><style>body{font-family:'Courier New',monospace;font-size:20px;margin:0;padding:6px;width:58mm;font-weight:bold}.header{text-align:center;margin-bottom:8px}.line{border-bottom:2px dashed #000;margin:4px 0}.ticket-equipo{font-size:32px!important;font-weight:bold;text-align:center;margin:6px 0}.ticket-producto{font-size:16px!important;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted #000}.ticket-total{font-size:24px!important;text-align:center;margin-top:8px;font-weight:bold}.ticket-footer{text-align:center;margin-top:10px;font-size:16px!important;font-weight:bold}</style></head><body><div class="header"><h3 class="ticket-equipo">ABONO GRUPO</h3><div>Grupo: ${g.nombre}</div><div>${fecha}</div></div><div class="line"></div><div class="ticket-producto"><span>MONTO ABONADO:</span><span>$${abonoData.monto.toFixed(2)}</span></div><div class="line"></div><div class="ticket-total">NUEVO SALDO: $${nuevoSaldo.toFixed(2)}</div><div class="ticket-footer">GRACIAS POR PREFERIRNOS</div></body></html>`);pw.document.close();pw.focus();setTimeout(()=>{pw.print();setTimeout(()=>pw.close(),500);},500);},
  async editarGrupo(gId){const g=this.grupos.get(gId);if(!g){UIService.showStatus('Grupo no encontrado','error');return;} this.currentEditingGroup=g;AppState.equiposEditSeleccionados=new Set(g.equipos);document.getElementById('editar-nombre-grupo').value=g.nombre;this.generarGridEquipos('editar');this.actualizarListaSeleccionados('editar');document.getElementById('editar-grupo-modal').style.display='block';},
  generarGridEquipos(modalType='crear'){const grid=document.getElementById(modalType==='crear'?'all-equipos-grid':'editar-all-equipos-grid');const enGrupos=new Set();this.grupos.forEach(g=>g.equipos.forEach(en=>enGrupos.add(en)));const selectedSet=modalType==='crear'?AppState.equiposSeleccionados:AppState.equiposEditSeleccionados;let html='';for(let i=1;i<=130;i++){const en=i.toString();let eqEn=null;this.equiposPendientes.forEach(eq=>{if(eq.numero===en&&eq.total>0)eqEn=eq;});const tiene=eqEn&&eqEn.facturas.length>0;const sel=selectedSet.has(en);const enOtro=enGrupos.has(en)&&(modalType==='crear'||(modalType==='editar'&&this.currentEditingGroup&&!this.currentEditingGroup.equipos.includes(en)));let est='';if(enOtro)est='equipo-en-grupo';else if(tiene)est='has-facturas';html+=`<div class="all-equipo-item ${est} ${sel?'selected':''}" onclick="${enOtro?'':`toggleEquipoGrid('${en}','${modalType}')`}" style="${tiene&&!enOtro?'border-color:#27ae60;background:#f0fff0':''}${enOtro?'border-color:#e74c3c;background:#f8d7da;color:#721c24;cursor:not-allowed':''}">${i}${tiene?'<br><small style=color:#27ae60>$'+eqEn.total.toFixed(2)+'</small>':''}${enOtro?'<br><small style=color:#e74c3c;font-size:.6rem>EN GRUPO</small>':''}</div>`;}grid.innerHTML=html;},
  actualizarListaSeleccionados(modalType='crear'){const lista=document.getElementById(modalType==='crear'?'selected-equipos-list':'editar-selected-equipos-list');const cont=document.getElementById(modalType==='crear'?'contador-equipos':'editar-contador-equipos');const selectedSet=modalType==='crear'?AppState.equiposSeleccionados:AppState.equiposEditSeleccionados;cont.textContent=selectedSet.size;if(!selectedSet.size){lista.innerHTML='<div style=color:#999;text-align:center;font-size:.8rem>No hay equipos seleccionados</div>';return;} const ordenados=Array.from(selectedSet).sort((a,b)=>parseInt(a)-parseInt(b));let badges='';ordenados.forEach(en=>{let eqEn=null;this.equiposPendientes.forEach(eq=>{if(eq.numero===en&&eq.total>0)eqEn=eq;});if(eqEn)badges+=`<span class="selected-equipo-badge">${en} ($${eqEn.total.toFixed(2)})</span>`;else badges+=`<span class="selected-equipo-badge" style=background:#95a5a6>${en} ($0.00)</span>`;});lista.innerHTML=badges;},
  async actualizarDesdeVenta(ventaData){if(ventaData.paymentType==='pendiente'&&ventaData.status==='pendiente'){const en=ventaData.equipoNumber;if(en){await this.loadEquiposPendientes();await this.actualizarTotalesGrupos();this.updateUI();}}}
};
/* ----------  SALES SERVICE ---------- */
const SalesService={
  addToCart(p){AppState.cart.push({id:p.id,codigo:p.codigo||'MANUAL',descripcion:p.descripcion||'Sin descripción',precio:p.precio||0,cantidad:1});UIService.updateCartDisplay();UIService.showStatus('Producto agregado','success');},
  addManualProduct(q){if(!q.trim()){UIService.showStatus('Ingrese descripción','error');return;} this.addToCart({id:'manual-'+Date.now(),codigo:'MANUAL',descripcion:q,precio:0,cantidad:1});},
  removeFromCart(ix){AppState.cart.splice(ix,1);UIService.updateCartDisplay();UIService.showStatus('Producto eliminado','info');},
  updateQuantity(ix,v){const cant=parseInt(v)||1;if(cant<1){UIService.showStatus('Cantidad mínima 1','error');AppState.cart[ix].cantidad=1;}else AppState.cart[ix].cantidad=cant;UIService.updateCartDisplay();},
  updatePrice(ix,v){const prec=parseFloat(v)||0;if(prec<0){UIService.showStatus('Precio no puede ser negativo','error');AppState.cart[ix].precio=0;}else AppState.cart[ix].precio=prec;UIService.updateCartDisplay();},
  async generateInvoiceNumber(){const fv=document.getElementById('fecha-venta').value;const date=fv||DateUtils.getCurrentDateStringElSalvador();const datePart=date.replace(/-/g,'').substring(2);const c=await DataService.getSaleCounter(date);const cnt=(c+1).toString().padStart(4,'0');AppState.currentInvoiceNumber=datePart+cnt;return AppState.currentInvoiceNumber;},
  validateSaleData(en,cl,fv){if(!en.trim())throw new Error('Equipo obligatorio');if(!/^\d+$/.test(en.trim()))throw new Error('Equipo solo números');if(!fv)throw new Error('Seleccione fecha');if(DateUtils.isFutureDateInElSalvador(fv)){if(!confirm('La fecha es futura. ¿Confirma?'))throw new Error('Fecha futura no confirmada');}const prodCero=AppState.cart.filter(it=>it.precio===0);if(prodCero.length)throw new Error('Hay productos con precio $0.00');const invP=AppState.cart.filter(it=>it.precio<0||!isFinite(it.precio));if(invP.length)throw new Error('Hay precios inválidos');return true;},
  async processSale(tipoPago){if(AppState.processingSale){UIService.showStatus('Venta en proceso','error');return;} if(!AppState.cart.length){UIService.showStatus('Carrito vacío','error');return;} const en=document.getElementById('equipo').value.trim(),cl=document.getElementById('cliente').value.trim(),fv=document.getElementById('fecha-venta').value;try{this.validateSaleData(en,cl,fv);const clienteFinal=cl||`Equipo ${en}`;const equipoFinal=en||'0000';const total=AppState.cart.reduce((s,it)=>s+(it.precio*it.cantidad),0);if(total>1000&&!confirm(`¿Confirma venta por $${total.toFixed(2)}?`))return;AppState.processingSale=true;UIService.showLoading(true);if(tipoPago==='contado')await this.procesarVentaContado(equipoFinal,clienteFinal,fv,total);else if(tipoPago==='pendiente')this.mostrarConfirmacionAbono(equipoFinal,clienteFinal,total,fv);}catch(e){UIService.showStatus('Error: '+e.message,'error');}finally{AppState.processingSale=false;UIService.showLoading(false);}},
  mostrarConfirmacionAbono(en,cl,total,fv){AppState.datosVentaPendiente={equipo:en,cliente:cl,totalVenta:total,fechaVenta:fv};document.getElementById('confirmacion-total').textContent=total.toFixed(2);document.getElementById('confirmacion-equipo').textContent=en;document.getElementById('confirmacion-cliente').textContent=cl||`Equipo ${en}`;document.getElementById('confirmacion-abono-modal').style.display='block';},
  async procesarVentaContado(en,cl,fv,total){try{const inv=await this.generateInvoiceNumber();const sd={invoiceNumber:inv,equipoNumber:en,clientName:cl,products:AppState.cart.map(it=>({id:it.id,codigo:it.codigo,descripcion:it.descripcion,precio:it.precio,cantidad:it.cantidad})),total,paymentType:'contado',timestamp:DateUtils.getCurrentTimestampElSalvador(),date:fv,status:'pagado',fechaCreacion:DateUtils.getCurrentTimestampElSalvador()};await DataService.saveSale(sd);this.printTicket(sd);UIService.showStatus(`Venta CONTADO #${inv} guardada`,'success');this.limpiarFormularioVenta();await ProductCache.initialize();await this.loadHistorial();}catch(e){UIService.showStatus('Error contado: '+e.message,'error');}},
  async procesarVentaPendienteSinAbono(en,cl,fv,total){try{const inv=await this.generateInvoiceNumber();const sd={invoiceNumber:inv,equipoNumber:en,clientName:cl,products:AppState.cart.map(it=>({id:it.id,codigo:it.codigo,descripcion:it.descripcion,precio:it.precio,cantidad:it.cantidad})),total,paymentType:'pendiente',timestamp:DateUtils.getCurrentTimestampElSalvador(),date:fv,status:'pendiente',saldoPendiente:total,abonos:[],fechaCreacion:DateUtils.getCurrentTimestampElSalvador()};await DataService.saveSale(sd);this.printTicket(sd);UIService.showStatus(`Venta PENDIENTE #${inv} guardada`,'success');this.limpiarFormularioVenta();await ProductCache.initialize();await this.loadHistorial();}catch(e){UIService.showStatus('Error pendiente: '+e.message,'error');}},
  async procesarVentaPendienteConAbono(en,cl,fv,total,montoAbono){try{const inv=await this.generateInvoiceNumber();const saldoPend=total-montoAbono;const abonoData={monto:montoAbono,fecha:DateUtils.getCurrentTimestampElSalvador(),fechaString:DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES')};const sd={invoiceNumber:inv,equipoNumber:en,clientName:cl,products:AppState.cart.map(it=>({id:it.id,codigo:it.codigo,descripcion:it.descripcion,precio:it.precio,cantidad:it.cantidad})),total,paymentType:saldoPend<=0?'contado':'pendiente',timestamp:DateUtils.getCurrentTimestampElSalvador(),date:fv,status:saldoPend<=0?'pagado':'pendiente',saldoPendiente:saldoPend,abonos:[abonoData],fechaCreacion:DateUtils.getCurrentTimestampElSalvador()};await DataService.saveSale(sd);this.printTicket(sd);if(montoAbono>0)this.printAbonoTicket(sd,abonoData,saldoPend);UIService.showStatus(`Venta con abono #${inv} guardada`,'success');this.limpiarFormularioVenta();await ProductCache.initialize();await this.loadHistorial();}catch(e){UIService.showStatus('Error venta+abono: '+e.message,'error');}},
  mostrarModalAbonoInicial(en,cl,total,fv){AppState.datosVentaPendiente={equipo:en,cliente:cl,totalVenta:total,fechaVenta:fv};document.getElementById('abono-modal-total').textContent=total.toFixed(2);document.getElementById('abono-modal-equipo').textContent=en;document.getElementById('abono-modal-cliente').textContent=cl||`Equipo ${en}`;document.getElementById('monto-abono-inicial').value='';document.getElementById('saldo-despues-abono').textContent='$'+total.toFixed(2);document.getElementById('abono-inicial-modal').style.display='block';document.getElementById('monto-abono-inicial').focus();},
  limpiarFormularioVenta(){AppState.cart=[];UIService.updateCartDisplay();document.getElementById('equipo').value='';document.getElementById('cliente').value='';document.getElementById('buscar-producto').value='';delete AppState.datosVentaPendiente;},
  printTicket(sd){const pw=window.open('','_blank');const fecha=new Date(sd.timestamp.toDate?sd.timestamp.toDate():sd.timestamp).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});const sp=sd.saldoPendiente!==undefined?sd.saldoPendiente:sd.total;const tieneAb=sd.abonos&&sd.abonos.length;const tipo=sd.paymentType==='pendiente'?'PENDIENTE':'CONTADO';const prod=sd.products?sd.products.map(p=>`<div class="ticket-producto"><span>${(p.descripcion.length>25?p.descripcion.slice(0,25)+'…':p.descripcion)} x${p.cantidad}</span><span>$${(p.precio*p.cantidad).toFixed(2)}</span></div>`).join(''):'';let abonosHTML='';if(tieneAb){sd.abonos.forEach(a=>{const fa=new Date(a.fecha.toDate?a.fecha.toDate():a.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});abonosHTML+=`<div class="ticket-producto"><span>ABONO: $${a.monto.toFixed(2)} (${fa})</span></div>`;});}pw.document.write(`<!DOCTYPE html><html><head><style>body{font-family:'Courier New',monospace;font-size:20px;margin:0;padding:6px;width:58mm;font-weight:bold}.header{text-align:center;margin-bottom:8px}.line{border-bottom:2px dashed #000;margin:4px 0}.ticket-equipo{font-size:32px!important;font-weight:bold;text-align:center;margin:6px 0}.ticket-producto{font-size:16px!important;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted #000}.ticket-total{font-size:24px!important;text-align:center;margin-top:8px;font-weight:bold}.ticket-footer{text-align:center;margin-top:10px;font-size:16px!important;font-weight:bold}</style></head><body><div class="header"><h3 class="ticket-equipo">EQUIPO ${sd.equipoNumber}</h3><div>Factura: ${sd.invoiceNumber}</div><div>${fecha}, ${tipo}</div></div><div class="line"></div><div><strong>Grupo:</strong> ${sd.clientName}</div><div class="line"></div>${prod}${abonosHTML}<div class="line"></div><div class="ticket-total">TOTAL: $${sd.total.toFixed(2)}</div>${sd.paymentType==='pendiente'&&sp>0?`<div style="background:#f0f0f0;padding:8px;margin:8px 0;border-radius:4px"><div>SALDO PENDIENTE:</div><div class="ticket-total">$${sp.toFixed(2)}</div></div>`:''}<div class="ticket-footer">GRACIAS POR PREFERIRNOS</div></body></html>`);pw.document.close();pw.focus();setTimeout(()=>{pw.print();setTimeout(()=>pw.close(),500);},500);},
  printAbonoTicket(venta,abonoData,nuevoSaldo){const pw=window.open('','_blank');const fecha=new Date(abonoData.fecha.toDate?abonoData.fecha.toDate():abonoData.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'});pw.document.write(`<!DOCTYPE html><html><head><style>body{font-family:'Courier New',monospace;font-size:20px;margin:0;padding:6px;width:58mm;font-weight:bold}.header{text-align:center;margin-bottom:8px}.line{border-bottom:2px dashed #000;margin:4px 0}.ticket-equipo{font-size:32px!important;font-weight:bold;text-align:center;margin:6px 0}.ticket-producto{font-size:16px!important;display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted #000}.ticket-total{font-size:24px!important;text-align:center;margin-top:8px;font-weight:bold}.ticket-footer{text-align:center;margin-top:10px;font-size:16px!important;font-weight:bold}</style></head><body><div class="header"><h3 class="ticket-equipo">ABONO</h3><div>Factura: ${venta.invoiceNumber}</div><div>Equipo: ${venta.equipoNumber}</div><div>${fecha}</div></div><div class="line"></div><div class="ticket-producto"><span>MONTO ABONADO:</span><span>$${abonoData.monto.toFixed(2)}</span></div><div class="line"></div><div class="ticket-total">NUEVO SALDO: $${nuevoSaldo.toFixed(2)}</div><div class="ticket-footer">GRACIAS POR PREFERIRNOS</div></body></html>`);pw.document.close();pw.focus();setTimeout(()=>{pw.print();setTimeout(()=>pw.close(),500);},500);},
  async loadHistorial(){try{UIService.showLoading(true);const movs=await DataService.loadAllMovements(500);UIService.updateHistorial(movs);}catch(e){UIService.showStatus('Error historial: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async viewInvoice(id){let v=AppState.historial.find(x=>x.id===id&&x.tipo==='venta');if(!v)v=await DataService.getSaleById(id);if(!v)return;const prod=v.products?v.products.map(p=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #eee"><span>${(p.descripcion.length>25?p.descripcion.slice(0,25)+'…':p.descripcion)} (x${p.cantidad})</span><span>$${(p.precio*p.cantidad).toFixed(2)}</span></div>`).join(''):'';const sp=v.saldoPendiente!==undefined?v.saldoPendiente:v.total;const abonos=v.abonos&&v.abonos.length?`<div class="abono-section"><h4>Historial de Abonos:</h4>${v.abonos.map(a=>`<div class="abono-item"><div>${new Date(a.fecha.toDate?a.fecha.toDate():a.fecha).toLocaleString('es-ES')}</div><div>$${a.monto.toFixed(2)}</div></div>`).join('')}</div>`:'';const estadoReal=v.paymentType;if(v.paymentType==='pendiente'&&sp<=0)estadoReal='contado';const tipo=estadoReal==='contado'?'CONTADO':'PENDIENTE';const modalContent=`<h3 style="margin-bottom:15px;text-align:center">Factura #${v.invoiceNumber}</h3><div class="invoice-details"><strong>Grupo:</strong> ${v.clientName||'N/A'}<br><strong>Equipo:</strong> ${v.equipoNumber||'N/A'}<br><strong>Tipo:</strong> ${tipo}<br><strong>Fecha:</strong> ${new Date(v.timestamp.toDate?v.timestamp.toDate():v.timestamp).toLocaleString('es-ES')}<br><strong>Total:</strong> $${(v.total||0).toFixed(2)}</div>${v.paymentType==='pendiente'&&sp>0?`<div class="saldo-info">Saldo Pendiente: $${sp.toFixed(2)}</div>`:''}<h4 style="margin:15px 0 10px 0">Productos:</h4>${prod||'<p>Sin productos</p>'}${abonos}`;UIService.showInvoiceModal(modalContent);},
  async viewRetiro(id){let r=AppState.historial.find(x=>x.id===id&&x.tipo==='retiro');if(!r)r=(await DataService.loadRetiros(1)).find(x=>x.id===id);if(!r)return;const modalContent=`<h3 style="margin-bottom:15px;text-align:center">Retiro de Fondos</h3><div class="invoice-details"><strong>Concepto:</strong> ${r.concepto||'Sin concepto'}<br><strong>Categoría:</strong> ${r.categoria||'Otros'}<br><strong>Fecha:</strong> ${new Date(r.timestamp.toDate?r.timestamp.toDate():r.timestamp).toLocaleString('es-ES')}<br><strong>Monto:</strong> $${(r.monto||0).toFixed(2)}</div>`;UIService.showInvoiceModal(modalContent);},
  async editInvoice(id){let v=AppState.historial.find(x=>x.id===id&&x.tipo==='venta');if(!v)v=await DataService.getSaleById(id);if(!v){UIService.showStatus('No encontrada para editar','error');return;} AppState.cart=v.products.map(p=>({id:p.id,codigo:p.codigo,descripcion:p.descripcion,precio:p.precio,cantidad:p.cantidad}));document.getElementById('equipo').value=v.equipoNumber||'';document.getElementById('cliente').value=v.clientName||'';document.getElementById('fecha-venta').value=v.date||DateUtils.getCurrentDateStringElSalvador();AppState.currentEditingInvoice=id;UIService.updateCartDisplay();document.getElementById('contado-btn').style.display='none';document.getElementById('pendiente-btn').style.display='none';const updateBtn=document.createElement('button');updateBtn.className='btn btn-success';updateBtn.textContent='ACTUALIZAR FACTURA';updateBtn.onclick=()=>this.updateInvoice(id);const cancelBtn=document.createElement('button');cancelBtn.className='btn btn-danger';cancelBtn.textContent='CANCELAR EDICIÓN';cancelBtn.onclick=()=>this.cancelEdit();const contadoContainer=document.querySelector('.venta-line-1').lastElementChild;const pendienteContainer=document.querySelector('.venta-line-2').lastElementChild;contadoContainer.innerHTML='';pendienteContainer.innerHTML='';contadoContainer.appendChild(updateBtn);pendienteContainer.appendChild(cancelBtn);UIService.showStatus('Modo edición activado','success');},
  cancelEdit(){AppState.cart=[];AppState.currentEditingInvoice=null;document.getElementById('equipo').value='';document.getElementById('cliente').value='';document.getElementById('buscar-producto').value='';UIService.updateCartDisplay();document.getElementById('contado-btn').style.display='block';document.getElementById('pendiente-btn').style.display='block';},
  async updateInvoice(id){if(!AppState.cart.length){UIService.showStatus('Carrito vacío','error');return;} try{const prodCero=AppState.cart.filter(it=>it.precio===0);if(prodCero.length)throw new Error('Hay productos con precio $0.00');const total=AppState.cart.reduce((s,it)=>s+(it.precio*it.cantidad),0);const sd={products:AppState.cart.map(it=>({id:it.id,codigo:it.codigo,descripcion:it.descripcion,precio:it.precio,cantidad:it.cantidad})),total,saldoPendiente:total,fechaActualizacion:DateUtils.getCurrentTimestampElSalvador()};const ventaActual=await DataService.getSaleById(id);if(ventaActual&&ventaActual.abonos&&ventaActual.abonos.length){const totalAbonado=ventaActual.abonos.reduce((s,a)=>s+a.monto,0);sd.saldoPendiente=total-totalAbonado;if(sd.saldoPendiente<=0){sd.paymentType='contado';sd.status='pagado';}}await AppState.db.collection('VENTAS').doc(id).update(sd);UIService.showStatus('Factura actualizada','success');this.printTicket({...ventaActual,...sd});this.cancelEdit();await this.loadHistorial();}catch(e){UIService.showStatus('Error al actualizar: '+e.message,'error');}},
  async deleteInvoice(id){if(!confirm('¿Está seguro de eliminar esta factura?'))return; try{UIService.showLoading(true);await DataService.deleteSale(id);UIService.showStatus('Factura eliminada','success');await this.loadHistorial();}catch(e){UIService.showStatus('Error al eliminar: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async deleteRetiro(id){if(!confirm('¿Está seguro de eliminar este retiro?'))return; try{UIService.showLoading(true);await AppState.db.collection('RETIROS').doc(id).delete();UIService.showStatus('Retiro eliminado','success');await this.loadHistorial();}catch(e){UIService.showStatus('Error al eliminar retiro: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async cancelInvoice(id){if(!confirm('¿Está seguro de cancelar esta factura? Se cambiará a CONTADO.'))return; try{UIService.showLoading(true);await DataService.cancelInvoice(id);UIService.showStatus('Factura cancelada','success');await this.loadHistorial();}catch(e){UIService.showStatus('Error al cancelar: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async reprintInvoice(id){let v=AppState.historial.find(x=>x.id===id&&x.tipo==='venta');if(!v)v=await DataService.getSaleById(id);if(v){this.printTicket(v);UIService.showStatus('Ticket reimpreso','success');}},
  async registrarAbono(id){let v=AppState.historial.find(x=>x.id===id&&x.tipo==='venta');if(!v)v=await DataService.getSaleById(id);if(!v)return; AppState.currentAbonoInvoice=v;const sp=v.saldoPendiente!==undefined?v.saldoPendiente:v.total;const modalContent=`<div class="invoice-details"><strong>Factura:</strong> ${v.invoiceNumber}<br><strong>Grupo:</strong> ${v.clientName}<br><strong>Total:</strong> $${v.total.toFixed(2)}<br><strong>Saldo Pendiente:</strong> $${sp.toFixed(2)}</div>`;UIService.showAbonoModal(modalContent);},
  async processAbono(){const monto=parseFloat(document.getElementById('monto-abono').value)||0;if(!monto||monto<=0){UIService.showStatus('Ingrese monto válido','error');return;} const v=AppState.currentAbonoInvoice;if(!v){UIService.showStatus('No hay factura seleccionada','error');return;} const sp=v.saldoPendiente!==undefined?v.saldoPendiente:v.total;if(monto>sp){UIService.showStatus('El abono no puede ser mayor al saldo','error');return;} try{UIService.showLoading(true);const abonoData={monto,fecha:DateUtils.getCurrentTimestampElSalvador(),fechaString:DateUtils.getCurrentTimestampElSalvador().toLocaleString('es-ES')};await DataService.addAbono(v.id,abonoData);this.printAbonoTicket(v,abonoData,sp-monto);UIService.showStatus(`Abono de $${monto.toFixed(2)} registrado`,'success');ModalService.closeAbonoModal();await this.loadHistorial();}catch(e){UIService.showStatus('Error al procesar abono: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async processRetiro(){const monto=parseFloat(document.getElementById('monto-retiro').value)||0;const concepto=document.getElementById('concepto-retiro').value.trim();const categoria=document.getElementById('categoria-retiro').value;if(!monto||monto<=0){UIService.showStatus('Ingrese monto válido','error');return;} if(!concepto){UIService.showStatus('Ingrese concepto','error');return;} try{UIService.showLoading(true);const rd={monto,concepto,categoria,timestamp:DateUtils.getCurrentTimestampElSalvador(),date:DateUtils.getCurrentDateStringElSalvador()};await DataService.saveRetiro(rd);this.printRetiroTicket(rd);UIService.showStatus('Retiro guardado','success');ModalService.closeRetiroModal();await this.loadHistorial();}catch(e){UIService.showStatus('Error retiro: '+e.message,'error');}finally{UIService.showLoading(false);}},
  async printCurrentHistorial(){const movs=AppState.filteredHistorial;if(!movs.length){UIService.showStatus('Sin movimientos para imprimir','warning');return;} this.printHistorialCorte(movs);}
};
/* ----------  MODAL SERVICE ---------- */
const ModalService={
  closeAbonoModal:()=>{document.getElementById('abono-modal').style.display='none';AppState.currentAbonoInvoice=null;},
  closeRetiroModal:()=>{document.getElementById('retiro-modal').style.display='none';},
  closeInvoiceModal:()=>{document.getElementById('invoice-modal').style.display='none';},
  closeDetalleModal:()=>{document.getElementById('detalle-modal').style.display='none';AppState.currentDetalle=null;},
  closeGrupoDetalleModal:()=>{document.getElementById('grupo-detalle-modal').style.display='none';GrupoManager.currentGrupoDetalle=null;},
  closeCrearGrupoModal:()=>{document.getElementById('crear-grupo-modal').style.display='none';AppState.equiposSeleccionados.clear();},
  closeEditarGrupoModal:()=>{document.getElementById('editar-grupo-modal').style.display='none';GrupoManager.currentEditingGroup=null;AppState.equiposEditSeleccionados.clear();},
  closeConfirmacionAbonoModal:()=>{document.getElementById('confirmacion-abono-modal').style.display='none';delete AppState.datosVentaPendiente;},
  closeAbonoInicialModal:()=>{document.getElementById('abono-inicial-modal').style.display='none';delete AppState.datosVentaPendiente;},
  closeAbonoGrupoModal:()=>{document.getElementById('abono-modal').style.display='none';}
};
/* ----------  CONNECTION ---------- */
const ConnectionManager={
  isOnline:true,initialize(){this.checkConnection();setInterval(()=>this.checkConnection(),30000);window.addEventListener('online',()=>this.handleOnline());window.addEventListener('offline',()=>this.handleOffline());},
  async checkConnection(){try{if(AppState.firebaseInitialized){await AppState.db.collection('VENTAS').limit(1).get();this.handleOnline();}else this.handleOffline();}catch{this.handleOffline();}},
  handleOnline(){if(!this.isOnline){this.isOnline=true;this.updateUI();UIService.showStatus('Conexión restaurada','success');}},
  handleOffline(){if(this.isOnline){this.isOnline=false;this.updateUI();UIService.showStatus('Sin conexión - Modo offline','error');}},
  updateUI(){const el=document.getElementById('connection-status');el.textContent=this.isOnline?'🟢 CONECTADO':'🔴 SIN CONEXIÓN';el.className=this.isOnline?'connection-status online':'connection-status offline';el.style.display='block';}
};
/* ----------  APP INIT ---------- */
const App={
  async init(){try{await this.initializeFirebase();this.setupUI();await this.loadInitialData();this.setupEventListeners();ConnectionManager.initialize();UIService.showStatus('Sistema optimizado inicializado','success');}catch(e){UIService.showStatus('Error al inicializar: '+e.message,'error');}},
  async initializeFirebase(){if(firebase.apps.length===0)firebase.initializeApp(CONFIG.firebase);AppState.db=firebase.firestore();try{await AppState.db.enablePersistence();}catch(e){console.log('Persistencia offline no disponible',e);}AppState.firebaseInitialized=true;},
  setupUI(){SalesService.setTodayDate();UIService.setupTabs();},
  async loadInitialData(){try{UIService.showLoading(true);await ProductCache.initialize();AppState.saleCounter=await DataService.getSaleCounter();await SalesService.loadHistorial();await GrupoManager.initialize();}catch(e){console.error(e);}finally{UIService.showLoading(false);}},
  setupEventListeners(){
    document.addEventListener('click',e=>{if(!e.target.closest('.search-container'))document.getElementById('search-dropdown').style.display='none';});
    const searchInput=document.getElementById('buscar-producto');let searchTO;searchInput.addEventListener('input',async(e)=>{clearTimeout(searchTO);const q=e.target.value.trim();if(q.length<2){document.getElementById('search-dropdown').style.display='none';return;} searchTO=setTimeout(async()=>{try{AppState.searchResults=await DataService.searchProducts(q);UIService.showSearchResults(AppState.searchResults);}catch{document.getElementById('search-dropdown').style.display='none';}},300);});searchInput.addEventListener('keypress',e=>{if(e.key==='Enter'){const q=searchInput.value.trim();if(q){SalesService.addManualProduct(q);searchInput.value='';document.getElementById('search-dropdown').style.display='none';}}});
    document.getElementById('equipo').addEventListener('input',e=>{e.target.value=e.target.value.replace(/[^0-9]/g,'');if(e.target.value.length>4)e.target.value=e.target.value.substring(0,4);});
    document.getElementById('fecha-venta').addEventListener('change',()=>SalesService.setTodayDate());
    document.getElementById('contado-btn').addEventListener('click',()=>SalesService.processSale('contado'));
    document.getElementById('pendiente-btn').addEventListener('click',()=>SalesService.processSale('pendiente'));
    document.getElementById('print-historial-btn').addEventListener('click',()=>SalesService.printCurrentHistorial());
    document.getElementById('filter-historial').addEventListener('input',(e)=>{const v=e.target.value;switch(AppState.currentFilter){case 'equipo':case 'producto':case 'monto':case 'rango':AppState.currentFilter='todo';if(v)AppState.currentFilter=document.querySelector('.filter-btn.active')?.dataset.filter||'todo';break;} UIService.applyCurrentFilter();});
    document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',(e)=>{AppState.currentFilter=e.target.dataset.filter;UIService.updateFilterButtons();if(AppState.currentFilter==='rango'){const r=prompt('Ingrese rango: yyyy-mm-dd to yyyy-mm-dd');if(r){document.getElementById('filter-historial').value=r;UIService.applyCurrentFilter();}return;} if(AppState.currentFilter==='monto'){const r=prompt('Ingrese mínimo-máximo: 0-100');if(r){document.getElementById('filter-historial').value=r;UIService.applyCurrentFilter();}return;} UIService.applyCurrentFilter();}));
    document.getElementById('close-invoice-modal').addEventListener('click',ModalService.closeInvoiceModal);
    document.getElementById('process-abono-btn').addEventListener('click',()=>SalesService.processAbono());
    document.getElementById('close-abono-modal').addEventListener('click',ModalService.closeAbonoModal);
    document.getElementById('close-retiro-modal').addEventListener('click',ModalService.closeRetiroModal);
    document.getElementById('close-detalle-modal').addEventListener('click',ModalService.closeDetalleModal);
    document.getElementById('imprimir-detalle-modal').addEventListener('click',()=>{if(AppState.currentDetalle&&AppState.currentDetalle.tipo==='equipo'){const eq=GrupoManager.equiposPendientes.get(AppState.currentDetalle.data);if(eq)eq.facturas.forEach(f=>GrupoManager.imprimirTicketFactura(f,eq));}});
    document.getElementById('close-grupo-detalle-modal').addEventListener('click',ModalService.closeGrupoDetalleModal);
    document.getElementById('imprimir-grupo-detalle-modal').addEventListener('click',()=>GrupoManager.imprimirGrupoCompleto());
    document.getElementById('crear-grupo-btn').addEventListener('click',()=>{document.getElementById('crear-grupo-modal').style.display='block';AppState.equiposSeleccionados.clear();GrupoManager.generarGridEquipos('crear');GrupoManager.actualizarListaSeleccionados('crear');document.getElementById('nombre-grupo').value='';});
    document.getElementById('guardar-grupo-btn').addEventListener('click',async()=>{const nombre=document.getElementById('nombre-grupo').value.trim();if(!nombre){UIService.showStatus('Ingrese nombre del grupo','error');return;} if(AppState.equiposSeleccionados.size===0){UIService.showStatus('Seleccione al menos un equipo','error');return;} try{UIService.showLoading(true);await GrupoManager.crearGrupo(nombre,Array.from(AppState.equiposSeleccionados));UIService.showStatus('Grupo creado','success');ModalService.closeCrearGrupoModal();}catch(e){UIService.showStatus('Error al crear grupo: '+e.message,'error');}finally{UIService.showLoading(false);}});
    document.getElementById('cancelar-grupo-btn').addEventListener('click',ModalService.closeCrearGrupoModal);
    document.getElementById('actualizar-grupo-btn').addEventListener('click',()=>GrupoManager.actualizarGrupoDesdeModal());
    document.getElementById('cancelar-editar-grupo-btn').addEventListener('click',ModalService.closeEditarGrupoModal);
    document.getElementById('confirmar-con-abono-btn').addEventListener('click',()=>{const d=AppState.datosVentaPendiente;if(d){document.getElementById('confirmacion-abono-modal').style.display='none';SalesService.mostrarModalAbonoInicial(d.equipo,d.cliente,d.totalVenta,d.fechaVenta);}});
    document.getElementById('continuar-sin-abono-btn').addEventListener('click',()=>{const d=AppState.datosVentaPendiente;if(d){document.getElementById('confirmacion-abono-modal').style.display='none';SalesService.procesarVentaPendienteSinAbono(d.equipo,d.cliente,d.fechaVenta,d.totalVenta);}});
    document.getElementById('cancelar-confirmacion-btn').addEventListener('click',ModalService.closeConfirmacionAbonoModal);
    document.getElementById('monto-abono-inicial').addEventListener('input',(e)=>{const monto=parseFloat(e.target.value)||0;const total=AppState.datosVentaPendiente?.totalVenta||0;const saldo=Math.max(0,total-monto);document.getElementById('saldo-despues-abono').textContent=`$${saldo.toFixed(2)}`;e.target.classList.toggle('price-warning',monto>total);});
    document.getElementById('procesar-venta-con-abono-btn').addEventListener('click',()=>{const monto=parseFloat(document.getElementById('monto-abono-inicial').value)||0;const d=AppState.datosVentaPendiente;if(!d){UIService.showStatus('Error: sin datos de venta','error');return;} if(monto<=0){UIService.showStatus('Ingrese monto de abono','error');return;} if(monto>d.totalVenta){UIService.showStatus('El abono no puede ser mayor al total','error');return;} document.getElementById('abono-inicial-modal').style.display='none';SalesService.procesarVentaPendienteConAbono(d.equipo,d.cliente,d.fechaVenta,d.totalVenta,monto);});
    document.getElementById('cancelar-abono-inicial-btn').addEventListener('click',ModalService.closeAbonoInicialModal);
    window.addEventListener('beforeunload',()=>{if(ProductCache.unsub)ProductCache.unsub.forEach(u=>u());if(GrupoManager.unsub)GrupoManager.unsub();});
  }
};
/* ----------  GLOBAL HELPERS ---------- */
function toggleEquipoGrid(en,modalType='crear'){const selectedSet=modalType==='crear'?AppState.equiposSeleccionados:AppState.equiposEditSeleccionados;if(selectedSet.has(en))selectedSet.delete(en);else{if(selectedSet.size>=130){UIService.showStatus('Máximo 130 equipos','error');return;} selectedSet.add(en);} GrupoManager.actualizarListaSeleccionados(modalType); GrupoManager.generarGridEquipos(modalType);}
function eliminarGrupo(gId){GrupoManager.eliminarGrupo(gId);}
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>
