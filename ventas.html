<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas - Taller Wilian</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --text-color: #333;
            --bg-color: #f5f7fa;
            --panel-bg: white;
            --border-color: #ddd;
            --header-gradient: linear-gradient(135deg, #3498db, #2c3e50);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.4;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        header {
            background: var(--header-gradient);
            color: white;
            padding: 10px 0;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .sales-process-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .sales-form-container, .pending-invoices-container {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .panel h2 {
            color: var(--text-color);
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
            background: var(--panel-bg);
            color: var(--text-color);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .client-fields {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 8px;
            margin-bottom: 15px;
            align-items: end;
        }

        .search-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: end;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-color); }

        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #219a52; }

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c0392b; }

        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover { background-color: #d35400; }

        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .payment-btn {
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .payment-btn.contado {
            background-color: var(--success-color);
            color: white;
        }

        .payment-btn.contado:hover {
            background-color: #219a52;
        }

        .payment-btn.pendiente {
            background-color: var(--warning-color);
            color: white;
        }

        .payment-btn.pendiente:hover {
            background-color: #d35400;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead {
            background-color: var(--secondary-color);
            color: white;
        }

        tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .compact-table {
            font-size: 0.75rem;
        }

        .compact-table th, 
        .compact-table td {
            padding: 6px 8px;
        }

        .product-item {
            background: var(--light-color);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
        }

        .search-dropdown {
            position: absolute;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 100px);
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
        }

        .search-dropdown-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-dropdown-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .product-info {
            flex: 1;
        }

        .product-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quantity-btn {
            width: 25px;
            height: 25px;
            border: none;
            border-radius: 3px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.85rem;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .summary-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--success-color);
            text-align: center;
            margin: 15px 0;
        }

        .actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .actions button {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        /* Nuevos estilos para equipos */
        .equipos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .equipo-card {
            background: var(--light-color);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .equipo-card:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .equipo-card.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--accent-color);
        }

        .equipo-card.pagado {
            border-left: 4px solid var(--success-color);
        }

        .equipo-card.pendiente {
            border-left: 4px solid var(--warning-color);
        }

        .equipo-number {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .equipo-saldo {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .equipo-count {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .equipo-invoices {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .equipo-invoices.active {
            display: block;
        }

        .invoice-item {
            background: var(--light-color);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.8rem;
        }

        .invoice-item.pagado {
            border-left: 4px solid var(--success-color);
            opacity: 0.7;
        }

        .invoice-item.pendiente {
            border-left: 4px solid var(--warning-color);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .invoice-number {
            font-weight: bold;
            font-size: 1rem;
        }

        .invoice-total {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .invoice-details {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .invoice-products {
            background: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.75rem;
        }

        .product-detail {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px dotted var(--border-color);
        }

        .product-detail:last-child {
            border-bottom: none;
        }

        .payment-history {
            background: var(--light-color);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .file-actions button {
            flex: 1;
        }

        @media (max-width: 768px) {
            .sales-process-container {
                grid-template-columns: 1fr;
            }
            
            .client-fields, .search-container {
                grid-template-columns: 1fr;
            }
            
            .search-dropdown {
                width: 100%;
            }

            .container {
                padding: 5px;
            }

            .panel {
                padding: 10px;
            }

            .equipos-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .file-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="status-message"></div>
    
    <div class="container">
        <header>
            <h1>Sistema de Ventas - Taller Wilian</h1>
            <div class="header-info">
                <span>Fecha: <span id="current-date"></span></span>
                <span>Vendedor: <span id="current-user">Usuario</span></span>
            </div>
        </header>

        <div class="sales-process-container">
            <div class="sales-form-container">
                <h2>Proceso de Venta</h2>
                
                <div class="client-fields">
                    <div class="form-group">
                        <label for="equipo-number">N° Equipo</label>
                        <input type="text" id="equipo-number" placeholder="000000" maxlength="6" pattern="[0-9]*">
                    </div>
                    <div class="form-group">
                        <label for="client-name">Cliente/Equipo</label>
                        <input type="text" id="client-name" placeholder="Nombre cliente o equipo">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="search-product">Buscar Producto</label>
                    <div class="search-container">
                        <div style="position: relative;">
                            <input type="text" id="search-product" placeholder="Código o descripción">
                            <div id="search-dropdown" class="search-dropdown" style="display: none;"></div>
                        </div>
                        <button class="btn btn-primary" id="add-product-btn">
                            AGREGAR
                        </button>
                    </div>
                </div>
                
                <h3 style="margin: 15px 0 8px 0; color: var(--text-color); font-size: 1rem;">Carrito</h3>
                
                <div id="cart-items" style="max-height: 200px; overflow-y: auto;">
                    <p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">No hay productos</p>
                </div>
                
                <div style="margin-top: 15px;">
                    <div class="summary-total">
                        Total: <span id="total-amount">$0.00</span>
                    </div>
                    
                    <div class="payment-buttons">
                        <button class="payment-btn contado" id="contado-btn">
                            CONTADO
                        </button>
                        <button class="payment-btn pendiente" id="pendiente-btn">
                            PENDIENTE
                        </button>
                    </div>
                </div>
            </div>

            <div class="pending-invoices-container">
                <h2>Facturas Pendientes por Equipo</h2>
                
                <div class="file-actions">
                    <button class="btn btn-info" id="save-pending-btn">
                        Guardar Pendientes
                    </button>
                    <button class="btn btn-warning" id="load-pending-btn">
                        Cargar Pendientes
                    </button>
                    <input type="file" id="pending-file-input" accept=".json" style="display: none;">
                </div>
                
                <div class="equipos-grid" id="equipos-grid">
                    <div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; font-size: 0.8rem;">
                        Cargando equipos...
                    </div>
                </div>
                
                <div id="equipo-invoices-container" class="equipo-invoices">
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Ventas del Día</h2>
            <div id="daily-sales">
                <table class="compact-table">
                    <thead>
                        <tr>
                            <th>Factura</th>
                            <th>Cliente/Equipo</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Tipo</th>
                            <th>Hora</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="daily-sales-body">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">
                                Cargando ventas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDh074AarXaYCc-Htw-lsCeIc_95QQNSnY",
                authDomain: "tallerwilliam-732b3.firebaseapp.com",
                projectId: "tallerwilliam-732b3",
                storageBucket: "tallerwilliam-732b3.firebasestorage.app",
                messagingSenderId: "822262666247",
                appId: "1:822262666247:web:6680487bbf1108006b86a2"
            }
        };

        const AppState = {
            firebaseInitialized: false,
            db: null,
            cart: [],
            dailySales: [],
            pendingCredits: [],
            equiposConPendientes: [],
            searchResults: [],
            isProcessingSale: false,
            saleCounter: 0,
            selectedProduct: null,
            selectedQuantity: 1,
            selectedEquipo: null
        };

        const DataService = {
            async searchProducts(query) {
                if (!AppState.firebaseInitialized) {
                    throw new Error("No hay conexión a la base de datos");
                }

                const searchTerm = query.toLowerCase().trim();
                const snapshot = await AppState.db.collection("INVENTARIO").get();
                
                const results = [];
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    const codigo = (product.codigo || '').toLowerCase();
                    const descripcion = (product.descripcion || '').toLowerCase();
                    
                    if (codigo.includes(searchTerm) || descripcion.includes(searchTerm)) {
                        results.push(product);
                    }
                });
                
                return results;
            },

            saveSale(saleData) {
                const sales = this.loadFromLocalStorage("dailySales") || [];
                const newItem = { ...saleData, localId: Date.now().toString() };
                sales.push(newItem);
                localStorage.setItem("dailySales", JSON.stringify(sales));
                return newItem.localId;
            },

            loadDailySales(date = new Date().toISOString().split('T')[0]) {
                const sales = this.loadFromLocalStorage("dailySales") || [];
                return sales.filter(sale => sale.date === date);
            },

            deleteSale(saleId) {
                const sales = this.loadFromLocalStorage("dailySales");
                const updatedSales = sales.filter(item => item.localId !== saleId);
                localStorage.setItem("dailySales", JSON.stringify(updatedSales));
                
                // También eliminar de créditos pendientes si existe
                this.deleteCredit(saleId);
            },

            saveCredit(creditData) {
                const credits = this.loadFromLocalStorage("pendingCredits") || [];
                const newItem = { ...creditData, localId: Date.now().toString() };
                credits.push(newItem);
                localStorage.setItem("pendingCredits", JSON.stringify(credits));
                return newItem.localId;
            },

            loadPendingCredits() {
                const credits = this.loadFromLocalStorage("pendingCredits") || [];
                return credits;
            },

            addPayment(creditId, paymentData) {
                const credits = this.loadFromLocalStorage("pendingCredits");
                const creditIndex = credits.findIndex(c => c.localId === creditId);
                
                if (creditIndex === -1) throw new Error("No se encontró el crédito");
                
                const credit = credits[creditIndex];
                const totalPaid = credit.payments ? credit.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                const newTotalPaid = totalPaid + paymentData.amount;
                
                if (newTotalPaid > credit.total) {
                    throw new Error("El abono excede el total pendiente");
                }
                
                if (!credit.payments) credit.payments = [];
                credit.payments.push(paymentData);
                
                if (newTotalPaid >= credit.total) {
                    credit.status = 'pagado';
                }
                
                credits[creditIndex] = credit;
                localStorage.setItem("pendingCredits", JSON.stringify(credits));
                
                return newTotalPaid;
            },

            deleteCredit(creditId) {
                const credits = this.loadFromLocalStorage("pendingCredits");
                const updatedCredits = credits.filter(item => item.localId !== creditId);
                localStorage.setItem("pendingCredits", JSON.stringify(updatedCredits));
            },

            deleteSaleAndCredit(saleId) {
                // Eliminar de ventas diarias
                this.deleteSale(saleId);
                
                // Eliminar de créditos pendientes
                this.deleteCredit(saleId);
            },

            exportPendingCredits() {
                const credits = this.loadFromLocalStorage("pendingCredits") || [];
                const dataStr = JSON.stringify(credits, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                return URL.createObjectURL(dataBlob);
            },

            importPendingCredits(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const credits = JSON.parse(e.target.result);
                            localStorage.setItem("pendingCredits", JSON.stringify(credits));
                            resolve(credits);
                        } catch (error) {
                            reject(new Error("Archivo inválido"));
                        }
                    };
                    reader.onerror = () => reject(new Error("Error al leer el archivo"));
                    reader.readAsText(file);
                });
            },

            loadFromLocalStorage(key) {
                return JSON.parse(localStorage.getItem(key) || '[]');
            }
        };

        const UIService = {
            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
            },

            updateCartDisplay() {
                const cartItems = document.getElementById('cart-items');
                const totalAmount = document.getElementById('total-amount');
                
                if (AppState.cart.length === 0) {
                    cartItems.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">No hay productos</p>';
                    totalAmount.textContent = '$0.00';
                    return;
                }
                
                let total = 0;
                let itemsHTML = '';
                
                AppState.cart.forEach((item, index) => {
                    const itemTotal = item.precio * item.quantity;
                    total += itemTotal;
                    
                    itemsHTML += `
                        <div class="product-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.descripcion}</strong>
                                    <div style="font-size: 0.7rem; margin-top: 2px;">
                                        Cód: ${item.codigo} | $${item.precio.toFixed(2)} x ${item.quantity}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 8px; font-weight: bold;">$${itemTotal.toFixed(2)}</span>
                                    <button class="btn btn-danger" data-remove-index="${index}" style="padding: 2px 6px; font-size: 0.7rem;">
                                        X
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = itemsHTML;
                totalAmount.textContent = `$${total.toFixed(2)}`;
            },

            showSearchResults(results) {
                const dropdown = document.getElementById('search-dropdown');
                dropdown.innerHTML = '';
                
                if (results.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'search-dropdown-item';
                    item.textContent = 'No se encontraron productos';
                    dropdown.appendChild(item);
                } else {
                    results.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'search-dropdown-item';
                        
                        const quantity = AppState.selectedProduct?.id === product.id ? AppState.selectedQuantity : 1;
                        
                        item.innerHTML = `
                            <div class="product-info">
                                <strong>${product.descripcion || 'Sin descripción'}</strong>
                                <div style="font-size: 0.7rem; margin-top: 2px;">
                                    Cód: ${product.codigo || 'N/A'} | Stock: ${product.cantidad || 0} | $${(product.precio || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="product-quantity">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" data-action="decrease" data-product-id="${product.id}">-</button>
                                    <input type="number" class="quantity-input" value="${quantity}" min="1" max="${product.cantidad || 99}" 
                                           data-product-id="${product.id}" style="width: 40px; padding: 2px;">
                                    <button class="quantity-btn" data-action="increase" data-product-id="${product.id}">+</button>
                                </div>
                                <button class="btn btn-success" data-add-product="${product.id}" style="padding: 4px 8px; font-size: 0.7rem;">
                                    Agregar
                                </button>
                            </div>
                        `;
                        dropdown.appendChild(item);
                    });
                }
                
                dropdown.style.display = 'block';
            },

            updateEquiposGrid() {
                const grid = document.getElementById('equipos-grid');
                
                if (AppState.equiposConPendientes.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; font-size: 0.8rem;">
                            No hay equipos con facturas pendientes
                        </div>
                    `;
                    return;
                }
                
                let gridHTML = '';
                
                AppState.equiposConPendientes.forEach(equipo => {
                    const statusClass = equipo.totalPendiente > 0 ? 'pendiente' : 'pagado';
                    const isActive = AppState.selectedEquipo === equipo.number ? 'active' : '';
                    
                    gridHTML += `
                        <div class="equipo-card ${statusClass} ${isActive}" 
                             data-equipo="${equipo.number}">
                            <div class="equipo-number">${equipo.number}</div>
                            <div class="equipo-saldo">$${equipo.totalPendiente.toFixed(2)}</div>
                            <div class="equipo-count">${equipo.count} factura(s)</div>
                        </div>
                    `;
                });
                
                grid.innerHTML = gridHTML;
            }
        };

        const SalesService = {
            setSelectedProduct(product, quantity = 1) {
                AppState.selectedProduct = product;
                AppState.selectedQuantity = quantity;
            },

            addToCart(productId, quantity) {
                let productToAdd;
                let quantityToAdd;

                if (productId && quantity) {
                    productToAdd = AppState.searchResults.find(p => p.id === productId);
                    quantityToAdd = quantity;
                } else if (AppState.selectedProduct) {
                    productToAdd = AppState.selectedProduct;
                    quantityToAdd = AppState.selectedQuantity;
                } else {
                    UIService.showStatus("Seleccione un producto primero", "error");
                    return;
                }

                if (!productToAdd) {
                    UIService.showStatus("Producto no encontrado", "error");
                    return;
                }

                if (!productToAdd.precio || productToAdd.precio <= 0) {
                    UIService.showStatus("El producto no tiene precio válido", "error");
                    return;
                }
                
                const existingItem = AppState.cart.find(item => item.id === productToAdd.id);
                
                if (existingItem) {
                    existingItem.quantity += quantityToAdd;
                } else {
                    AppState.cart.push({
                        id: productToAdd.id,
                        codigo: productToAdd.codigo || 'N/A',
                        descripcion: productToAdd.descripcion || 'Sin descripción',
                        precio: productToAdd.precio,
                        quantity: quantityToAdd
                    });
                }
                
                UIService.updateCartDisplay();
                UIService.showStatus("Producto agregado al carrito", "success");
                
                AppState.selectedProduct = null;
                AppState.selectedQuantity = 1;
                document.getElementById('search-product').value = '';
                document.getElementById('search-dropdown').style.display = 'none';
            },

            removeFromCart(index) {
                AppState.cart.splice(index, 1);
                UIService.updateCartDisplay();
            },

            async processSale(paymentType) {
                if (AppState.isProcessingSale) {
                    UIService.showStatus("Procesando venta anterior...", "error");
                    return;
                }

                if (AppState.cart.length === 0) {
                    UIService.showStatus("El carrito está vacío", "error");
                    return;
                }
                
                const equipoNumber = document.getElementById('equipo-number').value.trim();
                const clientName = document.getElementById('client-name').value.trim();
                
                if (!equipoNumber && !clientName) {
                    UIService.showStatus("Ingrese un número de equipo o nombre de cliente", "error");
                    return;
                }
                
                const finalClientName = clientName || `Equipo ${equipoNumber}`;
                const finalEquipoNumber = equipoNumber || '000000';
                
                AppState.isProcessingSale = true;
                
                try {
                    const saleData = {
                        invoiceNumber: this.generateInvoiceNumber(),
                        equipoNumber: finalEquipoNumber,
                        clientName: finalClientName,
                        products: AppState.cart.map(item => ({
                            id: item.id,
                            codigo: item.codigo,
                            descripcion: item.descripcion,
                            precio: item.precio,
                            cantidad: item.quantity
                        })),
                        total: AppState.cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0),
                        paymentType: paymentType,
                        timestamp: new Date(),
                        date: new Date().toISOString().split('T')[0],
                        status: paymentType === 'contado' ? 'pagado' : 'pendiente'
                    };
                    
                    const saleId = await DataService.saveSale(saleData);
                    
                    if (paymentType === 'pendiente') {
                        const creditData = {
                            ...saleData,
                            localId: saleId,
                            payments: [],
                            status: 'pendiente'
                        };
                        await DataService.saveCredit(creditData);
                    }
                    
                    UIService.showStatus(`Venta procesada - Factura #${saleData.invoiceNumber}`, "success");
                    
                    AppState.cart = [];
                    UIService.updateCartDisplay();
                    document.getElementById('client-name').value = '';
                    document.getElementById('equipo-number').value = '';
                    
                    await this.loadDailySales();
                    await this.loadPendingCredits();
                    
                } catch (error) {
                    UIService.showStatus("Error al procesar la venta: " + error.message, "error");
                } finally {
                    AppState.isProcessingSale = false;
                }
            },

            generateInvoiceNumber() {
                const now = new Date();
                const datePart = now.getFullYear().toString().substr(-2) + 
                               (now.getMonth() + 1).toString().padStart(2, '0') + 
                               now.getDate().toString().padStart(2, '0');
                const counterPart = (AppState.saleCounter + 1).toString().padStart(4, '0');
                return datePart + counterPart;
            },

            printTicket(saleData) {
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket #${saleData.invoiceNumber}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 11px; 
                                margin: 0; 
                                padding: 3px;
                                width: 54mm;
                            }
                            .header { text-align: center; margin-bottom: 6px; }
                            .line { border-bottom: 1px dashed #000; margin: 2px 0; }
                            .product { margin: 1px 0; font-size: 10px; }
                            .product-name { 
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                max-width: 32mm;
                            }
                            .total { font-weight: bold; text-align: center; margin-top: 6px; font-size: 12px; }
                            .footer { text-align: center; margin-top: 6px; font-size: 9px; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .dotted-line { border-bottom: 1px dotted #000; margin: 1px 0; }
                            .small-text { font-size: 9px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3 style="margin: 1px 0; font-size: 13px;">TALLER WILIAN</h3>
                            <div class="small-text">Factura: ${saleData.invoiceNumber}</div>
                            <div class="small-text">${new Date(saleData.timestamp).toLocaleString('es-ES')}</div>
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="small-text">
                            <strong>Cliente:</strong> ${saleData.clientName}<br>
                            <strong>Equipo:</strong> ${saleData.equipoNumber}<br>
                            <strong>Tipo:</strong> ${saleData.paymentType.toUpperCase()}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div style="margin: 4px 0;">
                            ${saleData.products.map(p => `
                                <div class="product" style="display: flex; justify-content: space-between;">
                                    <div class="product-name">${p.descripcion}</div>
                                    <div style="text-align: right;">
                                        <div>${p.cantidad} x $${p.precio.toFixed(2)}</div>
                                        <div>$${(p.precio * p.cantidad).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="dotted-line"></div>
                            `).join('')}
                        </div>
                        
                        <div class="line"></div>
                        
                        <div class="total">
                            TOTAL: $${saleData.total.toFixed(2)}
                        </div>
                        
                        <div class="footer">
                            <div>¡Gracias por su compra!</div>
                            <div>Taller Wilian</div>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 500);
                }, 500);
            },

            async loadDailySales() {
                try {
                    AppState.dailySales = await DataService.loadDailySales();
                    this.renderDailySales();
                } catch (error) {
                    UIService.showStatus("Error al cargar ventas del día", "error");
                }
            },

            async loadPendingCredits() {
                try {
                    AppState.pendingCredits = await DataService.loadPendingCredits();
                    this.processEquiposConPendientes();
                    UIService.updateEquiposGrid();
                } catch (error) {
                    UIService.showStatus("Error al cargar créditos pendientes", "error");
                }
            },

            processEquiposConPendientes() {
                const equiposMap = new Map();
                
                AppState.pendingCredits.forEach(credit => {
                    const equipoNumber = credit.equipoNumber || '000000';
                    const totalPaid = credit.payments ? credit.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                    const pendingAmount = credit.total - totalPaid;
                    
                    if (equiposMap.has(equipoNumber)) {
                        const existing = equiposMap.get(equipoNumber);
                        existing.totalPendiente += pendingAmount;
                        existing.count += 1;
                    } else {
                        equiposMap.set(equipoNumber, {
                            number: equipoNumber,
                            clientName: credit.clientName,
                            totalPendiente: pendingAmount,
                            count: 1
                        });
                    }
                });
                
                AppState.equiposConPendientes = Array.from(equiposMap.values())
                    .sort((a, b) => a.number.localeCompare(b.number));
            },

            renderDailySales() {
                const salesBody = document.getElementById('daily-sales-body');
                
                if (AppState.dailySales.length === 0) {
                    salesBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">
                                No hay ventas registradas hoy
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let salesHTML = '';
                
                AppState.dailySales.forEach(sale => {
                    const time = sale.timestamp ? new Date(sale.timestamp).toLocaleTimeString('es-ES', { 
                        hour: '2-digit', minute: '2-digit' 
                    }) : 'N/A';
                    
                    const productsList = sale.products ? sale.products.map(p => 
                        `${p.descripcion} (x${p.cantidad})`
                    ).join(', ') : 'N/A';
                    
                    salesHTML += `
                        <tr>
                            <td>${sale.invoiceNumber || 'N/A'}</td>
                            <td>${sale.clientName || 'N/A'}</td>
                            <td>${productsList}</td>
                            <td>$${(sale.total || 0).toFixed(2)}</td>
                            <td>
                                <span style="padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; 
                                    background-color: ${sale.paymentType === 'contado' ? '#27ae60' : '#f39c12'}; 
                                    color: white;">
                                    ${sale.paymentType === 'contado' ? 'CONTADO' : 'PENDIENTE'}
                                </span>
                            </td>
                            <td>${time}</td>
                            <td class="actions">
                                <button class="btn btn-info" data-print-sale="${sale.localId}" style="padding: 4px 8px; font-size: 0.75rem;">
                                    Imprimir
                                </button>
                                <button class="btn btn-danger" data-delete-sale="${sale.localId}" style="padding: 4px 8px; font-size: 0.75rem;">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                salesBody.innerHTML = salesHTML;
            }
        };

        const App = {
            async init() {
                try {
                    await this.initializeFirebase();
                    this.setupUI();
                    await this.loadInitialData();
                    this.setupEventListeners();
                    UIService.showStatus("Sistema inicializado correctamente", "success");
                } catch (error) {
                    console.error("Error en inicialización:", error);
                    UIService.showStatus("Error al inicializar: " + error.message, "error");
                }
            },

            async initializeFirebase() {
                try {
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(CONFIG.firebase);
                    }
                    AppState.db = firebase.firestore();
                    AppState.firebaseInitialized = true;
                } catch (error) {
                    console.error("Error inicializando Firebase:", error);
                    AppState.firebaseInitialized = false;
                    UIService.showStatus("Modo offline activado", "warning");
                }
            },

            setupUI() {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES');
                
                const sales = DataService.loadFromLocalStorage("dailySales") || [];
                const today = new Date().toISOString().split('T')[0];
                AppState.saleCounter = sales.filter(sale => sale.date === today).length;
            },

            async loadInitialData() {
                await SalesService.loadDailySales();
                await SalesService.loadPendingCredits();
            },

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('search-dropdown').style.display = 'none';
                    }
                });

                const searchInput = document.getElementById('search-product');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    searchTimeout = setTimeout(async () => {
                        if (query.length >= 2) {
                            try {
                                AppState.searchResults = await DataService.searchProducts(query);
                                UIService.showSearchResults(AppState.searchResults);
                            } catch (error) {
                                document.getElementById('search-dropdown').style.display = 'none';
                                if (query.length > 0) {
                                    UIService.showStatus("Error en búsqueda: " + error.message, "error");
                                }
                            }
                        } else {
                            document.getElementById('search-dropdown').style.display = 'none';
                        }
                    }, 300);
                });

                document.getElementById('add-product-btn').addEventListener('click', () => {
                    SalesService.addToCart();
                });

                document.getElementById('equipo-number').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value.length > 6) {
                        e.target.value = e.target.value.substring(0, 6);
                    }
                });

                document.getElementById('contado-btn').addEventListener('click', () => {
                    SalesService.processSale('contado');
                });

                document.getElementById('pendiente-btn').addEventListener('click', () => {
                    SalesService.processSale('pendiente');
                });

                document.getElementById('save-pending-btn').addEventListener('click', () => {
                    this.savePendingCredits();
                });

                document.getElementById('load-pending-btn').addEventListener('click', () => {
                    document.getElementById('pending-file-input').click();
                });

                document.getElementById('pending-file-input').addEventListener('change', (e) => {
                    this.loadPendingCredits(e.target.files[0]);
                });

                document.addEventListener('click', async (e) => {
                    const target = e.target;
                    
                    if (target.hasAttribute('data-remove-index')) {
                        const index = parseInt(target.getAttribute('data-remove-index'));
                        SalesService.removeFromCart(index);
                    }
                    
                    if (target.hasAttribute('data-delete-sale')) {
                        const saleId = target.getAttribute('data-delete-sale');
                        this.deleteSale(saleId);
                    }
                    
                    if (target.hasAttribute('data-add-payment')) {
                        const creditId = target.getAttribute('data-add-payment');
                        const totalAmount = parseFloat(target.getAttribute('data-total-amount'));
                        this.addPayment(creditId, totalAmount);
                    }
                    
                    if (target.hasAttribute('data-delete-credit')) {
                        const creditId = target.getAttribute('data-delete-credit');
                        this.deleteCredit(creditId);
                    }
                    
                    if (target.hasAttribute('data-add-product')) {
                        const productId = target.getAttribute('data-add-product');
                        const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
                        const quantity = parseInt(quantityInput.value) || 1;
                        SalesService.addToCart(productId, quantity);
                    }
                    
                    if (target.hasAttribute('data-action')) {
                        const action = target.getAttribute('data-action');
                        const productId = target.getAttribute('data-product-id');
                        const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
                        let quantity = parseInt(quantityInput.value) || 1;
                        
                        if (action === 'increase') {
                            const product = AppState.searchResults.find(p => p.id === productId);
                            const maxStock = product?.cantidad || 99;
                            if (quantity < maxStock) {
                                quantity++;
                            }
                        } else if (action === 'decrease') {
                            if (quantity > 1) {
                                quantity--;
                            }
                        }
                        
                        quantityInput.value = quantity;
                        
                        const product = AppState.searchResults.find(p => p.id === productId);
                        if (product) {
                            SalesService.setSelectedProduct(product, quantity);
                        }
                    }
                    
                    if (target.closest('.equipo-card')) {
                        const equipoCard = target.closest('.equipo-card');
                        const equipoNumber = equipoCard.getAttribute('data-equipo');
                        this.selectEquipo(equipoNumber);
                    }
                    
                    if (target.hasAttribute('data-print-sale')) {
                        const saleId = target.getAttribute('data-print-sale');
                        this.printSale(saleId);
                    }
                    
                    if (target.hasAttribute('data-print-credit')) {
                        const creditId = target.getAttribute('data-print-credit');
                        this.printCredit(creditId);
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('quantity-input')) {
                        const productId = e.target.getAttribute('data-product-id');
                        const quantity = parseInt(e.target.value) || 1;
                        const product = AppState.searchResults.find(p => p.id === productId);
                        if (product) {
                            SalesService.setSelectedProduct(product, quantity);
                        }
                    }
                });
            },

            async selectEquipo(equipoNumber) {
                AppState.selectedEquipo = equipoNumber;
                
                document.querySelectorAll('.equipo-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.querySelector(`[data-equipo="${equipoNumber}"]`).classList.add('active');
                
                await this.showEquipoInvoices(equipoNumber);
            },

            async showEquipoInvoices(equipoNumber) {
                const container = document.getElementById('equipo-invoices-container');
                const equipoCredits = AppState.pendingCredits.filter(credit => 
                    credit.equipoNumber === equipoNumber
                );
                
                if (equipoCredits.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #7f8c8d; font-size: 0.8rem;">
                            No hay facturas para este equipo
                        </p>
                    `;
                    container.className = 'equipo-invoices active';
                    return;
                }
                
                let invoicesHTML = '';
                
                equipoCredits.forEach(credit => {
                    let productsHTML = '';
                    if (credit.products && credit.products.length > 0) {
                        credit.products.forEach(product => {
                            productsHTML += `
                                <div class="product-detail">
                                    <span>${product.descripcion} (x${product.cantidad})</span>
                                    <span>$${(product.precio * product.cantidad).toFixed(2)}</span>
                                </div>
                            `;
                        });
                    }
                    
                    const date = credit.timestamp ? new Date(credit.timestamp).toLocaleDateString('es-ES') : 'N/A';
                    const totalPaid = credit.payments ? credit.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                    const pendingAmount = credit.total - totalPaid;
                    const status = pendingAmount > 0 ? 'pendiente' : 'pagado';
                    const statusText = pendingAmount > 0 ? 'PENDIENTE' : 'PAGADO';
                    
                    let paymentsHTML = '';
                    if (credit.payments && credit.payments.length > 0) {
                        paymentsHTML = `
                            <div class="payment-history">
                                <strong>Abonos:</strong>
                                ${credit.payments.map(payment => `
                                    <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                        <span>${new Date(payment.timestamp).toLocaleDateString('es-ES')}</span>
                                        <span>$${payment.amount.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    invoicesHTML += `
                        <div class="invoice-item ${status}">
                            <div class="invoice-header">
                                <div class="invoice-number">Factura #${credit.invoiceNumber}</div>
                                <div class="invoice-total">$${credit.total.toFixed(2)}</div>
                            </div>
                            <div class="invoice-details">
                                Fecha: ${date} | 
                                Abonado: $${totalPaid.toFixed(2)} | 
                                Pendiente: $${pendingAmount.toFixed(2)} |
                                Estado: ${statusText}
                            </div>
                            <div class="invoice-products">
                                ${productsHTML}
                            </div>
                            ${paymentsHTML}
                            <div class="actions">
                                <button class="btn btn-success" data-add-payment="${credit.localId}" data-total-amount="${pendingAmount}" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Abonar
                                </button>
                                <button class="btn btn-primary" data-print-credit="${credit.localId}" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Imprimir
                                </button>
                                <button class="btn btn-danger" data-delete-credit="${credit.localId}" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = invoicesHTML;
                container.className = 'equipo-invoices active';
            },

            async addPayment(creditId, totalAmount) {
                const amount = prompt(`Ingrese el monto del abono (Total pendiente: $${totalAmount.toFixed(2)})`);
                
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                    UIService.showStatus("Monto inválido", "error");
                    return;
                }
                
                const paymentAmount = parseFloat(amount);
                
                try {
                    const paymentData = {
                        amount: paymentAmount,
                        timestamp: new Date(),
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    const totalPaid = await DataService.addPayment(creditId, paymentData);
                    
                    UIService.showStatus(`Abono registrado. Total pagado: $${totalPaid.toFixed(2)}`, "success");
                    
                    await SalesService.loadPendingCredits();
                    
                    if (AppState.selectedEquipo) {
                        await this.showEquipoInvoices(AppState.selectedEquipo);
                    }
                    
                } catch (error) {
                    UIService.showStatus("Error al registrar abono: " + error.message, "error");
                }
            },

            async deleteSale(saleId) {
                if (!confirm("¿Está seguro de eliminar esta venta?")) return;
                
                try {
                    // Eliminar de ambos contenedores
                    await DataService.deleteSaleAndCredit(saleId);
                    UIService.showStatus("Venta eliminada exitosamente de ambos contenedores", "success");
                    await SalesService.loadDailySales();
                    await SalesService.loadPendingCredits();
                    
                    // Actualizar la vista si hay un equipo seleccionado
                    if (AppState.selectedEquipo) {
                        await this.showEquipoInvoices(AppState.selectedEquipo);
                    }
                } catch (error) {
                    UIService.showStatus("Error al eliminar venta", "error");
                }
            },

            async deleteCredit(creditId) {
                if (!confirm("¿Está seguro de eliminar este crédito pendiente?")) return;
                
                try {
                    await DataService.deleteCredit(creditId);
                    UIService.showStatus("Crédito eliminado exitosamente", "success");
                    await SalesService.loadPendingCredits();
                    
                    if (AppState.selectedEquipo) {
                        await this.showEquipoInvoices(AppState.selectedEquipo);
                    }
                } catch (error) {
                    UIService.showStatus("Error al eliminar crédito", "error");
                }
            },

            savePendingCredits() {
                const credits = DataService.loadFromLocalStorage("pendingCredits");
                if (credits.length === 0) {
                    UIService.showStatus("No hay facturas pendientes para guardar", "error");
                    return;
                }
                
                const url = DataService.exportPendingCredits();
                const a = document.createElement('a');
                a.href = url;
                a.download = `facturas-pendientes-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                UIService.showStatus("Facturas pendientes guardadas exitosamente", "success");
            },

            async loadPendingCredits(file) {
                if (!file) return;
                
                try {
                    await DataService.importPendingCredits(file);
                    UIService.showStatus("Facturas pendientes cargadas exitosamente", "success");
                    await SalesService.loadPendingCredits();
                    
                    if (AppState.selectedEquipo) {
                        await this.showEquipoInvoices(AppState.selectedEquipo);
                    }
                    
                    document.getElementById('pending-file-input').value = '';
                    
                } catch (error) {
                    UIService.showStatus("Error al cargar facturas: " + error.message, "error");
                }
            },

            printSale(saleId) {
                const sale = AppState.dailySales.find(s => s.localId === saleId);
                if (sale) {
                    SalesService.printTicket(sale);
                }
            },

            printCredit(creditId) {
                const credit = AppState.pendingCredits.find(c => c.localId === creditId);
                if (credit) {
                    SalesService.printTicket(credit);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
    </script>
</body>
</html>
